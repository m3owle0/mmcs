name: MMCS Notifier

on:
  schedule:
    # Run every minute
    - cron: '*/1 * * * *'
  # Allow manual triggering
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    timeout-minutes: 4
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'
          cache-dependencies: true
      
      - name: Download dependencies
        working-directory: ./notifier
        run: go mod download
      
      - name: Build notifier
        working-directory: ./notifier
        run: go build -o notifier
      
      - name: Run notifier (single cycle)
        working-directory: ./notifier
        env:
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          # Run notifier for one cycle (about 1-2 minutes), then exit
          timeout 180 ./notifier || exit 0
