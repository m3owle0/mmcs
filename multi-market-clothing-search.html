<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Multi-Market Secondhand Clothing Search</title>
  <meta name="viewport" content="width=1920, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="icon" type="image/svg+xml" href="miku.svg">
  <style>
    :root {
      --theme-bg: #0a0a0a;
      --theme-text: #f0f0f0;
      --theme-accent: #444;
      --theme-highlight: #00e6d6;
      --theme-bg-image: none;
    }
    
    img[loading="lazy"] {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    img[loading="lazy"].loaded {
      opacity: 1;
    }

    /* Main Styles */
    html, body {
      height: 100%;
      background: var(--theme-bg) var(--theme-bg-image);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: var(--theme-text);
      min-height: 100vh;
      overflow: hidden;
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
    }
    .container {
      max-width: 900px;
      min-width: 350px;
      width: 100%;
      min-height: 350px;
      max-height: 98vh;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: rgba(15,15,15,0.98);
      padding: 32px 20px 20px 20px;
      border-radius: 18px;
      box-shadow: 
        0 8px 32px rgba(0,0,0,0.5),
        0 0 0 1px rgba(255,255,255,0.05);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.1);
      z-index: 10;
      transition: all 0.4s cubic-bezier(0.2, 0.9, 0.1, 1.1);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .container::-webkit-scrollbar {
      width: 6px;
    }

    .container::-webkit-scrollbar-track {
      background: rgba(30,32,34,0.5);
    }

    .container::-webkit-scrollbar-thumb {
      background: rgba(120,120,120,0.5);
      border-radius: 3px;
    }

    .container.minimized {
      overflow-y: hidden;
    }
    
    .container.minimized {
      width: 300px !important;
      height: 40px !important;
      min-height: 0;
      min-width: 300px;
      padding: 0;
      overflow: hidden;
      cursor: move;
      transform: none !important;
    }
    .container.minimized .panel-controls {
      display: none;
    }
    .container.minimized .resize-handle {
      pointer-events: none;
    }

    .sidebar.minimized {
      width: 300px !important;
      height: 40px !important;
      min-height: 0;
      min-width: 300px;
      padding: 0;
      overflow: hidden;
      cursor: move;
      transform: none !important;
    }
    .sidebar.minimized .panel-controls,
    .sidebar.minimized .resize-handle {
      display: none;
    }
    .sidebar.minimized .drag-handle::after {
      width: 30px;
    }

    .wishlist-section.minimized {
      width: 300px !important;
      height: 40px !important;
      min-height: 0;
      min-width: 300px;
      padding: 0;
      overflow: hidden;
      cursor: move;
      transform: none !important;
    }
    .wishlist-section.minimized .panel-controls,
    .wishlist-section.minimized .resize-handle {
      display: none;
    }
    .wishlist-section.minimized .drag-handle::after {
      width: 30px;
    }
    
    .container.minimized .drag-handle::after {
      opacity: 0.7;
    }
    
    .container.minimized h1 {
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: none;
    }
    
    .container:not(.minimized) h1 {
      transition: opacity 0.3s ease 0.1s;
    }
    .drag-handle {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      cursor: move;
      display: flex;
      justify-content: center;
      align-items: center;
      -webkit-user-select: none;
      user-select: none;
    }
    .drag-handle::after {
      content: '';
      width: 60px;
      height: 4px;
      background: rgba(120,120,120,0.4);
      border-radius: 2px;
      transition: background 0.2s;
    }
    .drag-handle:hover::after {
      background: rgba(160,160,160,0.6);
    }
    /* Remove margin-left/margin-right for large screens */
    @media (min-width: 1200px) {
      .container {
        margin-left: 0 !important;
        margin-right: 0 !important;
      }
    }
    h1, h2 {
      color: #e3e3e3;
      text-shadow: 0 2px 12px #2224;
    }
    h1 { margin-bottom: 12px; font-size: 1.8em; }
    h2 { font-size: 1.19em; margin-top: 30px; margin-bottom: 14px; display: inline-block; }
    .section-header-row { display: flex; align-items: center; gap: 8px; margin-top: 30px; margin-bottom: 14px; }
    .section-openall-btn {
      background: #232323;
      color: #e3e3e3;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: bold;
      padding: 7px 18px 8px 18px;
      cursor: pointer;
      letter-spacing: .01em;
      box-shadow: 0 2px 8px #2224;
      transition: background .18s, box-shadow .18s, transform .13s;
      margin-left: 0;
      margin-bottom: 2px;
      backdrop-filter: blur(2px);
      opacity: 0.93;
    }
    .section-openall-btn:hover {
      background: #444;
      color: #fff;
      box-shadow: 0 4px 16px #2226;
      transform: translateY(-2px) scale(1.04);
    }
    .tip { font-size: 14px; color: #b0b0b0; margin-bottom: 20px; }
    .market-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 18px; }
    input[type="text"] {
      font-size: 18px;
      padding: 12px 14px;
      border-radius: 7px;
      border: 1.5px solid #2a2d2f;
      outline: none;
      background: rgba(30,32,34,0.93);
      color: #e3e3e3;
      transition: border .2s, background .18s;
      flex: 1 1 250px;
      min-width: 180px;
      box-shadow: 0 1.5px 8px #0002;
      backdrop-filter: blur(1.5px);
    }
    input[type="text"]:focus { border: 1.5px solid #888; background: rgba(40,42,44,0.98);}
    #clear-search:hover { color: #fff; }
    .markets { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 12px; 
      justify-content: flex-start;
      padding-right: 5px;
    }
    .markets::-webkit-scrollbar {
      width: 6px;
    }
    .markets::-webkit-scrollbar-track {
      background: rgba(30,32,34,0.5);
    }
    .markets::-webkit-scrollbar-thumb {
      background: rgba(120,120,120,0.5);
      border-radius: 3px;
    }
    .market-btn {
      background: rgba(25,25,25,0.98);
      color: #e0e0e0;
      border: none;
      border-radius: 7px;
      padding: 10px 18px 10px 38px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      min-width: 125px;
      margin-bottom: 2px;
      margin-top: 2px;
      transition: all .18s;
      position: relative;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      backdrop-filter: blur(2px);
      opacity: 0.93;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .market-btn.disabled {
      opacity: 0.5;
      filter: grayscale(0.8);
    }
    .market-toggle {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: var(--theme-accent);
    }
    .market-btn:hover, #open-all-btn:hover {
      background: rgba(60,60,60,0.95);
      color: #fff;
      box-shadow: 
        0 6px 20px rgba(0,0,0,0.4),
        0 0 0 1px rgba(255,255,255,0.1);
      transform: translateY(-3px) scale(1.05);
      opacity: 1;
      transition: all 0.2s cubic-bezier(0.22, 1, 0.36, 1);
    }
    .market-remove-btn {
      position: absolute;
      right: 6px;
      top: 6px;
      background: rgba(30,32,34,0.7);
      border: none;
      color: #ff3b5c; /* keep trashcan accent */
      font-size: 1.1em;
      cursor: pointer;
      padding: 0 2px;
      border-radius: 3px;
      transition: color .17s, background .14s;
      z-index: 2;
      box-shadow: 0 1px 4px #0002;
    }
    .market-remove-btn:hover { color: #fff; background: #444; }
    .special-group {
      margin-top: 30px;
      margin-bottom: 18px;
      padding: 16px 12px 12px 12px;
      border: 1.5px solid #232323;
      border-radius: 12px;
      background: rgba(32,34,36,0.72);
      box-shadow: 0 2px 12px #0003;
      backdrop-filter: blur(4px);
    }
    .special-group-label {
      font-weight: bold;
      color: #e3e3e3;
      font-size: 1.11em;
      margin-bottom: 10px;
      display: block;
      letter-spacing: 0.01em;
      text-shadow: 0 1px 8px #2224;
    }
    #open-all-btn {
      background: #232323;
      color: #e3e3e3;
      border: none;
      border-radius: 10px;
      font-size: 17px;
      font-weight: bold;
      padding: 13px 28px;
      margin: 0 0 25px 0;
      cursor: pointer;
      letter-spacing: .02em;
      box-shadow: 0 4px 20px #2226;
      transition: background .18s, box-shadow .18s, transform .13s;
      display: block;
      width: 100%;
      max-width: 270px;
      opacity: 0.97;
      backdrop-filter: blur(2px);
    }
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 250px;
      min-width: 200px;
      max-width: 600px;
      height: 100vh;
      min-height: 400px;
      max-height: 100vh;
      background: rgba(15,15,15,0.98);
      border-right: 1px solid rgba(255,255,255,0.1);
      box-shadow: 2px 0 16px rgba(0,0,0,0.3);
      z-index: 100;
      padding: 22px 12px 18px 18px;
      display: flex;
      flex-direction: column;
      gap: 13px;
      backdrop-filter: blur(7px);
      overflow-y: auto;
      transition: transform 0.3s ease, left 0.3s ease, top 0.3s ease;
    }

    .sidebar.detached {
      position: absolute;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.1);
      transform: none !important;
      cursor: move;
      height: auto;
      min-height: 300px;
      max-height: 90vh;
      resize: both;
      overflow: auto;
    }

    .sidebar.detached .resize-handle {
      display: none;
    }

    .sidebar.detached .drag-handle::after {
      background: var(--theme-highlight);
    }

    .sidebar.reattach-preview {
      box-shadow: 0 0 0 3px var(--theme-highlight);
      transition: box-shadow 0.2s ease;
    }

    .sidebar.minimized {
      overflow-y: hidden;
    }

    .sidebar::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar::-webkit-scrollbar-track {
      background: rgba(30,32,34,0.5);
    }

    .sidebar::-webkit-scrollbar-thumb {
      background: rgba(120,120,120,0.5);
      border-radius: 3px;
    }
    .resize-handle {
      position: absolute;
      z-index: 9999;
      background: transparent;
      transition: background 0.2s;
    }
    .resize-handle:hover {
      background: rgba(120, 120, 120, 0.2);
    }
    .resize-handle-right {
      top: 0;
      right: 0;
      width: 8px;
      height: 100%;
      cursor: ew-resize;
    }
    .resize-handle-left {
      top: 0;
      left: 0;
      width: 8px;
      height: 100%;
      cursor: ew-resize;
    }
    .resize-handle-bottom {
      left: 0;
      bottom: 0;
      width: 100%;
      height: 8px;
      cursor: ns-resize;
    }
    .resize-handle-bottom-right,
    .resize-handle-bottom-left,
    .resize-handle-top-right,
    .resize-handle-top-left {
      width: 16px;
      height: 16px;
    }
    .resize-handle-bottom-right {
      right: 0;
      bottom: 0;
      cursor: nwse-resize;
    }
    .resize-handle-bottom-left {
      left: 0;
      bottom: 0;
      cursor: nesw-resize;
    }
    .resize-handle-top-right {
      right: 0;
      top: 0;
      cursor: nesw-resize;
    }
    .resize-handle-top-left {
      left: 0;
      top: 0;
      cursor: nwse-resize;
    }
    .resize-handle-horizontal {
      width: calc(100% - 20px);
      height: 8px;
      cursor: ns-resize;
      background: rgba(120, 120, 120, 0.1);
      border-radius: 4px;
      margin-left: 10px;
      transition: background 0.2s;
    }
    .resize-handle-horizontal:hover {
      background: rgba(120, 120, 120, 0.3);
    }
    .sidebar-title {
      font-size: 1.07em;
      color: #e3e3e3;
      font-weight: bold;
      margin-bottom: 7px;
      letter-spacing: 0.015em;
      text-shadow: 0 1px 8px #2224;
    }
    .sidebar-folder-row {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-bottom: 8px;
    }
    .sidebar-folder-input {
      flex: 1 1 auto;
      font-size: 1em;
      border: 1.5px solid #232323;
      border-radius: 5px;
      padding: 4.5px 9px;
      outline: none;
      transition: border .15s, background .14s;
      background: rgba(30,32,34,0.93);
      color: #e3e3e3;
    }
    .sidebar-folder-input:focus { border: 1.5px solid #888; background: rgba(40,42,44,0.98);}
    .sidebar-folder-btn {
      background: #232323;
      color: #e3e3e3;
      border: none;
      border-radius: 5px;
      font-size: 1.08em;
      font-weight: bold;
      cursor: pointer;
      padding: 4.5px 13px;
      transition: background .15s, box-shadow .15s, transform .13s;
      margin-bottom: 2px;
      box-shadow: 0 2px 8px #2224;
      opacity: 0.93;
      backdrop-filter: blur(1.5px);
    }
    .sidebar-folder-btn:hover { background: #444; box-shadow: 0 4px 16px #2226; transform: translateY(-1px) scale(1.04);}
    .saved-folder-list {
      list-style: none;
      padding: 0;
      margin: 0 0 12px 0;
      flex: 1 1 auto;
      min-height: 0;
      max-height: none;
      overflow-y: visible;
    }
    .saved-folder-item {
      margin-bottom: 4px;
      font-weight: bold;
      color: #e3e3e3;
      font-size: 1.03em;
      display: flex;
      align-items: center;
      gap: 4px;
      background:none;
      cursor: grab;
      user-select: none;
      border-radius: 4px;
      transition: background .13s;
    }
    .sidebar-folder-edit-btn, .sidebar-folder-remove-btn {
      border: none;
      background: none;
      color: #b0b0b0;
      font-size: 1em;
      cursor: pointer;
      padding: 0 2px;
      border-radius: 2px;
      transition: color .17s, background .14s;
    }
    .sidebar-folder-remove-btn { color: #ff3b5c; } /* keep trashcan accent */
    .sidebar-folder-edit-btn:hover, .sidebar-folder-remove-btn:hover { color: #ff3b5c; background: #2224; }
    .saved-searches-list {
      margin-left: 10px;
      min-height: 100px;
      max-height: none;
      overflow-y: visible;
      resize: none;
      scrollbar-width: thin;
      scrollbar-color: #888 #232323;
      background: rgba(44,46,48,0.15);
      border-radius: 6px;
      padding: 4px;
    }
    .sidebar-folder-active {
      background: #2224;
      border-radius: 4px;
      color: #fff;
    }
    .sidebar-folder-dragover {
      background: #444 !important;
      border-radius: 6px;
      color: #fff;
    }
    .sidebar-exp-btn, .sidebar-imp-btn {
      background: #232323;
      color: #e3e3e3;
      border: none;
      border-radius: 5px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      padding: 7px 13px;
      margin-right: 7px;
      transition: background .18s, box-shadow .18s, transform .13s;
      box-shadow: 0 1px 4px #2224;
      opacity: 0.93;
      backdrop-filter: blur(2px);
    }
    .randomize-section {
      margin-bottom: 15px;
    }
    .randomize-select {
      width: 100%;
      font-size: 1em;
      border: 1.5px solid #232323;
      border-radius: 5px;
      padding: 4.5px 9px 4.5px 28px;
      outline: none;
      transition: border .15s, background .14s;
      background: rgba(30,32,34,0.93);
      color: #e3e3e3;
      margin-bottom: 8px;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12' fill='none'%3E%3Cpath d='M3 4.5L6 7.5L9 4.5' stroke='%23e3e3e3' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
    }
    .randomize-select:focus { 
      border: 1.5px solid #888; 
      background: rgba(40,42,44,0.98);
    }
    /* Style options with colors */
    .randomize-select option[value="all"] {
      background-color: #6a0572;
      color: #ffffff;
    }
    .randomize-select option[value="asia"] {
      background-color: #ff6b6b;
      color: #121212;
    }
    .randomize-select option[value="international"] {
      background-color: #4ecdc4;
      color: #121212;
    }
    .randomize-select option[value="special"] {
      background-color: #ffe66d;
      color: #121212;
    }
    .sidebar-randomize-btn {
      background: #232323;
      color: #e3e3e3;
      border: none;
      border-radius: 5px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      padding: 7px 13px;
      width: 100%;
      transition: background .18s, box-shadow .18s, transform .13s;
      box-shadow: 0 1px 4px #2224;
      opacity: 0.93;
      backdrop-filter: blur(2px);
    }
    .sidebar-randomize-btn:hover,
    .sidebar-multi-search-btn:hover,
    .sidebar-multi-clear-btn:hover { 
      background: #444; 
      color: #fff; 
    }
    .sidebar-multi-search-btn,
    .sidebar-multi-clear-btn {
      background: #232323;
      color: #e3e3e3;
      border: none;
      border-radius: 5px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      padding: 7px 13px;
      transition: background .18s, box-shadow .18s, transform .13s;
      box-shadow: 0 1px 4px #2224;
      opacity: 0.93;
      backdrop-filter: blur(2px);
    }
    .randomize-select:focus { 
      border: 1.5px solid #888; 
      background: rgba(40,42,44,0.98);
    }
    .sidebar-exp-btn:hover, 
    .sidebar-imp-btn:hover,
    .sidebar-reset-btn:hover { 
      background: #444; 
      color: #fff; 
    }
    .sidebar-reset-btn {
      background: #232323;
      color: #e3e3e3;
      border: none;
      border-radius: 5px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      padding: 7px 13px;
      margin-right: 7px;
      transition: background .18s, box-shadow .18s, transform .13s;
      box-shadow: 0 1px 4px #2224;
      opacity: 0.93;
      backdrop-filter: blur(2px);
    }
    .sidebar-imp-btn input[type="file"] { display: none; }
    .sidebar-divider {
      border: none;
      border-top: 1.5px solid #232323;
      margin: 12px 0;
    }
    /* Saved search items */
    .saved-search-item {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 4px;
      background: rgba(44,46,48,0.55);
      border-radius: 5px;
      padding: 3px 7px;
      transition: background .13s;
    }
    .saved-search-term {
      background: none;
      border: none;
      color: #e3e3e3;
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      padding: 6px 8px;
      border-radius: 3px;
      transition: background .13s, color .13s;
      flex: 1;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .search-term-checkbox {
      width: 16px;
      height: 16px;
      accent-color: var(--theme-highlight);
      cursor: pointer;
      flex-shrink: 0;
      margin: 0;
      padding: 0;
      display: block;
      opacity: 1;
      visibility: visible;
    }
    .search-term-text {
      flex: 1;
      text-align: left;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .saved-search-term:hover { background: #2224; color: #fff; }
    .saved-search-term.active {
      font-weight: bold;
    }
    .saved-search-term.active[data-category="asia"] {
      background: #ff6b6b;
      color: #121212;
      box-shadow: 0 0 10px rgba(255,107,107,0.5);
    }
    .saved-search-term.active[data-category="international"] {
      background: #4ecdc4;
      color: #121212;
      box-shadow: 0 0 10px rgba(78,205,196,0.5);
    }
    .saved-search-term.active[data-category="special"] {
      background: #ffe66d;
      color: #121212;
      box-shadow: 0 0 10px rgba(255,230,109,0.5);
    }
    .saved-search-term.active[data-category="all"] {
      background: #6a0572;
      color: #ffffff;
      box-shadow: 0 0 10px rgba(106,5,114,0.5);
    }
    .edit-btn, .remove-btn, .save-edit-btn, .cancel-edit-btn {
      background: none;
      border: none;
      color: #b0b0b0;
      font-size: 1em;
      cursor: pointer;
      padding: 0 2px;
      border-radius: 2px;
      transition: color .17s, background .14s;
    }
    .remove-btn { color: #ff3b5c; } /* keep trashcan accent */
    .edit-btn:hover, .remove-btn:hover, .save-edit-btn:hover, .cancel-edit-btn:hover { color: #ff3b5c; background: #2224; }
    /* Modal styling: always centered and above everything */
    .custom-market-modal-bg {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(10,10,10,0.65);
      z-index: 3000;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(2.5px);
    }
    .custom-market-modal {
      background: rgba(32,34,36, 0.98);
      border-radius: 18px;
      box-shadow: 0 8px 32px #000a, 0 1.5px 0 #232323;
      padding: 28px 22px 18px 22px;
      max-width: 350px;
      width: 96vw;
      position: absolute;
      border: 1.5px solid #232323;
      backdrop-filter: blur(7px) saturate(1.2);
      cursor: default;
    }
    .custom-market-modal .drag-handle {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      cursor: move;
    }
    .custom-market-modal h3 {
      margin-top: 0;
      font-size: 1.17em;
      color: #e3e3e3;
      margin-bottom: 10px;
      font-weight: bold;
      letter-spacing: 0.01em;
      text-shadow: 0 1px 8px #2224;
    }
    .custom-market-modal label {
      display: block;
      margin-top: 12px;
      margin-bottom: 2px;
      color: #e3e3e3;
      font-weight: bold;
      font-size: 1em;
    }
    .custom-market-modal input[type="text"] {
      width: 100%;
      font-size: 1.07em;
      margin-bottom: 9px;
      padding: 7px 9px;
      border-radius: 5px;
      border: 1.5px solid #232323;
      outline: none;
      transition: border .16s, background .14s;
      background: rgba(30,32,34,0.93);
      color: #e3e3e3;
    }
    .custom-market-modal input[type="text"]:focus { border: 1.5px solid #888; background: rgba(40,42,44,0.98);}
    .custom-market-modal .modal-btn-row {
      display: flex;
      gap: 11px;
      margin-top: 18px;
      justify-content: flex-end;
    }
    .custom-market-modal .modal-btn {
      background: #232323;
      color: #e3e3e3;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      padding: 8px 22px;
      transition: background .18s, box-shadow .18s, transform .13s;
      box-shadow: 0 2px 8px #2224;
      opacity: 0.93;
      backdrop-filter: blur(1.5px);
    }
    .custom-market-modal .modal-btn:hover { background: #444; box-shadow: 0 4px 16px #2226; transform: translateY(-1px) scale(1.04);}
    .custom-market-modal .modal-cancel-btn {
      background: #232323;
      color: #e3e3e3;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      padding: 8px 22px;
      transition: background .14s, color .14s;
      opacity: 0.93;
      backdrop-filter: blur(1.5px);
    }
    .custom-market-modal .modal-cancel-btn:hover { background: #2224; color: #fff; }
    .custom-market-modal .modal-tip {
      color: #b0b0b0;
      font-size: 13px;
      margin-top: 2px;
      margin-bottom: 7px;
    }
    .custom-market-modal .modal-section-label {
      font-size: 1.01em;
      color: #e3e3e3;
      margin-bottom: 8px;
      margin-top: 2px;
      font-weight: bold;
    }
    /* Add website buttons */
    .add-market-row {
      display: flex;
      gap: 12px;
      margin-bottom: 2px;
      align-items: center;
      margin-top: 4px;
      margin-left: 1px;
      margin-right: 1px;
    }
    .add-market-btn {
      background: #232323;
      color: #e3e3e3;
      border: none;
      border-radius: 7px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      padding: 9px 16px;
      min-width: 125px;
      margin-bottom: 2px;
      margin-top: 2px;
      transition: background .18s, box-shadow .18s, transform .13s;
      box-shadow: 0 1px 4px #2224;
      opacity: 0.93;
      backdrop-filter: blur(2px);
    }
    .add-market-btn:hover { background: #444; color: #fff; box-shadow: 0 4px 16px #2226; transform: translateY(-1px) scale(1.04);}
    /* Wishlist styles (dark mode) */
    .wishlist-section {
      position: fixed;
      right: 0;
      top: 0;
      width: 370px;
      min-width: 200px;
      max-width: 600px;
      height: 100vh;
      min-height: 400px;
      max-height: 100vh;
      background: rgba(15,15,15,0.98);
      border-left: 1px solid rgba(255,255,255,0.1);
      box-shadow: -2px 0 16px rgba(0,0,0,0.3);
      z-index: 101;
      padding: 24px 15px 18px 18px;
      display: flex;
      flex-direction: column;
      gap: 13px;
      backdrop-filter: blur(7px);
    }
    .resize-handle {
      position: absolute;
      z-index: 9999;
      background: transparent;
    }
    .resize-handle-right {
      top: 0; right: 0; width: 8px; height: 100%;
      cursor: ew-resize;
    }
    .resize-handle-left {
      top: 0; left: 0; width: 8px; height: 100%;
      cursor: ew-resize;
    }
    .resize-handle-bottom-right {
      right: 0; bottom: 0; width: 16px; height: 16px;
      cursor: nwse-resize;
    }
    .wishlist-title {
      font-size: 1.10em;
      color: #e3e3e3;
      font-weight: bold;
      margin-bottom: 8px;
      letter-spacing: 0.015em;
      text-shadow: 0 1px 8px #2224;
    }
    .wishlist-add-row {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-bottom: 8px;
    }
    .wishlist-add-input {
      flex: 1 1 auto;
      font-size: 1em;
      border: 1.5px solid #232323;
      border-radius: 5px;
      padding: 4.5px 9px;
      outline: none;
      transition: border .15s, background .14s;
      background: rgba(30,32,34,0.93);
      color: #e3e3e3;
    }
    .wishlist-add-input:focus { border: 1.5px solid #888; background: rgba(40,42,44,0.98);}
    .wishlist-add-btn {
      background: #232323;
      color: #e3e3e3;
      border: none;
      border-radius: 5px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      padding: 4.5px 14px;
      transition: background .15s, box-shadow .15s, transform .13s;
      box-shadow: 0 2px 8px #2224;
      opacity: 0.93;
      backdrop-filter: blur(1.5px);
    }
    .wishlist-add-btn:hover { background: #444; box-shadow: 0 4px 16px #2226; transform: translateY(-1px) scale(1.04);}
    .wishlist-list {
      list-style: none;
      padding: 0;
      margin: 0 0 12px 0;
      max-height: 74vh;
      overflow-y: auto;
    }
    .wishlist-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 9px;
      background: rgba(44,46,48,0.55);
      border-radius: 8px;
      padding: 7px 9px 7px 9px;
      border-left: 4px solid #888;
      box-shadow: 0 1px 5px #2224;
      word-break: break-all;
      font-size: 0.97em;
      position: relative;
      transition: background .13s;
    }
    .wishlist-link {
      color: #e3e3e3;
      text-decoration: underline;
      font-weight: bold;
      margin-right: 5px;
      word-break: break-all;
      max-width: 170px;
      display: inline-block;
      vertical-align: middle;
    }
    .wishlist-title-text {
      color: #e3e3e3;
      font-size: 1em;
      font-weight: 500;
      margin-right: 6px;
      max-width: 170px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: inline-block;
      vertical-align: middle;
      cursor: pointer;
      border: none;
      background: transparent;
      outline: none;
      transition: color .13s;
    }
    .wishlist-title-text:hover { color: #fff; }
    .wishlist-title-input {
      color: #e3e3e3;
      font-size: 1em;
      font-weight: 500;
      margin-right: 6px;
      max-width: 170px;
      min-width: 20px;
      border: 1.5px solid #888;
      border-radius: 4px;
      padding: 1px 5px;
      vertical-align: middle;
      outline: none;
      background: #232323;
    }
    .wishlist-remove-btn {
      background: none;
      border: none;
      color: #ff3b5c; /* keep trashcan accent */
      font-size: 1.18em;
      cursor: pointer;
      padding: 0 3px;
      border-radius: 2px;
      transition: color .17s, background .14s;
      align-self: flex-start;
      margin-left: 5px;
    }
    .wishlist-remove-btn:hover { color: #fff; background: #2224; }
    .wishlist-tip {
      color: #888;
      font-size: 12px;
      padding-left: 2px;
      margin-bottom: 0;
      margin-top: 8px;
      opacity: 0.8;
    }
    
    .wishlist-mascot {
      position: absolute;
      right: 0;
      bottom: 0;
      width: 180px;
      height: 180px;
      pointer-events: none;
      z-index: 1;
      transform-origin: bottom right;
      transition: transform 0.3s ease;
    }
    .wishlist-mascot:hover,
    .wishlist-section:hover .wishlist-mascot {
      transform: translateY(-5px);
      filter: brightness(1.1);
    }
    @keyframes float {
      0%, 100% { transform: translateY(-8px) scale(1.05); }
      50% { transform: translateY(-12px) scale(1.06); }
    }
    .panel-controls {
      position: absolute;
      top: 5px;
      right: 5px;
      z-index: 1000;
    }
    .panel-close {
      background: rgba(32,34,36,0.8);
      border: 1px solid rgba(255,255,255,0.1);
      color: #e3e3e3;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .panel-close:hover {
      background: rgba(255,60,60,0.3);
      transform: scale(1.1);
    }

    /* Minimized Panel Buttons */
    .minimized-panels {
      position: fixed;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      z-index: 999;
    }
    .minimized-panel-btn {
      background: rgba(32,34,36,0.8);
      border: 1px solid rgba(255,255,255,0.1);
      color: #e3e3e3;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      font-size: 12px;
    }
    .minimized-panel-btn:hover {
      background: rgba(100,220,255,0.3);
      transform: scale(1.1);
    }
    /* Resizing visual feedback */
    .resizing {
      box-shadow: 0 0 0 2px rgba(120,120,120,0.3);
      transition: none;
    }
    @media (max-width: 1200px) {
      .wishlist-section { display: none; }
      .container { margin-right: 0; }
      .custom-market-modal-bg { justify-content: center; align-items: center; }
      .custom-market-modal { margin: auto; }
    }
    @media (max-width: 1000px) {
      .sidebar {
        position: static;
        width: 100%;
        height: auto;
        box-shadow: none;
        border-right: none;
        border-bottom: 1.5px solid #232323;
        padding: 13px 8px 7px 8px;
        margin-bottom: 18px;
        max-width: 100vw;
      }
      .container { max-width: 98vw; margin: 0.5em; }
      .custom-market-modal-bg { justify-content: center !important; align-items: center !important; }
      .custom-market-modal { margin: auto !important; }
    }
    @media (max-width: 700px) {
      .market-row, .markets { flex-direction: column; gap: 8px; }
      .market-btn { min-width: 0; width: 100%; }
      .add-market-btn { min-width: 0; width: 100%; }
      input[type="text"] { min-width: 0; }
      .special-group { padding: 10px 4px 6px 4px; }
      #open-all-btn { max-width: 100%; }
      .sidebar { padding: 9px 3px 7px 6px; font-size: 0.97em; }
      .custom-market-modal-bg { justify-content: center !important; align-items: center !important; }
      .custom-market-modal { margin: auto !important; }
    }
    @media (min-width: 1200px) {
  .container {
    margin-left: 320px;  /* Increased from 255px for more space from sidebar */
    margin-right: 405px; /* Keeps it visually centered */
  }
}
  </style>
</head>
<body>
  <div class="minimized-panels" id="minimized-panels"></div>
  <div class="sidebar" id="sidebar">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
      <span class="sidebar-title">Saved Searches</span>
      <span id="unhighlighted-count" style="font-size: 12px; color: #b0b0b0; background: rgba(44,46,48,0.7); padding: 2px 6px; border-radius: 8px;">
        0 unhighlighted
      </span>
    </div>
    <!-- Folders UI -->
    <div class="sidebar-folder-row">
      <input type="text" placeholder="Add folder..." id="sidebar-folder-input" class="sidebar-folder-input" maxlength="44" />
      <button class="sidebar-folder-btn" id="sidebar-folder-btn" title="Add Folder">+</button>
    </div>
    <ul class="saved-folder-list" id="saved-folder-list"></ul>
    <!-- Saved Searches UI (will be folder-specific) -->
    <div class="resize-handle resize-handle-horizontal" id="sidebar-folder-search-resize" style="position: relative; bottom: 0; margin-top: 8px;"></div>
    <div class="sidebar-add-row">
      <input type="text" placeholder="Save a search term..." id="sidebar-add-input" class="sidebar-add-input" maxlength="70" />
      <button class="sidebar-add-btn" id="sidebar-add-btn" title="Save Search">+</button>
    </div>
    <div class="sidebar-multi-search-row" style="margin-bottom: 8px;">
      <button class="sidebar-multi-clear-btn" id="sidebar-multi-clear-btn" type="button" title="Clear Selection">Clear Selection</button>
    </div>
    <div class="sidebar-import-export-row">
      <button class="sidebar-exp-btn" id="sidebar-export-btn" type="button">Export</button>
      <label class="sidebar-imp-btn" title="Import">
        Import
        <input type="file" id="sidebar-import-input" accept=".json">
      </label>
      <button class="sidebar-reset-btn" id="sidebar-reset-highlights-btn" type="button" title="Reset Highlights" style="color: var(--theme-highlight);">Reset Highlights</button>
    </div>
    <hr class="sidebar-divider" />
    <ul class="saved-searches-list" id="saved-searches-list"></ul>
    <hr class="sidebar-divider" />
    <div style="color:#888; font-size:13px; padding-left:1px;">
      Click a saved search to load it.<br>
      Use <b>âœŽ</b> to edit or <b>ðŸ—‘</b> to remove.<br>
      Export or Import your list for backup or transfer.<br>
      <b>Folders</b> let you organize searches. Drag to rearrange.<br>
      Saved searches are always sorted A-Z.<br>
      <b>Randomize</b> picks an unhighlighted term and opens the selected category.
    </div>
    <div class="drag-handle"></div>
    <div class="resize-handle resize-handle-right" data-resize="sidebar"></div>
    <div class="resize-handle resize-handle-left" data-resize="sidebar"></div>
    <div class="resize-handle resize-handle-bottom" data-resize="sidebar"></div>
  </div>
  <div class="wishlist-section" id="wishlist-section">
    <img src="mmcs.svg" class="wishlist-mascot" alt="MMCS Logo" loading="lazy" onload="this.classList.add('loaded')">
    <div class="wishlist-title">Wishlist / Considering</div>
    <form class="wishlist-add-row" id="wishlist-add-form" autocomplete="off">
      <input type="text" class="wishlist-add-input" id="wishlist-link-input" placeholder="Paste item link here..." maxlength="700" required />
      <button class="wishlist-add-btn" type="submit" title="Add Link">+</button>
    </form>
    <ul class="wishlist-list" id="wishlist-list"></ul>
    <div class="wishlist-tip">
      Add links to items you're considering buying.<br>
      Titles are fetched automatically, and you can click to edit.
    </div>
    <div class="panel-controls">
      <button class="panel-close" data-panel="wishlist" title="Close Panel">Ã—</button>
    </div>
    <div class="resize-handle resize-handle-left" data-resize="wishlist"></div>
    <div class="resize-handle resize-handle-bottom" data-resize="wishlist"></div>
    <div class="resize-handle resize-handle-bottom-left" data-resize="wishlist"></div>
  </div>
  <div class="container">
    <div class="drag-handle" id="container-handle"></div>
    <h1>Multi-Market Clothing Search</h1>
    <div class="tip">Enter your search and click any button to open the most recent results on that secondhand fashion site.<br>
      Example: <span style="color:#e60021;font-weight:bold;">rick owens</span>
    </div>
    <form id="searchForm" autocomplete="off">
      <div class="market-row" style="position:relative;">
        <input type="text" id="query" placeholder="Search for clothing, brands, etc." required />
        <button id="clear-search" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:#888;cursor:pointer;display:none;">âœ•</button>
      </div>
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 25px;">
        <button type="button" id="open-all-btn">Open All</button>
        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
          <input type="checkbox" id="toggle-all-checkbox" checked style="width: 16px; height: 16px; accent-color: #666;">
          <span style="font-size: 14px; color: #e3e3e3;">Toggle All</span>
        </label>
        <div class="randomize-section" style="display: flex; align-items: center; gap: 8px;">
          <div style="position: relative; flex: 1;">
            <select id="randomize-category-select" class="randomize-select">
              <option value="all">All Categories</option>
              <option value="asia">Asia</option>
              <option value="international">International</option>
              <option value="special">Designer</option>
            </select>
            <div id="randomize-color-indicator" style="position: absolute; left: 8px; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; border-radius: 50%;"></div>
          </div>
          <button class="sidebar-randomize-btn" id="sidebar-randomize-btn" type="button" style="background: #232323; color: #e3e3e3; border: none; border-radius: 5px; font-size: 13px; font-weight: bold; padding: 7px 13px; cursor: pointer; box-shadow: 0 1px 4px #2224; opacity: 0.93; backdrop-filter: blur(2px);">Randomize</button>
        </div>
        <button type="button" id="theme-editor-btn" style="background: #232323; color: #e3e3e3; border: none; border-radius: 8px; font-size: 13px; font-weight: bold; padding: 7px 18px 8px 18px; cursor: pointer; letter-spacing: .01em; box-shadow: 0 2px 8px #2224; transition: background .18s, box-shadow .18s, transform .13s; margin-left: 0; margin-bottom: 2px; backdrop-filter: blur(2px); opacity: 0.93;">Theme Editor</button>
      </div>
      <div class="add-market-row">
        <button type="button" class="add-market-btn" data-section="asia">+ Add Website to Asia</button>
        <button type="button" class="add-market-btn" data-section="international">+ Add Website to International</button>
        <button type="button" class="add-market-btn" data-section="special">+ Add Website to Designer</button>
      </div>
      <div class="section-header-row">
        <h2>Asia</h2>
        <button type="button" class="section-openall-btn" data-section="asia">Open All Asia</button>
      </div>
      <div class="markets" id="asia-markets"></div>
      <div class="section-header-row">
        <h2>International &amp; Other Markets</h2>
        <button type="button" class="section-openall-btn" data-section="international">Open All International</button>
      </div>
      <div class="markets" id="international-markets"></div>
      <div class="special-group">
        <div class="section-header-row" style="margin-top:0;margin-bottom:8px;">
          <span class="special-group-label">Designer &amp; Global Select</span>
          <button type="button" class="section-openall-btn" data-section="special">Open All Designer</button>
        </div>
        <div class="markets" id="special-markets"></div>
      </div>
    </form>
    <div class="resize-handle resize-handle-right" data-resize="container"></div>
    <div class="resize-handle resize-handle-left" data-resize="container"></div>
    <div class="resize-handle resize-handle-bottom" data-resize="container"></div>
    <div class="resize-handle resize-handle-top" data-resize="container"></div>
    <div class="resize-handle resize-handle-bottom-right" data-resize="container"></div>
    <div class="resize-handle resize-handle-bottom-left" data-resize="container"></div>
    <div class="resize-handle resize-handle-top-right" data-resize="container"></div>
    <div class="resize-handle resize-handle-top-left" data-resize="container"></div>
  </div>
  <!-- Custom Market Modal -->
  <div id="custom-market-modal-bg" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:3000;">
    <div class="custom-market-modal">
      <div class="drag-handle"></div>
      <h3>Add Custom Website</h3>
      <div class="modal-section-label" id="custom-market-modal-section"></div>
      <label for="custom-market-title-input">Website Title</label>
      <input type="text" id="custom-market-title-input" maxlength="44" placeholder="e.g. Grailed" required />
      <label for="custom-market-url-input">Search Layout URL</label>
      <input type="text" id="custom-market-url-input" maxlength="250" placeholder="e.g. https://www.grailed.com/shop?query=example" required />
      <div class="modal-tip">
        Use <b>example</b> where the search term should appear.<br>
        For instance: <code>https://www.grailed.com/shop?query=example</code><br>
        When searching, <b>example</b> will be replaced with your search.
      </div>
      <div class="modal-btn-row">
        <button class="modal-btn" id="custom-market-modal-save-btn">Save</button>
        <button class="modal-cancel-btn" id="custom-market-modal-cancel-btn">Cancel</button>
      </div>
    </div>
  </div>
  <script>
    // Custom Market Storage
    const CUSTOM_MARKETS_KEY = 'customMarkets_v1';
    function loadCustomMarketsFromFolders(foldersObj) {
      return (foldersObj?.customMarkets && typeof foldersObj.customMarkets === 'object') 
        ? foldersObj.customMarkets
        : JSON.parse(localStorage.getItem(CUSTOM_MARKETS_KEY)) || { asia: [], international: [], special: [] };
    }
    const saveCustomMarkets = data => localStorage.setItem(CUSTOM_MARKETS_KEY, JSON.stringify(data));
    // Folder Storage
    const FOLDER_KEY = 'savedFolders_v2';
    function loadFoldersObj() {
      const raw = localStorage.getItem(FOLDER_KEY);
      if (raw) {
        try {
          const data = JSON.parse(raw);
          if (Array.isArray(data)) {
            // legacy format, convert
            return { folders: data, customMarkets: loadCustomMarketsFromFolders() };
          }
          return data;
        } catch {}
      }
      // Legacy fallback
      return { folders: [{ name: 'Default', searches: [] }], customMarkets: { asia: [], international: [], special: [] } };
    }
    function saveFoldersObj(obj) {
      localStorage.setItem(FOLDER_KEY, JSON.stringify(obj));
      saveCustomMarkets(obj.customMarkets);
    }
    let foldersObj = loadFoldersObj();
    let savedFolders = foldersObj.folders;
    let customMarkets = foldersObj.customMarkets || { asia: [], international: [], special: [] };
    let currentFolderIdx = 0; // Default folder on start
    // Market Data
    const marketDataInitial = {
      asia: [
        { key: "mercari-jp", label: "Mercari Japan" },
        { key: "paypay-fleamarket", label: "Yahoo PayPay Flea" },
        { key: "rakuma", label: "Rakuten Rakuma" },
        { key: "rakuten-jp", label: "Rakuten Japan" },
        { key: "xianyu", label: "Xianyu (é—²é±¼)" },
        { key: "yahoo-auctions", label: "Yahoo Japan Auctions" }
      ],
      international: [
        { key: "depop", label: "Depop" },
        { key: "ebay", label: "eBay Global" },
        { key: "facebook", label: "Facebook Marketplace" },
        { key: "gem", label: "Gem" },
        { key: "grailed", label: "Grailed" },
        { key: "mercari-us", label: "Mercari US" },
        { key: "poshmark", label: "Poshmark" },
        { key: "shopgoodwill", label: "ShopGoodwill" },
        { key: "vinted", label: "Vinted" }
      ],
      special: [
        { key: "secondstreet", label: "2nd STREET" },
        { key: "therealreal", label: "The RealReal" },
        { key: "vestiaire", label: "Vestiaire Collective" }
      ]
    };
    // Market toggle state storage
    const MARKET_TOGGLE_KEY = 'marketToggleStates';
    function loadMarketToggleState(marketKey) {
      return toggleStatesCache[marketKey] !== false; // Default to true if not set
    }
    let toggleStatesCache = JSON.parse(localStorage.getItem(MARKET_TOGGLE_KEY)) || {};
    function saveMarketToggleState(marketKey, isEnabled) {
      toggleStatesCache[marketKey] = isEnabled;
      // Debounce the localStorage write with requestAnimationFrame
      cancelAnimationFrame(window.toggleStateSaveRAF);
      window.toggleStateSaveRAF = requestAnimationFrame(() => {
        localStorage.setItem(MARKET_TOGGLE_KEY, JSON.stringify(toggleStatesCache));
      });
    }

    // Combined Market Data + Custom
    function getMarkets(section) {
      const orig = marketDataInitial[section].slice();
      const custom = (customMarkets[section] || []).map(m => ({
        key: "custom-" + section + "-" + m.id,
        label: m.title,
        custom: true,
        urlTemplate: m.url,
        id: m.id
      }));
      return orig.concat(custom);
    }
    function createMarketButtons(markets, sectionId, sectionName) {
      const container = document.getElementById(sectionId);
      container.innerHTML = '';
      markets.slice().sort((a, b) => a.label.localeCompare(b.label)).forEach(market => {
        const btn = document.createElement('button');
        btn.type = "button";
        btn.className = "market-btn";
        btn.setAttribute("data-market", market.key);
        btn.setAttribute("data-section", sectionName);
        
        // Add toggle checkbox
        const toggle = document.createElement('input');
        toggle.type = "checkbox";
        toggle.className = "market-toggle";
        toggle.checked = true;
        toggle.addEventListener('change', function(e) {
          e.stopPropagation();
          const isChecked = toggle.checked;
          btn.classList.toggle('disabled', !isChecked);
          // Save state without blocking UI
          setTimeout(() => saveMarketToggleState(market.key, isChecked), 0);
        }, { passive: true });
        
        // Set initial state
        const isEnabled = loadMarketToggleState(market.key);
        toggle.checked = isEnabled;
        if (!isEnabled) btn.classList.add('disabled');
        
        btn.appendChild(toggle);
        const label = document.createElement('span');
        label.textContent = market.label + (market.custom ? " â˜…" : "");
        btn.appendChild(label);
        container.appendChild(btn);

        // Custom market remove button
        if (market.custom) {
          const removeBtn = document.createElement('button');
          removeBtn.className = 'market-remove-btn';
          removeBtn.title = 'Remove Website';
          removeBtn.innerHTML = 'ðŸ—‘';
          removeBtn.onclick = function(e) {
            e.stopPropagation();
            removeCustomMarket(sectionName, market.id);
          };
          btn.appendChild(removeBtn);
        }
      });
    }
    function refreshAllMarketButtons() {
      createMarketButtons(getMarkets('asia'), "asia-markets", "asia");
      createMarketButtons(getMarkets('international'), "international-markets", "international");
      createMarketButtons(getMarkets('special'), "special-markets", "special");
    }
    refreshAllMarketButtons();

    // Remove custom market
    function removeCustomMarket(section, id) {
      customMarkets[section] = (customMarkets[section] || []).filter(m => m.id !== id);
      foldersObj.customMarkets = customMarkets;
      saveFoldersObj(foldersObj);
      refreshAllMarketButtons();
    }

    // --- Saved Searches Folders UI ---
    const folderListEl = document.getElementById('saved-folder-list');
    const folderInputEl = document.getElementById('sidebar-folder-input');
    const folderAddBtn = document.getElementById('sidebar-folder-btn');

    function renderFolders() {
      folderListEl.innerHTML = '';
      savedFolders.forEach((folder, idx) => {
        const li = document.createElement('li');
        li.className = 'saved-folder-item' + (idx === currentFolderIdx ? ' sidebar-folder-active' : '');
        li.setAttribute('draggable', 'true');
        li.setAttribute('data-index', idx);

        // Drag events
        li.addEventListener('dragstart', function(e){
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', idx);
          setTimeout(() => { li.classList.add('sidebar-folder-dragover'); }, 10);
        });
        li.addEventListener('dragend', function(e){
          li.classList.remove('sidebar-folder-dragover');
        });
        li.addEventListener('dragover', function(e){
          e.preventDefault();
          li.classList.add('sidebar-folder-dragover');
        });
        li.addEventListener('dragleave', function(e){
          li.classList.remove('sidebar-folder-dragover');
        });
        li.addEventListener('drop', function(e){
          e.preventDefault();
          li.classList.remove('sidebar-folder-dragover');
          const fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
          const toIdx = idx;
          if (fromIdx !== toIdx) {
            const moved = savedFolders.splice(fromIdx, 1)[0];
            savedFolders.splice(toIdx, 0, moved);
            if (currentFolderIdx === fromIdx) currentFolderIdx = toIdx;
            else if (fromIdx < currentFolderIdx && toIdx >= currentFolderIdx) currentFolderIdx--;
            else if (fromIdx > currentFolderIdx && toIdx <= currentFolderIdx) currentFolderIdx++;
            foldersObj.folders = savedFolders;
            saveFoldersObj(foldersObj);
            renderFolders();
            renderSavedSearches();
          }
        });

        // Folder name or edit input
        if (folder.editing) {
          const editInput = document.createElement('input');
          editInput.type = 'text';
          editInput.value = folder.name;
          editInput.className = 'sidebar-folder-input';
          editInput.maxLength = 44;
          editInput.autofocus = true;
          editInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') saveFolderEdit(idx, editInput.value.trim());
            if (e.key === 'Escape') cancelFolderEdit(idx);
          });
          li.appendChild(editInput);
          const saveBtn = document.createElement('button');
          saveBtn.type = 'button';
          saveBtn.className = 'sidebar-folder-edit-btn';
          saveBtn.title = 'Save';
          saveBtn.textContent = 'âœ”';
          saveBtn.onclick = () => saveFolderEdit(idx, editInput.value.trim());
          const cancelBtn = document.createElement('button');
          cancelBtn.type = 'button';
          cancelBtn.className = 'sidebar-folder-edit-btn';
          cancelBtn.title = 'Cancel';
          cancelBtn.textContent = 'âœ•';
          cancelBtn.onclick = () => cancelFolderEdit(idx);
          li.appendChild(saveBtn);
          li.appendChild(cancelBtn);
        } else {
          const nameBtn = document.createElement('button');
          nameBtn.type = 'button';
          nameBtn.style = 'background:none;border:none;padding:0;margin:0;color:inherit;font-weight:inherit;cursor:pointer;display:flex;align-items:center;gap:6px;';
          nameBtn.onclick = () => {
            currentFolderIdx = idx;
            renderFolders();
            renderSavedSearches();
          };
          // Add miku.svg as folder icon
          const folderIcon = document.createElement('img');
          folderIcon.src = 'miku.svg';
          folderIcon.alt = 'Folder';
          folderIcon.style.width = '18px';
          folderIcon.style.height = '18px';
          folderIcon.style.marginRight = '4px';
          folderIcon.style.verticalAlign = 'middle';
          nameBtn.appendChild(folderIcon);
          // Folder name text
          const folderText = document.createElement('span');
          folderText.textContent = folder.name;
          nameBtn.appendChild(folderText);
          
          li.appendChild(nameBtn);
          // Edit/remove
          const editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.className = 'sidebar-folder-edit-btn';
          editBtn.title = 'Rename';
          editBtn.textContent = 'âœŽ';
          editBtn.onclick = () => editFolder(idx);
          li.appendChild(editBtn);
          if (savedFolders.length > 1) {
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'sidebar-folder-remove-btn';
            removeBtn.title = 'Remove';
            removeBtn.textContent = 'ðŸ—‘';
            removeBtn.onclick = () => removeFolder(idx);
            li.appendChild(removeBtn);
          }
        }
        folderListEl.appendChild(li);
      });
    }
    function addFolder(name) {
      name = name.trim();
      if (!name) return;
      if (savedFolders.some(f => f.name === name)) return;
      savedFolders.push({ name, searches: [] });
      currentFolderIdx = savedFolders.length - 1;
      foldersObj.folders = savedFolders;
      saveFoldersObj(foldersObj);
      renderFolders();
      renderSavedSearches();
    }
    function removeFolder(idx) {
      if (savedFolders.length === 1) return;
      savedFolders.splice(idx, 1);
      if (currentFolderIdx >= savedFolders.length) currentFolderIdx = savedFolders.length - 1;
      foldersObj.folders = savedFolders;
      saveFoldersObj(foldersObj);
      renderFolders();
      renderSavedSearches();
    }
    function editFolder(idx) {
      savedFolders = savedFolders.map((f, i) => i === idx ? { ...f, editing: true } : { ...f, editing: false });
      foldersObj.folders = savedFolders;
      saveFoldersObj(foldersObj);
      renderFolders();
      setTimeout(() => {
        const input = folderListEl.querySelector('input.sidebar-folder-input');
        if (input) input.focus();
      }, 50);
    }
    function saveFolderEdit(idx, value) {
      value = value.trim();
      if (!value) return;
      if (savedFolders.some((f, i) => f.name === value && i !== idx)) return;
      savedFolders[idx].name = value;
      savedFolders[idx].editing = false;
      foldersObj.folders = savedFolders;
      saveFoldersObj(foldersObj);
      renderFolders();
      renderSavedSearches();
    }
    function cancelFolderEdit(idx) {
      savedFolders[idx].editing = false;
      foldersObj.folders = savedFolders;
      saveFoldersObj(foldersObj);
      renderFolders();
    }
    folderAddBtn.addEventListener('click', function() {
      addFolder(folderInputEl.value);
      folderInputEl.value = '';
      folderInputEl.focus();
    });
    folderInputEl.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        addFolder(folderInputEl.value);
        folderInputEl.value = '';
      }
    });
    renderFolders();

    // --- Saved Searches Logic (Now Folder-Specific) ---
    const listEl = document.getElementById('saved-searches-list');
    const addInput = document.getElementById('sidebar-add-input');
    const addBtn = document.getElementById('sidebar-add-btn');
    const exportBtn = document.getElementById('sidebar-export-btn');
    const importInput = document.getElementById('sidebar-import-input');
    function sortSavedSearches(searches) {
      searches.sort((a, b) => (a.value || "").localeCompare(b.value || "", undefined, {sensitivity: 'base'}));
    }
    const CLICKED_SEARCHES_KEY = 'clickedSearches';
    let clickedSearches = JSON.parse(localStorage.getItem(CLICKED_SEARCHES_KEY)) || {};

    function updateUnhighlightedCount() {
      const folder = savedFolders[currentFolderIdx];
      const unhighlightedCount = folder.searches.filter(term => !clickedSearches[term.value]).length;
      document.getElementById('unhighlighted-count').textContent = `${unhighlightedCount} unhighlighted`;
    }

    function renderSavedSearches() {
      const folder = savedFolders[currentFolderIdx];
      sortSavedSearches(folder.searches);
      listEl.innerHTML = '';
      folder.searches.forEach((term, idx) => {
        const li = document.createElement('li');
        li.className = 'saved-search-item';
        if (term.editing) {
          const editInput = document.createElement('input');
          editInput.type = 'text';
          editInput.value = term.value;
          editInput.className = 'sidebar-add-input';
          editInput.style.marginRight = '5px';
          editInput.maxLength = 70;
          editInput.autofocus = true;
          editInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') saveEdit(idx, editInput.value.trim());
            if (e.key === 'Escape') cancelEdit(idx);
          });
          const saveBtn = document.createElement('button');
          saveBtn.type = 'button';
          saveBtn.className = 'save-edit-btn';
          saveBtn.title = 'Save';
          saveBtn.textContent = 'âœ”';
          saveBtn.onclick = () => saveEdit(idx, editInput.value.trim());
          const cancelBtn = document.createElement('button');
          cancelBtn.type = 'button';
          cancelBtn.className = 'cancel-edit-btn';
          cancelBtn.title = 'Cancel';
          cancelBtn.textContent = 'âœ•';
          cancelBtn.onclick = () => cancelEdit(idx);
          li.appendChild(editInput);
          li.appendChild(saveBtn);
          li.appendChild(cancelBtn);
        } else {
          const termBtn = document.createElement('button');
          termBtn.type = 'button';
          termBtn.className = 'saved-search-term';
          termBtn.title = 'Load into search bar';
          
          // Add checkbox
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'search-term-checkbox';
          checkbox.checked = selectedSearchTerms[term.value] || false;
          checkbox.addEventListener('change', function(e) {
            e.stopPropagation();
            selectedSearchTerms[term.value] = checkbox.checked;
            localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
          });
          
          // Add text
          const textSpan = document.createElement('span');
          textSpan.className = 'search-term-text';
          textSpan.textContent = term.value;
          textSpan.onclick = () => {
            document.getElementById('query').value = term.value;
            document.getElementById('query').focus();
            
            // Mark as clicked with category
            clickedSearches[term.value] = { 
              clicked: true, 
              category: determineSearchCategory(term.value) 
            };
            localStorage.setItem(CLICKED_SEARCHES_KEY, JSON.stringify(clickedSearches));
        
            // Update UI
            termBtn.classList.add('active');
            termBtn.setAttribute('data-category', determineSearchCategory(term.value));
            updateUnhighlightedCount();
          };
          
          termBtn.appendChild(checkbox);
          termBtn.appendChild(textSpan);
          
          // Check if previously clicked
          if (clickedSearches[term.value] && clickedSearches[term.value].clicked) {
            termBtn.classList.add('active');
            termBtn.setAttribute('data-category', clickedSearches[term.value].category || 'all');
          }
          const editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.className = 'edit-btn';
          editBtn.title = 'Edit';
          editBtn.textContent = 'âœŽ';
          editBtn.onclick = () => editSavedSearch(idx);
          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'remove-btn';
          removeBtn.title = 'Remove';
          removeBtn.textContent = 'ðŸ—‘';
          removeBtn.onclick = () => removeSavedSearch(idx);
          li.appendChild(termBtn);
          li.appendChild(editBtn);
          li.appendChild(removeBtn);
        }
        listEl.appendChild(li);
      });
      updateUnhighlightedCount();
    }
    function addSavedSearch(term) {
      term = term.trim();
      if (!term) return;
      const folder = savedFolders[currentFolderIdx];
      if (folder.searches.some(t => t.value === term)) return;
      folder.searches.push({ value: term });
      sortSavedSearches(folder.searches);
      foldersObj.folders = savedFolders;
      saveFoldersObj(foldersObj);
      renderSavedSearches();
      updateUnhighlightedCount();
      
      // Clear selection when adding new term
      selectedSearchTerms = {};
      localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
    }
    function removeSavedSearch(idx) {
      const folder = savedFolders[currentFolderIdx];
      const removedTerm = folder.searches[idx].value;
      folder.searches.splice(idx, 1);
      sortSavedSearches(folder.searches);
      foldersObj.folders = savedFolders;
      saveFoldersObj(foldersObj);
      
      // Remove from selected terms if present
      if (selectedSearchTerms[removedTerm]) {
        delete selectedSearchTerms[removedTerm];
        localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
      }
      
      renderSavedSearches();
      updateUnhighlightedCount();
    }
    function editSavedSearch(idx) {
      const folder = savedFolders[currentFolderIdx];
      folder.searches = folder.searches.map((t, i) => i === idx ? { ...t, editing: true } : { ...t, editing: false });
      foldersObj.folders = savedFolders;
      saveFoldersObj(foldersObj);
      renderSavedSearches();
      setTimeout(() => {
        const input = listEl.querySelector('input.sidebar-add-input');
        if (input) input.focus();
      }, 50);
    }
    function saveEdit(idx, value) {
      value = value.trim();
      if (!value) return;
      const folder = savedFolders[currentFolderIdx];
      const oldValue = folder.searches[idx].value;
      if (folder.searches.some((t, i) => t.value === value && i !== idx)) return;
      folder.searches[idx] = { value: value };
      sortSavedSearches(folder.searches);
      foldersObj.folders = savedFolders;
      saveFoldersObj(foldersObj);
      
      // Update selected terms if the old value was selected
      if (selectedSearchTerms[oldValue]) {
        selectedSearchTerms[value] = true;
        delete selectedSearchTerms[oldValue];
        localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
      }
      
      renderSavedSearches();
      updateUnhighlightedCount();
    }
    function cancelEdit(idx) {
      const folder = savedFolders[currentFolderIdx];
      folder.searches[idx].editing = false;
      foldersObj.folders = savedFolders;
      saveFoldersObj(foldersObj);
      renderSavedSearches();
    }
    addBtn.addEventListener('click', function() {
      addSavedSearch(addInput.value);
      addInput.value = '';
      addInput.focus();
    });
    addInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        addSavedSearch(addInput.value);
        addInput.value = '';
      }
    });

    exportBtn.addEventListener('click', function() {
      const dataStr = JSON.stringify(foldersObj, null, 2);
      const blob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'saved-searches-with-folders-and-websites.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 50);
    });

    importInput.addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          // If imported is array, legacy format
          if (Array.isArray(imported)) {
            foldersObj = { folders: imported, customMarkets: loadCustomMarketsFromFolders(imported) };
          } else if (imported && Array.isArray(imported.folders) && imported.customMarkets) {
            foldersObj = imported;
          } else {
            alert('Invalid file format.');
            return;
          }
          savedFolders = foldersObj.folders;
          customMarkets = foldersObj.customMarkets || { asia: [], international: [], special: [] };
          if (savedFolders.length === 0) savedFolders = [{ name: 'Default', searches: [] }];
          currentFolderIdx = 0;
          saveFoldersObj(foldersObj);
          refreshAllMarketButtons();
          renderFolders();
          renderSavedSearches();
        } catch (err) {
          alert('Failed to import: ' + err.message);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    });

    // Helper function to determine search category (you can customize this logic)
    function determineSearchCategory(searchTerm) {
      // This is a simple implementation - you can enhance it based on your needs
      // For now, we'll just return 'all' as a default
      return 'all';
    }

    // Track selected search terms
    const SELECTED_SEARCH_TERMS_KEY = 'selectedSearchTerms';
    let selectedSearchTerms = JSON.parse(localStorage.getItem(SELECTED_SEARCH_TERMS_KEY)) || {};

    // Update renderSavedSearches to handle category-based highlighting
    function renderSavedSearches() {
      const folder = savedFolders[currentFolderIdx];
      sortSavedSearches(folder.searches);
      listEl.innerHTML = '';
      folder.searches.forEach((term, idx) => {
        const li = document.createElement('li');
        li.className = 'saved-search-item';
        if (term.editing) {
          const editInput = document.createElement('input');
          editInput.type = 'text';
          editInput.value = term.value;
          editInput.className = 'sidebar-add-input';
          editInput.style.marginRight = '5px';
          editInput.maxLength = 70;
          editInput.autofocus = true;
          editInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') saveEdit(idx, editInput.value.trim());
            if (e.key === 'Escape') cancelEdit(idx);
          });
          const saveBtn = document.createElement('button');
          saveBtn.type = 'button';
          saveBtn.className = 'save-edit-btn';
          saveBtn.title = 'Save';
          saveBtn.textContent = 'âœ”';
          saveBtn.onclick = () => saveEdit(idx, editInput.value.trim());
          const cancelBtn = document.createElement('button');
          cancelBtn.type = 'button';
          cancelBtn.className = 'cancel-edit-btn';
          cancelBtn.title = 'Cancel';
          cancelBtn.textContent = 'âœ•';
          cancelBtn.onclick = () => cancelEdit(idx);
          li.appendChild(editInput);
          li.appendChild(saveBtn);
          li.appendChild(cancelBtn);
        } else {
          const termBtn = document.createElement('button');
          termBtn.type = 'button';
          termBtn.className = 'saved-search-term';
          termBtn.title = 'Load into search bar';
          
          // Add checkbox
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'search-term-checkbox';
          checkbox.checked = selectedSearchTerms[term.value] || false;
          checkbox.addEventListener('change', function(e) {
            e.stopPropagation();
            selectedSearchTerms[term.value] = checkbox.checked;
            localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
          });
          
          // Add text
          const textSpan = document.createElement('span');
          textSpan.className = 'search-term-text';
          textSpan.textContent = term.value;
          textSpan.onclick = () => {
            document.getElementById('query').value = term.value;
            document.getElementById('query').focus();
            
            // Mark as clicked with category
            clickedSearches[term.value] = { 
              clicked: true, 
              category: determineSearchCategory(term.value) 
            };
            localStorage.setItem(CLICKED_SEARCHES_KEY, JSON.stringify(clickedSearches));
        
            // Update UI
            termBtn.classList.add('active');
            termBtn.setAttribute('data-category', determineSearchCategory(term.value));
            updateUnhighlightedCount();
          };
          
          termBtn.appendChild(checkbox);
          termBtn.appendChild(textSpan);
          
          // Check if previously clicked
          if (clickedSearches[term.value] && clickedSearches[term.value].clicked) {
            termBtn.classList.add('active');
            termBtn.setAttribute('data-category', clickedSearches[term.value].category || 'all');
          }
          const editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.className = 'edit-btn';
          editBtn.title = 'Edit';
          editBtn.textContent = 'âœŽ';
          editBtn.onclick = () => editSavedSearch(idx);
          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'remove-btn';
          removeBtn.title = 'Remove';
          removeBtn.textContent = 'ðŸ—‘';
          removeBtn.onclick = () => removeSavedSearch(idx);
          li.appendChild(termBtn);
          li.appendChild(editBtn);
          li.appendChild(removeBtn);
        }
        listEl.appendChild(li);
      });
      updateUnhighlightedCount();
    }

    // Function to get selected search terms
    function getSelectedSearchTerms() {
      return Object.entries(selectedSearchTerms)
        .filter(([term, isSelected]) => isSelected)
        .map(([term]) => term);
    }
    
    // Function to open each selected term in separate tabs
    function openSelectedTermsInSeparateTabs(terms, marketFunction) {
      terms.forEach(term => {
        marketFunction(term);
      });
    }

    // Clear selection
    document.getElementById('sidebar-multi-clear-btn').addEventListener('click', function() {
      selectedSearchTerms = {};
      localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
      renderSavedSearches();
    });

    renderSavedSearches();
    updateUnhighlightedCount();


    function openRandomizedTerm(query, category) {
      // Set the query in the search bar
      document.getElementById('query').value = query;
      
      // Mark as clicked/highlighted with category
      clickedSearches[query] = { 
        clicked: true, 
        category: category 
      };
      localStorage.setItem(CLICKED_SEARCHES_KEY, JSON.stringify(clickedSearches));
      updateUnhighlightedCount();
        
      // Get markets for the selected category
      let markets = [];
      if (category === 'all') {
          markets = [...getMarkets('asia'), ...getMarkets('international'), ...getMarkets('special')];
      } else {
          markets = getMarkets(category);
      }
      
      // Filter to only enabled markets
      const enabledMarkets = markets.filter(market => loadMarketToggleState(market.key));
      
      if (enabledMarkets.length === 0) {
        alert('No enabled markets in this category');
        return;
      }
      
      // Open all market URLs immediately without delays
      enabledMarkets.forEach(market => {
        if (market.custom) {
          const parts = market.key.split("-");
          const customId = parts.slice(2).join("-");
          const section = market.key.split("-")[1]; // Get the section from the key
          const url = getCustomMarketUrl(section, customId, query);
          if (url) tabQueue.add(url);
        } else if (marketUrls[market.key]) {
          tabQueue.add(marketUrls[market.key](query));
        }
      });
      
      // Re-render to update highlights
      renderSavedSearches();
    }

    // --- Wishlist Logic with Editable Titles ---
    const WISHLIST_KEY = 'wishlist_links_v1';
    const wishlistListEl = document.getElementById('wishlist-list');
    const wishlistInput = document.getElementById('wishlist-link-input');
    const wishlistForm = document.getElementById('wishlist-add-form');
    let wishlistLinks = [];

    function loadWishlistLinks() {
      const raw = localStorage.getItem(WISHLIST_KEY);
      return raw ? JSON.parse(raw) : [];
    }
    function saveWishlistLinks(links) {
      localStorage.setItem(WISHLIST_KEY, JSON.stringify(links));
    }
    function renderWishlist() {
      wishlistListEl.innerHTML = '';
      wishlistLinks.forEach((item, idx) => {
        const li = document.createElement('li');
        li.className = 'wishlist-item';

        // Title (editable)
        let titleElem;
        if (item.editing) {
          titleElem = document.createElement('input');
          titleElem.type = 'text';
          titleElem.value = item.title || '';
          titleElem.className = 'wishlist-title-input';
          titleElem.autofocus = true;
          titleElem.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') saveTitleEdit(idx, titleElem.value.trim());
            if (e.key === 'Escape') cancelTitleEdit(idx);
          });
          titleElem.addEventListener('blur', function() {
            saveTitleEdit(idx, titleElem.value.trim());
          });
        } else {
          titleElem = document.createElement('span');
          titleElem.className = 'wishlist-title-text';
          titleElem.textContent = item.title ? item.title : 'Loading...';
          titleElem.title = 'Click to edit title';
          titleElem.onclick = () => beginTitleEdit(idx);
        }

        // Link
        const a = document.createElement('a');
        a.href = item.url;
        a.className = 'wishlist-link';
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = item.url;

        // Remove button
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'wishlist-remove-btn';
        removeBtn.title = 'Remove';
        removeBtn.textContent = 'ðŸ—‘';
        removeBtn.onclick = () => {
          wishlistLinks.splice(idx, 1);
          saveWishlistLinks(wishlistLinks);
          renderWishlist();
        };

        li.appendChild(titleElem);
        li.appendChild(a);
        li.appendChild(removeBtn);
        wishlistListEl.appendChild(li);
      });
    }

    function beginTitleEdit(idx) {
      wishlistLinks = wishlistLinks.map((item, i) => i === idx ? {...item, editing: true} : {...item, editing: false});
      renderWishlist();
      setTimeout(() => {
        const input = wishlistListEl.querySelector('input.wishlist-title-input');
        if (input) input.focus();
      }, 50);
    }
    function saveTitleEdit(idx, value) {
      wishlistLinks[idx].title = value || wishlistLinks[idx].title || 'Untitled';
      wishlistLinks[idx].editing = false;
      saveWishlistLinks(wishlistLinks);
      renderWishlist();
    }
    function cancelTitleEdit(idx) {
      wishlistLinks[idx].editing = false;
      renderWishlist();
    }

    async function fetchTitle(url) {
      // Sanitize URL first
      try {
        const parsedUrl = new URL(url);
        if (!['http:', 'https:'].includes(parsedUrl.protocol)) {
          throw new Error('Invalid protocol');
        }
        
        // Use a CORS proxy (public) for demonstration (should use own backend for prod)
        const proxy = "https://corsproxy.io/?";
        const res = await fetch(proxy + encodeURIComponent(url));
        const text = await res.text();
        const titleMatch = text.match(/<title.*?>([\s\S]*?)<\/title>/i);
        if (titleMatch) {
          let title = titleMatch[1].replace(/\n/g, ' ').trim();
          title = title.replace(/\s+/g, ' ');
          return title.length > 100 ? title.slice(0, 100) + "..." : title;
        }
      } catch (e) {}
      try {
        const u = new URL(url);
        return u.hostname;
      } catch {
        return url;
      }
    }

    function isValidUrl(u) {
      try {
        const test = new URL(u);
        return /^https?:/.test(test.protocol);
      } catch {
        return false;
      }
    }

    wishlistForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      let url = wishlistInput.value.trim();
      if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
      if (!isValidUrl(url)) {
        alert('Please enter a valid URL.');
        return;
      }
      if (wishlistLinks.some(item => item.url === url)) {
        wishlistInput.value = '';
        return;
      }
      wishlistLinks.push({ url, title: '', editing: false });
      saveWishlistLinks(wishlistLinks);
      renderWishlist();
      const idx = wishlistLinks.length - 1;
      const title = await fetchTitle(url);
      wishlistLinks[idx].title = title;
      saveWishlistLinks(wishlistLinks);
      renderWishlist();
      wishlistInput.value = '';
    });

    wishlistLinks = loadWishlistLinks();
    renderWishlist();
    wishlistLinks.forEach(async (item, idx) => {
      if (!item.title && item.url) {
        const title = await fetchTitle(item.url);
        wishlistLinks[idx].title = title;
        saveWishlistLinks(wishlistLinks);
        renderWishlist();
      }
    });

    // --- Main Search UI Logic ---
    function getVintedTime() {
      return Math.floor(Date.now() / 1000);
    }
    function getShopGoodwillDate() {
      const now = new Date();
      const month = now.getUTCMonth() + 1;
      const day = now.getUTCDate();
      const year = now.getUTCFullYear();
      return `${month}/${day}/${year}`;
    }
    const marketUrls = {
      "mercari-jp":      q => `https://jp.mercari.com/en/search?keyword=${encodeURIComponent(q)}&sort=created_time&order=desc`,
      "paypay-fleamarket": q => `https://paypayfleamarket.yahoo.co.jp/search/${encodeURIComponent(q)}?page=1&sort=openTime&order=desc`,
      "rakuma":          q => `https://fril.jp/s?order=desc&query=${encodeURIComponent(q)}&sort=created_at&transaction=selling`,
      "rakuten-jp":      q => `https://search.rakuten.co.jp/search/mall/${encodeURIComponent(q)}/?s=4&st=O`,
      "xianyu":          q => `https://2.taobao.com/search?word=${encodeURIComponent(q)}&spm=a2170.xianyu_tbpc_search.0.0`,
      "yahoo-auctions":  q => `https://auctions.yahoo.co.jp/search/search?p=${encodeURIComponent(q)}&s1=new&o1=d`,
      "depop":           q => `https://www.depop.com/search/?q=${encodeURIComponent(q)}&sort=newlyListed`,
      "ebay":            q => `https://www.ebay.com/sch/i.html?_nkw=${encodeURIComponent(q)}&_sop=10`,
      "facebook":        q => `https://www.facebook.com/marketplace/search/?query=${encodeURIComponent(q)}`,
      "gem":             q => `https://gem.app/search?terms=${encodeURIComponent(q)}&sort=newestFirst`,
      "grailed":         q => `https://www.grailed.com/shop?query=${encodeURIComponent(q)}&sort=new`,
      "mercari-us":      q => `https://www.mercari.com/search/?keyword=${encodeURIComponent(q)}&sortBy=2`,
      "poshmark":        q => `https://poshmark.com/search?query=${encodeURIComponent(q)}&sort_by=added_desc`,
      "shopgoodwill":    q => `https://shopgoodwill.com/categories/listing?st=${encodeURIComponent(q)}&sg=Keyword&c=&s=&lp=0&hp=999999&sbn=&spo=false&snpo=false&socs=false&sd=false&sca=false&caed=${encodeURIComponent(getShopGoodwillDate())}&cadb=7&scs=false&sis=false&col=1&p=1&ps=40&desc=true&ss=0&UseBuyerPrefs=true&sus=false&cln=1&catIds=&pn=&wc=false&mci=false&hmt=false&layout=grid&ihp=`,
      "vinted":          q => `https://www.vinted.com/catalog?search_text=${encodeURIComponent(q)}&time=${getVintedTime()}&order=newest_first&page=1`,
      "secondstreet":    q => `https://ec.2ndstreetusa.com/pages/search-results-page?q=${encodeURIComponent(q)}&tab=products&sort_by=created&page=1`,
      "therealreal":     q => `https://www.therealreal.com/products?keywords=${encodeURIComponent(q)}`,
      "vestiaire":       q => `https://us.vestiairecollective.com/search/?q=${encodeURIComponent(q)}&sortBy=3`
    };
    // Custom market URLs: key is "custom-section-id"
    function getCustomMarketUrl(section, id, q) {
      const found = (customMarkets[section] || []).find(item => item.id === id);
      if (!found) return null;
      return found.url.replace(/example/g, encodeURIComponent(q));
    }

    // Instant tab opening queue
    const tabQueue = {
      queue: [],
      isProcessing: false,
      
      add: function(url) {
        this.queue.push(url);
        if (!this.isProcessing) {
          this.process();
        }
      },
      
      process: function() {
        if (this.queue.length === 0) {
          this.isProcessing = false;
          return;
        }
        
        this.isProcessing = true;
        
        // Open all links simultaneously
        this.queue.forEach(url => {
          // Use window.open for first tab, then window.open with _blank for others
          const newWindow = window.open();
          if (newWindow) {
            newWindow.location.href = url;
          } else {
            window.open(url, '_blank');
          }
        });
        
        this.queue = []; // Clear the queue
        this.isProcessing = false;
      }
    };

    document.addEventListener('click', function(e) {
      // --- Market button logic (support custom) ---
      const marketBtn = e.target.closest('.market-btn');
      // Only proceed if clicking the button (not checkbox) and not disabled
      if (marketBtn && !marketBtn.classList.contains('disabled') && !e.target.classList.contains('market-toggle')) {
        // Check if any search terms are selected
        const selectedTerms = getSelectedSearchTerms();
        
        if (selectedTerms.length > 0) {
          // Mark each term as clicked
          selectedTerms.forEach(term => {
            clickedSearches[term] = { 
              clicked: true, 
              category: determineSearchCategory(term) 
            };
          });
          localStorage.setItem(CLICKED_SEARCHES_KEY, JSON.stringify(clickedSearches));
          
          // Open each selected term in separate tabs for this specific market
          const market = marketBtn.getAttribute('data-market');
          const section = marketBtn.getAttribute('data-section');
          
          openSelectedTermsInSeparateTabs(selectedTerms, function(term) {
            if (market.startsWith("custom-")) {
              const parts = market.split("-");
              const customId = parts.slice(2).join("-");
              const url = getCustomMarketUrl(section, customId, term);
              if (url) tabQueue.add(url);
            } else if (marketUrls[market]) {
              tabQueue.add(marketUrls[market](term));
            }
          });
          
          // Clear selection
          selectedSearchTerms = {};
          localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
          
          // Update UI
          renderSavedSearches();
          updateUnhighlightedCount();
        } else {
          // Use the current search query
          const query = document.getElementById('query').value.trim();
          if (!query) {
            document.getElementById('query').focus();
            return;
          }
          const market = marketBtn.getAttribute('data-market');
          const section = marketBtn.getAttribute('data-section');
          if (market.startsWith("custom-")) {
            const parts = market.split("-");
            const customId = parts.slice(2).join("-");
            const url = getCustomMarketUrl(section, customId, query);
            if (url) tabQueue.add(url);
          } else if (marketUrls[market]) {
            tabQueue.add(marketUrls[market](query));
          }
        }
      }
      // Sectional Open All
      if (e.target.classList.contains('section-openall-btn')) {
        // Check if any search terms are selected
        const selectedTerms = getSelectedSearchTerms();
        
        if (selectedTerms.length > 0) {
          // Mark each term as clicked
          selectedTerms.forEach(term => {
            clickedSearches[term] = { 
              clicked: true, 
              category: determineSearchCategory(term) 
            };
          });
          localStorage.setItem(CLICKED_SEARCHES_KEY, JSON.stringify(clickedSearches));
          
          // Open each selected term in separate tabs for all markets in this section
          const section = e.target.getAttribute('data-section');
          
          openSelectedTermsInSeparateTabs(selectedTerms, function(term) {
            let marketArr = getMarkets(section);
            
            // Open all URLs immediately without delays
            marketArr.slice().sort((a, b) => a.label.localeCompare(b.label)).forEach(market => {
              // Skip if this market is toggled off
              if (!loadMarketToggleState(market.key)) return;
              
              if (market.custom) {
                const parts = market.key.split("-");
                const customId = parts.slice(2).join("-");
                const url = getCustomMarketUrl(section, customId, term);
                if (url) tabQueue.add(url);
              } else if (marketUrls[market.key]) {
                tabQueue.add(marketUrls[market.key](term));
              }
            });
          });
          
          // Clear selection
          selectedSearchTerms = {};
          localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
          
          // Update UI
          renderSavedSearches();
          updateUnhighlightedCount();
        } else {
          // Use the current search query
          const query = document.getElementById('query').value.trim();
          if (!query) {
            document.getElementById('query').focus();
            return;
          }
          const section = e.target.getAttribute('data-section');
          let marketArr = getMarkets(section);
          
          // Collect all URLs first (only enabled markets)
          const urls = [];
          marketArr.slice().sort((a, b) => a.label.localeCompare(b.label)).forEach(market => {
            // Skip if this market is toggled off
            if (!loadMarketToggleState(market.key)) return;
            
            if (market.custom) {
              const parts = market.key.split("-");
              const customId = parts.slice(2).join("-");
              const url = getCustomMarketUrl(section, customId, query);
              if (url) urls.push(url);
            } else if (marketUrls[market.key]) {
              urls.push(marketUrls[market.key](query));
            }
          });
          
          // Process URLs with queue
          urls.forEach(url => tabQueue.add(url));
        }
      }
      // --- Add Custom Market Button ---
      if (e.target.classList.contains('add-market-btn')) {
        const section = e.target.getAttribute('data-section');
        showCustomMarketModal(section);
      }
    });

    document.getElementById('open-all-btn').addEventListener('click', function() {
      // Check if any search terms are selected
      const selectedTerms = getSelectedSearchTerms();
      
      if (selectedTerms.length > 0) {
        // Mark each term as clicked
        selectedTerms.forEach(term => {
          clickedSearches[term] = { 
            clicked: true, 
            category: determineSearchCategory(term) 
          };
        });
        localStorage.setItem(CLICKED_SEARCHES_KEY, JSON.stringify(clickedSearches));
        
        // Open each selected term in separate tabs for all markets
        openSelectedTermsInSeparateTabs(selectedTerms, function(term) {
          openAllMarketsWithQuery(term);
        });
        
        // Clear selection
        selectedSearchTerms = {};
        localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
        
        // Update UI
        renderSavedSearches();
        updateUnhighlightedCount();
      } else {
        // Use the current search query
        const query = document.getElementById('query').value.trim();
        if (!query) {
          document.getElementById('query').focus();
          return;
        }
        openAllMarketsWithQuery(query);
      }
    });

    // Update color indicator based on selected category
    function updateRandomizeColorIndicator() {
      const select = document.getElementById('randomize-category-select');
      const indicator = document.getElementById('randomize-color-indicator');
      const colors = {
        'all': '#6a0572',
        'asia': '#ff6b6b',
        'international': '#4ecdc4',
        'special': '#ffe66d'
      };
      indicator.style.backgroundColor = colors[select.value];
    }

    // Initialize color indicator
    updateRandomizeColorIndicator();
    
    // Update indicator when selection changes
    document.getElementById('randomize-category-select').addEventListener('change', updateRandomizeColorIndicator);
    
    // Randomize button functionality
    document.getElementById('sidebar-randomize-btn').addEventListener('click', function() {
      const category = document.getElementById('randomize-category-select').value;
      
      // Get the current folder's searches
      const folder = savedFolders[currentFolderIdx];
      if (!folder.searches || folder.searches.length === 0) {
        alert('No saved searches to randomize from');
        return;
      }
      
      // Find unhighlighted terms (compatibility with new structure)
      const unhighlightedTerms = folder.searches.filter(term => 
        !clickedSearches[term.value] || !clickedSearches[term.value].clicked
      );
      
      if (unhighlightedTerms.length === 0) {
        // Reset all highlights if all terms have been used
        clickedSearches = {};
        localStorage.setItem(CLICKED_SEARCHES_KEY, JSON.stringify(clickedSearches));
        // Use all terms
        const randomTerm = folder.searches[Math.floor(Math.random() * folder.searches.length)];
        openRandomizedTerm(randomTerm.value, category);
      } else {
        // Pick a random unhighlighted term
        const randomTerm = unhighlightedTerms[Math.floor(Math.random() * unhighlightedTerms.length)];
        openRandomizedTerm(randomTerm.value, category);
      }
    });

    // Clear search button
    const clearBtn = document.getElementById('clear-search');
    const searchInput = document.getElementById('query');
    
    searchInput.addEventListener('input', function() {
      clearBtn.style.display = this.value ? 'block' : 'none';
    });
    
    clearBtn.addEventListener('click', function() {
      searchInput.value = '';
      this.style.display = 'none';
      searchInput.focus();
    });

    document.getElementById('searchForm').addEventListener('submit', function(e){
      e.preventDefault();
      // Check if any search terms are selected
      const selectedTerms = getSelectedSearchTerms();
      
      if (selectedTerms.length > 0) {
        // Mark each term as clicked
        selectedTerms.forEach(term => {
          clickedSearches[term] = { 
            clicked: true, 
            category: determineSearchCategory(term) 
          };
        });
        localStorage.setItem(CLICKED_SEARCHES_KEY, JSON.stringify(clickedSearches));
        
        // Open each selected term in separate tabs for Mercari Japan
        openSelectedTermsInSeparateTabs(selectedTerms, function(term) {
          window.open(marketUrls["mercari-jp"](term), '_blank');
        });
        
        // Clear selection
        selectedSearchTerms = {};
        localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
        
        // Update UI
        renderSavedSearches();
        updateUnhighlightedCount();
      } else {
        // Use the current search query
        const query = document.getElementById('query').value.trim();
        if (!query) return;
        window.open(marketUrls["mercari-jp"](query), '_blank');
      }
    });

    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      const queryInput = document.getElementById('query');
      
      // Ctrl+Enter to open all
      if (e.ctrlKey && e.key === 'Enter') {
        document.getElementById('open-all-btn').click();
        return;
      }
      // Escape to clear search
      if (e.key === 'Escape') {
        queryInput.value = '';
        queryInput.focus();
        return;
      }
      
      // Arrow key navigation
      if (['ArrowDown', 'ArrowUp', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
        e.preventDefault();
        
        // Left-side elements (folders and search terms)
        const folders = [...document.querySelectorAll('.saved-folder-item button:first-child')].filter(el => el.offsetParent !== null);
        const searchTerms = [...document.querySelectorAll('.saved-search-term')].filter(el => el.offsetParent !== null);
        
        // Right-side elements (open all buttons and market buttons)
        const openAllBtns = [...document.querySelectorAll('.section-openall-btn')].filter(el => el.offsetParent !== null);
        const mainOpenAllBtn = document.getElementById('open-all-btn');
        const marketBtns = [...document.querySelectorAll('.market-btn')].filter(el => el.offsetParent !== null);
        
        // Get current focused element
        const currentEl = document.activeElement;
        
        // Handle vertical navigation (up/down)
        if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
          // Left-side navigation (folders and search terms)
          if (folders.includes(currentEl) || searchTerms.includes(currentEl)) {
            const leftElements = [...folders, ...searchTerms];
            const currentIndex = leftElements.indexOf(currentEl);
            let nextIndex = 0;
            
            if (e.key === 'ArrowDown') {
              nextIndex = currentIndex < leftElements.length - 1 ? currentIndex + 1 : 0;
            } else {
              nextIndex = currentIndex > 0 ? currentIndex - 1 : leftElements.length - 1;
            }
            
            leftElements[nextIndex].focus();
          } 
          // Right-side navigation (open all and market buttons)
          else if (openAllBtns.includes(currentEl) || currentEl === mainOpenAllBtn || marketBtns.includes(currentEl)) {
            const rightElements = [...openAllBtns, mainOpenAllBtn, ...marketBtns];
            const currentIndex = rightElements.indexOf(currentEl);
            let nextIndex = 0;
            
            if (e.key === 'ArrowDown') {
              // If on main Open All button, go to first section Open All button
              if (currentEl === mainOpenAllBtn && openAllBtns.length > 0) {
                nextIndex = rightElements.indexOf(openAllBtns[0]);
              } else {
                nextIndex = currentIndex < rightElements.length - 1 ? currentIndex + 1 : 0;
              }
            } else {
              nextIndex = currentIndex > 0 ? currentIndex - 1 : rightElements.length - 1;
            }
            
            rightElements[nextIndex].focus();
          }
        }
        // Handle horizontal navigation (left/right)
        else if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
          // Left arrow focuses left-side elements
          if (e.key === 'ArrowLeft') {
            if (searchTerms.length > 0) {
              searchTerms[0].focus();
            } else if (folders.length > 0) {
              folders[0].focus();
            }
          } 
          // Right arrow focuses right-side elements
          else {
            if (openAllBtns.length > 0) {
              openAllBtns[0].focus();
            } else if (marketBtns.length > 0) {
              marketBtns[0].focus();
            } else if (mainOpenAllBtn) {
              mainOpenAllBtn.focus();
            }
          }
        }
        return;
      }
      
      // Enter to load focused search term
      if (e.key === 'Enter' && e.target.classList.contains('saved-search-term')) {
        const searchTerm = e.target.textContent;
        const queryInput = document.getElementById('query');
        queryInput.value = searchTerm;
        queryInput.focus();
        
        // Force selection of all text in input
        setTimeout(() => {
          queryInput.setSelectionRange(0, queryInput.value.length);
        }, 0);
        
        // Mark as clicked with category
        clickedSearches[searchTerm] = { 
          clicked: true, 
          category: determineSearchCategory(searchTerm) 
        };
        localStorage.setItem(CLICKED_SEARCHES_KEY, JSON.stringify(clickedSearches));
        e.target.classList.add('active');
        e.target.setAttribute('data-category', determineSearchCategory(searchTerm));
        updateUnhighlightedCount();
        
        // Focus the Open All button
        setTimeout(() => {
          document.getElementById('open-all-btn').focus();
        }, 10);
        
        // Prevent form submission
        e.preventDefault();
        return false;
      }
      
      // Tab to focus first search term
      if (e.key === 'Tab' && e.target === queryInput && !e.shiftKey) {
        e.preventDefault();
        const firstSearchTerm = document.querySelector('.saved-search-term');
        if (firstSearchTerm) firstSearchTerm.focus();
      }
    });

    // --- Custom Market Modal Logic ---
    function showCustomMarketModal(section) {
      const bg = document.getElementById('custom-market-modal-bg');
      document.getElementById('custom-market-modal-section').textContent = {
        asia: "Asia Section",
        international: "International Section",
        special: "Designer Section"
      }[section] || "";
      bg.style.display = 'flex';
      bg.setAttribute('data-section', section);
      document.getElementById('custom-market-title-input').value = '';
      document.getElementById('custom-market-url-input').value = '';
      setTimeout(() => {
        document.getElementById('custom-market-title-input').focus();
      }, 20);
    }
    function hideCustomMarketModal() {
      document.getElementById('custom-market-modal-bg').style.display = 'none';
    }
    document.getElementById('custom-market-modal-cancel-btn').onclick = hideCustomMarketModal;
    document.getElementById('custom-market-modal-bg').onclick = function(e) {
      if (e.target === this) hideCustomMarketModal();
    };
    document.getElementById('custom-market-modal-save-btn').onclick = function() {
      const section = document.getElementById('custom-market-modal-bg').getAttribute('data-section');
      const title = document.getElementById('custom-market-title-input').value.trim();
      const url = document.getElementById('custom-market-url-input').value.trim();
      if (!title || !url || !url.includes('example')) {
        alert('Both a title and search layout URL are required. URL must contain "example".');
        return;
      }
      // Generate unique id
      const id = Date.now().toString(36) + '-' + Math.floor(Math.random()*99999).toString(36);
      customMarkets[section] = customMarkets[section] || [];
      customMarkets[section].push({ id, title, url });
      foldersObj.customMarkets = customMarkets;
      saveFoldersObj(foldersObj);
      refreshAllMarketButtons();
      hideCustomMarketModal();
    };

    // Container minimize/restore and dragging functionality
    const container = document.querySelector('.container');
    const dragHandle = document.getElementById('container-handle');
    let isMinimized = false;
    
    // Double click to minimize/restore
    dragHandle.addEventListener('dblclick', function() {
      isMinimized = !isMinimized;
      
      if (isMinimized) {
        // Store current position before minimizing
        container.dataset.lastLeft = container.style.left;
        container.dataset.lastTop = container.style.top;
        
        // Apply minimized state - force specific dimensions
        container.classList.add('minimized');
        container.style.width = '300px';
        container.style.height = '40px';
        container.style.left = container.dataset.lastLeft || '50%';
        container.style.top = container.dataset.lastTop || '50%';
      } else {
        // Restore to previous position but use original max dimensions
        container.classList.remove('minimized');
        container.style.left = container.dataset.lastLeft || '50%';
        container.style.top = container.dataset.lastTop || '50%';
        container.style.width = '';
        container.style.height = '';
      }
      
      // Force reflow to ensure smooth transition
      void container.offsetWidth;
    });
    let isDragging = false;
    let offsetX, offsetY;
    let initialLeft, initialTop;

    dragHandle.addEventListener('mousedown', function(e) {
      // Don't drag if this is a double click
      if (e.detail > 1) return;
      
      isDragging = true;
      const rect = container.getBoundingClientRect();
      // Calculate offset from mouse to container's current position
      offsetX = e.clientX - rect.left;
      offsetY = e.clientY - rect.top;
      // Store initial position before we change transform
      initialLeft = rect.left;
      initialTop = rect.top;
      container.style.cursor = 'grabbing';
      e.preventDefault();
    });

    document.addEventListener('mousemove', function(e) {
      if (!isDragging) return;
      
      requestAnimationFrame(() => {
        // Calculate new position using the offset
        const x = e.clientX - offsetX;
        const y = e.clientY - offsetY;
        
        container.style.left = x + 'px';
        container.style.top = y + 'px';
        container.style.transform = 'none';
        
        // Store current position for restore
        container.dataset.lastLeft = x + 'px';
        container.dataset.lastTop = y + 'px';
      });
    });

    document.addEventListener('mouseup', function() {
      if (isDragging) {
        isDragging = false;
        container.style.cursor = '';
      }
    });

    // Make custom market modal draggable
    const modal = document.querySelector('.custom-market-modal');
    const modalHandle = modal.querySelector('.drag-handle');
    let isModalDragging = false;
    let modalOffsetX, modalOffsetY;
    let modalInitialLeft, modalInitialTop;

    modalHandle.addEventListener('mousedown', function(e) {
      isModalDragging = true;
      // Get modal position relative to viewport
      const rect = modal.getBoundingClientRect();
      // Calculate offset from mouse to modal's top-left corner
      modalOffsetX = e.clientX - rect.left;
      modalOffsetY = e.clientY - rect.top;
      modal.style.cursor = 'grabbing';
      e.preventDefault();
    });

    document.addEventListener('mousemove', function(e) {
      if (!isModalDragging) return;
      
      // Calculate new position keeping the same mouse offset
      const x = e.clientX - modalOffsetX;
      const y = e.clientY - modalOffsetY;
      
      modal.style.left = x + 'px';
      modal.style.top = y + 'px';
      modal.style.transform = 'none'; // Remove centering transform
    });

    document.addEventListener('mouseup', function() {
      if (isModalDragging) {
        isModalDragging = false;
        modal.style.cursor = '';
      }
    });

    // Center modal on show
    function showCustomMarketModal(section) {
      const bg = document.getElementById('custom-market-modal-bg');
      document.getElementById('custom-market-modal-section').textContent = {
        asia: "Asia Section",
        international: "International Section",
        special: "Designer Section"
      }[section] || "";
      bg.style.display = 'flex';
      bg.setAttribute('data-section', section);
      document.getElementById('custom-market-title-input').value = '';
      document.getElementById('custom-market-url-input').value = '';
      
      // Center modal
      const modal = document.querySelector('.custom-market-modal');
      modal.style.left = '50%';
      modal.style.top = '50%';
      modal.style.transform = 'translate(-50%, -50%)';
      
      setTimeout(() => {
        document.getElementById('custom-market-title-input').focus();
      }, 20);
    }

    // Toggle all marketplaces
    document.getElementById('toggle-all-checkbox').addEventListener('change', function(e) {
      const isChecked = e.target.checked;
      const marketButtons = document.querySelectorAll('.market-btn');
      
      marketButtons.forEach(btn => {
        const toggle = btn.querySelector('.market-toggle');
        if (toggle) {
          toggle.checked = isChecked;
          btn.classList.toggle('disabled', !isChecked);
          const marketKey = btn.getAttribute('data-market');
          saveMarketToggleState(marketKey, isChecked);
        }
      });
    });

    // On page load, refresh market buttons with custom
    refreshAllMarketButtons();

    // On folder or custom market change, refresh UI
    // (already handled above after relevant actions)
  </script>
  <script>
(function() {
  const folderList = document.getElementById('saved-folder-list');
  const searchList = document.getElementById('saved-searches-list');
  const handle = document.getElementById('sidebar-folder-search-resize');
  let startY, startFolderHeight, startSearchHeight, resizing = false;

  // Set initial heights
  folderList.style.height = '120px';
  searchList.style.height = '180px';
  folderList.style.overflowY = 'auto';
  searchList.style.overflowY = 'auto';

  handle.addEventListener('mousedown', function(e) {
    e.preventDefault();
    resizing = true;
    startY = e.clientY;
    startFolderHeight = folderList.offsetHeight;
    startSearchHeight = searchList.offsetHeight;
    document.body.style.userSelect = 'none';
  });

  window.addEventListener('mousemove', function(e) {
    if (!resizing) return;
    let dy = e.clientY - startY;
    let newFolderHeight = Math.max(60, Math.min(300, startFolderHeight + dy));
    let newSearchHeight = Math.max(80, Math.min(400, startSearchHeight - dy));
    folderList.style.height = newFolderHeight + 'px';
    searchList.style.height = newSearchHeight + 'px';
  });

  window.addEventListener('mouseup', function() {
    if (resizing) {
      resizing = false;
      document.body.style.userSelect = '';
    }
  });
})();
</script>
<script>
(function() {
  const sidebar = document.querySelector('.sidebar');
  const wishlist = document.querySelector('.wishlist-section');
  const container = document.querySelector('.container');
  const resizeHandles = document.querySelectorAll('.resize-handle');

  let resizing = false;
  let startX, startY, startW, startH;

  resizeHandles.forEach(handle => {
    handle.addEventListener('mousedown', function(e) {
      e.preventDefault();
      resizing = { type: handle.dataset.resize };
      startX = e.clientX;
      startY = e.clientY;
      startW = parseInt(document.defaultView.getComputedStyle(resizing.type === 'sidebar' ? sidebar : resizing.type === 'wishlist' ? wishlist : container).width, 10);
      startH = parseInt(document.defaultView.getComputedStyle(container).height, 10);
      document.body.style.userSelect = 'none';
    });
  });

  window.addEventListener('mousemove', function(e) {
    if (!resizing) return;
    
    
    if (resizing.type === 'sidebar') {
      const dx = e.clientX - startX;
      let newW = Math.max(200, Math.min(600, startW + dx));
      document.querySelector('.sidebar').style.width = newW + 'px';
      
      // Adjust container margin when sidebar resizes
      if (window.innerWidth >= 1200) {
        document.querySelector('.container').style.marginLeft = newW + 'px';
      }
    }
    if (resizing.type === 'wishlist') {
      const dx = startX - e.clientX;
      let newW = Math.max(200, Math.min(600, startW + dx));
      document.querySelector('.wishlist-section').style.width = newW + 'px';
    }
    if (resizing.type === 'container') {
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      let newW = Math.max(350, Math.min(900, startW + dx));
      let newH = Math.max(350, Math.min(window.innerHeight - 40, startH + dy));
      const container = document.querySelector('.container');
      container.style.width = newW + 'px';
      container.style.height = newH + 'px';
    }
  });

  window.addEventListener('mouseup', function() {
    if (resizing) {
      resizing = false;
      document.body.style.userSelect = '';
    }
  });
})();
</script>
  <!-- Theme Editor Modal -->
  <div id="theme-editor-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:3000;background:rgba(10,10,10,0.65);backdrop-filter:blur(2.5px);align-items:center;justify-content:center;">
    <div style="background:rgba(32,34,36,0.98);border-radius:18px;box-shadow:0 8px 32px #000a;padding:28px 22px 18px 22px;max-width:350px;width:96vw;border:1.5px solid #232323;backdrop-filter:blur(7px);cursor:default;">
      <h3 style="margin-top:0;font-size:1.17em;color:#e3e3e3;margin-bottom:10px;font-weight:bold;letter-spacing:0.01em;text-shadow:0 1px 8px #2224;">Theme Editor</h3>
      <div style="margin-bottom:15px;">
        <label style="display:block;margin-top:12px;margin-bottom:2px;color:#e3e3e3;font-weight:bold;font-size:1em;">Background Color</label>
        <input type="color" id="theme-bg-color" value="#121212" style="width:100%;height:40px;border-radius:5px;border:1.5px solid #232323;">
      </div>
      <div style="margin-bottom:15px;">
        <label style="display:block;margin-top:12px;margin-bottom:2px;color:#e3e3e3;font-weight:bold;font-size:1em;">Accent Color</label>
        <input type="color" id="theme-accent-color" value="#666" style="width:100%;height:40px;border-radius:5px;border:1.5px solid #232323;">
      </div>
      <div style="margin-bottom:15px;">
        <label style="display:block;margin-top:12px;margin-bottom:2px;color:#e3e3e3;font-weight:bold;font-size:1em;">Search Highlight Color</label>
        <input type="color" id="theme-highlight-color" value="#a0d8ed" style="width:100%;height:40px;border-radius:5px;border:1.5px solid #232323;">
      </div>
      <div style="margin-bottom:15px;">
        <label style="display:block;margin-top:12px;margin-bottom:2px;color:#e3e3e3;font-weight:bold;font-size:1em;">Background Image</label>
        <input type="file" id="theme-bg-image" accept="image/*" style="width:100%;border-radius:5px;border:1.5px solid #232323;padding:5px;">
        <div style="display:flex;gap:5px;margin-top:5px;">
          <button id="theme-bg-image-remove" style="background:#232323;color:#e3e3e3;border:none;border-radius:4px;font-size:0.9em;padding:3px 8px;cursor:pointer;">Remove Image</button>
          <button id="theme-bg-image-preview" style="background:#232323;color:#e3e3e3;border:none;border-radius:4px;font-size:0.9em;padding:3px 8px;cursor:pointer;">Preview</button>
        </div>
      </div>
      <div style="margin-bottom:15px;">
        <label style="display:block;margin-top:12px;margin-bottom:2px;color:#e3e3e3;font-weight:bold;font-size:1em;">Logo Image</label>
        <input type="file" id="theme-logo-image" accept="image/*" style="width:100%;border-radius:5px;border:1.5px solid #232323;padding:5px;">
        <div style="display:flex;gap:5px;margin-top:5px;">
          <button id="theme-logo-image-remove" style="background:#232323;color:#e3e3e3;border:none;border-radius:4px;font-size:0.9em;padding:3px 8px;cursor:pointer;">Reset Default</button>
          <button id="theme-logo-image-preview" style="background:#232323;color:#e3e3e3;border:none;border-radius:4px;font-size:0.9em;padding:3px 8px;cursor:pointer;">Preview</button>
        </div>
      </div>
      <div style="display:flex;gap:11px;margin-top:18px;justify-content:flex-end;">
        <button id="theme-apply-btn" style="background:#232323;color:#e3e3e3;border:none;border-radius:6px;font-size:1em;font-weight:bold;cursor:pointer;padding:8px 22px;transition:background .18s,box-shadow .18s,transform .13s;box-shadow:0 2px 8px #2224;opacity:0.93;backdrop-filter:blur(1.5px);">Apply</button>
        <button id="theme-reset-btn" style="background:#232323;color:#e3e3e3;border:none;border-radius:6px;font-size:1em;font-weight:bold;cursor:pointer;padding:8px 22px;transition:background .14s,color .14s;opacity:0.93;backdrop-filter:blur(1.5px);">Reset</button>
        <button id="theme-close-btn" style="background:#232323;color:#e3e3e3;border:none;border-radius:6px;font-size:1em;font-weight:bold;cursor:pointer;padding:8px 22px;transition:background .14s,color .14s;opacity:0.93;backdrop-filter:blur(1.5px);">Close</button>
      </div>
    </div>
  </div>

  <!-- Particle Background Effect -->
  <canvas id="particle-canvas" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;pointer-events:none;"></canvas>
  <script>
    // Particle background
    (function() {
      const canvas = document.getElementById('particle-canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      
      const particles = [];
      const particleCount = Math.floor(window.innerWidth / 10);
      
      for (let i = 0; i < particleCount; i++) {
        particles.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          size: Math.random() * 2 + 0.5,
          speedX: Math.random() * 0.2 - 0.1,
          speedY: Math.random() * 0.2 - 0.1,
          color: `rgba(100, 220, 255, ${Math.random() * 0.1 + 0.05})`
        });
      }
      
      function animateParticles() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        for (let i = 0; i < particles.length; i++) {
          const p = particles[i];
          
          p.x += p.speedX;
          p.y += p.speedY;
          
          if (p.x < 0 || p.x > canvas.width) p.speedX *= -1;
          if (p.y < 0 || p.y > canvas.height) p.speedY *= -1;
          
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
          ctx.fillStyle = p.color;
          ctx.fill();
        }
        
        requestAnimationFrame(animateParticles);
      }
      
      animateParticles();
      
      window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      });
    })();
  </script>
  <script>
    // Theme Editor Functionality
    document.getElementById('theme-editor-btn').addEventListener('click', function() {
      document.getElementById('theme-editor-modal').style.display = 'flex';
    });

    document.getElementById('theme-close-btn').addEventListener('click', function() {
      document.getElementById('theme-editor-modal').style.display = 'none';
    });

    // Handle background image upload
    document.getElementById('theme-bg-image').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          const bgImage = event.target.result;
          document.documentElement.style.setProperty('--theme-bg-image', `url(${bgImage})`);
          localStorage.setItem('themeBgImage', bgImage);
        };
        reader.readAsDataURL(file);
      }
    });

    // Remove background image
    document.getElementById('theme-bg-image-remove').addEventListener('click', function() {
      document.documentElement.style.setProperty('--theme-bg-image', 'none');
      localStorage.removeItem('themeBgImage');
      document.getElementById('theme-bg-image').value = '';
    });

    // Preview background image
    document.getElementById('theme-bg-image-preview').addEventListener('click', function() {
      const bgImage = localStorage.getItem('themeBgImage');
      if (bgImage) {
        document.documentElement.style.setProperty('--theme-bg-image', `url(${bgImage})`);
      } else {
        document.documentElement.style.setProperty('--theme-bg-image', 'url("bg.svg")');
      }
    });

    document.getElementById('theme-apply-btn').addEventListener('click', function() {
      const bgColor = document.getElementById('theme-bg-color').value;
      const accentColor = document.getElementById('theme-accent-color').value;
      const highlightColor = document.getElementById('theme-highlight-color').value;
      
      // Apply theme
      document.documentElement.style.setProperty('--theme-bg', bgColor);
      document.documentElement.style.setProperty('--theme-accent', accentColor);
      document.documentElement.style.setProperty('--theme-highlight', highlightColor);
      
      // Save to localStorage
      localStorage.setItem('themeSettings', JSON.stringify({
        bgColor,
        accentColor,
        highlightColor
      }));
    });

    document.getElementById('theme-reset-btn').addEventListener('click', function() {
      // Reset to defaults
      document.getElementById('theme-bg-color').value = '#121212';
      document.getElementById('theme-accent-color').value = '#666';
      document.getElementById('theme-highlight-color').value = '#a0d8ed';
      
      // Remove saved theme
      localStorage.removeItem('themeSettings');
      localStorage.removeItem('themeBgImage');
      
      // Apply defaults
      document.documentElement.style.setProperty('--theme-bg', '#121212');
      document.documentElement.style.setProperty('--theme-accent', '#666');
      document.documentElement.style.setProperty('--theme-highlight', '#a0d8ed');
      document.documentElement.style.setProperty('--theme-bg-image', 'url("bg.png")');
      
      // Reset logo to default
      document.querySelector('.wishlist-mascot').src = 'mmcs.svg';
      localStorage.removeItem('themeLogoImage');
      document.getElementById('theme-logo-image').value = '';
      document.getElementById('theme-bg-image').value = '';
    });

    // Reset highlights button
    document.getElementById('sidebar-reset-highlights-btn').addEventListener('click', function() {
      clickedSearches = {};
      localStorage.removeItem(CLICKED_SEARCHES_KEY);
      document.querySelectorAll('.saved-search-term').forEach(btn => {
        btn.classList.remove('active');
        btn.removeAttribute('data-category');
      });
      updateUnhighlightedCount();
      
      // Also clear selection
      selectedSearchTerms = {};
      localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
      renderSavedSearches();
    });

    // Helper function to open all markets with a query
    function openAllMarketsWithQuery(query) {
      // Collect all URLs first (only enabled markets)
      const urls = [];
      ['asia', 'international', 'special'].forEach(section => {
        getMarkets(section).forEach(market => {
          // Skip if this market is toggled off
          if (!loadMarketToggleState(market.key)) return;
          
          if (market.custom) {
            const parts = market.key.split("-");
            const customId = parts.slice(2).join("-");
            const url = getCustomMarketUrl(section, customId, query);
            if (url) urls.push(url);
          } else if (marketUrls[market.key]) {
            urls.push(marketUrls[market.key](query));
          }
        });
      });
      
      // Process URLs with queue
      urls.forEach(url => tabQueue.add(url));
      
      // Clear selection after search
      selectedSearchTerms = {};
      localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
      renderSavedSearches();
    }

    // Load saved theme on startup
    const savedTheme = localStorage.getItem('themeSettings');
    if (savedTheme) {
      const theme = JSON.parse(savedTheme);
      document.getElementById('theme-bg-color').value = theme.bgColor;
      document.getElementById('theme-accent-color').value = theme.accentColor;
      document.getElementById('theme-highlight-color').value = theme.highlightColor || '#00e6d6';
      
      document.documentElement.style.setProperty('--theme-bg', theme.bgColor);
      document.documentElement.style.setProperty('--theme-accent', theme.accentColor);
      document.documentElement.style.setProperty('--theme-highlight', theme.highlightColor || '#00e6d6');
    } else {
      // Apply default background image if no saved theme
      document.documentElement.style.setProperty('--theme-bg-image', 'url("bg.png")');
    }

    // Load saved background image
    const savedBgImage = localStorage.getItem('themeBgImage');
    if (savedBgImage) {
      document.documentElement.style.setProperty('--theme-bg-image', `url(${savedBgImage})`);
    }

    // Load saved logo image
    const savedLogoImage = localStorage.getItem('themeLogoImage');
    if (savedLogoImage) {
      document.querySelector('.wishlist-mascot').src = savedLogoImage;
    }

    // Handle logo image upload
    document.getElementById('theme-logo-image').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          const logoImage = event.target.result;
          document.querySelector('.wishlist-mascot').src = logoImage;
          localStorage.setItem('themeLogoImage', logoImage);
        };
        reader.readAsDataURL(file);
      }
    });

    // Reset logo to default
    document.getElementById('theme-logo-image-remove').addEventListener('click', function() {
      document.querySelector('.wishlist-mascot').src = 'mmcs.svg';
      localStorage.removeItem('themeLogoImage');
      document.getElementById('theme-logo-image').value = '';
    });

    // Preview logo
    document.getElementById('theme-logo-image-preview').addEventListener('click', function() {
      const logoImage = localStorage.getItem('themeLogoImage');
      if (logoImage) {
        document.querySelector('.wishlist-mascot').src = logoImage;
      }
    });

    // Sidebar detach/reattach functionality
    (function() {
      const sidebar = document.getElementById('sidebar');
      const dragHandle = sidebar.querySelector('.drag-handle');
      let isDetached = false;
      let isDragging = false;
      let dragOffsetX = 0;
      let dragOffsetY = 0;
      const originalPosition = { left: 0, top: 0 };

      // Double click to detach/reattach
      dragHandle.addEventListener('dblclick', function() {
        if (isDetached) {
          reattachSidebar();
        } else {
          detachSidebar();
        }
      });

      // Also allow dragging near left edge to reattach
      document.addEventListener('mousemove', function(e) {
        if (!isDragging || !isDetached) return;
        
        // If dragged near left edge, show reattachment preview
        if (e.clientX < 50) {
          sidebar.classList.add('reattach-preview');
        } else {
          sidebar.classList.remove('reattach-preview');
        }
      });

      document.addEventListener('mouseup', function() {
        if (isDragging && isDetached) {
          // If released near left edge, reattach
          const rect = sidebar.getBoundingClientRect();
          if (rect.left < 100) {
            reattachSidebar();
          }
          sidebar.classList.remove('reattach-preview');
        }
        isDragging = false;
      });

      function detachSidebar() {
        isDetached = true;
        originalPosition.left = sidebar.offsetLeft;
        originalPosition.top = sidebar.offsetTop;
        sidebar.classList.add('detached');
        sidebar.style.left = originalPosition.left + 'px';
        sidebar.style.top = originalPosition.top + 'px';
        sidebar.style.width = sidebar.offsetWidth + 'px';
      }

      function reattachSidebar() {
        isDetached = false;
        sidebar.classList.remove('detached');
        sidebar.style.left = '0';
        sidebar.style.top = '0';
        sidebar.style.width = '250px';
        sidebar.style.height = '';
        sidebar.style.minHeight = '';
        sidebar.style.maxHeight = '';
        sidebar.style.resize = '';
        
        // Force reflow to ensure smooth transition
        void sidebar.offsetWidth;
      }

      // Dragging when detached
      dragHandle.addEventListener('mousedown', function(e) {
        if (!isDetached) return;
        e.preventDefault();
        isDragging = true;
        const rect = sidebar.getBoundingClientRect();
        dragOffsetX = e.clientX - rect.left;
        dragOffsetY = e.clientY - rect.top;
      });

      document.addEventListener('mousemove', function(e) {
        if (!isDragging || !isDetached) return;
        sidebar.style.left = (e.clientX - dragOffsetX) + 'px';
        sidebar.style.top = (e.clientY - dragOffsetY) + 'px';
      });

      document.addEventListener('mouseup', function() {
        isDragging = false;
      });

      // Panel controls functionality
      const minimizedPanels = document.getElementById('minimized-panels');
      const PANEL_SIZES_KEY = 'panelSizes';
      
      // Create minimized button for wishlist
      function createWishlistButton() {
        const btn = document.createElement('button');
        btn.className = 'minimized-panel-btn';
        btn.title = 'Show Wishlist';
        btn.textContent = 'W';
        btn.style.position = 'fixed';
        btn.style.right = '10px';
        btn.style.top = '10px';
        btn.onclick = function() {
          document.getElementById('wishlist-section').style.display = '';
          btn.remove();
        };
        document.body.appendChild(btn);
      }

      // Close panel handler
      document.addEventListener('click', function(e) {
        const closeBtn = e.target.closest('.panel-close');
        if (!closeBtn) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        const panelId = closeBtn.dataset.panel;
        const panel = document.getElementById(panelId === 'wishlist' ? 'wishlist-section' : panelId);
        if (!panel) return;
        
        panel.style.display = 'none';
        
        if (panelId === 'wishlist') {
          createWishlistButton();
        }
      });
    })();
  </script>
</body>
</html>
