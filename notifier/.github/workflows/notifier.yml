name: MMCS Notifier

on:
  schedule:
    # Run every minute
    - cron: '*/1 * * * *'
  # Allow manual triggering
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    timeout-minutes: 5  # Prevent long-running jobs
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'
      
      - name: Download dependencies
        working-directory: ./notifier
        run: go mod download
      
      - name: Build notifier
        working-directory: ./notifier
        run: go build -o notifier
      
      - name: Run notifier
        working-directory: ./notifier
        env:
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: timeout 240 ./notifier || true
        # Timeout after 4 minutes (allows one full cycle + buffer)
        # || true prevents failure if timeout triggers
