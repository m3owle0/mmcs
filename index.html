<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Multi-Market Secondhand Clothing Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <link rel="icon" type="image/png" href="miku.png">
  <style>
    :root {
      --theme-bg: #0a0a0a;
      --theme-text: #f0f0f0;
      --theme-accent: #444;
      --theme-highlight: #00e6d6;
      --theme-bg-image: none;
    }
    
    img[loading="lazy"] {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    img[loading="lazy"].loaded {
      opacity: 1;
    }

    /* Main Styles */
    html, body {
      height: 100%;
      background: var(--theme-bg) var(--theme-bg-image);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: var(--theme-text);
      min-height: 100vh;
      overflow: hidden;
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
    }
    .container {
      max-width: 900px;
      min-width: 350px;
      width: 100%;
      min-height: 350px;
      max-height: 98vh;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, rgba(20,20,20,0.98) 0%, rgba(15,15,15,0.98) 100%);
      padding: 25px 25px 25px 25px;
      border-radius: 20px;
      box-shadow: 
        0 20px 60px rgba(0,0,0,0.6),
        0 0 0 1px rgba(255,255,255,0.08),
        inset 0 1px 0 rgba(255,255,255,0.1);
      backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid rgba(255,255,255,0.15);
      z-index: 1001; /* Higher than top-header (1000) so drag handles aren't blocked */
      transition: all 0.4s cubic-bezier(0.2, 0.9, 0.1, 1.1);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      /* Ensure scrolling works on iOS */
      -webkit-overflow-scrolling: touch;
      will-change: transform, left, top; /* Optimize for smooth dragging */
    }
    
    .container.dragging {
      transition: none; /* Disable transitions while dragging for smoother movement */
    }
    
    /* Add safe area padding for iOS */
    @supports (padding-bottom: env(safe-area-inset-bottom)) {
      .container {
        padding-bottom: calc(25px + env(safe-area-inset-bottom));
      }
    }

    .container::-webkit-scrollbar {
      width: 6px;
    }

    .container::-webkit-scrollbar-track {
      background: rgba(30,32,34,0.5);
    }

    .container::-webkit-scrollbar-thumb {
      background: rgba(120,120,120,0.5);
      border-radius: 3px;
    }

    .container.minimized {
      overflow-y: hidden;
    }
    
    .container.minimized {
      width: 300px !important;
      height: 40px !important;
      min-height: 0;
      min-width: 300px;
      padding: 0;
      overflow: hidden;
      cursor: move;
      transform: none !important;
    }
    .container.minimized .panel-controls {
      display: none;
    }
    .container.minimized .resize-handle {
      pointer-events: none;
    }

    .sidebar.minimized {
      width: 300px !important;
      height: 40px !important;
      min-height: 0;
      min-width: 300px;
      padding: 0;
      overflow: hidden;
      cursor: move;
      transform: none !important;
    }
    .sidebar.minimized .panel-controls,
    .sidebar.minimized .resize-handle {
      display: none;
    }
    .sidebar.minimized .drag-handle::after {
      width: 30px;
    }

    .wishlist-section.minimized {
      width: 300px !important;
      height: 40px !important;
      min-height: 0;
      min-width: 300px;
      padding: 0;
      overflow: hidden;
      cursor: move;
      transform: none !important;
    }
    .wishlist-section.minimized .panel-controls,
    .wishlist-section.minimized .resize-handle {
      display: none;
    }
    .wishlist-section.minimized .drag-handle::after {
      width: 30px;
    }
    
    .container.minimized .drag-handle::after {
      opacity: 0.7;
    }
    
    .container.minimized h1 {
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: none;
    }
    
    .container:not(.minimized) h1 {
      transition: opacity 0.3s ease 0.1s;
    }
    .drag-handle {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      cursor: move;
      display: flex;
      justify-content: center;
      align-items: center;
      -webkit-user-select: none;
      user-select: none;
      z-index: 1001; /* Higher than top-header (1000) to ensure handles aren't blocked */
      pointer-events: auto;
      will-change: transform; /* Optimize for smooth dragging */
    }
    
    /* Hide drag handles on desktop - minimization buttons are in header */
    @media (min-width: 1200px) {
      .drag-handle {
        display: none !important;
      }
    }
    .drag-handle::after {
      content: '';
      width: 60px;
      height: 4px;
      background: rgba(120,120,120,0.4);
      border-radius: 2px;
      transition: background 0.2s;
    }
    .drag-handle:hover::after {
      background: rgba(160,160,160,0.6);
    }
    /* Remove margin-left/margin-right for large screens */
    @media (min-width: 1200px) {
      .container {
        margin-left: 0 !important;
        margin-right: 0 !important;
      }
    }
    h1, h2 {
      color: #e3e3e3;
      text-shadow: 0 2px 12px #2224;
    }
    h1 { margin-bottom: 12px; font-size: 1.8em; }
    h2 { font-size: 1.2em; margin-top: 24px; margin-bottom: 12px; display: inline-block; }
    .section-header-row { display: flex; align-items: center; gap: 10px; margin-top: 24px; margin-bottom: 12px; }
    .section-openall-btn {
      background: #232323;
      color: #e3e3e3;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: bold;
      padding: 7px 18px 8px 18px;
      cursor: pointer;
      letter-spacing: .01em;
      box-shadow: 0 2px 8px #2224;
      transition: background .18s, box-shadow .18s, transform .13s;
      margin-left: 0;
      margin-bottom: 2px;
      backdrop-filter: blur(2px);
      opacity: 0.93;
    }
    .section-openall-btn:hover {
      background: #444;
      color: #fff;
      box-shadow: 0 4px 16px #2226;
      transform: translateY(-2px) scale(1.04);
    }
    .tip { font-size: 13.5px; color: #b0b0b0; margin-bottom: 18px; line-height: 1.5; }
    .market-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 18px; }
    input[type="text"] {
      font-size: 18px;
      padding: 12px 14px;
      border-radius: 7px;
      border: 1.5px solid #2a2d2f;
      outline: none;
      background: rgba(30,32,34,0.93);
      color: #e3e3e3;
      transition: border .2s, background .18s;
      flex: 1 1 250px;
      min-width: 180px;
      box-shadow: 0 1.5px 8px #0002;
      backdrop-filter: blur(1.5px);
    }
    input[type="text"]:focus { border: 1.5px solid #888; background: rgba(40,42,44,0.98);}
    #clear-search:hover { color: #fff; }
    .markets { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 12px; 
      justify-content: flex-start;
      padding-right: 5px;
      margin-bottom: 8px;
    }
    .markets::-webkit-scrollbar {
      width: 6px;
    }
    .markets::-webkit-scrollbar-track {
      background: rgba(30,32,34,0.5);
    }
    .markets::-webkit-scrollbar-thumb {
      background: rgba(120,120,120,0.5);
      border-radius: 3px;
    }
    .market-btn {
      background: rgba(25,25,25,0.98);
      color: #e0e0e0;
      border: none;
      border-radius: 7px;
      padding: 10px 18px 10px 38px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      min-width: 125px;
      margin-bottom: 2px;
      margin-top: 2px;
      transition: all .18s;
      position: relative;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      backdrop-filter: blur(2px);
      opacity: 0.93;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .market-btn.disabled {
      opacity: 0.5;
      filter: grayscale(0.8);
    }
    .market-toggle {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: var(--theme-accent);
    }
    .market-btn:hover, #open-all-btn:hover {
      background: rgba(60,60,60,0.95);
      color: #fff;
      box-shadow: 
        0 6px 20px rgba(0,0,0,0.4),
        0 0 0 1px rgba(255,255,255,0.1);
      transform: translateY(-3px) scale(1.05);
      opacity: 1;
      transition: all 0.2s cubic-bezier(0.22, 1, 0.36, 1);
    }
    .market-remove-btn {
      position: absolute;
      right: 6px;
      top: 6px;
      background: rgba(30,32,34,0.7);
      border: none;
      color: #ff3b5c; /* keep trashcan accent */
      font-size: 1.1em;
      cursor: pointer;
      padding: 0 2px;
      border-radius: 3px;
      transition: color .17s, background .14s;
      z-index: 2;
      box-shadow: 0 1px 4px #0002;
    }
    .market-remove-btn:hover { color: #fff; background: #444; }
    .special-group {
      margin-top: 30px;
      margin-bottom: 18px;
      padding: 16px 12px 12px 12px;
      border: 1.5px solid #232323;
      border-radius: 12px;
      background: rgba(32,34,36,0.72);
      box-shadow: 0 2px 12px #0003;
      backdrop-filter: blur(4px);
    }
    .special-group-label {
      font-weight: bold;
      color: #e3e3e3;
      font-size: 1.11em;
      margin-bottom: 10px;
      display: block;
      letter-spacing: 0.01em;
      text-shadow: 0 1px 8px #2224;
    }
    #open-all-btn {
      background: #232323;
      color: #e3e3e3;
      border: none;
      border-radius: 10px;
      font-size: 17px;
      font-weight: bold;
      padding: 13px 28px;
      margin: 0 0 25px 0;
      cursor: pointer;
      letter-spacing: .02em;
      box-shadow: 0 4px 20px #2226;
      transition: background .18s, box-shadow .18s, transform .13s;
      display: block;
      width: 100%;
      max-width: 270px;
      opacity: 0.97;
      backdrop-filter: blur(2px);
    }
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 300px;
      min-width: 200px;
      max-width: 600px;
      height: 100vh;
      min-height: 400px;
      max-height: 100vh;
      background: rgba(15,15,15,0.98);
      border-right: 1px solid rgba(255,255,255,0.1);
      box-shadow: 2px 0 16px rgba(0,0,0,0.3);
      z-index: 1001; /* Higher than top-header (1000) so drag handles aren't blocked */
      padding: 15px 10px 15px 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      backdrop-filter: blur(7px);
      overflow-y: auto;
      transition: transform 0.3s ease, left 0.3s ease, top 0.3s ease;
      will-change: transform, left, top; /* Optimize for smooth dragging */
    }
    
    .sidebar.dragging {
      transition: none; /* Disable transitions while dragging for smoother movement */
    }

    .sidebar.detached {
      position: absolute;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.1);
      transform: none !important;
      cursor: move;
      height: auto;
      min-height: 300px;
      max-height: 90vh;
      resize: both;
      overflow: auto;
    }

    .sidebar.detached .resize-handle {
      display: none;
    }

    .sidebar.detached .drag-handle::after {
      background: var(--theme-highlight);
    }

    .sidebar.reattach-preview {
      box-shadow: 0 0 0 3px var(--theme-highlight);
      transition: box-shadow 0.2s ease;
    }

    .sidebar.minimized {
      overflow-y: hidden;
    }

    .sidebar::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar::-webkit-scrollbar-track {
      background: rgba(30,32,34,0.5);
    }

    .sidebar::-webkit-scrollbar-thumb {
      background: rgba(120,120,120,0.5);
      border-radius: 3px;
    }
    .resize-handle {
      position: absolute;
      z-index: 9999;
      background: transparent;
      transition: background 0.2s;
    }
    .resize-handle:hover {
      background: rgba(120, 120, 120, 0.2);
    }
    .resize-handle-right {
      top: 0;
      right: 0;
      width: 8px;
      height: 100%;
      cursor: ew-resize;
    }
    .resize-handle-left {
      top: 0;
      left: 0;
      width: 8px;
      height: 100%;
      cursor: ew-resize;
    }
    
    /* Prevent side handles from going under top header */
    @media (min-width: 1200px) {
      .sidebar .resize-handle-left,
      .sidebar .resize-handle-right {
        top: 50px; /* Start below top header (approximately 50px tall) */
        height: calc(100% - 50px); /* Adjust height to account for top header */
      }
      .wishlist-section .resize-handle-left {
        top: 50px; /* Start below top header */
        height: calc(100% - 50px); /* Adjust height to account for top header */
      }
      .container .resize-handle-left,
      .container .resize-handle-right {
        top: 50px; /* Start below top header */
        height: calc(100% - 50px); /* Adjust height to account for top header */
      }
    }
    .resize-handle-bottom {
      left: 0;
      bottom: 0;
      width: 100%;
      height: 8px;
      cursor: ns-resize;
    }
    .resize-handle-bottom-right,
    .resize-handle-bottom-left,
    .resize-handle-top-right,
    .resize-handle-top-left {
      width: 16px;
      height: 16px;
    }
    .resize-handle-bottom-right {
      right: 0;
      bottom: 0;
      cursor: nwse-resize;
    }
    .resize-handle-bottom-left {
      left: 0;
      bottom: 0;
      cursor: nesw-resize;
    }
    .resize-handle-top-right {
      right: 0;
      top: 0;
      cursor: nesw-resize;
    }
    .resize-handle-top-left {
      left: 0;
      top: 0;
      cursor: nwse-resize;
    }
    .resize-handle-horizontal {
      width: calc(100% - 20px);
      height: 8px;
      cursor: ns-resize;
      background: rgba(120, 120, 120, 0.1);
      border-radius: 4px;
      margin-left: 10px;
      transition: background 0.2s;
    }
    .resize-handle-horizontal:hover {
      background: rgba(120, 120, 120, 0.3);
    }
    .sidebar-title {
      font-size: 1.07em;
      color: #e3e3e3;
      font-weight: bold;
      margin-bottom: 7px;
      letter-spacing: 0.015em;
      text-shadow: 0 1px 8px #2224;
    }
    .sidebar-folder-row {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-bottom: 8px;
    }
    .sidebar-folder-input {
      flex: 1 1 auto;
      font-size: 1em;
      border: 1.5px solid #232323;
      border-radius: 5px;
      padding: 4.5px 9px;
      outline: none;
      transition: border .15s, background .14s;
      background: rgba(30,32,34,0.93);
      color: #e3e3e3;
    }
    .sidebar-folder-input:focus { border: 1.5px solid #888; background: rgba(40,42,44,0.98);}
    .sidebar-folder-btn {
      background: #232323;
      color: #e3e3e3;
      border: none;
      border-radius: 5px;
      font-size: 1.08em;
      font-weight: bold;
      cursor: pointer;
      padding: 4.5px 13px;
      transition: background .15s, box-shadow .15s, transform .13s;
      margin-bottom: 2px;
      box-shadow: 0 2px 8px #2224;
      opacity: 0.93;
      backdrop-filter: blur(1.5px);
    }
    .sidebar-folder-btn:hover { background: #444; box-shadow: 0 4px 16px #2226; transform: translateY(-1px) scale(1.04);}
    .saved-folder-list {
      list-style: none;
      padding: 0;
      margin: 0 0 12px 0;
      flex: 1 1 auto;
      min-height: 0;
      max-height: none;
      overflow-y: visible;
    }
    .saved-folder-item {
      margin-bottom: 3px;
      font-weight: bold;
      color: #e3e3e3;
      font-size: 1em;
      display: flex;
      align-items: center;
      gap: 4px;
      background:none;
      cursor: grab;
      user-select: none;
      border-radius: 4px;
      transition: background .13s;
    }
    .sidebar-folder-edit-btn, .sidebar-folder-remove-btn {
      border: none;
      background: none;
      color: #b0b0b0;
      font-size: 1em;
      cursor: pointer;
      padding: 0 2px;
      border-radius: 2px;
      transition: color .17s, background .14s;
    }
    .sidebar-folder-remove-btn { color: #ff3b5c; } /* keep trashcan accent */
    .sidebar-folder-edit-btn:hover, .sidebar-folder-remove-btn:hover { color: #ff3b5c; background: #2224; }
    .saved-searches-list {
      margin-left: 8px;
      min-height: 80px;
      max-height: none;
      overflow-y: visible;
      resize: none;
      scrollbar-width: thin;
      scrollbar-color: #888 #232323;
      background: rgba(44,46,48,0.15);
      border-radius: 6px;
      padding: 3px;
    }
    .sidebar-folder-active {
      background: #2224;
      border-radius: 4px;
      color: #fff;
    }
    .sidebar-folder-dragover {
      background: #444 !important;
      border-radius: 6px;
      color: #fff;
    }
    .sidebar-exp-btn, .sidebar-imp-btn {
      background: #232323;
      color: #e3e3e3;
      border: none;
      border-radius: 5px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      padding: 7px 13px;
      margin-right: 7px;
      transition: background .18s, box-shadow .18s, transform .13s;
      box-shadow: 0 1px 4px #2224;
      opacity: 0.93;
      backdrop-filter: blur(2px);
    }
    .randomize-section {
      margin-bottom: 15px;
    }
    .randomize-select {
      width: 100%;
      font-size: 1em;
      border: 1.5px solid #232323;
      border-radius: 5px;
      padding: 4.5px 9px 4.5px 28px;
      outline: none;
      transition: border .15s, background .14s;
      background: rgba(30,32,34,0.93);
      color: #e3e3e3;
      margin-bottom: 8px;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12' fill='none'%3E%3Cpath d='M3 4.5L6 7.5L9 4.5' stroke='%23e3e3e3' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
    }
    .randomize-select:focus { 
      border: 1.5px solid #888; 
      background: rgba(40,42,44,0.98);
    }
    /* Style options with colors */
    .randomize-select option[value="all"] {
      background-color: #6a0572;
      color: #ffffff;
    }
    .randomize-select option[value="asia"] {
      background-color: #ff6b6b;
      color: #121212;
    }
    .randomize-select option[value="international"] {
      background-color: #4ecdc4;
      color: #121212;
    }
    .randomize-select option[value="special"] {
      background-color: #ffe66d;
      color: #121212;
    }
    .sidebar-randomize-btn {
      background: #232323;
      color: #e3e3e3;
      border: none;
      border-radius: 5px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      padding: 7px 13px;
      width: 100%;
      transition: background .18s, box-shadow .18s, transform .13s;
      box-shadow: 0 1px 4px #2224;
      opacity: 0.93;
      backdrop-filter: blur(2px);
    }
    .sidebar-randomize-btn:hover,
    .sidebar-multi-search-btn:hover,
    .sidebar-multi-clear-btn:hover { 
      background: #444; 
      color: #fff; 
    }
    .sidebar-multi-search-btn,
    .sidebar-multi-clear-btn {
      background: #232323;
      color: #e3e3e3;
      border: none;
      border-radius: 5px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      padding: 7px 13px;
      transition: background .18s, box-shadow .18s, transform .13s;
      box-shadow: 0 1px 4px #2224;
      opacity: 0.93;
      backdrop-filter: blur(2px);
    }
    .randomize-select:focus { 
      border: 1.5px solid #888; 
      background: rgba(40,42,44,0.98);
    }
    .sidebar-exp-btn:hover, 
    .sidebar-imp-btn:hover,
    .sidebar-reset-btn:hover { 
      background: #444; 
      color: #fff; 
    }
    
    /* Mobile import/export button styles */
    @media (max-width: 768px) {
      .sidebar-exp-btn, .sidebar-imp-btn {
        padding: 10px 16px;
        font-size: 14px;
        margin: 0;
        width: 100%;
      }
    }
    .sidebar-reset-btn {
      background: #232323;
      color: #e3e3e3;
      border: none;
      border-radius: 5px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      padding: 7px 13px;
      margin-right: 7px;
      transition: background .18s, box-shadow .18s, transform .13s;
      box-shadow: 0 1px 4px #2224;
      opacity: 0.93;
      backdrop-filter: blur(2px);
    }
    .sidebar-imp-btn input[type="file"] { display: none; }
    .sidebar-divider {
      border: none;
      border-top: 1.5px solid #232323;
      margin: 12px 0;
    }
    /* Saved search items */
    .saved-search-item {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 4px;
      background: rgba(44,46,48,0.55);
      border-radius: 5px;
      padding: 3px 7px;
      transition: background .13s;
    }
    .saved-search-term {
      background: none;
      border: none;
      color: #e3e3e3;
      font-size: 0.95em;
      font-weight: 500;
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 3px;
      transition: background .13s, color .13s;
      flex: 1;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .search-term-checkbox {
      width: 16px;
      height: 16px;
      accent-color: var(--theme-highlight);
      cursor: pointer;
      flex-shrink: 0;
      margin: 0;
      padding: 0;
      display: block;
      opacity: 1;
      visibility: visible;
    }
    .search-term-text {
      flex: 1;
      text-align: left;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .saved-search-term:hover { background: #2224; color: #fff; }
    .saved-search-term.active {
      font-weight: bold;
    }
    .saved-search-term.active[data-category="asia"] {
      background: #ff6b6b;
      color: #121212;
      box-shadow: 0 0 10px rgba(255,107,107,0.5);
    }
    .saved-search-term.active[data-category="international"] {
      background: #4ecdc4;
      color: #121212;
      box-shadow: 0 0 10px rgba(78,205,196,0.5);
    }
    .saved-search-term.active[data-category="special"] {
      background: #ffe66d;
      color: #121212;
      box-shadow: 0 0 10px rgba(255,230,109,0.5);
    }
    .saved-search-term.active[data-category="all"] {
      background: #6a0572;
      color: #ffffff;
      box-shadow: 0 0 10px rgba(106,5,114,0.5);
    }
    .edit-btn, .remove-btn, .save-edit-btn, .cancel-edit-btn {
      background: none;
      border: none;
      color: #b0b0b0;
      font-size: 1em;
      cursor: pointer;
      padding: 0 2px;
      border-radius: 2px;
      transition: color .17s, background .14s;
    }
    .remove-btn { color: #ff3b5c; } /* keep trashcan accent */
    .edit-btn:hover, .remove-btn:hover, .save-edit-btn:hover, .cancel-edit-btn:hover { color: #ff3b5c; background: #2224; }
    
    /* Chat System Styles */
    #chat-widget {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 5000;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    
    /* Hide chat widget when site is locked */
    body.site-locked #chat-widget {
      display: none !important;
    }
    
    .chat-toggle-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00e6d6 0%, #00b8a8 100%);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(0, 230, 214, 0.4);
      transition: all 0.3s ease;
      position: relative;
    }
    
    .chat-toggle-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 30px rgba(0, 230, 214, 0.6);
    }
    
    .chat-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ff3b5c;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      border: 2px solid rgba(15, 15, 15, 0.95);
    }
    
    .chat-panel {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 380px;
      height: 600px;
      max-height: calc(100vh - 120px);
      background: rgba(20, 20, 20, 0.98);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(20px);
      z-index: 5001;
      transform: translateY(20px);
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s ease;
    }
    
    .chat-panel.open {
      transform: translateY(0);
      opacity: 1;
      pointer-events: all;
    }
    
    .chat-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(15, 15, 15, 0.5);
      border-radius: 18px 18px 0 0;
    }
    
    .chat-header h3 {
      margin: 0;
      color: #e3e3e3;
      font-size: 18px;
      font-weight: 600;
    }
    
    .chat-close-btn {
      background: none;
      border: none;
      color: #888;
      font-size: 28px;
      cursor: pointer;
      line-height: 1;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .chat-close-btn:hover {
      color: #fff;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      -webkit-overflow-scrolling: touch;
    }
    
    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }
    
    .chat-messages::-webkit-scrollbar-track {
      background: rgba(30, 32, 34, 0.5);
    }
    
    .chat-messages::-webkit-scrollbar-thumb {
      background: rgba(120, 120, 120, 0.5);
      border-radius: 3px;
    }
    
    .chat-message {
      display: flex;
      gap: 10px;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .chat-message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00e6d6 0%, #00b8a8 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
      flex-shrink: 0;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform 0.2s;
      overflow: hidden;
      background-size: cover;
      background-position: center;
    }
    
    .chat-message-avatar:hover {
      transform: scale(1.1);
    }
    
    .chat-message-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .chat-message-username {
      cursor: pointer;
      transition: color 0.2s;
    }
    
    .chat-message-username:hover {
      color: #00e6d6 !important;
    }
    
    .chat-message-content {
      flex: 1;
      min-width: 0;
    }
    
    .chat-message-header {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }
    
    .chat-message-username {
      color: #00e6d6;
      font-weight: 600;
      font-size: 14px;
    }
    
    .chat-message-time {
      color: #888;
      font-size: 11px;
    }
    
    .chat-message-text {
      color: #e3e3e3;
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
    }
    
    .chat-input-container {
      padding: 15px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      gap: 10px;
      background: rgba(15, 15, 15, 0.5);
      border-radius: 0 0 18px 18px;
    }
    
    .chat-input {
      flex: 1;
      background: rgba(30, 32, 34, 0.93);
      border: 1.5px solid #2a2d2f;
      color: #e3e3e3;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 14px;
      outline: none;
      box-sizing: border-box;
    }
    
    .chat-input:focus {
      border-color: rgba(0, 230, 214, 0.55);
      background: rgba(40, 42, 44, 0.98);
    }
    
    .chat-send-btn {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      background: linear-gradient(135deg, #00e6d6 0%, #00b8a8 100%);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    
    .chat-send-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 230, 214, 0.4);
    }
    
    .chat-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Profile Modal Styles */
    .profile-modal-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100000;
    }
    
    .profile-modal-bg.show {
      display: flex !important;
    }
    
    .profile-modal {
      background: rgba(20, 20, 20, 0.98);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 18px;
      padding: 32px;
      width: min(400px, 90vw);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
      text-align: center;
    }
    
    .profile-modal-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      margin: 0 auto 20px;
      background: linear-gradient(135deg, #00e6d6 0%, #00b8a8 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 48px;
      text-transform: uppercase;
      overflow: hidden;
      background-size: cover;
      background-position: center;
      border: 3px solid rgba(0, 230, 214, 0.3);
    }
    
    .profile-modal-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .profile-modal-username {
      color: #e3e3e3;
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .profile-modal-info {
      color: #b0b0b0;
      font-size: 14px;
      margin: 8px 0;
    }
    
    .profile-modal-info-label {
      color: #888;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 20px;
    }
    
    .profile-modal-description-container {
      margin: 20px 0;
      text-align: left;
    }
    
    .profile-modal-description {
      color: #b0b0b0;
      font-size: 14px;
      line-height: 1.6;
      padding: 12px;
      background: rgba(30, 32, 34, 0.5);
      border-radius: 8px;
      min-height: 40px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .profile-modal-description.empty {
      color: #666;
      font-style: italic;
    }
    
    .profile-modal-description-edit {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      background: rgba(30, 32, 34, 0.8);
      border: 1.5px solid #2a2d2f;
      border-radius: 8px;
      color: #e3e3e3;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      outline: none;
      box-sizing: border-box;
    }
    
    .profile-modal-description-edit:focus {
      border-color: rgba(0, 230, 214, 0.55);
      background: rgba(40, 42, 44, 0.98);
    }
    
    .profile-modal-description-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      justify-content: flex-end;
    }
    
    .profile-description-save-btn,
    .profile-description-cancel-btn {
      padding: 6px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    
    .profile-description-save-btn {
      background: #00e6d6;
      color: #0a0a0a;
    }
    
    .profile-description-save-btn:hover {
      background: #00d4c4;
      transform: translateY(-1px);
    }
    
    .profile-description-cancel-btn {
      background: rgba(60, 60, 60, 0.8);
      color: #e3e3e3;
    }
    
    .profile-description-cancel-btn:hover {
      background: rgba(80, 80, 80, 0.9);
    }
    
    .profile-description-edit-btn {
      margin-top: 8px;
      padding: 6px 16px;
      background: rgba(0, 230, 214, 0.2);
      color: #00e6d6;
      border: 1px solid rgba(0, 230, 214, 0.3);
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .profile-description-edit-btn:hover {
      background: rgba(0, 230, 214, 0.3);
      border-color: rgba(0, 230, 214, 0.5);
    }
    
    .profile-modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: #888;
      font-size: 28px;
      cursor: pointer;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .profile-modal-close:hover {
      color: #fff;
      background: rgba(255, 255, 255, 0.1);
    }
    
    /* Profile Picture Selection */
    .profile-picture-selector {
      position: relative;
      display: inline-block;
      cursor: pointer;
    }
    
    .header-discord-notifications-btn {
      background: linear-gradient(135deg, #5865F2 0%, #4752C4 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 10px;
      box-shadow: 0 2px 8px rgba(88, 101, 242, 0.4);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .header-discord-notifications-btn:hover {
      background: linear-gradient(135deg, #4752C4 0%, #3C45A5 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(88, 101, 242, 0.5);
    }
    
    .header-profile-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00e6d6 0%, #00b8a8 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 16px;
      text-transform: uppercase;
      overflow: hidden;
      background-size: cover;
      background-position: center;
      border: 2px solid rgba(255,255,255,0.2);
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 10px;
      flex-shrink: 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    
    .header-profile-avatar:hover {
      transform: scale(1.1);
      border-color: rgba(0, 230, 214, 0.6);
      box-shadow: 0 3px 10px rgba(0, 230, 214, 0.4);
    }
    
    .header-profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    /* Discord Notifications Feature Banner */
    .discord-feature-banner {
      background: linear-gradient(135deg, rgba(88, 101, 242, 0.15) 0%, rgba(71, 82, 196, 0.15) 100%);
      border: 2px solid rgba(88, 101, 242, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      display: flex;
      align-items: center;
      gap: 20px;
      box-shadow: 0 4px 16px rgba(88, 101, 242, 0.2);
    }
    
    .discord-feature-icon {
      font-size: 48px;
      flex-shrink: 0;
    }
    
    .discord-feature-content {
      flex: 1;
    }
    
    .discord-feature-title {
      color: #5865F2;
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    
    .discord-feature-description {
      color: #e3e3e3;
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 12px;
    }
    
    .discord-feature-benefits {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .discord-feature-benefit {
      background: rgba(88, 101, 242, 0.2);
      color: #b0d4ff;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .discord-feature-cta {
      background: linear-gradient(135deg, #5865F2 0%, #4752C4 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(88, 101, 242, 0.4);
    }
    
    .discord-feature-cta:hover {
      background: linear-gradient(135deg, #4752C4 0%, #3C45A5 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(88, 101, 242, 0.5);
    }
    
    /* Market selection styling */
    #notification-markets-select option {
      padding: 6px 8px;
      cursor: pointer;
    }
    
    #notification-markets-select option:hover {
      background: rgba(88, 101, 242, 0.3);
    }
    
    #notification-markets-select option:checked {
      background: rgba(88, 101, 242, 0.5);
      color: white;
      font-weight: bold;
    }
    
  /* Premium Upgrade Banner */
  .premium-upgrade-banner {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 193, 7, 0.15) 100%);
    border: 2px solid rgba(255, 215, 0, 0.4);
    border-radius: 12px;
    padding: 16px 20px;
    margin: 15px 0;
    display: none;
    align-items: center;
    justify-content: space-between;
    gap: 15px;
    animation: slideInDown 0.5s ease;
  }
  
  .premium-upgrade-banner.show {
    display: flex;
  }
  
  .premium-upgrade-content {
    flex: 1;
  }
  
  .premium-upgrade-title {
    color: #ffd700;
    font-weight: bold;
    font-size: 16px;
    margin-bottom: 5px;
  }
  
  .premium-upgrade-text {
    color: #e3e3e3;
    font-size: 13px;
  }
  
  .premium-upgrade-btn {
    background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
    color: #0a0a0a;
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  
  .premium-upgrade-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
  }
  
  /* Premium Badge */
  .premium-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 193, 7, 0.2) 100%);
    border: 1px solid rgba(255, 215, 0, 0.4);
    color: #ffd700;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: bold;
    margin-left: 8px;
  }
  
  /* Donation Buttons */
  .donation-button {
    background: linear-gradient(135deg, #00e6d6 0%, #00b8a8 100%);
    color: #0a0a0a;
    border: none;
    border-radius: 8px;
    padding: 8px 16px;
    font-weight: bold;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  
  .donation-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 230, 214, 0.4);
  }
  
  .donation-button.secondary {
    background: rgba(0, 230, 214, 0.2);
    color: #00e6d6;
    border: 1px solid #00e6d6;
  }
  
  .donation-button.secondary:hover {
    background: rgba(0, 230, 214, 0.3);
  }
  
  /* Upgrade Modal */
  .upgrade-modal-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(5px);
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
  }
  
  .upgrade-modal-bg.show {
    display: flex;
  }
  
  .upgrade-modal {
    background: rgba(32, 34, 36, 0.98);
    border-radius: 18px;
    padding: 30px;
    max-width: 600px;
    width: 90vw;
    max-height: 90vh;
    overflow-y: auto;
    border: 2px solid rgba(255, 215, 0, 0.3);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
  }
  
  .upgrade-modal-header {
    text-align: center;
    margin-bottom: 25px;
  }
  
  .upgrade-modal-title {
    color: #ffd700;
    font-size: 28px;
    font-weight: bold;
    margin-bottom: 10px;
  }
  
  .upgrade-modal-subtitle {
    color: #b0b0b0;
    font-size: 14px;
  }
  
  .upgrade-features {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 25px 0;
  }
  
  .upgrade-feature {
    background: rgba(255, 215, 0, 0.05);
    border: 1px solid rgba(255, 215, 0, 0.2);
    border-radius: 10px;
    padding: 15px;
  }
  
  .upgrade-feature-icon {
    font-size: 24px;
    margin-bottom: 8px;
  }
  
  .upgrade-feature-title {
    color: #ffd700;
    font-weight: bold;
    font-size: 14px;
    margin-bottom: 5px;
  }
  
  .upgrade-feature-text {
    color: #b0b0b0;
    font-size: 12px;
    line-height: 1.5;
  }
  
  .upgrade-pricing {
    background: rgba(0, 230, 214, 0.1);
    border: 1px solid rgba(0, 230, 214, 0.3);
    border-radius: 12px;
    padding: 20px;
    margin: 25px 0;
    text-align: center;
  }
  
  .upgrade-pricing-title {
    color: #00e6d6;
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 10px;
  }
  
  .upgrade-pricing-amount {
    color: #ffd700;
    font-size: 32px;
    font-weight: bold;
    margin-bottom: 5px;
  }
  
  .upgrade-pricing-note {
    color: #888;
    font-size: 12px;
  }
  
  .upgrade-modal-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 25px;
  }
  
  .upgrade-modal-btn {
    padding: 12px 24px;
    border-radius: 10px;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
  }
  
  .upgrade-modal-btn.primary {
    background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
    color: #0a0a0a;
  }
  
  .upgrade-modal-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
  }
  
  .upgrade-modal-btn.secondary {
    background: rgba(60, 60, 60, 0.8);
    color: #e3e3e3;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .upgrade-modal-btn.secondary:hover {
    background: rgba(80, 80, 80, 0.9);
  }
  
  .upgrade-modal-close {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    color: #888;
    font-size: 28px;
    cursor: pointer;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s;
  }
  
  .upgrade-modal-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #e3e3e3;
  }
  
  /* Subscription Tiers */
  .subscription-tiers {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 25px 0;
  }
  
  .subscription-tier {
    background: rgba(35, 35, 35, 0.8);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s;
    cursor: pointer;
    position: relative;
  }
  
  .subscription-tier:hover {
    border-color: rgba(0, 230, 214, 0.5);
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 230, 214, 0.2);
  }
  
  .subscription-tier.recommended {
    border-color: rgba(255, 215, 0, 0.6);
    background: rgba(255, 215, 0, 0.05);
  }
  
  .subscription-tier.recommended::before {
    content: '⭐ Recommended';
    position: absolute;
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
    color: #0a0a0a;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: bold;
  }
  
  .subscription-tier.current {
    border-color: rgba(0, 230, 214, 0.8);
    background: rgba(0, 230, 214, 0.1);
  }
  
  .subscription-tier-name {
    color: #e3e3e3;
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 10px;
  }
  
  .subscription-tier-price {
    color: #ffd700;
    font-size: 28px;
    font-weight: bold;
    margin-bottom: 5px;
  }
  
  .subscription-tier-period {
    color: #888;
    font-size: 12px;
    margin-bottom: 15px;
  }
  
  .subscription-tier-features {
    text-align: left;
    margin-top: 15px;
  }
  
  .subscription-tier-feature {
    color: #b0b0b0;
    font-size: 12px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .subscription-tier-feature::before {
    content: '✓';
    color: #00e6d6;
    font-weight: bold;
  }
  
  .subscription-payment-methods {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 20px;
  }
  
  .subscription-payment-btn {
    padding: 12px 20px;
    border-radius: 8px;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  .subscription-payment-btn.stripe {
    background: linear-gradient(135deg, #635BFF 0%, #5A52FF 100%);
    color: white;
  }
  
  .subscription-payment-btn.stripe:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 91, 255, 0.4);
  }
  
  .subscription-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    margin-bottom: 15px;
  }
  
  .subscription-status-badge.active {
    background: rgba(0, 230, 214, 0.2);
    color: #00e6d6;
    border: 1px solid rgba(0, 230, 214, 0.4);
  }
  
  .subscription-status-badge.trial {
    background: rgba(255, 230, 109, 0.2);
    color: #ffe66d;
    border: 1px solid rgba(255, 230, 109, 0.4);
  }
  
  .subscription-status-badge.expired {
    background: rgba(255, 107, 107, 0.2);
    color: #ff6b6b;
    border: 1px solid rgba(255, 107, 107, 0.4);
  }
  
  @keyframes slideInDown {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @media (max-width: 768px) {
    .discord-feature-banner {
      flex-direction: column;
      text-align: center;
    }
    
    .premium-upgrade-banner {
      flex-direction: column;
      text-align: center;
    }
    
    .upgrade-features {
      grid-template-columns: 1fr;
    }
    
    .upgrade-modal-actions {
      flex-direction: column;
    }
    
    .header-discord-notifications-btn {
        font-size: 12px;
        padding: 6px 12px;
      }
    }
    
    .profile-picture-btn {
      background: rgba(0, 230, 214, 0.2);
      color: #00e6d6;
      border: 1px solid #00e6d6;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: 10px;
    }
    
    .profile-picture-btn:hover {
      background: rgba(0, 230, 214, 0.3);
      transform: translateY(-1px);
    }
    
    .profile-picture-input {
      display: none;
    }
    
    /* Users List Modal Styles */
    .users-list-modal-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(10,10,10,0.65);
      z-index: 3000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(2.5px);
    }
    
    .users-list-modal-bg.show {
      display: flex !important;
    }
    
    .users-list-modal {
      background: rgba(32,34,36, 0.98);
      border-radius: 18px;
      box-shadow: 0 8px 32px #000a, 0 1.5px 0 #232323;
      padding: 28px 22px 18px 22px;
      max-width: 600px;
      max-height: 85vh;
      width: 96vw;
      position: relative;
      border: 1.5px solid #232323;
      backdrop-filter: blur(7px) saturate(1.2);
      cursor: default;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    
    .users-list-modal-title {
      color: #e3e3e3;
      font-size: 1.3em;
      font-weight: bold;
      margin: 0 0 8px 0;
      text-align: center;
      text-shadow: 0 1px 4px #2224;
    }
    
    .users-list-total {
      color: #b0b0b0;
      font-size: 0.9em;
      text-align: center;
      margin: 0 0 18px 0;
      padding: 8px;
      background: rgba(35, 35, 35, 0.4);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .users-list-modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(35,35,35,0.8);
      border: 1px solid rgba(255,255,255,0.1);
      color: #e3e3e3;
      font-size: 20px;
      cursor: pointer;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
      padding: 0;
      line-height: 1;
    }
    
    .users-list-modal-close:hover {
      background: rgba(60,60,60,0.9);
      color: #fff;
      border-color: rgba(255,255,255,0.2);
    }
    
    .users-list-content {
      overflow-y: auto;
      flex: 1;
      min-height: 200px;
      max-height: calc(85vh - 120px);
      padding-right: 4px;
    }
    
    .users-list-content::-webkit-scrollbar {
      width: 6px;
    }
    
    .users-list-content::-webkit-scrollbar-track {
      background: rgba(30,32,34,0.5);
    }
    
    .users-list-content::-webkit-scrollbar-thumb {
      background: rgba(120,120,120,0.4);
      border-radius: 3px;
    }
    
    .users-list-content::-webkit-scrollbar-thumb:hover {
      background: rgba(140,140,140,0.5);
    }
    
    .users-list-loading {
      text-align: center;
      color: #b0b0b0;
      padding: 40px;
      font-size: 14px;
    }
    
    .user-list-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      margin-bottom: 8px;
      background: rgba(44,46,48,0.55);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    
    .user-list-item:hover {
      background: rgba(54,56,58,0.75);
      border-color: rgba(255,255,255,0.15);
      transform: translateX(4px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    
    .user-list-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00e6d6 0%, #00b8a8 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 22px;
      text-transform: uppercase;
      overflow: hidden;
      background-size: cover;
      background-position: center;
      border: 2px solid rgba(255,255,255,0.2);
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .user-list-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .user-list-info {
      flex: 1;
      min-width: 0;
    }
    
    .user-list-name {
      color: #e3e3e3;
      font-size: 15px;
      font-weight: 500;
      margin-bottom: 5px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .user-list-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }
    
    .user-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    .user-status-dot.online {
      background: #00e6d6;
      box-shadow: 0 0 6px rgba(0, 230, 214, 0.6);
      animation: pulse 2s infinite;
    }
    
    .user-status-dot.offline {
      background: #666;
    }
    
    .user-status-text {
      color: #b0b0b0;
      font-size: 12px;
    }
    
    .user-status-text.online {
      color: #00e6d6;
      font-weight: 500;
    }
    
    .users-list-empty {
      text-align: center;
      color: #888;
      padding: 40px;
      font-size: 14px;
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
      .users-list-modal {
        max-width: 95vw;
        max-height: 90vh;
        padding: 20px 15px 15px 15px;
      }
      
      .users-list-modal-title {
        font-size: 1.2em;
        margin-bottom: 15px;
      }
      
      .user-list-item {
        padding: 10px 12px;
      }
      
      .user-list-avatar {
        width: 44px;
        height: 44px;
        font-size: 20px;
      }
    }
    
    /* Mobile chat styles */
    @media (max-width: 768px) {
      .chat-panel {
        width: calc(100vw - 40px);
        height: calc(100vh - 100px);
        right: 20px;
        left: 20px;
        bottom: 80px;
      }
      
      .chat-toggle-btn {
        width: 56px;
        height: 56px;
      }
      
      .profile-modal {
        padding: 24px;
      }
      
      .profile-modal-avatar {
        width: 100px;
        height: 100px;
        font-size: 40px;
      }
    }
    
    /* Modal styling: always centered and above everything */
    .custom-market-modal-bg {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(10,10,10,0.65);
      z-index: 3000;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(2.5px);
    }
    .custom-market-modal {
      background: rgba(32,34,36, 0.98);
      border-radius: 18px;
      box-shadow: 0 8px 32px #000a, 0 1.5px 0 #232323;
      padding: 28px 22px 18px 22px;
      max-width: 350px;
      width: 96vw;
      position: absolute;
      border: 1.5px solid #232323;
      backdrop-filter: blur(7px) saturate(1.2);
      cursor: default;
      transition: transform 0.3s ease, left 0.3s ease, top 0.3s ease;
      will-change: transform, left, top; /* Optimize for smooth dragging */
    }
    
    .custom-market-modal.dragging {
      transition: none; /* Disable transitions while dragging for smoother movement */
    }
    .custom-market-modal .drag-handle {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      cursor: move;
    }
    .custom-market-modal h3 {
      margin-top: 0;
      font-size: 1.17em;
      color: #e3e3e3;
      margin-bottom: 10px;
      font-weight: bold;
      letter-spacing: 0.01em;
      text-shadow: 0 1px 8px #2224;
    }
    .custom-market-modal label {
      display: block;
      margin-top: 12px;
      margin-bottom: 2px;
      color: #e3e3e3;
      font-weight: bold;
      font-size: 1em;
    }
    .custom-market-modal input[type="text"] {
      width: 100%;
      font-size: 1.07em;
      margin-bottom: 9px;
      padding: 7px 9px;
      border-radius: 5px;
      border: 1.5px solid #232323;
      outline: none;
      transition: border .16s, background .14s;
      background: rgba(30,32,34,0.93);
      color: #e3e3e3;
    }
    .custom-market-modal input[type="text"]:focus { border: 1.5px solid #888; background: rgba(40,42,44,0.98);}
    .custom-market-modal .modal-btn-row {
      display: flex;
      gap: 11px;
      margin-top: 18px;
      justify-content: flex-end;
    }
    .custom-market-modal .modal-btn {
      background: #232323;
      color: #e3e3e3;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      padding: 8px 22px;
      transition: background .18s, box-shadow .18s, transform .13s;
      box-shadow: 0 2px 8px #2224;
      opacity: 0.93;
      backdrop-filter: blur(1.5px);
    }
    .custom-market-modal .modal-btn:hover { background: #444; box-shadow: 0 4px 16px #2226; transform: translateY(-1px) scale(1.04);}
    .custom-market-modal .modal-cancel-btn {
      background: #232323;
      color: #e3e3e3;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      padding: 8px 22px;
      transition: background .14s, color .14s;
      opacity: 0.93;
      backdrop-filter: blur(1.5px);
    }
    .custom-market-modal .modal-cancel-btn:hover { background: #2224; color: #fff; }
    .custom-market-modal .modal-tip {
      color: #b0b0b0;
      font-size: 13px;
      margin-top: 2px;
      margin-bottom: 7px;
    }
    .custom-market-modal .modal-section-label {
      font-size: 1.01em;
      color: #e3e3e3;
      margin-bottom: 8px;
      margin-top: 2px;
      font-weight: bold;
    }
    /* Site List Modal */
    .site-list-modal-bg {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(10,10,10,0.65);
      z-index: 3000;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(2.5px);
    }
    .site-list-modal {
      background: rgba(32,34,36, 0.98);
      border-radius: 18px;
      box-shadow: 0 8px 32px #000a, 0 1.5px 0 #232323;
      padding: 28px 22px 18px 22px;
      max-width: 600px;
      max-height: 85vh;
      width: 96vw;
      position: absolute;
      border: 1.5px solid #232323;
      backdrop-filter: blur(7px) saturate(1.2);
      cursor: default;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease, left 0.3s ease, top 0.3s ease;
      will-change: transform, left, top; /* Optimize for smooth dragging */
    }
    
    .site-list-modal.dragging {
      transition: none; /* Disable transitions while dragging for smoother movement */
    }
    .site-list-modal .drag-handle {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      cursor: move;
    }
    .site-list-modal h3 {
      margin-top: 0;
      font-size: 1.17em;
      color: #e3e3e3;
      margin-bottom: 15px;
      font-weight: bold;
      letter-spacing: 0.01em;
      text-shadow: 0 1px 8px #2224;
    }
    .site-list-content {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 15px;
    }
    .site-list-section {
      margin-bottom: 20px;
    }
    .site-list-section-title {
      font-size: 1.05em;
      color: #e3e3e3;
      margin-bottom: 10px;
      font-weight: bold;
      padding-bottom: 5px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .site-list-items {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .site-list-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: rgba(30,32,34,0.7);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      transition: background 0.2s, border-color 0.2s;
    }
    .site-list-item:hover {
      background: rgba(40,42,44,0.8);
      border-color: rgba(255,255,255,0.2);
    }
    .site-list-item.disabled {
      opacity: 0.5;
    }
    .site-list-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #666;
      flex-shrink: 0;
    }
    .site-list-item-label {
      flex: 1;
      color: #e3e3e3;
      font-size: 14px;
      cursor: pointer;
      user-select: none;
    }
    .site-list-item-actions {
      display: flex;
      gap: 5px;
      align-items: center;
    }
    .site-list-item-edit-btn,
    .site-list-item-remove-btn {
      background: rgba(35,35,35,0.8);
      border: 1px solid rgba(255,255,255,0.1);
      color: #e3e3e3;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s;
    }
    .site-list-item-edit-btn:hover {
      background: rgba(60,60,60,0.9);
    }
    .site-list-item-remove-btn:hover {
      background: rgba(200,60,60,0.9);
    }
    .site-list-item-custom-badge {
      font-size: 11px;
      color: #00e6d6;
      font-weight: bold;
      margin-left: 5px;
    }
    .site-list-modal .modal-btn-row {
      display: flex;
      gap: 11px;
      margin-top: 10px;
      justify-content: flex-end;
      flex-shrink: 0;
    }
    .site-list-modal .modal-btn {
      background: #232323;
      color: #e3e3e3;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      padding: 8px 22px;
      transition: background .18s, box-shadow .18s, transform .13s;
      box-shadow: 0 2px 8px #2224;
      opacity: 0.93;
      backdrop-filter: blur(1.5px);
    }
    .site-list-modal .modal-btn:hover {
      background: #444;
      box-shadow: 0 4px 16px #2226;
      transform: translateY(-1px) scale(1.04);
    }
    /* Add website buttons */
    .add-market-row {
      display: flex;
      gap: 12px;
      margin-bottom: 2px;
      align-items: center;
      margin-top: 4px;
      margin-left: 1px;
      margin-right: 1px;
    }
    .add-market-btn {
      background: #232323;
      color: #e3e3e3;
      border: none;
      border-radius: 7px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      padding: 9px 16px;
      min-width: 125px;
      margin-bottom: 2px;
      margin-top: 2px;
      transition: background .18s, box-shadow .18s, transform .13s;
      box-shadow: 0 1px 4px #2224;
      opacity: 0.93;
      backdrop-filter: blur(2px);
    }
    .add-market-btn:hover { background: #444; color: #fff; box-shadow: 0 4px 16px #2226; transform: translateY(-1px) scale(1.04);}
    /* Wishlist styles (dark mode) */
    .wishlist-section {
      position: fixed;
      right: 0;
      top: 0;
      width: 370px;
      min-width: 200px;
      max-width: 600px;
      height: 100vh;
      min-height: 400px;
      max-height: 100vh;
      background: rgba(15,15,15,0.98);
      border-left: 1px solid rgba(255,255,255,0.1);
      box-shadow: -2px 0 16px rgba(0,0,0,0.3);
      z-index: 1001; /* Higher than top-header (1000) so drag handles aren't blocked */
      padding: 24px 15px 18px 18px;
      display: flex;
      flex-direction: column;
      gap: 13px;
      backdrop-filter: blur(7px);
      will-change: transform, left, top; /* Optimize for smooth dragging */
    }
    
    .wishlist-section.dragging {
      transition: none; /* Disable transitions while dragging for smoother movement */
    }
    .resize-handle {
      position: absolute;
      z-index: 9999;
      background: transparent;
    }
    .resize-handle-right {
      top: 0; right: 0; width: 8px; height: 100%;
      cursor: ew-resize;
    }
    .resize-handle-left {
      top: 0; left: 0; width: 8px; height: 100%;
      cursor: ew-resize;
    }
    .resize-handle-bottom-right {
      right: 0; bottom: 0; width: 16px; height: 16px;
      cursor: nwse-resize;
    }
    .wishlist-title {
      font-size: 1.10em;
      color: #e3e3e3;
      font-weight: bold;
      margin-bottom: 8px;
      letter-spacing: 0.015em;
      text-shadow: 0 1px 8px #2224;
    }
    .wishlist-add-row {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-bottom: 8px;
    }
    .wishlist-add-input {
      flex: 1 1 auto;
      font-size: 1em;
      border: 1.5px solid #232323;
      border-radius: 5px;
      padding: 4.5px 9px;
      outline: none;
      transition: border .15s, background .14s;
      background: rgba(30,32,34,0.93);
      color: #e3e3e3;
    }
    .wishlist-add-input:focus { border: 1.5px solid #888; background: rgba(40,42,44,0.98);}
    .wishlist-add-btn {
      background: #232323;
      color: #e3e3e3;
      border: none;
      border-radius: 5px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      padding: 4.5px 14px;
      transition: background .15s, box-shadow .15s, transform .13s;
      box-shadow: 0 2px 8px #2224;
      opacity: 0.93;
      backdrop-filter: blur(1.5px);
    }
    .wishlist-add-btn:hover { background: #444; box-shadow: 0 4px 16px #2226; transform: translateY(-1px) scale(1.04);}
    .wishlist-list {
      list-style: none;
      padding: 0;
      margin: 0 0 12px 0;
      max-height: 74vh;
      overflow-y: auto;
    }
    .wishlist-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 9px;
      background: rgba(44,46,48,0.55);
      border-radius: 8px;
      padding: 7px 9px 7px 9px;
      border-left: 4px solid #888;
      box-shadow: 0 1px 5px #2224;
      word-break: break-all;
      font-size: 0.97em;
      position: relative;
      transition: background .13s;
    }
    .wishlist-link {
      color: #e3e3e3;
      text-decoration: underline;
      font-weight: bold;
      margin-right: 5px;
      word-break: break-all;
      max-width: 170px;
      display: inline-block;
      vertical-align: middle;
    }
    .wishlist-title-text {
      color: #e3e3e3;
      font-size: 1em;
      font-weight: 500;
      margin-right: 6px;
      max-width: 170px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: inline-block;
      vertical-align: middle;
      cursor: pointer;
      border: none;
      background: transparent;
      outline: none;
      transition: color .13s;
    }
    .wishlist-title-text:hover { color: #fff; }
    .wishlist-title-input {
      color: #e3e3e3;
      font-size: 1em;
      font-weight: 500;
      margin-right: 6px;
      max-width: 170px;
      min-width: 20px;
      border: 1.5px solid #888;
      border-radius: 4px;
      padding: 1px 5px;
      vertical-align: middle;
      outline: none;
      background: #232323;
    }
    .wishlist-remove-btn {
      background: none;
      border: none;
      color: #ff3b5c; /* keep trashcan accent */
      font-size: 1.18em;
      cursor: pointer;
      padding: 0 3px;
      border-radius: 2px;
      transition: color .17s, background .14s;
      align-self: flex-start;
      margin-left: 5px;
    }
    .wishlist-remove-btn:hover { color: #fff; background: #2224; }
    .wishlist-tip {
      color: #888;
      font-size: 12px;
      padding-left: 2px;
      margin-bottom: 0;
      margin-top: 8px;
      opacity: 0.8;
    }
    
    .wishlist-mascot {
      position: absolute;
      right: 0;
      bottom: 0;
      width: 180px;
      height: 180px;
      pointer-events: none;
      z-index: 1;
      transform-origin: bottom right;
      transition: transform 0.3s ease;
    }
    .wishlist-mascot:hover,
    .wishlist-section:hover .wishlist-mascot {
      transform: translateY(-5px);
      filter: brightness(1.1);
    }
    @keyframes float {
      0%, 100% { transform: translateY(-8px) scale(1.05); }
      50% { transform: translateY(-12px) scale(1.06); }
    }
    .panel-controls {
      position: absolute;
      top: 5px;
      right: 5px;
      z-index: 1000;
    }
    .panel-close {
      background: rgba(32,34,36,0.8);
      border: 1px solid rgba(255,255,255,0.1);
      color: #e3e3e3;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .panel-close:hover {
      background: rgba(255,60,60,0.3);
      transform: scale(1.1);
    }
    
    /* Mobile menu toggle button - hidden by default */
    .mobile-menu-toggle {
      display: none;
    }
    
    /* Ensure mobile sidebar is hidden on desktop */
    @media (min-width: 769px) {
      .mobile-sidebar,
      .mobile-sidebar-overlay,
      .mobile-menu-toggle {
        display: none !important;
      }
    }

    /* Minimized Panel Buttons */
    .minimized-panels {
      position: fixed;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      z-index: 999;
    }
    .minimized-panel-btn {
      background: rgba(32,34,36,0.8);
      border: 1px solid rgba(255,255,255,0.1);
      color: #e3e3e3;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      font-size: 12px;
    }
    .minimized-panel-btn:hover {
      background: rgba(100,220,255,0.3);
      transform: scale(1.1);
    }
    /* Resizing visual feedback */
    .resizing {
      box-shadow: 0 0 0 2px rgba(120,120,120,0.3);
      transition: none;
    }
    /* Mobile-specific styles - Enhanced for better aesthetics */
    @media (max-width: 768px) {
      /* Fix background for mobile */
      html, body {
        background: var(--theme-bg) !important;
        background-size: cover !important;
        background-position: center !important;
        background-attachment: fixed !important;
        overflow-x: hidden !important;
        height: 100% !important;
      }
      
      /* Improve top header for mobile - reposition to bottom */
      .top-header {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 10px 15px;
        background: rgba(15,15,15,0.95);
        backdrop-filter: blur(12px);
        border-top: 1px solid rgba(255,255,255,0.1);
        z-index: 1001;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
      }
      
      .header-left {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        width: 100%;
        max-width: 100%;
      }
      
      .donation-link {
        padding: 8px 12px;
        font-size: 12px;
        border-radius: 8px;
        flex: 1;
        min-width: 0;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px;
      }
      
      .donation-link.discord {
        order: -1; /* Make Discord first */
        max-width: 120px;
      }
      
      .donation-link.cashapp {
        max-width: 140px;
      }
      
      .donation-link.bitcoin {
        max-width: 140px;
      }
      
      .online-users-count {
        display: none;
      }
      
      .header-right {
        display: none;
      }
      
      /* Adjust container to account for bottom header */
      .container {
        padding-bottom: 80px !important; /* Add space for bottom header */
      }
      
      /* Main container adjustments */
      .container {
        position: relative;
        left: 0;
        top: 0;
        transform: none;
        width: 100vw;
        height: 100vh;
        max-width: 100vw;
        max-height: 100vh;
        margin: 0;
        padding: 15px;
        border-radius: 0;
        overflow-y: auto;
        background: rgba(15,15,15,0.98);
        backdrop-filter: blur(12px);
        border: none;
        box-shadow: none;
        z-index: 1;
        box-sizing: border-box;
        /* Ensure scrolling works on iOS */
        -webkit-overflow-scrolling: touch;
        /* Add safe area padding */
        padding-bottom: calc(15px + env(safe-area-inset-bottom)) !important;
      }
      
      /* Ensure body is scrollable on mobile */
      body {
        overflow-y: auto !important;
        height: auto !important;
        min-height: 100vh !important;
      }
      
      /* Hide resize handles on mobile */
      .resize-handle {
        display: none !important;
      }
      
      /* Hide useless features on mobile */
      .add-market-row,
      #theme-editor-btn,
      #site-list-btn,
      .randomize-section,
      .special-group {
        display: none !important;
      }
      
      /* Hide Open All buttons on mobile - they don't work well */
      #open-all-btn,
      .section-openall-btn {
        display: none !important;
      }
      
      /* Improve search interface */
      .market-row {
        flex-direction: column;
        gap: 12px;
      }
      
      input[type="text"] {
        font-size: 16px;
        padding: 14px 16px;
        width: 100%;
        border-radius: 10px;
        background: rgba(30,32,34,0.95);
        border: 2px solid rgba(255,255,255,0.1);
      }
      
      /* Make buttons larger and more beautiful for touch */
      .market-btn, .section-openall-btn, #open-all-btn {
        padding: 14px 20px;
        min-height: 52px;
        font-size: 16px;
        width: 100%;
        margin: 6px 0;
        border-radius: 12px;
        background: linear-gradient(135deg, rgba(40,42,44,0.95) 0%, rgba(30,32,34,0.95) 100%);
        border: 1px solid rgba(255,255,255,0.15);
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
      }
      
      .market-btn:hover, .section-openall-btn:hover, #open-all-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.4);
      }
      
      /* Adjust market buttons layout */
      .markets {
        flex-direction: column;
        gap: 10px;
      }
      
      .market-btn {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        text-align: left;
        padding-left: 50px;
        position: relative;
      }
      
      .market-toggle {
        left: 15px;
        width: 20px;
        height: 20px;
      }
      
      /* Hide complex features on mobile */
      .sidebar, .wishlist-section,
      .saved-searches-list, 
      .saved-folder-list {
        display: none !important;
      }
      
      /* Ensure mobile sidebar is properly positioned */
      .mobile-sidebar {
        display: block;
      }
      
      /* Hide desktop saved searches to prevent duplication */
      #saved-searches-list {
        display: none !important;
      }
      
      /* Adjust header spacing */
      h1 {
        font-size: 1.6em;
        margin-top: 10px;
        text-align: center;
        color: #e3e3e3;
        text-shadow: 0 2px 12px #2224;
      }
      
      .tip {
        font-size: 14px;
        line-height: 1.4;
        text-align: center;
        color: #b0b0b0;
        margin-bottom: 20px;
        padding: 0 10px;
      }
      
      /* Simplify the controls row */
      #open-all-btn {
        width: 100%;
        margin-bottom: 15px;
        background: linear-gradient(135deg, #00e6d6 0%, #00b8a9 100%);
        color: #0a0a0a;
        font-weight: bold;
        font-size: 16px;
      }
      
      /* Adjust section headers */
      .section-header-row {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        margin: 20px 0 12px 0;
      }
      
      .section-openall-btn {
        align-self: stretch;
        text-align: center;
        background: linear-gradient(135deg, rgba(60,60,60,0.95) 0%, rgba(40,40,40,0.95) 100%);
      }
      
      h2 {
        font-size: 1.3em;
        text-align: center;
        margin-bottom: 5px;
      }
      
      /* Hide particle canvas on mobile for performance */
      #particle-canvas {
        display: none;
      }
      
      /* Adjust unlock modal for mobile */
      .unlock-modal {
        width: 95vw;
        padding: 20px 15px;
        border-radius: 15px;
      }
      
      .unlock-input {
        padding: 12px 14px;
        font-size: 16px;
        border-radius: 8px;
      }
      
      /* Make custom market modal mobile-friendly */
      .custom-market-modal {
        width: 95vw;
        padding: 20px 15px;
        border-radius: 15px;
      }
      
      /* Mobile menu toggle - improved */
      .mobile-menu-toggle {
        display: flex !important;
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 1000;
        background: linear-gradient(135deg, rgba(32,34,36,0.95) 0%, rgba(20,22,24,0.95) 100%);
        border: 1px solid rgba(255,255,255,0.2);
        color: #e3e3e3;
        width: 50px;
        height: 50px;
        border-radius: 12px;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        transition: all 0.3s ease;
      }
      
      .mobile-menu-toggle:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(0,0,0,0.5);
      }
      
      /* Ensure mobile sidebar overlay is properly positioned */
      .mobile-sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.7);
        z-index: 1999;
        display: none;
        backdrop-filter: blur(3px);
      }
      
      /* Ensure the overlay covers the entire screen including safe areas */
      @supports (height: 100dvh) {
        .mobile-sidebar-overlay {
          height: 100dvh;
        }
      }
      
      .mobile-sidebar-overlay.active {
        display: block;
      }
      
      /* Adjust for very small screens */
      @media (max-width: 480px) {
        .donation-link {
          padding: 6px 8px;
          font-size: 11px;
          max-width: 110px;
        }
        
        .donation-link.discord {
          max-width: 100px;
        }
        
        .top-header {
          padding: 8px 10px;
          gap: 6px;
        }
        
        .container {
          padding-bottom: 70px !important;
        }
      }
      
      @media (max-width: 360px) {
        .donation-link {
          font-size: 10px;
          padding: 5px 6px;
          max-width: 90px;
        }
        
        .donation-link.discord {
          max-width: 85px;
        }
        
        .top-header {
          padding: 6px 8px;
          gap: 4px;
        }
      }
      
      /* Mobile sidebar - enhanced with folders */
      .mobile-sidebar {
        position: fixed;
        top: 0;
        left: -100%;
        width: 85vw;
        height: 100vh;
        background: linear-gradient(135deg, rgba(15,15,15,0.98) 0%, rgba(10,10,10,0.98) 100%);
        z-index: 2000;
        padding: 70px 20px 80px 20px; /* Increased bottom padding to 80px */
        overflow-y: auto;
        transition: left 0.3s ease;
        border-right: 1px solid rgba(255,255,255,0.15);
        box-shadow: 8px 0 30px rgba(0,0,0,0.5);
        visibility: visible;
        display: flex;
        flex-direction: column;
        /* Ensure smooth scrolling on iOS */
        -webkit-overflow-scrolling: touch;
      }
      
      /* Add safe area inset for modern iOS devices */
      @supports (padding-bottom: env(safe-area-inset-bottom)) {
        .mobile-sidebar {
          padding-bottom: calc(80px + env(safe-area-inset-bottom));
        }
      }
      
      @supports (padding-bottom: constant(safe-area-inset-bottom)) {
        .mobile-sidebar {
          padding-bottom: calc(80px + constant(safe-area-inset-bottom));
        }
      }
      
      /* Ensure the mobile sidebar content is scrollable */
      .mobile-sidebar > div:first-child {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .mobile-sidebar > div:first-child {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }
      
      #mobile-searches-container {
        flex: 1;
        min-height: 200px;
        max-height: none;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
      }
      
      .mobile-sidebar {
        -webkit-overflow-scrolling: touch; /* Smooth scrolling for the entire sidebar */
      }
      
      .mobile-sidebar.active {
        left: 0;
      }
      
      .mobile-sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.7);
        z-index: 1999;
        display: none;
        backdrop-filter: blur(3px);
      }
      
      .mobile-sidebar-overlay.active {
        display: block;
      }
      
      /* Improve mobile sidebar content */
      .mobile-sidebar h3 {
        font-size: 1.2em;
        margin-bottom: 15px;
        text-align: center;
        color: #e3e3e3;
      }
      
      .mobile-sidebar .sidebar-add-row {
        margin-bottom: 15px;
      }
      
      .mobile-sidebar .sidebar-add-input {
        padding: 10px 12px;
        border-radius: 8px;
        font-size: 15px;
      }
      
      .mobile-sidebar .sidebar-add-btn {
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 16px;
      }
      
      /* Mobile folder list - Updated for tabs */
      .mobile-folder-list {
        margin-bottom: 15px;
        max-height: none;
        overflow-y: visible;
        border: none;
        padding: 0;
        background: transparent;
      }
      
      /* Mobile import/export buttons */
      .mobile-sidebar .sidebar-exp-btn,
      .mobile-sidebar .sidebar-imp-btn {
        background: #232323;
        color: #e3e3e3;
        border: none;
        border-radius: 5px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        padding: 10px 16px;
        transition: background .18s, box-shadow .18s, transform .13s;
        box-shadow: 0 1px 4px #2224;
        opacity: 0.93;
        backdrop-filter: blur(2px);
        flex: 1;
        text-align: center;
        margin: 0;
      }
      
      .mobile-sidebar .sidebar-exp-btn:hover,
      .mobile-sidebar .sidebar-imp-btn:hover {
        background: #444;
        color: #fff;
      }
      
      /* Adjust spacing for import/export buttons in mobile sidebar */
      .mobile-sidebar h3 {
        margin-bottom: 10px;
      }
      
      .mobile-folder-item {
        padding: 8px 12px;
        margin-bottom: 0;
        background: rgba(44,46,48,0.7);
        border-radius: 6px;
        color: #e3e3e3;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid rgba(255,255,255,0.1);
        font-size: 14px;
        flex: 0 0 auto;
      }
      
      .mobile-folder-item.active {
        background: rgba(0, 230, 214, 0.2);
        border: 1px solid rgba(0, 230, 214, 0.4);
        font-weight: bold;
      }
      
      .mobile-folder-item:hover {
        background: rgba(60,60,60,0.8);
      }
      
      /* Mobile searches container */
      #mobile-folders-container {
        max-height: 500px;
        overflow-y: auto;
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        padding: 10px;
        background: rgba(30,32,34,0.5);
      }
      
      #mobile-folders-container::-webkit-scrollbar {
        width: 6px;
      }
      
      #mobile-folders-container::-webkit-scrollbar-track {
        background: rgba(30,32,34,0.5);
      }
      
      #mobile-folders-container::-webkit-scrollbar-thumb {
        background: rgba(120,120,120,0.5);
        border-radius: 3px;
      }
      
      /* Fix body padding for mobile */
      body {
        padding-top: 0;
        overflow-x: hidden;
        box-sizing: border-box;
      }
      
      /* Ensure content is not hidden behind fixed elements */
      .container {
        margin-bottom: 0;
      }
      
      /* Improve wishlist mascot visibility */
      .wishlist-mascot {
        display: none;
      }
      
      /* Better scrollbar for mobile */
      .container::-webkit-scrollbar {
        width: 6px;
      }
      
      .container::-webkit-scrollbar-thumb {
        background: rgba(120,120,120,0.4);
        border-radius: 3px;
      }
      
      /* Remove drag handles on mobile */
      .drag-handle {
        display: none !important;
      }
    }
    
    /* Additional mobile optimizations for very small screens */
    @media (max-width: 480px) {
      .donation-link {
        min-width: 120px;
        font-size: 12px;
        padding: 7px 10px;
      }
      
      h1 {
        font-size: 1.6em;
      }
      
      .tip {
        font-size: 14px;
      }
      
      .market-btn, .add-market-btn, .section-openall-btn, #open-all-btn {
        padding: 14px 20px;
        min-height: 52px;
        font-size: 15px;
      }
      
      .mobile-menu-toggle {
        width: 50px;
        height: 50px;
        font-size: 24px;
        top: 15px;
        left: 15px;
      }
    }
    
    @media (max-width: 1200px) {
      .wishlist-section { display: none; }
      .container { margin-right: 0; }
      .custom-market-modal-bg { justify-content: center; align-items: center; }
      .custom-market-modal { margin: auto; }
      .site-list-modal-bg { justify-content: center; align-items: center; }
      .site-list-modal { margin: auto; max-width: 95vw; max-height: 90vh; }
    }
    @media (max-width: 1000px) {
      .sidebar {
        position: static;
        width: 100%;
        height: auto;
        box-shadow: none;
        border-right: none;
        border-bottom: 1.5px solid #232323;
        padding: 13px 8px 7px 8px;
        margin-bottom: 18px;
        max-width: 100vw;
      }
      .container { max-width: 98vw; margin: 0.5em; }
      .custom-market-modal-bg { justify-content: center !important; align-items: center !important; }
      .custom-market-modal { margin: auto !important; }
      .site-list-modal-bg { justify-content: center !important; align-items: center !important; }
      .site-list-modal { margin: auto !important; max-width: 95vw; max-height: 90vh; }
    }
    @media (max-width: 700px) {
      .market-row, .markets { flex-direction: column; gap: 8px; }
      .market-btn { min-width: 0; width: 100%; }
      .add-market-btn { min-width: 0; width: 100%; }
      input[type="text"] { min-width: 0; }
      .special-group { padding: 10px 4px 6px 4px; }
      #open-all-btn { max-width: 100%; }
      .sidebar { padding: 9px 3px 7px 6px; font-size: 0.97em; }
      .custom-market-modal-bg { justify-content: center !important; align-items: center !important; }
      .custom-market-modal { margin: auto !important; }
      .site-list-modal-bg { justify-content: center !important; align-items: center !important; }
      .site-list-modal { margin: auto !important; max-width: 95vw; max-height: 90vh; padding: 20px 15px 15px 15px; }
      .site-list-item { padding: 8px 10px; }
      .site-list-item-label { font-size: 13px; }
    }
    @media (min-width: 1200px) {
  .sidebar {
    width: 320px; /* Slightly wider sidebar for better readability */
    height: calc(100vh - 60px) !important; /* Account for top header */
    max-height: calc(100vh - 60px) !important;
    min-height: calc(100vh - 60px) !important;
    /* Remove scale - use full size for better readability */
  }
  
  .container {
    margin-left: 340px;  /* Space from sidebar */
    margin-right: 380px; /* Space for wishlist */
    max-width: 1000px; /* Wider container for better use of space */
    transform: translate(-50%, -50%) scale(0.9); /* Scale down slightly, same as when dragging */
    transform-origin: center center;
    padding: 35px 35px 30px 35px; /* More comfortable padding */
  }
  
  .wishlist-section {
    width: 360px; /* Slightly wider */
    height: calc(100vh - 60px) !important; /* Account for top header */
    max-height: calc(100vh - 60px) !important;
    min-height: calc(100vh - 60px) !important;
    /* Remove scale - use full size */
  }
  
    @media (min-width: 1920px) {
    .container {
      max-width: 1100px; /* Even wider for large screens */
      max-height: 92vh; /* Use more vertical space */
      padding: 40px 40px 35px 40px; /* More generous padding */
      transform: translate(-50%, -50%) scale(0.9); /* Maintain same scale */
    }
    
    .sidebar {
      width: 340px; /* Even wider sidebar on large screens */
    }
    
    .wishlist-section {
      width: 380px; /* Even wider wishlist on large screens */
    }
  }

  /* Top Header Styles */
  .top-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: rgba(15, 15, 15, 0.95);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 1000;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }
  
  /* Minimization buttons in header (desktop only) */
  .header-minimize-buttons {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-right: 15px;
  }
  
  .header-minimize-btn {
    background: rgba(32, 34, 36, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #e3e3e3;
    width: 28px;
    height: 28px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    font-size: 14px;
    padding: 0;
  }
  
  .header-minimize-btn:hover {
    background: rgba(60, 60, 60, 0.9);
    transform: scale(1.1);
    border-color: rgba(255, 255, 255, 0.2);
  }
  
  .header-minimize-btn.active {
    background: rgba(0, 230, 214, 0.2);
    border-color: rgba(0, 230, 214, 0.4);
    color: #00e6d6;
  }
  
  @media (min-width: 1200px) {
    .header-minimize-buttons {
      display: flex !important;
    }
  }

  .header-left, .header-right {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .trial-searches-display {
    color: #ffe66d;
    font-size: 13px;
    font-weight: 600;
    padding: 6px 12px;
    background: rgba(255, 230, 109, 0.15);
    border: 1px solid rgba(255, 230, 109, 0.3);
    border-radius: 8px;
    margin-right: 10px;
    white-space: nowrap;
  }

  .trial-searches-display.warning {
    color: #ff6b6b;
    background: rgba(255, 107, 107, 0.15);
    border-color: rgba(255, 107, 107, 0.3);
    animation: pulse-warning 2s infinite;
  }

  @keyframes pulse-warning {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.7;
    }
  }

  .online-users-count {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    color: #b0b0b0;
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    transition: background 0.2s;
  }
  
  .online-users-count:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .online-users-count .online-dot {
    width: 6px;
    height: 6px;
    background: #00e6d6;
    border-radius: 50%;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 1;
      transform: scale(1);
    }
    50% {
      opacity: 0.5;
      transform: scale(1.2);
    }
  }

  .donation-link {
    background: linear-gradient(135deg, #0070ba 0%, #1546a0 100%);
    color: white;
    text-decoration: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(0, 112, 186, 0.3);
  }

  .donation-link:hover {
    background: linear-gradient(135deg, #005a9a 0%, #0f3a80 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 112, 186, 0.4);
  }

  .donation-link.cashapp {
    background: linear-gradient(135deg, #00d632 0%, #00b82a 100%);
    box-shadow: 0 2px 8px rgba(0, 214, 50, 0.3);
  }

  .donation-link.cashapp:hover {
    background: linear-gradient(135deg, #00b82a 0%, #009a22 100%);
    box-shadow: 0 4px 12px rgba(0, 214, 50, 0.4);
  }

  .donation-link.bitcoin {
    background: linear-gradient(135deg, #f7931a 0%, #e8840e 100%);
    box-shadow: 0 2px 8px rgba(247, 147, 26, 0.3);
  }

  .donation-link.bitcoin:hover {
    background: linear-gradient(135deg, #e8840e 0%, #d6750a 100%);
    box-shadow: 0 4px 12px rgba(247, 147, 26, 0.4);
  }

  .donation-link.discord {
    background: linear-gradient(135deg, #5865F2 0%, #4752C4 100%);
    box-shadow: 0 2px 8px rgba(88, 101, 242, 0.3);
  }

  .donation-link.discord:hover {
    background: linear-gradient(135deg, #4752C4 0%, #3C45A5 100%);
    box-shadow: 0 4px 12px rgba(88, 101, 242, 0.4);
  }

  .unlock-btn {
    background: rgba(0, 230, 214, 0.2);
    color: #00e6d6;
    border: 1px solid #00e6d6;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .unlock-btn:hover {
    background: rgba(0, 230, 214, 0.3);
    transform: translateY(-1px);
  }

  /* Unlock Modal Styles */
  .unlock-modal-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(8px);
    display: none; /* Start hidden, only show when explicitly needed */
    align-items: center;
    justify-content: center;
    z-index: 99999; /* Above lock overlay */
  }

  .unlock-modal-bg.show {
    display: flex !important;
  }

  .unlock-modal {
    background: rgba(20, 20, 20, 0.98);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 18px;
    padding: 32px 28px;
    width: min(400px, 90vw);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
    text-align: center;
  }

  .unlock-modal h3 {
    color: #e3e3e3;
    margin: 0 0 10px 0;
    font-size: 24px;
  }

  .unlock-input {
    width: 100%;
    background: rgba(30, 32, 34, 0.93);
    border: 1.5px solid #2a2d2f;
    color: #e3e3e3;
    border-radius: 10px;
    padding: 14px 16px;
    font-size: 1em;
    outline: none;
    margin-bottom: 20px;
    box-sizing: border-box;
  }

  .unlock-input:focus {
    border-color: rgba(0, 230, 214, 0.55);
    background: rgba(40, 42, 44, 0.98);
  }

  .unlock-btn-row {
    display: flex;
    gap: 10px;
    justify-content: center;
  }

  .unlock-submit-btn {
    background: #00e6d6;
    color: #0a0a0a;
    border: none;
    border-radius: 10px;
    padding: 12px 24px;
    font-size: 1em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .unlock-submit-btn:hover {
    background: #00d4c4;
    transform: translateY(-1px);
  }

  .unlock-cancel-btn {
    background: rgba(60, 60, 60, 0.8);
    color: #e3e3e3;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 12px 24px;
    font-size: 1em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .unlock-cancel-btn:hover {
    background: rgba(80, 80, 80, 0.9);
  }

  /* Adjust body padding for top header */
  body {
    padding-top: 60px;
  }

  /* Ensure main content doesn't overlap with header */
  .container {
    margin-top: 10px; /* Add space below header */
  }

  .sidebar {
    top: 60px; /* Start below header */
    height: calc(100vh - 60px); /* Adjust height for header */
  }

  .wishlist-section {
    top: 60px; /* Start below header */
    height: calc(100vh - 60px); /* Adjust height for header */
  }

  /* Lock overlay when site is locked - covers ENTIRE viewport */
  body.site-locked::before {
    content: '';
    position: fixed;
    top: 0; /* Cover entire viewport including header */
    left: 0;
    right: 0;
    bottom: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(8px);
    z-index: 99997; /* Below unlock modal but above everything else */
    pointer-events: all;
    cursor: not-allowed;
  }

  /* Block ALL interactions with content when locked */
  body.site-locked * {
    pointer-events: none !important;
    user-select: none !important;
  }

  /* Exception: allow unlock modal and its children */
  body.site-locked .unlock-modal-bg,
  body.site-locked .unlock-modal-bg *,
  body.site-locked .top-header,
  body.site-locked .top-header * {
    pointer-events: auto !important;
  }

  /* Visual feedback for locked content */
  body.site-locked .container,
  body.site-locked .sidebar,
  body.site-locked .wishlist-section,
  body.site-locked .container *,
  body.site-locked .sidebar *,
  body.site-locked .wishlist-section * {
    filter: blur(4px);
    opacity: 0.3;
  }
}
  </style>
  <!-- Supabase Client Library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- Mobile Menu Toggle -->
  <button class="mobile-menu-toggle" id="mobile-menu-toggle" style="display: none;">☰</button>
  <div class="mobile-sidebar-overlay" id="mobile-sidebar-overlay"></div>
  <div class="mobile-sidebar" id="mobile-sidebar">
    <div style="display: flex; flex-direction: column; height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch;">
      <div style="flex-shrink: 0; margin-bottom: 20px;">
        <h3 style="color: #e3e3e3; margin-bottom: 15px;">Saved Searches</h3>
        
        <!-- Import/Export buttons moved here -->
        <div style="display: flex; gap: 8px; margin-bottom: 15px;">
          <button class="sidebar-exp-btn" id="mobile-export-btn" type="button" style="flex: 1;">Export</button>
          <label class="sidebar-imp-btn" title="Import" style="flex: 1; text-align: center; cursor: pointer; padding: 7px 13px; background: #232323; color: #e3e3e3; border-radius: 5px; font-size: 13px; font-weight: bold;">
            Import
            <input type="file" id="mobile-import-input" accept=".json" style="display: none;">
          </label>
        </div>
        
        <!-- Add new search input -->
        <div style="margin-bottom: 15px;">
          <div class="sidebar-add-row" style="display: flex; gap: 8px; margin-bottom: 15px;">
            <input type="text" placeholder="Add search to current folder..." id="mobile-add-input" class="sidebar-add-input" maxlength="70" style="flex: 1;">
            <button class="sidebar-add-btn" id="mobile-add-btn" title="Save Search">+</button>
          </div>
        </div>
        
        <!-- Folder tabs -->
        <div id="mobile-folder-tabs" style="display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px;">
          <!-- Folder tabs will be populated here -->
        </div>
      </div>
      
      <!-- Saved searches for the selected folder -->
      <div id="mobile-searches-container" style="flex: 1; min-height: 200px; max-height: none; overflow-y: auto; -webkit-overflow-scrolling: touch; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 10px; background: rgba(30,32,34,0.5); margin-bottom: 15px;">
        <ul id="mobile-searches-list" style="list-style: none; padding: 0; margin: 0;">
          <!-- Saved searches will be populated here -->
        </ul>
      </div>
      
      <div style="flex-shrink: 0; margin-top: auto; padding-top: 20px; border-top: 1px solid #232323; padding-bottom: env(safe-area-inset-bottom);">
        <button class="sidebar-randomize-btn" id="mobile-randomize-btn" style="width: 100%; margin-bottom: 10px;">Randomize Search</button>
        <button class="sidebar-reset-btn" id="mobile-reset-highlights-btn" style="width: 100%; margin-bottom: 10px;">Reset Highlights</button>
      </div>
    </div>
  </div>

  <!-- Top Header with PayPal Donation -->
  <div class="top-header">
    <div class="header-left">
      <a href="https://discord.gg/s6AzmucFGd" 
         target="_blank" 
         rel="noopener noreferrer" 
         class="donation-link discord">
        💬 Join Discord
      </a>
      <a href="https://www.paypal.com/donate?business=m3owle0@gmail.com&currency_code=USD" 
         target="_blank" 
         rel="noopener noreferrer" 
         class="donation-link">
        💝 Donate via PayPal
      </a>
      <a href="https://cash.app/$0emo" 
         target="_blank" 
         rel="noopener noreferrer" 
         class="donation-link cashapp">
        💚 Donate via CashApp
      </a>
      <a href="bitcoin:bc1qxer8y9dkwmswl7gxsvhxfrkqzpp7tuzzvz2txn" 
         class="donation-link bitcoin"
         onclick="navigator.clipboard.writeText('bc1qxer8y9dkwmswl7gxsvhxfrkqzpp7tuzzvz2txn'); alert('Bitcoin address copied! Address: bc1qxer8y9dkwmswl7gxsvhxfrkqzpp7tuzzvz2txn'); return false;">
        ₿ Donate via Bitcoin
      </a>
      <button id="online-users-count" class="online-users-count" style="margin-left: 15px; background: none; border: none; cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: background 0.2s;">
        <span class="online-dot"></span>
        <span id="online-users-number">Loading...</span> online
      </button>
    </div>
    <div class="header-right">
      <!-- Minimization buttons (desktop only) -->
      <div class="header-minimize-buttons" style="display: none;">
        <button class="header-minimize-btn" id="minimize-container-btn" title="Minimize Main Container" data-panel="container">📦</button>
        <button class="header-minimize-btn" id="minimize-sidebar-btn" title="Minimize Saved Searches" data-panel="sidebar">📋</button>
        <button class="header-minimize-btn" id="minimize-wishlist-btn" title="Minimize Wishlist" data-panel="wishlist">⭐</button>
      </div>
      <span id="user-display" style="display: none; color: #00e6d6; font-size: 14px; margin-right: 15px;"></span>
      <span id="premium-badge" class="premium-badge" style="display: none;">⭐ Premium</span>
      <span id="trial-searches-display" class="trial-searches-display" style="display: none;"></span>
      <button id="header-donate-btn" class="donation-button secondary" style="display: none;" title="Support the site">💝 Donate</button>
      <button id="header-discord-notifications-btn" class="header-discord-notifications-btn" title="Get notified when items you're looking for are listed!">🔔 Notifications</button>
      <div id="header-profile-avatar" class="header-profile-avatar" style="display: none;" title="Click to view profile"></div>
      <button id="profile-picture-btn" class="profile-picture-btn" style="display: none;">📷 Profile</button>
      <button id="unlock-btn" class="unlock-btn" style="display: none;">Unlock Site</button>
    </div>
  </div>
  
  <!-- Profile Picture Input (hidden) -->
  <input type="file" id="profile-picture-input" class="profile-picture-input" accept="image/*" />
  
  <!-- Profile Modal -->
  <div id="profile-modal-bg" class="profile-modal-bg">
    <div class="profile-modal">
      <button class="profile-modal-close" id="profile-modal-close">×</button>
      <div class="profile-modal-avatar" id="profile-modal-avatar"></div>
      <div class="profile-modal-username" id="profile-modal-username"></div>
      <div class="profile-modal-description-container" id="profile-modal-description-container">
        <div class="profile-modal-description" id="profile-modal-description"></div>
        <textarea class="profile-modal-description-edit" id="profile-modal-description-edit" placeholder="Add a description..." maxlength="500" style="display: none;"></textarea>
        <div class="profile-modal-description-actions" id="profile-modal-description-actions" style="display: none;">
          <button class="profile-description-save-btn" id="profile-description-save-btn">Save</button>
          <button class="profile-description-cancel-btn" id="profile-description-cancel-btn">Cancel</button>
        </div>
        <button class="profile-description-edit-btn" id="profile-description-edit-btn" style="display: none;">Edit Description</button>
      </div>
      <div class="profile-modal-info-label">User ID</div>
      <div class="profile-modal-info" id="profile-modal-userid"></div>
      <div class="profile-modal-info-label">Join Date</div>
      <div class="profile-modal-info" id="profile-modal-joindate"></div>
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
        <button class="profile-description-edit-btn" id="manage-subscription-btn" style="display: block; width: 100%; margin-bottom: 10px;">💳 Manage Subscription</button>
        <button class="profile-description-edit-btn" id="discord-notifications-btn" style="display: block; width: 100%;">🔔 Discord Notifications (Pro - $10/mo)</button>
      </div>
    </div>
  </div>
  
  <!-- Discord Notifications Modal -->
  <div id="discord-notifications-modal-bg" class="users-list-modal-bg" style="display: none;">
    <div class="users-list-modal" style="max-width: 600px;">
      <button class="users-list-modal-close" id="discord-notifications-modal-close">×</button>
      <h3 class="users-list-modal-title">Discord Notifications (Pro Tier Required)</h3>
      <div id="discord-subscription-status" style="padding: 0 20px 10px 20px; text-align: center;">
        <div style="color: #00e6d6; font-weight: bold; margin-bottom: 5px;">Premium Feature - Requires Pro Tier ($10/month)</div>
        <div id="discord-subscription-info" style="color: #b0b0b0; font-size: 12px;"></div>
      </div>
      <div style="padding: 0 20px 20px 20px;">
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: #e3e3e3; font-weight: bold; margin-bottom: 8px;">Discord Webhook URL</label>
          <input type="text" id="discord-webhook-input" placeholder="https://discord.com/api/webhooks/..." 
                 style="width: 100%; padding: 10px; border-radius: 8px; border: 1.5px solid #232323; background: rgba(30,32,34,0.93); color: #e3e3e3; font-size: 13px; box-sizing: border-box;" />
          <div style="color: #b0b0b0; font-size: 12px; margin-top: 5px;">
            Create a webhook in your Discord server: Server Settings → Integrations → Webhooks → New Webhook
          </div>
        </div>
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: #e3e3e3; font-weight: bold; margin-bottom: 8px;">Search Terms to Monitor</label>
          <div style="background: rgba(30,32,34,0.5); border-radius: 8px; padding: 10px; max-height: 300px; overflow-y: auto;">
            <div id="discord-notifications-list" style="display: flex; flex-direction: column; gap: 8px;">
              <div style="color: #888; font-size: 12px; text-align: center; padding: 20px;">No notifications configured</div>
            </div>
          </div>
          <button type="button" id="add-discord-notification-btn" 
                  style="margin-top: 10px; background: #232323; color: #e3e3e3; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer; font-size: 13px; font-weight: bold;">
            + Add Search Term
          </button>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
          <button id="discord-subscribe-btn" 
                  style="background: #635BFF; color: white; border: none; border-radius: 6px; padding: 10px 20px; cursor: pointer; font-size: 13px; font-weight: bold; display: none;">
            💳 Subscribe to Pro - $10/month
          </button>
          <button id="discord-notifications-test-btn" 
                  style="background: #5865F2; color: white; border: none; border-radius: 6px; padding: 10px 20px; cursor: pointer; font-size: 13px; font-weight: bold;">
            Test Webhook
          </button>
          <button id="discord-notifications-save-btn" 
                  style="background: #00e6d6; color: #0a0a0a; border: none; border-radius: 6px; padding: 10px 20px; cursor: pointer; font-size: 13px; font-weight: bold;">
            Save
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Notification Modal -->
  <div id="add-notification-modal-bg" class="custom-market-modal-bg" style="display: none;">
    <div class="custom-market-modal">
      <h3>Add Notification</h3>
      <label for="notification-search-term-input">Search Term</label>
      <input type="text" id="notification-search-term-input" maxlength="100" placeholder="e.g. vintage nike" required />
      <label for="notification-markets-select">Markets to Monitor (Select Multiple)</label>
      <div style="font-size: 12px; color: #888; margin-bottom: 6px;">Only these 5 markets are supported by the notifier. <strong style="color: #00e6d6;">You can select multiple!</strong></div>
      <select id="notification-markets-select" multiple size="5" style="width: 100%; padding: 8px; border-radius: 5px; border: 1.5px solid #232323; background: rgba(30,32,34,0.93); color: #e3e3e3;">
        <!-- Will be populated dynamically -->
      </select>
      <div class="modal-tip" style="margin-top: 5px; color: #00e6d6;">
        💡 <strong>Tip:</strong> Hold <kbd style="background: rgba(0,230,214,0.2); padding: 2px 6px; border-radius: 3px;">Ctrl</kbd> (Windows) or <kbd style="background: rgba(0,230,214,0.2); padding: 2px 6px; border-radius: 3px;">Cmd</kbd> (Mac) to select multiple markets. Leave empty to monitor all 5 supported markets.
      </div>
      <div class="modal-btn-row">
        <button class="modal-btn" id="add-notification-save-btn">Add</button>
        <button class="modal-cancel-btn" id="add-notification-cancel-btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Users List Modal -->
  <div id="users-list-modal-bg" class="users-list-modal-bg">
    <div class="users-list-modal">
      <button class="users-list-modal-close" id="users-list-modal-close">×</button>
      <h3 class="users-list-modal-title">All Users</h3>
      <div class="users-list-total" id="users-list-total">Total: 0 users</div>
      <div class="users-list-content" id="users-list-content">
        <div class="users-list-loading">Loading users...</div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="unlock-modal-bg" class="unlock-modal-bg" style="display: none;">
    <div class="unlock-modal">
      <h3>Login</h3>
      <div style="background: linear-gradient(135deg, rgba(0, 230, 214, 0.1) 0%, rgba(0, 184, 168, 0.1) 100%); border: 1px solid rgba(0, 230, 214, 0.3); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
      <p style="color: #b0b0b0; margin: 0 0 10px 0;">
        <strong style="color: #00e6d6;">⭐ Free Trial:</strong> New users get <strong style="color: #ffd700;">75 free searches</strong>! Create an account to start your trial.
      </p>
      <p style="color: #b0b0b0; margin: 0;">
        <strong style="color: #ffd700;">💎 Subscription Plans:</strong> After trial, choose from Basic ($5/mo) or Pro ($10/mo) plans. All subscriptions processed securely through Stripe.
      </p>
      </div>
      <div id="login-error" style="display: none; padding: 12px; margin-bottom: 15px; border-radius: 8px; background: rgba(255, 107, 107, 0.2); border: 1px solid rgba(255, 107, 107, 0.5);">
        <p style="color: #ff6b6b; margin: 0; font-size: 14px;" id="login-error-text"></p>
      </div>
      <div id="login-success" style="display: none; padding: 12px; margin-bottom: 15px; border-radius: 8px; background: rgba(0, 230, 214, 0.2); border: 1px solid rgba(0, 230, 214, 0.5);">
        <p style="color: #00e6d6; margin: 0; font-size: 14px;" id="login-success-text"></p>
      </div>
      <div id="login-form">
        <input type="text" id="login-username-input" placeholder="Email address" class="unlock-input" style="margin-bottom: 12px;" />
        <input type="password" id="login-password-input" placeholder="Password" class="unlock-input" />
        <div class="unlock-btn-row" style="margin-top: 15px;">
          <button id="login-submit-btn" class="unlock-submit-btn">Login</button>
          <button id="signup-toggle-btn" class="unlock-cancel-btn">Sign Up</button>
          <button id="login-cancel-btn" class="unlock-cancel-btn" style="display: none;">Cancel</button>
        </div>
      </div>
      <div id="signup-form" style="display: none;">
        <input type="text" id="signup-username-input" placeholder="Choose a username" class="unlock-input" style="margin-bottom: 12px;" />
        <input type="email" id="signup-email-input" placeholder="Your email (for verification)" class="unlock-input" style="margin-bottom: 12px;" />
        <input type="password" id="signup-password-input" placeholder="Choose a password (min 6 characters)" class="unlock-input" />
        <div class="unlock-btn-row" style="margin-top: 15px;">
          <button id="signup-submit-btn" class="unlock-submit-btn">Create Account</button>
          <button id="login-toggle-btn" class="unlock-cancel-btn">Back to Login</button>
        </div>
      </div>
      <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 10px; padding: 15px; margin-top: 20px; margin-bottom: 15px;">
        <div style="color: #ffd700; font-weight: bold; font-size: 14px; margin-bottom: 10px;">💎 Subscription Plans:</div>
        <div style="color: #e3e3e3; font-size: 12px; line-height: 1.8;">
          <strong>Basic ($5/month):</strong> Unlimited searches, premium badge, priority support<br>
          <strong>Pro ($10/month):</strong> Everything in Basic + Discord notifications, advanced filters, early access features<br><br>
          <strong style="color: #00e6d6;">Click "Unlock Site" to view all subscription options and subscribe securely with Stripe.</strong>
        </div>
      </div>
      <p style="color: #888; font-size: 12px; margin-top: 15px; line-height: 1.6; text-align: center;">
        <strong>Secure Subscriptions:</strong> All plans are processed securely through Stripe. Your payment information is never stored on our servers.<br><br>
        After subscribing, your account will be activated automatically. If you need help, contact support.
      </p>
    </div>
  </div>

  <!-- Upgrade Modal -->
  <div class="upgrade-modal-bg" id="upgrade-modal-bg">
    <div class="upgrade-modal">
      <button class="upgrade-modal-close" id="upgrade-modal-close">×</button>
      <div class="upgrade-modal-header">
        <div class="upgrade-modal-title">💎 Choose Your Plan</div>
        <div class="upgrade-modal-subtitle">Select a subscription tier that fits your needs</div>
        <div id="current-subscription-badge" style="margin-top: 10px;"></div>
      </div>
      
      <div class="subscription-tiers" id="subscription-tiers">
        <!-- Free Trial Tier -->
        <div class="subscription-tier" data-tier="trial">
          <div class="subscription-tier-name">Free Trial</div>
          <div class="subscription-tier-price">$0</div>
          <div class="subscription-tier-period">75 searches</div>
          <div class="subscription-tier-features">
            <div class="subscription-tier-feature">75 free searches</div>
            <div class="subscription-tier-feature">Basic search features</div>
            <div class="subscription-tier-feature">Community access</div>
          </div>
        </div>
        
        <!-- Basic Tier -->
        <div class="subscription-tier" data-tier="basic">
          <div class="subscription-tier-name">Basic</div>
          <div class="subscription-tier-price">$5</div>
          <div class="subscription-tier-period">per month</div>
          <div class="subscription-tier-features">
            <div class="subscription-tier-feature">Unlimited searches</div>
            <div class="subscription-tier-feature">Premium badge</div>
            <div class="subscription-tier-feature">Priority support</div>
            <div class="subscription-tier-feature">All search features</div>
          </div>
          <div class="subscription-payment-methods">
            <button class="subscription-payment-btn stripe" data-tier="basic" data-method="stripe">
              💳 Subscribe with Stripe
            </button>
          </div>
        </div>
        
        <!-- Pro Tier -->
        <div class="subscription-tier recommended" data-tier="pro">
          <div class="subscription-tier-name">Pro</div>
          <div class="subscription-tier-price">$10</div>
          <div class="subscription-tier-period">per month</div>
          <div class="subscription-tier-features">
            <div class="subscription-tier-feature">Everything in Basic</div>
            <div class="subscription-tier-feature">Discord notifications</div>
            <div class="subscription-tier-feature">Advanced filters</div>
            <div class="subscription-tier-feature">Early access features</div>
          </div>
          <div class="subscription-payment-methods">
            <button class="subscription-payment-btn stripe" data-tier="pro" data-method="stripe">
              💳 Subscribe with Stripe
            </button>
          </div>
        </div>
        
      </div>
      
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); text-align: center;">
        <div style="color: #888; font-size: 12px;">
          <strong>Secure Payment:</strong> All subscriptions are processed securely through Stripe. Your payment information is never stored on our servers.
        </div>
      </div>
      
      <div class="upgrade-modal-actions">
        <button class="upgrade-modal-btn secondary" id="upgrade-modal-cancel">
          Maybe Later
        </button>
      </div>
    </div>
  </div>

  <!-- Subscription Management Modal -->
  <div class="upgrade-modal-bg" id="subscription-management-modal-bg" style="display: none;">
    <div class="upgrade-modal" style="max-width: 700px;">
      <button class="upgrade-modal-close" id="subscription-management-modal-close">×</button>
      <div class="upgrade-modal-header">
        <div class="upgrade-modal-title">💳 Manage Subscription</div>
        <div class="upgrade-modal-subtitle">View and manage your subscription details</div>
      </div>
      
      <div id="subscription-management-content" style="margin-top: 20px;">
        <div style="background: rgba(0, 230, 214, 0.1); border: 1px solid rgba(0, 230, 214, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div>
              <div style="color: #e3e3e3; font-size: 18px; font-weight: bold; margin-bottom: 5px;" id="current-subscription-plan">Loading...</div>
              <div style="color: #b0b0b0; font-size: 12px;" id="current-subscription-details">Loading subscription details...</div>
            </div>
            <div id="subscription-status-badge-container"></div>
          </div>
          
          <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
              <div>
                <div style="color: #888; font-size: 11px; margin-bottom: 5px;">Next Billing Date</div>
                <div style="color: #e3e3e3; font-size: 14px; font-weight: bold;" id="next-billing-date">-</div>
              </div>
              <div>
                <div style="color: #888; font-size: 11px; margin-bottom: 5px;">Payment Method</div>
                <div style="color: #e3e3e3; font-size: 14px; font-weight: bold;" id="payment-method">-</div>
              </div>
            </div>
          </div>
        </div>
        
        <div style="margin-top: 20px;">
          <div style="color: #e3e3e3; font-weight: bold; margin-bottom: 15px; font-size: 16px;">Change Plan</div>
          <div class="subscription-tiers" id="subscription-management-tiers" style="grid-template-columns: repeat(3, 1fr);">
            <!-- Tiers will be populated dynamically -->
          </div>
        </div>
        
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
          <button class="upgrade-modal-btn secondary" id="cancel-subscription-btn" style="width: 100%; background: rgba(255, 107, 107, 0.2); color: #ff6b6b; border-color: rgba(255, 107, 107, 0.4);">
            Cancel Subscription
          </button>
          <div style="color: #888; font-size: 11px; margin-top: 10px; text-align: center;">
            Canceling will stop automatic renewals. You'll retain access until the end of your billing period.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="minimized-panels" id="minimized-panels"></div>
  <div class="sidebar" id="sidebar">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
      <span class="sidebar-title">Saved Searches</span>
      <span id="unhighlighted-count" style="font-size: 12px; color: #b0b0b0; background: rgba(44,46,48,0.7); padding: 2px 6px; border-radius: 8px;">
        0 unhighlighted
      </span>
    </div>
    <!-- Folders UI -->
    <div class="sidebar-folder-row">
      <input type="text" placeholder="Add folder..." id="sidebar-folder-input" class="sidebar-folder-input" maxlength="44" />
      <button class="sidebar-folder-btn" id="sidebar-folder-btn" title="Add Folder">+</button>
    </div>
    <ul class="saved-folder-list" id="saved-folder-list"></ul>
    <!-- Saved Searches UI (will be folder-specific) -->
    <div class="resize-handle resize-handle-horizontal" id="sidebar-folder-search-resize" style="position: relative; bottom: 0; margin-top: 8px;"></div>
    <div class="sidebar-add-row">
      <input type="text" placeholder="Save a search term..." id="sidebar-add-input" class="sidebar-add-input" maxlength="70" />
      <button class="sidebar-add-btn" id="sidebar-add-btn" title="Save Search">+</button>
    </div>
    <div class="sidebar-multi-search-row" style="margin-bottom: 8px;">
      <button class="sidebar-multi-clear-btn" id="sidebar-multi-clear-btn" type="button" title="Clear Selection">Clear Selection</button>
    </div>
    <div class="sidebar-import-export-row">
      <button class="sidebar-exp-btn" id="sidebar-export-btn" type="button">Export</button>
      <label class="sidebar-imp-btn" title="Import">
        Import
        <input type="file" id="sidebar-import-input" accept=".json">
      </label>
      <button class="sidebar-reset-btn" id="sidebar-reset-highlights-btn" type="button" title="Reset Highlights" style="color: var(--theme-highlight);">Reset Highlights</button>
    </div>
    <hr class="sidebar-divider" />
    <ul class="saved-searches-list" id="saved-searches-list"></ul>
    <hr class="sidebar-divider" />
    <div style="color:#888; font-size:13px; padding-left:1px;">
      Click a saved search to load it.<br>
      Use <b>✎</b> to edit or <b>🗑</b> to remove.<br>
      Export or Import your list for backup or transfer.<br>
      <b>Folders</b> let you organize searches. Drag to rearrange.<br>
      Saved searches are always sorted A-Z.<br>
      <b>Randomize</b> picks an unhighlighted term and opens the selected category.
    </div>
    <div class="drag-handle"></div>
    <div class="resize-handle resize-handle-right" data-resize="sidebar"></div>
    <div class="resize-handle resize-handle-left" data-resize="sidebar"></div>
    <div class="resize-handle resize-handle-bottom" data-resize="sidebar"></div>
  </div>
  <div class="wishlist-section" id="wishlist-section">
    <img src="mmcs.png" class="wishlist-mascot" alt="MMCS Logo" loading="lazy" onload="this.classList.add('loaded')">
    <div class="wishlist-title">Wishlist / Considering</div>
    <form class="wishlist-add-row" id="wishlist-add-form" autocomplete="off">
      <input type="text" class="wishlist-add-input" id="wishlist-link-input" placeholder="Paste item link here..." maxlength="700" required />
      <button class="wishlist-add-btn" type="submit" title="Add Link">+</button>
    </form>
    <ul class="wishlist-list" id="wishlist-list"></ul>
    <div class="wishlist-tip">
      Add links to items you're considering buying.<br>
      Titles are fetched automatically, and you can click to edit.
    </div>
    <div class="resize-handle resize-handle-left" data-resize="wishlist"></div>
    <div class="resize-handle resize-handle-bottom" data-resize="wishlist"></div>
    <div class="resize-handle resize-handle-bottom-left" data-resize="wishlist"></div>
  </div>
  <div class="container">
    <div class="drag-handle" id="container-handle"></div>
    <h1>Multi-Market Clothing Search</h1>
    
    <!-- Premium Upgrade Banner (shown when trial is low) -->
    <div class="premium-upgrade-banner" id="premium-upgrade-banner">
      <div class="premium-upgrade-content">
        <div class="premium-upgrade-title">⚡ Upgrade to Premium</div>
        <div class="premium-upgrade-text">Your free trial is running low! Upgrade now for unlimited searches and premium features.</div>
      </div>
      <button class="premium-upgrade-btn" id="premium-upgrade-btn">Upgrade Now</button>
    </div>
    
    <!-- Discord Notifications Feature Banner -->
    <div class="discord-feature-banner">
      <div class="discord-feature-icon">🔔</div>
      <div class="discord-feature-content">
        <div class="discord-feature-title">Get Instant Discord Notifications</div>
        <div class="discord-feature-description">
          Never miss a deal! Set up notifications for your favorite brands and get alerted instantly when new items are listed on Mercari, Rakuma, Yahoo Auctions, and more.
        </div>
        <div class="discord-feature-benefits">
          <span class="discord-feature-benefit">✓ Real-time alerts</span>
          <span class="discord-feature-benefit">✓ 5 Japanese markets</span>
          <span class="discord-feature-benefit">✓ Custom search terms</span>
          <span class="discord-feature-benefit">✓ Only $10/month (Pro tier)</span>
        </div>
        <button class="discord-feature-cta" id="main-discord-notifications-btn">Get Started →</button>
      </div>
    </div>
    
    <div class="tip">Enter your search and click any button to open the most recent results on that secondhand fashion site.<br>
      Example: <span style="color:#e60021;font-weight:bold;">rick owens</span>
    </div>
    <form id="searchForm" autocomplete="off">
      <div class="market-row" style="position:relative;">
        <input type="text" id="query" placeholder="Search for clothing, brands, etc." required />
        <button id="clear-search" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:#888;cursor:pointer;display:none;">✕</button>
      </div>
      <!-- Primary Actions Row -->
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
        <button type="button" id="open-all-btn" style="flex-shrink: 0;">Open All</button>
        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; flex-shrink: 0;">
          <input type="checkbox" id="toggle-all-checkbox" checked style="width: 16px; height: 16px; accent-color: #666;">
          <span style="font-size: 14px; color: #e3e3e3;">Toggle All</span>
        </label>
        <div class="randomize-section" style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
          <div style="position: relative;">
            <select id="randomize-category-select" class="randomize-select" style="min-width: 140px;">
              <option value="all">All Categories</option>
              <option value="asia">Asia</option>
              <option value="international">International</option>
              <option value="special">Designer</option>
            </select>
            <div id="randomize-color-indicator" style="position: absolute; left: 8px; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; border-radius: 50%; pointer-events: none;"></div>
          </div>
          <button class="sidebar-randomize-btn" id="sidebar-randomize-btn" type="button" style="background: #232323; color: #e3e3e3; border: none; border-radius: 5px; font-size: 13px; font-weight: bold; padding: 7px 13px; cursor: pointer; box-shadow: 0 1px 4px #2224; opacity: 0.93; backdrop-filter: blur(2px); white-space: nowrap;">Randomize</button>
        </div>
      </div>
      <!-- Settings Row -->
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;">
        <button type="button" id="theme-editor-btn" style="background: #232323; color: #e3e3e3; border: none; border-radius: 8px; font-size: 13px; font-weight: bold; padding: 7px 18px 8px 18px; cursor: pointer; letter-spacing: .01em; box-shadow: 0 2px 8px #2224; transition: background .18s, box-shadow .18s, transform .13s; backdrop-filter: blur(2px); opacity: 0.93;">Theme Editor</button>
        <button type="button" id="site-list-btn" style="background: #232323; color: #e3e3e3; border: none; border-radius: 8px; font-size: 13px; font-weight: bold; padding: 7px 18px 8px 18px; cursor: pointer; letter-spacing: .01em; box-shadow: 0 2px 8px #2224; transition: background .18s, box-shadow .18s, transform .13s; backdrop-filter: blur(2px); opacity: 0.93;">Site List</button>
      </div>
      <div class="add-market-row" style="margin-top: 8px; margin-bottom: 20px;">
        <button type="button" class="add-market-btn" data-section="asia">+ Add Website to Asia</button>
        <button type="button" class="add-market-btn" data-section="international">+ Add Website to International</button>
        <button type="button" class="add-market-btn" data-section="special">+ Add Website to Designer</button>
        <button type="button" id="add-custom-category-btn" style="background: #00e6d6; color: #0a0a0a; border: none; border-radius: 7px; font-size: 13px; font-weight: bold; cursor: pointer; padding: 9px 16px; margin-bottom: 2px; margin-top: 2px; transition: background .18s, box-shadow .18s, transform .13s; box-shadow: 0 1px 4px #2224; opacity: 0.93; backdrop-filter: blur(2px);">+ Create Custom Category</button>
      </div>
      <div class="section-header-row">
        <h2>Asia</h2>
        <button type="button" class="section-openall-btn" data-section="asia">Open All Asia</button>
      </div>
      <div class="markets" id="asia-markets"></div>
      <div class="section-header-row">
        <h2>International &amp; Other Markets</h2>
        <button type="button" class="section-openall-btn" data-section="international">Open All International</button>
      </div>
      <div class="markets" id="international-markets"></div>
      <div class="special-group">
        <div class="section-header-row" style="margin-top:0;margin-bottom:8px;">
          <span class="special-group-label">Designer &amp; Global Select</span>
          <button type="button" class="section-openall-btn" data-section="special">Open All Designer</button>
        </div>
        <div class="markets" id="special-markets"></div>
      </div>
    </form>
    <div class="resize-handle resize-handle-right" data-resize="container"></div>
    <div class="resize-handle resize-handle-left" data-resize="container"></div>
    <div class="resize-handle resize-handle-bottom" data-resize="container"></div>
    <div class="resize-handle resize-handle-top" data-resize="container"></div>
    <div class="resize-handle resize-handle-bottom-right" data-resize="container"></div>
    <div class="resize-handle resize-handle-bottom-left" data-resize="container"></div>
    <div class="resize-handle resize-handle-top-right" data-resize="container"></div>
    <div class="resize-handle resize-handle-top-left" data-resize="container"></div>
  </div>
  <!-- Chat System -->
  <div id="chat-widget" style="display: none;">
    <div id="chat-toggle-btn" class="chat-toggle-btn">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
      <span id="chat-badge" class="chat-badge" style="display: none;">0</span>
    </div>
    <div id="chat-panel" class="chat-panel">
      <div class="chat-header">
        <h3>Community Chat</h3>
        <button id="chat-close-btn" class="chat-close-btn">×</button>
      </div>
      <div id="chat-messages" class="chat-messages"></div>
      <div class="chat-input-container">
        <input type="text" id="chat-input" class="chat-input" placeholder="Type a message..." maxlength="500" />
        <button id="chat-send-btn" class="chat-send-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Custom Market Modal -->
  <div id="custom-market-modal-bg" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:3000;">
    <div class="custom-market-modal">
      <div class="drag-handle"></div>
      <h3>Add Custom Website</h3>
      <div class="modal-section-label" id="custom-market-modal-section"></div>
      <label for="custom-market-title-input">Website Title</label>
      <input type="text" id="custom-market-title-input" maxlength="44" placeholder="e.g. Grailed" required />
      <label for="custom-market-url-input">Search Layout URL</label>
      <input type="text" id="custom-market-url-input" maxlength="250" placeholder="e.g. https://www.grailed.com/shop?query=example" required />
      <div class="modal-tip">
        Use <b>example</b> where the search term should appear.<br>
        For instance: <code>https://www.grailed.com/shop?query=example</code><br>
        When searching, <b>example</b> will be replaced with your search.
      </div>
      <div class="modal-btn-row">
        <button class="modal-btn" id="custom-market-modal-save-btn">Save</button>
        <button class="modal-cancel-btn" id="custom-market-modal-cancel-btn">Cancel</button>
      </div>
    </div>
  </div>
  
  <!-- Custom Category Modal -->
  <div id="custom-category-modal-bg" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:3000;background:rgba(10,10,10,0.65);backdrop-filter:blur(2.5px);align-items:center;justify-content:center;">
    <div class="custom-market-modal">
      <div class="drag-handle"></div>
      <h3 id="custom-category-modal-title">Create Custom Category</h3>
      <label for="custom-category-name-input">Category Name</label>
      <input type="text" id="custom-category-name-input" maxlength="50" placeholder="e.g. Vintage, Sneakers, etc." required />
      <div class="modal-tip">
        Create a custom category to organize your websites. You can add websites to this category after creating it.
      </div>
      <div class="modal-btn-row">
        <button class="modal-btn" id="custom-category-modal-save-btn">Save</button>
        <button class="modal-cancel-btn" id="custom-category-modal-cancel-btn">Cancel</button>
        <button class="modal-cancel-btn" id="custom-category-modal-delete-btn" style="display:none;background:rgba(255,107,107,0.2);color:#ff6b6b;border-color:rgba(255,107,107,0.5);">Delete</button>
      </div>
    </div>
  </div>
  
  <!-- Site List Modal -->
  <div id="site-list-modal-bg" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:3000;">
    <div class="site-list-modal">
      <div class="drag-handle"></div>
      <h3>Site List Manager</h3>
      <div class="site-list-content">
        <div class="site-list-section">
          <h4 class="site-list-section-title">Asia</h4>
          <div id="site-list-asia" class="site-list-items"></div>
        </div>
        <div class="site-list-section">
          <h4 class="site-list-section-title">International & Other Markets</h4>
          <div id="site-list-international" class="site-list-items"></div>
        </div>
        <div class="site-list-section">
          <h4 class="site-list-section-title">Designer & Global Select</h4>
          <div id="site-list-special" class="site-list-items"></div>
        </div>
      </div>
      <div class="modal-btn-row">
        <button class="modal-btn" id="site-list-close-btn">Close</button>
      </div>
    </div>
  </div>
  
  <script>
    // Site Unlock System with Supabase
    (function() {
      // ============================================
      // SUPABASE CONFIGURATION
      // Replace these with your Supabase credentials
      // Get them from: Project Settings → API
      // ============================================
      const SUPABASE_URL = 'https://wbpfuuiznsmysbskywdx.supabase.co'; // e.g., 'https://xxxxx.supabase.co'
      const SUPABASE_ANON_KEY = 'sb_publishable_rIy_-DWT87Gj9ao1WvN3gA_WA6eME-x'; // Your anon/public key
      
      // Initialize Supabase client with session persistence
      const supabase = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: true, // Enable session persistence across page refreshes
          autoRefreshToken: true, // Automatically refresh expired tokens
          detectSessionInUrl: true, // Detect session from URL (for OAuth redirects)
          storage: window.localStorage, // Use localStorage for session storage
          storageKey: 'sb-' + SUPABASE_URL.split('//')[1].split('.')[0] + '-auth-token' // Unique storage key
        }
      }) : null;
      
      const CURRENT_USER_KEY = 'mmcs_current_user';
      
      function getCurrentUser() {
        return localStorage.getItem(CURRENT_USER_KEY);
      }
      
      function setCurrentUser(username) {
        if (username) {
          localStorage.setItem(CURRENT_USER_KEY, username);
        } else {
          localStorage.removeItem(CURRENT_USER_KEY);
        }
      }
      
      function clearSession() {
        localStorage.removeItem(CURRENT_USER_KEY);
        if (supabase) {
          supabase.auth.signOut();
        }
      }
      
      // Check if user is logged in via Supabase Auth AND verified in unlocked_users
      async function isUnlocked() {
        if (!supabase) return false;
        
        try {
          const { data: { session }, error } = await supabase.auth.getSession();
          
          if (error) {
            console.error('Error getting session:', error);
            return false;
          }
          
          if (!session) {
            return false;
          }
          
          // Check if session is still valid
          const { data: { user }, error: userError } = await supabase.auth.getUser();
          
          if (userError || !user) {
            return false;
          }
          
          // Check if user is verified in unlocked_users table
          const { data: unlockedData, error: unlockedError } = await supabase
            .from('unlocked_users')
            .select('verified, email, username, trial_searches_used')
            .eq('auth_user_id', user.id)
            .maybeSingle();
          
          console.log('Verification check:', {
            userId: user.id,
            email: user.email,
            unlockedData: unlockedData,
            unlockedError: unlockedError
          });
          
          if (unlockedError) {
            console.error('Error checking verification status:', unlockedError);
            // If table doesn't exist or error, allow access (fallback)
            // This prevents breaking if unlocked_users table isn't set up yet
            setCurrentUser(user.user_metadata?.username || user.email || user.id);
            return true;
          }
          
          // If no record exists, create one automatically (user signed up before trigger was set up)
          if (!unlockedData) {
            console.warn('User not found in unlocked_users table, creating record:', user.id);
            try {
              const { data: newRecord, error: insertError } = await supabase
                .from('unlocked_users')
                .insert({
                  auth_user_id: user.id,
                  email: user.email,
                  username: user.user_metadata?.username || '',
                  verified: false,
                  trial_searches_used: 0
                })
                .select()
                .single();
              
              if (insertError) {
                console.error('Error creating unlocked_users record:', insertError);
                // Allow access for now if we can't create record
                setCurrentUser(user.user_metadata?.username || user.email || user.id);
                return true;
              }
              
              // Record created but not verified - check trial
              const trialSearchesUsed = newRecord.trial_searches_used || 0;
              if (trialSearchesUsed < 75) {
                console.log('New user on free trial:', user.email, 'searches used:', trialSearchesUsed);
                setCurrentUser(newRecord.username || user.user_metadata?.username || user.email || user.id);
                return true; // Allow access during trial
              } else {
                console.log('User trial exhausted:', user.email);
                return false; // Trial exhausted, require donation
              }
            } catch (err) {
              console.error('Error creating unlocked_users record:', err);
              setCurrentUser(user.user_metadata?.username || user.email || user.id);
              return true; // Fallback: allow access
            }
          }
          
          // Check if user is verified (handle various true formats)
          const verifiedValue = unlockedData.verified;
          const isVerified = verifiedValue === true || 
                             verifiedValue === 'true' || 
                             verifiedValue === 1 ||
                             verifiedValue === '1' ||
                             String(verifiedValue).toLowerCase() === 'true';
          
          // Get trial searches used (default to 0 if null/undefined)
          const trialSearchesUsed = unlockedData.trial_searches_used || 0;
          const TRIAL_LIMIT = 75;
          
          console.log('Verification status:', {
            email: user.email,
            verifiedValue: verifiedValue,
            verifiedType: typeof verifiedValue,
            isVerified: isVerified,
            trialSearchesUsed: trialSearchesUsed
          });
          
          if (!isVerified) {
            // Check if user has trial searches remaining
            if (trialSearchesUsed < TRIAL_LIMIT) {
              console.log('User on free trial:', user.email, 'searches used:', trialSearchesUsed, '/', TRIAL_LIMIT);
              // Update current user in localStorage
              const displayName = unlockedData.username || user.user_metadata?.username || user.email || user.id;
              setCurrentUser(displayName);
              
              // Update last_active timestamp
              try {
                await supabase
                  .from('unlocked_users')
                  .update({ last_active: new Date().toISOString() })
                  .eq('auth_user_id', user.id);
              } catch (err) {
                console.warn('Error updating last_active:', err);
              }
              
              return true; // Allow access during trial
            } else {
              console.log('User trial exhausted:', user.email, 'searches used:', trialSearchesUsed);
              return false; // Trial exhausted, require donation
            }
          }
          
          // User is verified - allow access
          console.log('User verified, granting access:', user.email);
          
          // Update current user in localStorage
          const displayName = unlockedData.username || user.user_metadata?.username || user.email || user.id;
          setCurrentUser(displayName);
          
          // Show premium badge for verified users
          const premiumBadge = document.getElementById('premium-badge');
          if (premiumBadge) {
            premiumBadge.style.display = 'inline-flex';
          }
          
          // Hide donation button for verified users
          const donateBtn = document.getElementById('header-donate-btn');
          if (donateBtn) {
            donateBtn.style.display = 'none';
          }
          
          // Update last_active timestamp
          try {
            await supabase
              .from('unlocked_users')
              .update({ last_active: new Date().toISOString() })
              .eq('auth_user_id', user.id);
          } catch (err) {
            console.warn('Error updating last_active:', err);
          }
          
          return true;
        } catch (err) {
          console.error('Error checking unlock status:', err);
          return false;
        }
      }
      
      // Increment trial search count for unverified users
      async function incrementTrialSearch() {
        if (!supabase) return false;
        
        try {
          const { data: { session }, error: sessionError } = await supabase.auth.getSession();
          if (sessionError || !session) return false;
          
          const { data: { user }, error: userError } = await supabase.auth.getUser();
          if (userError || !user) return false;
          
          // Get current trial searches count
          const { data: unlockedData, error: fetchError } = await supabase
            .from('unlocked_users')
            .select('verified, trial_searches_used')
            .eq('auth_user_id', user.id)
            .maybeSingle();
          
          if (fetchError || !unlockedData) return false;
          
          // Only increment if user is not verified
          const verifiedValue = unlockedData.verified;
          const isVerified = verifiedValue === true || 
                             verifiedValue === 'true' || 
                             verifiedValue === 1 ||
                             verifiedValue === '1' ||
                             String(verifiedValue).toLowerCase() === 'true';
          
          if (isVerified) return true; // Verified users don't need tracking
          
          // Increment trial searches
          const currentCount = unlockedData.trial_searches_used || 0;
          const { error: updateError } = await supabase
            .from('unlocked_users')
            .update({ trial_searches_used: currentCount + 1 })
            .eq('auth_user_id', user.id);
          
          if (updateError) {
            console.error('Error incrementing trial search:', updateError);
            return false;
          }
          
          console.log('Trial search incremented:', currentCount + 1, '/ 75');
          
          // Update trial searches display
          updateTrialSearchesDisplay();
          
          return true;
        } catch (err) {
          console.error('Error incrementing trial search:', err);
          return false;
        }
      }
      
      // Update trial searches display
      async function updateTrialSearchesDisplay() {
        const trialDisplay = document.getElementById('trial-searches-display');
        if (!trialDisplay || !supabase) {
          if (trialDisplay) trialDisplay.style.display = 'none';
          return;
        }
        
        try {
          const { data: { session }, error: sessionError } = await supabase.auth.getSession();
          if (sessionError || !session) {
            trialDisplay.style.display = 'none';
            return;
          }
          
          const { data: { user }, error: userError } = await supabase.auth.getUser();
          if (userError || !user) {
            trialDisplay.style.display = 'none';
            return;
          }
          
          // Get user verification and trial status
          const { data: unlockedData, error: fetchError } = await supabase
            .from('unlocked_users')
            .select('verified, trial_searches_used')
            .eq('auth_user_id', user.id)
            .maybeSingle();
          
          if (fetchError || !unlockedData) {
            trialDisplay.style.display = 'none';
            return;
          }
          
          // Check if verified
          const verifiedValue = unlockedData.verified;
          const isVerified = verifiedValue === true || 
                             verifiedValue === 'true' || 
                             verifiedValue === 1 ||
                             verifiedValue === '1' ||
                             String(verifiedValue).toLowerCase() === 'true';
          
          // Hide display if verified
          if (isVerified) {
            trialDisplay.style.display = 'none';
            return;
          }
          
          // Show trial status
          const trialSearchesUsed = unlockedData.trial_searches_used || 0;
          const TRIAL_LIMIT = 75;
          const remaining = TRIAL_LIMIT - trialSearchesUsed;
          
          if (remaining <= 0) {
            trialDisplay.style.display = 'none';
            // Show upgrade banner if trial exhausted
            const upgradeBanner = document.getElementById('premium-upgrade-banner');
            if (upgradeBanner) {
              upgradeBanner.classList.add('show');
            }
            return;
          }
          
          // Update display
          trialDisplay.textContent = `🎁 ${remaining} free search${remaining === 1 ? '' : 'es'} left`;
          
          // Add warning class if low on searches
          if (remaining <= 5) {
            trialDisplay.classList.add('warning');
          } else {
            trialDisplay.classList.remove('warning');
          }
          
          trialDisplay.style.display = 'inline-block';
          
          // Show upgrade banner if trial is running low (10 or fewer searches)
          const upgradeBanner = document.getElementById('premium-upgrade-banner');
          if (upgradeBanner) {
            if (remaining <= 10) {
              upgradeBanner.classList.add('show');
            } else {
              upgradeBanner.classList.remove('show');
            }
          }
          
          // Show donation button for non-verified users
          const donateBtn = document.getElementById('header-donate-btn');
          if (donateBtn) {
            donateBtn.style.display = 'inline-flex';
          }
        } catch (err) {
          console.error('Error updating trial searches display:', err);
          trialDisplay.style.display = 'none';
        }
      }
      
      // Check if user can perform searches (verified or has trial remaining)
      async function canPerformSearch() {
        if (!supabase) return { allowed: false, reason: 'Database not configured' };
        
        try {
          const { data: { session }, error: sessionError } = await supabase.auth.getSession();
          if (sessionError || !session) {
            return { allowed: false, reason: 'Not logged in' };
          }
          
          const { data: { user }, error: userError } = await supabase.auth.getUser();
          if (userError || !user) {
            return { allowed: false, reason: 'User not found' };
          }
          
          // Get user verification and trial status
          const { data: unlockedData, error: fetchError } = await supabase
            .from('unlocked_users')
            .select('verified, trial_searches_used')
            .eq('auth_user_id', user.id)
            .maybeSingle();
          
          if (fetchError || !unlockedData) {
            return { allowed: false, reason: 'User record not found' };
          }
          
          // Check if verified
          const verifiedValue = unlockedData.verified;
          const isVerified = verifiedValue === true || 
                             verifiedValue === 'true' || 
                             verifiedValue === 1 ||
                             verifiedValue === '1' ||
                             String(verifiedValue).toLowerCase() === 'true';
          
          if (isVerified) {
            return { allowed: true, reason: 'verified' };
          }
          
          // Check trial status
          const trialSearchesUsed = unlockedData.trial_searches_used || 0;
          const TRIAL_LIMIT = 75;
          
          if (trialSearchesUsed < TRIAL_LIMIT) {
            const remaining = TRIAL_LIMIT - trialSearchesUsed;
            return { 
              allowed: true, 
              reason: 'trial', 
              remaining: remaining,
              used: trialSearchesUsed 
            };
          } else {
            return { 
              allowed: false, 
              reason: 'trial_exhausted',
              used: trialSearchesUsed 
            };
          }
        } catch (err) {
          console.error('Error checking search permission:', err);
          return { allowed: false, reason: 'Error checking permission' };
        }
      }
      
      // Login with username/email and password
      async function loginUser(usernameOrEmail, password) {
        if (!supabase) {
          return { success: false, error: 'Database connection not configured.' };
        }
        
        if (!usernameOrEmail || !password) {
          return { success: false, error: 'Please enter both username/email and password.' };
        }
        
        try {
          // Supabase Auth requires email for login
          // If user entered username, we need to look it up first
          let emailToUse = usernameOrEmail;
          
          // If it doesn't contain @, treat as username and try to find email
          if (!usernameOrEmail.includes('@')) {
            // Query auth.users to find email by username in metadata
            // Note: This requires admin access or a database function
            // For now, we'll require users to login with email
            // You can enhance this later with a database function
            return { success: false, error: 'Please login with your email address. Username login coming soon!' };
          }
          
          const { data, error } = await supabase.auth.signInWithPassword({
            email: emailToUse.toLowerCase().trim(),
            password: password
          });
          
          if (error) {
            console.error('Login error:', error);
            
            // Provide more helpful error messages
            let errorMessage = error.message || 'Invalid email or password.';
            
            if (error.message && error.message.includes('Email not confirmed')) {
              errorMessage = 'Please verify your email address first. Check your inbox for the confirmation link.';
            } else if (error.message && error.message.includes('Invalid login credentials')) {
              errorMessage = 'Invalid email or password. Please check your credentials and try again.';
            } else if (error.message && error.message.includes('User not found')) {
              errorMessage = 'No account found with this email. Please sign up first.';
            }
            
            return { success: false, error: errorMessage };
          }
          
          if (data.user && data.session) {
            console.log('Login successful:', data.user.id);
            const displayName = data.user.user_metadata?.username || data.user.email || data.user.id;
            setCurrentUser(displayName);
            return { success: true, user: data.user, session: data.session };
          }
          
          return { success: false, error: 'Login failed. Please try again.' };
        } catch (err) {
          console.error('Error logging in:', err);
          return { success: false, error: 'Error logging in. Please try again.' };
        }
      }
      
      // Sign up new user
      async function signUpUser(username, email, password) {
        if (!supabase) {
          return { success: false, error: 'Database connection not configured.' };
        }
        
        if (!username || !email || !password) {
          return { success: false, error: 'Please fill in all fields.' };
        }
        
        if (password.length < 6) {
          return { success: false, error: 'Password must be at least 6 characters.' };
        }
        
        if (!email.includes('@')) {
          return { success: false, error: 'Please enter a valid email address.' };
        }
        
        try {
          console.log('Attempting signup with:', { email: email.toLowerCase().trim(), username: username.trim() });
          
          const { data, error } = await supabase.auth.signUp({
            email: email.toLowerCase().trim(),
            password: password,
            options: {
              data: {
                username: username.trim()
              },
              emailRedirectTo: window.location.origin // For email confirmation
            }
          });
          
          console.log('Signup response:', { data, error });
          
          if (error) {
            console.error('Supabase signup error details:', {
              message: error.message,
              status: error.status,
              name: error.name,
              fullError: error
            });
            
            // Provide more helpful error messages
            let errorMessage = error.message || 'Error creating account.';
            
            if (error.message && error.message.includes('already registered')) {
              errorMessage = 'This email is already registered. Please login instead.';
            } else if (error.message && error.message.includes('password')) {
              errorMessage = 'Password does not meet requirements. Please use a stronger password.';
            } else if (error.message && error.message.includes('email')) {
              errorMessage = 'Invalid email address. Please check and try again.';
            } else if (error.message && error.message.includes('rate limit')) {
              errorMessage = 'Too many signup attempts. Please wait a moment and try again.';
            } else if (error.status === 400) {
              errorMessage = `Invalid request: ${error.message || 'Please check your input and try again.'}`;
            } else if (error.status === 422) {
              errorMessage = `Validation error: ${error.message || 'Please check your email and password format.'}`;
            } else if (error.status === 429) {
              errorMessage = 'Too many requests. Please wait a moment and try again.';
            } else {
              errorMessage = `Database error: ${error.message || 'Unable to create account. Error code: ' + (error.status || 'unknown')}`;
            }
            
            return { success: false, error: errorMessage };
          }
          
          if (data.user) {
            console.log('User created successfully:', data.user.id);
            console.log('Session available:', !!data.session);
            console.log('Email confirmed:', data.user.email_confirmed_at ? 'Yes' : 'No');
            
            // Wait a moment for trigger to create unlocked_users record
            // Then verify it was created
            setTimeout(async () => {
              if (supabase) {
                const { data: unlockedData, error: unlockedError } = await supabase
                  .from('unlocked_users')
                  .select('*')
                  .eq('auth_user_id', data.user.id)
                  .maybeSingle();
                
                if (unlockedError) {
                  console.warn('Could not verify unlocked_users record:', unlockedError);
                } else if (unlockedData) {
                  console.log('unlocked_users record created:', unlockedData);
                } else {
                  console.warn('unlocked_users record not found - trigger may not be set up');
                }
              }
            }, 1000);
            
            // If session exists, user is logged in immediately
            if (data.session) {
              setCurrentUser(username.trim());
              return { 
                success: true, 
                user: data.user,
                session: data.session,
                needsEmailVerification: false
              };
            } else {
              // No session means email confirmation is required
              setCurrentUser(username.trim());
              return { 
                success: true, 
                user: data.user,
                needsEmailVerification: true,
                message: 'Account created! Please check your email to verify your account before logging in.'
              };
            }
          }
          
          return { success: false, error: 'Account creation failed. Please try again.' };
        } catch (err) {
          console.error('Error signing up:', err);
          return { 
            success: false, 
            error: `Database error: ${err.message || 'Unable to create account. Please check your connection and try again.'}` 
          };
        }
      }
      
      // Initialize unlock system
      let isInitializing = false; // Prevent multiple simultaneous calls
      async function initUnlockSystem(suppressModal = false) {
        // Prevent multiple simultaneous initialization calls
        if (isInitializing) {
          return;
        }
        isInitializing = true;
        
        const unlockModalBg = document.getElementById('unlock-modal-bg');
        const unlockBtn = document.getElementById('unlock-btn');
        const loginSubmitBtn = document.getElementById('login-submit-btn');
        const signupSubmitBtn = document.getElementById('signup-submit-btn');
        const loginToggleBtn = document.getElementById('login-toggle-btn');
        const signupToggleBtn = document.getElementById('signup-toggle-btn');
        const loginCancelBtn = document.getElementById('login-cancel-btn');
        const loginUsernameInput = document.getElementById('login-username-input');
        const loginPasswordInput = document.getElementById('login-password-input');
        const signupUsernameInput = document.getElementById('signup-username-input');
        const signupEmailInput = document.getElementById('signup-email-input');
        const signupPasswordInput = document.getElementById('signup-password-input');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const loginError = document.getElementById('login-error');
        const loginErrorText = document.getElementById('login-error-text');
        const loginSuccess = document.getElementById('login-success');
        const loginSuccessText = document.getElementById('login-success-text');
        const userDisplay = document.getElementById('user-display');
        
          // Check if Supabase is configured
          if (!supabase || SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE') {
            console.warn('Supabase not configured. Please add your credentials.');
            // Show error message only if no user is set
            const currentUser = getCurrentUser();
            if (!currentUser && unlockModalBg) {
              unlockModalBg.innerHTML = `
                <div class="unlock-modal">
                  <h3>Configuration Required</h3>
                  <p style="color: #ff6b6b; margin-bottom: 20px;">
                    Please configure your Supabase credentials in the code.
                  </p>
                  <p style="color: #b0b0b0; font-size: 14px;">
                    Edit the SUPABASE_URL and SUPABASE_ANON_KEY variables in the script.
                  </p>
                </div>
              `;
              unlockModalBg.classList.add('show');
              unlockModalBg.style.display = 'flex';
            }
            return;
          }
        
        // Check if site is unlocked (async)
        const unlocked = await isUnlocked();
        const currentUser = getCurrentUser();
        
        console.log('initUnlockSystem check:', { unlocked, currentUser });
        
        // If user has a valid session, check verification status
        let hasValidSession = false;
        try {
          const { data: { session } } = await supabase.auth.getSession();
          hasValidSession = !!session;
        } catch (err) {
          console.error('Error checking session:', err);
        }
        
        if (unlocked && currentUser) {
          document.body.classList.remove('site-locked');
          
          // Remove all interaction blockers when unlocked
          if (window._lockBlockers && Array.isArray(window._lockBlockers)) {
            window._lockBlockers.forEach(({ type, handler }) => {
              document.removeEventListener(type, handler, true);
            });
            window._lockBlockers = [];
          }
          
          // Always hide modal when unlocked
          if (unlockModalBg) {
            unlockModalBg.classList.remove('show');
            unlockModalBg.style.display = 'none';
          }
          
          // Hide any success/error messages immediately
          const loginSuccessEl = document.getElementById('login-success');
          const loginErrorEl = document.getElementById('login-error');
          if (loginSuccessEl) {
            loginSuccessEl.style.display = 'none';
            loginSuccessEl.style.transition = 'opacity 0.3s';
            loginSuccessEl.style.opacity = '0';
          }
          if (loginErrorEl) {
            loginErrorEl.style.display = 'none';
          }
          
          // Clear form fields
          const loginUsernameInputEl = document.getElementById('login-username-input');
          const loginPasswordInputEl = document.getElementById('login-password-input');
          if (loginUsernameInputEl) loginUsernameInputEl.value = '';
          if (loginPasswordInputEl) loginPasswordInputEl.value = '';
          
          if (unlockBtn) unlockBtn.style.display = 'none';
          if (userDisplay) {
            userDisplay.textContent = `Welcome, ${currentUser}`;
            userDisplay.style.display = 'inline';
          }
          
          // Update trial searches display
          updateTrialSearchesDisplay();
          // Start session heartbeat for active session
          startSessionHeartbeat();
          
          // Initialize chat system
          if (window.initChat) {
            setTimeout(() => window.initChat(), 500);
          }
          
          isInitializing = false;
          return; // Exit early when unlocked
        } else {
          document.body.classList.add('site-locked');
          
          // Block ALL interactions when locked - prevent bypass via minimized/resized windows
          const blockInteractions = (e) => {
            // Allow interactions only with unlock modal and top header
            const target = e.target;
            const isUnlockModal = target.closest('.unlock-modal-bg');
            const isTopHeader = target.closest('.top-header');
            
            if (!isUnlockModal && !isTopHeader) {
              e.preventDefault();
              e.stopPropagation();
              e.stopImmediatePropagation();
              return false;
            }
          };
          
          // Store blocker function reference for cleanup
          if (!window._lockBlockers) {
            window._lockBlockers = [];
          }
          
          // Add event listeners to block all interactions (capture phase to catch everything)
          const mouseHandler = (e) => blockInteractions(e);
          const touchHandler = (e) => blockInteractions(e);
          const keyHandler = (e) => {
            const target = e.target;
            const isUnlockModal = target.closest('.unlock-modal-bg');
            if (!isUnlockModal) {
              e.preventDefault();
              e.stopPropagation();
              return false;
            }
          };
          
          document.addEventListener('mousedown', mouseHandler, true);
          document.addEventListener('click', mouseHandler, true);
          document.addEventListener('touchstart', touchHandler, true);
          document.addEventListener('keydown', keyHandler, true);
          
          // Store handlers for cleanup
          window._lockBlockers = [
            { type: 'mousedown', handler: mouseHandler },
            { type: 'click', handler: mouseHandler },
            { type: 'touchstart', handler: touchHandler },
            { type: 'keydown', handler: keyHandler }
          ];
          
          // Show modal if user is logged in but not verified, or if no user at all
          if (!suppressModal) {
            // Check if user has a session (logged in)
            try {
              const { data: { session } } = await supabase.auth.getSession();
              
              if (session && currentUser) {
                // User is logged in but not verified - show modal with error message
                if (unlockModalBg) {
                  unlockModalBg.classList.add('show');
                  unlockModalBg.style.display = 'flex';
                }
                // Show error message if not already showing
                const loginErrorEl = document.getElementById('login-error');
                const loginErrorTextEl = document.getElementById('login-error-text');
                if (loginErrorEl && loginErrorTextEl) {
                  loginErrorTextEl.textContent = 'Your account is not verified yet. Please wait for verification after donation.';
                  loginErrorEl.style.display = 'block';
                }
                // Hide success message if showing
                const loginSuccessEl = document.getElementById('login-success');
                if (loginSuccessEl) loginSuccessEl.style.display = 'none';
              } else if (!currentUser) {
                // No user - show modal for login/signup
                if (unlockModalBg) {
                  unlockModalBg.classList.add('show');
                  unlockModalBg.style.display = 'flex';
                }
              } else {
                // Hide modal, show button instead
                if (unlockModalBg) {
                  unlockModalBg.classList.remove('show');
                  unlockModalBg.style.display = 'none';
                }
              }
            } catch (err) {
              console.error('Error checking session:', err);
              // Default: show modal if no user
              if (!currentUser && unlockModalBg) {
                unlockModalBg.classList.add('show');
                unlockModalBg.style.display = 'flex';
              }
            }
          } else {
            // Modal suppressed - hide it
            if (unlockModalBg) {
              unlockModalBg.classList.remove('show');
              unlockModalBg.style.display = 'none';
            }
          }
          
          if (unlockBtn) unlockBtn.style.display = 'inline-block';
          if (userDisplay) userDisplay.style.display = 'none';
        }
        
        isInitializing = false;
        
        // Show login modal button
        if (unlockBtn) {
          unlockBtn.onclick = () => {
            if (unlockModalBg) {
              unlockModalBg.classList.add('show');
              unlockModalBg.style.display = 'flex';
            }
            // Show login form by default
            if (loginForm) loginForm.style.display = 'block';
            if (signupForm) signupForm.style.display = 'none';
            if (loginUsernameInput) {
              setTimeout(() => loginUsernameInput.focus(), 100);
            }
          };
        }
        
        // Toggle between login and signup forms
        if (signupToggleBtn) {
          signupToggleBtn.onclick = () => {
            if (loginForm) loginForm.style.display = 'none';
            if (signupForm) signupForm.style.display = 'block';
            if (loginError) loginError.style.display = 'none';
            if (loginSuccess) loginSuccess.style.display = 'none';
            if (signupUsernameInput) {
              setTimeout(() => signupUsernameInput.focus(), 100);
            }
          };
        }
        
        if (loginToggleBtn) {
          loginToggleBtn.onclick = () => {
            if (loginForm) loginForm.style.display = 'block';
            if (signupForm) signupForm.style.display = 'none';
            if (loginError) loginError.style.display = 'none';
            if (loginSuccess) loginSuccess.style.display = 'none';
            if (loginUsernameInput) {
              setTimeout(() => loginUsernameInput.focus(), 100);
            }
          };
        }
        
        // Login handler
        if (loginSubmitBtn) {
          loginSubmitBtn.onclick = async () => {
            const usernameOrEmail = loginUsernameInput ? loginUsernameInput.value.trim() : '';
            const password = loginPasswordInput ? loginPasswordInput.value : '';
            
            if (!usernameOrEmail || !password) {
              if (loginError) {
                loginErrorText.textContent = 'Please enter both username/email and password.';
                loginError.style.display = 'block';
              }
              return;
            }
            
            loginSubmitBtn.disabled = true;
            loginSubmitBtn.textContent = 'Logging in...';
            if (loginError) loginError.style.display = 'none';
            
            const result = await loginUser(usernameOrEmail, password);
            
            loginSubmitBtn.disabled = false;
            loginSubmitBtn.textContent = 'Login';
            
            if (result.success) {
              // Hide error message if showing
              if (loginError) loginError.style.display = 'none';
              
              // Clear password field
              if (loginPasswordInput) loginPasswordInput.value = '';
              // Clear username field
              if (loginUsernameInput) loginUsernameInput.value = '';
              
              // Immediately check unlock status
              const unlocked = await isUnlocked();
              console.log('Unlock status after login:', unlocked);
              
              if (unlocked) {
                // User is verified - unlock immediately!
                console.log('User verified - unlocking site now');
                
                // Hide modal immediately
                if (unlockModalBg) {
                  unlockModalBg.classList.remove('show');
                  unlockModalBg.style.display = 'none';
                }
                
                // Hide success/error messages
                if (loginSuccess) loginSuccess.style.display = 'none';
                if (loginError) loginError.style.display = 'none';
                
                // Unlock the site
                document.body.classList.remove('site-locked');
                
                // Remove interaction blockers
                if (window._lockBlockers && Array.isArray(window._lockBlockers)) {
                  window._lockBlockers.forEach(({ type, handler }) => {
                    document.removeEventListener(type, handler, true);
                  });
                  window._lockBlockers = [];
                }
                
                // Update UI
                if (unlockBtn) unlockBtn.style.display = 'none';
                if (userDisplay) {
                  const currentUser = getCurrentUser();
                  userDisplay.textContent = `Welcome, ${currentUser || result.user?.email || 'User'}`;
                  userDisplay.style.display = 'inline';
                }
                
                // Update trial searches display
                updateTrialSearchesDisplay();
                
                // Start session heartbeat
                startSessionHeartbeat();
                
                // Initialize chat system
                if (window.initChat) {
                  setTimeout(() => window.initChat(), 500);
                }
                
                console.log('Site unlocked successfully for verified user!');
                
                // IMPORTANT: Don't call initUnlockSystem here - it might re-lock!
                // The site is already unlocked above
                return; // Exit early - don't continue
              } else {
                // User logged in but not verified - show error, keep modal open
                console.warn('User logged in but not verified');
                if (loginSuccess) {
                  loginSuccess.style.display = 'none';
                }
                if (loginError) {
                  loginErrorText.textContent = 'Your account is not verified yet. Please wait for verification after donation.';
                  loginError.style.display = 'block';
                }
                // Keep modal open so they can see the message
                // Don't call initUnlockSystem - it will re-lock them
              }
            } else {
              if (loginError) {
                loginErrorText.textContent = result.error || 'Login failed. Please try again.';
                loginError.style.display = 'block';
                console.error('Login failed:', result.error);
              }
              // Clear password field on error
              if (loginPasswordInput) loginPasswordInput.value = '';
            }
          };
        }
        
        // Signup handler
        if (signupSubmitBtn) {
          signupSubmitBtn.onclick = async () => {
            const username = signupUsernameInput ? signupUsernameInput.value.trim() : '';
            const email = signupEmailInput ? signupEmailInput.value.trim() : '';
            const password = signupPasswordInput ? signupPasswordInput.value : '';
            
            if (!username || !email || !password) {
              if (loginError) {
                loginErrorText.textContent = 'Please fill in all fields.';
                loginError.style.display = 'block';
              }
              return;
            }
            
            signupSubmitBtn.disabled = true;
            signupSubmitBtn.textContent = 'Creating account...';
            if (loginError) loginError.style.display = 'none';
            
            const result = await signUpUser(username, email, password);
            
            signupSubmitBtn.disabled = false;
            signupSubmitBtn.textContent = 'Create Account';
            
            if (result.success) {
              if (result.needsEmailVerification) {
                // Email confirmation required
                if (loginSuccess) {
                  loginSuccessText.textContent = result.message || 'Account created! Please check your email (' + email + ') to verify your account before logging in.';
                  loginSuccess.style.display = 'block';
                }
                // Clear form
                if (signupUsernameInput) signupUsernameInput.value = '';
                if (signupEmailInput) signupEmailInput.value = '';
                if (signupPasswordInput) signupPasswordInput.value = '';
                // Switch to login form after 3 seconds
                setTimeout(() => {
                  if (loginToggleBtn) loginToggleBtn.click();
                  if (loginSuccess) loginSuccess.style.display = 'none';
                }, 5000);
              } else {
                // User is logged in immediately (email confirmation disabled)
                if (loginSuccess) {
                  loginSuccessText.textContent = 'Account created! Welcome!';
                  loginSuccess.style.display = 'block';
                }
                setTimeout(async () => {
                  await initUnlockSystem();
                }, 500);
              }
            } else {
              if (loginError) {
                // Show the actual error message from Supabase
                const errorMsg = result.error || 'Account creation failed. Please try again.';
                loginErrorText.textContent = errorMsg;
                loginError.style.display = 'block';
                console.error('Signup error:', result.error);
              }
            }
          };
        }
        
        // Cancel button
        if (loginCancelBtn) {
          loginCancelBtn.onclick = () => {
            if (unlockModalBg) {
              unlockModalBg.classList.remove('show');
              unlockModalBg.style.display = 'none';
            }
          };
        }
        
        // Enter key handlers
        if (loginPasswordInput) {
          loginPasswordInput.onkeydown = (e) => {
            if (e.key === 'Enter' && loginSubmitBtn) {
              loginSubmitBtn.click();
            }
          };
        }
        
        if (signupPasswordInput) {
          signupPasswordInput.onkeydown = (e) => {
            if (e.key === 'Enter' && signupSubmitBtn) {
              signupSubmitBtn.click();
            }
          };
        }
      }
      
      // Session heartbeat - refresh Supabase session periodically to keep it alive
      let sessionHeartbeatInterval = null;
      function startSessionHeartbeat() {
        if (sessionHeartbeatInterval) {
          clearInterval(sessionHeartbeatInterval);
        }
        
        sessionHeartbeatInterval = setInterval(async () => {
          if (!supabase) return;
          
          try {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
              // Refresh the session to keep it alive
              const { data: { session: refreshedSession }, error } = await supabase.auth.refreshSession();
              
              if (error) {
                console.error('Error refreshing session:', error);
                // Only clear if session is truly expired/invalid
                if (error.message && (error.message.includes('expired') || error.message.includes('invalid'))) {
                  console.log('Session expired, clearing...');
                  clearSession();
                  clearInterval(sessionHeartbeatInterval);
                  await initUnlockSystem();
                }
              } else if (refreshedSession) {
                console.log('Session refreshed via heartbeat');
                // Update last_active timestamp
                try {
                  await supabase
                    .from('unlocked_users')
                    .update({ last_active: new Date().toISOString() })
                    .eq('auth_user_id', refreshedSession.user.id);
                } catch (err) {
                  console.warn('Error updating last_active:', err);
                }
              }
            }
          } catch (err) {
            console.error('Error in session heartbeat:', err);
          }
        }, 300000); // Refresh every 5 minutes (Supabase sessions last ~1 hour)
      }
      
      function stopSessionHeartbeat() {
        if (sessionHeartbeatInterval) {
          clearInterval(sessionHeartbeatInterval);
          sessionHeartbeatInterval = null;
        }
      }
      
      // Note: We no longer clear session on page unload to allow users to stay logged in
      // Sessions will persist across page refreshes
      function handlePageUnload() {
        // Don't sign out - let users stay logged in after refresh
        // Only update last_active timestamp if user is logged in
        if (supabase) {
          supabase.auth.getSession().then(({ data: { session } }) => {
            if (session) {
              // Update last_active but don't sign out
              supabase
                .from('unlocked_users')
                .update({ last_active: new Date().toISOString() })
                .eq('auth_user_id', session.user.id)
                .catch(err => console.warn('Error updating last_active on unload:', err));
            }
          });
        }
      }
      
      // Restore session on page load and refresh
      async function restoreSession() {
        if (!supabase) return;
        
        try {
          // Get existing session from localStorage (Supabase handles this automatically)
          const { data: { session }, error } = await supabase.auth.getSession();
          
          if (error) {
            console.error('Error restoring session:', error);
            return;
          }
          
          if (session) {
            console.log('Session restored on page load:', session.user.email);
            
            // Refresh the session to ensure it's still valid
            const { data: { session: refreshedSession }, error: refreshError } = await supabase.auth.refreshSession();
            
            if (refreshError) {
              console.warn('Session refresh error (may be expired):', refreshError);
              // Session might be expired, but continue with existing session check
            } else if (refreshedSession) {
              console.log('Session refreshed successfully');
            }
            
            // Check if user is verified and unlock site
            const unlocked = await isUnlocked();
            if (unlocked) {
              // User is logged in and verified - unlock site immediately
              document.body.classList.remove('site-locked');
              
              // Remove all interaction blockers
              if (window._lockBlockers && Array.isArray(window._lockBlockers)) {
                window._lockBlockers.forEach(({ type, handler }) => {
                  document.removeEventListener(type, handler, true);
                });
                window._lockBlockers = [];
              }
              
              // Hide modal
              const unlockModalBg = document.getElementById('unlock-modal-bg');
              if (unlockModalBg) {
                unlockModalBg.classList.remove('show');
                unlockModalBg.style.display = 'none';
              }
              
              // Update UI
              const userDisplay = document.getElementById('user-display');
              const unlockBtn = document.getElementById('unlock-btn');
              if (userDisplay) {
                const currentUser = getCurrentUser();
                userDisplay.textContent = `Welcome, ${currentUser || session.user.email}`;
                userDisplay.style.display = 'inline';
              }
              if (unlockBtn) unlockBtn.style.display = 'none';
              
              // Update trial searches display
              updateTrialSearchesDisplay();
              
              // Start session heartbeat
              startSessionHeartbeat();
              
              console.log('User automatically logged in after page refresh');
            }
          } else {
            console.log('No existing session found');
          }
        } catch (err) {
          console.error('Error in restoreSession:', err);
        }
      }
      
      // Expose functions globally for search handlers
      window.canPerformSearch = canPerformSearch;
      window.incrementTrialSearch = incrementTrialSearch;
      window.initUnlockSystem = initUnlockSystem;
      window.updateTrialSearchesDisplay = updateTrialSearchesDisplay;
      
      // Initialize on page load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', async () => {
          // First restore session, then initialize unlock system
          await restoreSession();
          await initUnlockSystem();
          
          // Start heartbeat after initialization
          const currentUser = getCurrentUser();
          if (currentUser) {
            startSessionHeartbeat();
          }
        });
      } else {
        // Page already loaded, restore session immediately
        setTimeout(async () => {
          await restoreSession();
          await initUnlockSystem();
          
          const currentUser = getCurrentUser();
          if (currentUser) {
            startSessionHeartbeat();
          }
        }, 100);
      }
      
      // Set up page unload handler
      window.addEventListener('beforeunload', handlePageUnload);
      window.addEventListener('pagehide', handlePageUnload);
      
      // Also handle visibility change (tab switch) - but don't show modal unnecessarily
      let visibilityCheckTimeout = null;
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          // Tab is hidden, clear any pending checks
          if (visibilityCheckTimeout) {
            clearTimeout(visibilityCheckTimeout);
            visibilityCheckTimeout = null;
          }
        } else {
          // Tab is visible again, verify session is still valid (with delay to avoid flicker)
          const currentUser = getCurrentUser();
          if (currentUser) {
            // Clear any existing timeout
            if (visibilityCheckTimeout) {
              clearTimeout(visibilityCheckTimeout);
            }
            // Delay check to avoid showing modal during normal tab switches
            visibilityCheckTimeout = setTimeout(async () => {
              const unlocked = await isUnlocked();
              if (!unlocked) {
                // Session expired, clear and reload
                clearSession();
                stopSessionHeartbeat();
                await initUnlockSystem(true); // Suppress modal during visibility check
              } else {
                startSessionHeartbeat();
              }
              visibilityCheckTimeout = null;
            }, 1000); // 1 second delay
          }
        }
      });
    })();
    
    // ============================================
    // CHAT SYSTEM
    // ============================================
    (function() {
      try {
        const SUPABASE_URL = 'https://wbpfuuiznsmysbskywdx.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_rIy_-DWT87Gj9ao1WvN3gA_WA6eME-x';
        
        // Create Supabase client for chat
        const supabase = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: true,
            storage: window.localStorage,
            storageKey: 'sb-' + SUPABASE_URL.split('//')[1].split('.')[0] + '-auth-token'
          }
        }) : null;
        
        const chatWidget = document.getElementById('chat-widget');
        const chatToggleBtn = document.getElementById('chat-toggle-btn');
        const chatPanel = document.getElementById('chat-panel');
        const chatCloseBtn = document.getElementById('chat-close-btn');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatBadge = document.getElementById('chat-badge');
        
        // If chat elements don't exist, exit early
        if (!chatWidget || !chatToggleBtn || !chatPanel) {
          console.warn('Chat elements not found, skipping chat initialization');
          return;
        }
      
      let chatSubscription = null;
      let unreadCount = 0;
      let currentUserId = null;
      let currentUsername = null;
      let currentUserAvatar = null;
      let isChatInitialized = false;
      
      // Initialize chat when user is unlocked
      async function initChat() {
        if (isChatInitialized || !supabase) return;
        
        try {
          const { data: { session } } = await supabase.auth.getSession();
          if (!session) return;
          
          const { data: { user } } = await supabase.auth.getUser();
          if (!user) return;
          
          // Get user info from unlocked_users table
          const { data: userData } = await supabase
            .from('unlocked_users')
            .select('username, email, profile_picture_url')
            .eq('auth_user_id', user.id)
            .maybeSingle();
          
          currentUserId = user.id;
          currentUsername = userData?.username || user.user_metadata?.username || user.email?.split('@')[0] || 'User';
          currentUserAvatar = userData?.profile_picture_url || currentUsername.charAt(0).toUpperCase();
          
          // Update header profile avatar
          await updateHeaderProfileAvatar();
          
          // Show chat widget
          if (chatWidget) {
            chatWidget.style.display = 'block';
          }
          
          // Load existing messages
          await loadMessages();
          
          // Subscribe to new messages
          subscribeToMessages();
          
          isChatInitialized = true;
        } catch (error) {
          console.error('Error initializing chat:', error);
        }
      }
      
      // Load existing messages
      async function loadMessages() {
        if (!supabase || !chatMessages) return;
        
        try {
          const { data, error } = await supabase
            .from('chat_messages')
            .select('*')
            .order('created_at', { ascending: true })
            .limit(100);
          
          if (error) {
            console.error('Error loading messages:', error);
            return;
          }
          
          // Clear existing messages
          chatMessages.innerHTML = '';
          
          // Render messages
          if (data && data.length > 0) {
            data.forEach(msg => renderMessage(msg));
            scrollToBottom();
          } else {
            chatMessages.innerHTML = '<div style="text-align: center; color: #888; padding: 20px; font-size: 14px;">No messages yet. Be the first to say something!</div>';
          }
        } catch (error) {
          console.error('Error loading messages:', error);
        }
      }
      
      // Subscribe to real-time message updates
      function subscribeToMessages() {
        if (!supabase) return;
        
        // Remove existing subscription if any
        if (chatSubscription) {
          supabase.removeChannel(chatSubscription);
        }
        
        chatSubscription = supabase
          .channel('chat_messages')
          .on('postgres_changes', 
            { 
              event: 'INSERT', 
              schema: 'public', 
              table: 'chat_messages' 
            }, 
            (payload) => {
              renderMessage(payload.new);
              scrollToBottom();
              
              // Update unread count if chat is closed
              if (!chatPanel.classList.contains('open')) {
                unreadCount++;
                updateBadge();
              }
            }
          )
          .subscribe();
      }
      
      // Render a message
      function renderMessage(msg) {
        if (!chatMessages) return;
        
        // Remove "no messages" placeholder if it exists
        const placeholder = chatMessages.querySelector('div[style*="text-align: center"]');
        if (placeholder) {
          placeholder.remove();
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message';
        
        const avatarUrl = msg.avatar && (msg.avatar.startsWith('http') || msg.avatar.startsWith('data:')) ? msg.avatar : null;
        const avatarInitial = msg.username ? msg.username.charAt(0).toUpperCase() : '?';
        const username = msg.username || 'Anonymous';
        const message = msg.message || '';
        const time = msg.created_at ? formatTime(new Date(msg.created_at)) : '';
        const userId = msg.user_id || '';
        
        // Create avatar element
        let avatarHtml = '';
        if (avatarUrl && (avatarUrl.startsWith('http') || avatarUrl.startsWith('data:'))) {
          avatarHtml = `<img src="${escapeHtml(avatarUrl)}" alt="${escapeHtml(username)}" />`;
        } else {
          avatarHtml = avatarInitial;
        }
        
        messageDiv.innerHTML = `
          <div class="chat-message-avatar" data-user-id="${escapeHtml(userId)}" data-username="${escapeHtml(username)}" data-avatar="${escapeHtml(avatarUrl || '')}">${avatarHtml}</div>
          <div class="chat-message-content">
            <div class="chat-message-header">
              <span class="chat-message-username" data-user-id="${escapeHtml(userId)}" data-username="${escapeHtml(username)}" data-avatar="${escapeHtml(avatarUrl || '')}">${escapeHtml(username)}</span>
              <span class="chat-message-time">${time}</span>
            </div>
            <div class="chat-message-text">${escapeHtml(message)}</div>
          </div>
        `;
        
        // Add click handlers for profile viewing
        const avatarEl = messageDiv.querySelector('.chat-message-avatar');
        const usernameEl = messageDiv.querySelector('.chat-message-username');
        
        if (avatarEl && userId) {
          avatarEl.addEventListener('click', () => showProfile(userId, username, avatarUrl));
        }
        if (usernameEl && userId) {
          usernameEl.addEventListener('click', () => showProfile(userId, username, avatarUrl));
        }
        
        chatMessages.appendChild(messageDiv);
      }
      
      // Show user profile
      async function showProfile(userId, username, avatarUrl) {
        if (!supabase || !userId) return;
        
        const profileModalBg = document.getElementById('profile-modal-bg');
        const profileModalAvatar = document.getElementById('profile-modal-avatar');
        const profileModalUsername = document.getElementById('profile-modal-username');
        const profileModalUserid = document.getElementById('profile-modal-userid');
        const profileModalJoindate = document.getElementById('profile-modal-joindate');
        const profileModalDescription = document.getElementById('profile-modal-description');
        const profileModalDescriptionEdit = document.getElementById('profile-modal-description-edit');
        const profileDescriptionActions = document.getElementById('profile-modal-description-actions');
        const profileDescriptionEditBtn = document.getElementById('profile-description-edit-btn');
        
        if (!profileModalBg) return;
        
        // Hide edit controls initially
        if (profileModalDescriptionEdit) profileModalDescriptionEdit.style.display = 'none';
        if (profileDescriptionActions) profileDescriptionActions.style.display = 'none';
        if (profileDescriptionEditBtn) profileDescriptionEditBtn.style.display = 'none';
        
        // Set username and avatar immediately
        if (profileModalUsername) {
          profileModalUsername.textContent = username || 'Unknown User';
        }
        
        if (profileModalAvatar) {
          if (avatarUrl && (avatarUrl.startsWith('http') || avatarUrl.startsWith('data:'))) {
            profileModalAvatar.innerHTML = `<img src="${escapeHtml(avatarUrl)}" alt="${escapeHtml(username)}" />`;
            profileModalAvatar.style.background = 'transparent';
          } else {
            const initial = username ? username.charAt(0).toUpperCase() : '?';
            profileModalAvatar.innerHTML = '';
            profileModalAvatar.textContent = initial;
            profileModalAvatar.style.background = 'linear-gradient(135deg, #00e6d6 0%, #00b8a8 100%)';
          }
        }
        
        // Check if this is the current user's profile
        // Get current user ID from session
        let isOwnProfile = false;
        try {
          const { data: { session } } = await supabase.auth.getSession();
          if (session && session.user) {
            isOwnProfile = session.user.id === userId;
          }
        } catch (e) {
          console.error('Error checking own profile:', e);
        }
        
        // Fetch user details from database
        try {
          const { data: userData, error } = await supabase
            .from('unlocked_users')
            .select('auth_user_id, email, created_at, description, profile_picture_url')
            .eq('auth_user_id', userId)
            .maybeSingle();
          
          if (userData) {
            // Set user ID
            if (profileModalUserid) {
              profileModalUserid.textContent = userId.substring(0, 8) + '...';
            }
            
            // Set join date
            if (profileModalJoindate && userData.created_at) {
              const joinDate = new Date(userData.created_at);
              profileModalJoindate.textContent = joinDate.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
              });
            } else if (profileModalJoindate) {
              profileModalJoindate.textContent = 'Unknown';
            }
            
            // Set description
            if (profileModalDescription) {
              const description = userData.description || '';
              if (description.trim()) {
                profileModalDescription.textContent = description;
                profileModalDescription.classList.remove('empty');
              } else {
                profileModalDescription.textContent = isOwnProfile ? 'No description yet. Click "Edit Description" to add one.' : 'No description.';
                profileModalDescription.classList.add('empty');
              }
            }
            
            // Show edit button if it's own profile
            if (isOwnProfile && profileDescriptionEditBtn) {
              profileDescriptionEditBtn.style.display = 'block';
            }
          } else {
            // Fallback if user not found in unlocked_users
            if (profileModalUserid) {
              profileModalUserid.textContent = userId.substring(0, 8) + '...';
            }
            if (profileModalJoindate) {
              profileModalJoindate.textContent = 'Unknown';
            }
            if (profileModalDescription) {
              profileModalDescription.textContent = isOwnProfile ? 'No description yet. Click "Edit Description" to add one.' : 'No description.';
              profileModalDescription.classList.add('empty');
            }
            if (isOwnProfile && profileDescriptionEditBtn) {
              profileDescriptionEditBtn.style.display = 'block';
            }
          }
        } catch (error) {
          console.error('Error fetching user profile:', error);
          if (profileModalUserid) {
            profileModalUserid.textContent = userId.substring(0, 8) + '...';
          }
          if (profileModalJoindate) {
            profileModalJoindate.textContent = 'Unknown';
          }
          if (profileModalDescription) {
            profileModalDescription.textContent = isOwnProfile ? 'No description yet. Click "Edit Description" to add one.' : 'No description.';
            profileModalDescription.classList.add('empty');
          }
        }
        
        // Set up edit functionality for own profile
        if (isOwnProfile) {
          setupProfileDescriptionEdit(userId);
        }
        
        // Show modal
        profileModalBg.classList.add('show');
      }
      
      // Setup profile description editing
      function setupProfileDescriptionEdit(userId) {
        const profileModalDescription = document.getElementById('profile-modal-description');
        const profileModalDescriptionEdit = document.getElementById('profile-modal-description-edit');
        const profileDescriptionActions = document.getElementById('profile-modal-description-actions');
        const profileDescriptionEditBtn = document.getElementById('profile-description-edit-btn');
        const profileDescriptionSaveBtn = document.getElementById('profile-description-save-btn');
        const profileDescriptionCancelBtn = document.getElementById('profile-description-cancel-btn');
        
        if (!profileModalDescription || !profileModalDescriptionEdit || !profileDescriptionEditBtn) return;
        
        // Remove existing listeners to avoid duplicates
        const newEditBtn = profileDescriptionEditBtn.cloneNode(true);
        profileDescriptionEditBtn.parentNode.replaceChild(newEditBtn, profileDescriptionEditBtn);
        
        newEditBtn.addEventListener('click', () => {
          const currentDescription = profileModalDescription.textContent;
          const isEmpty = profileModalDescription.classList.contains('empty');
          
          profileModalDescription.style.display = 'none';
          profileModalDescriptionEdit.style.display = 'block';
          profileDescriptionActions.style.display = 'flex';
          newEditBtn.style.display = 'none';
          
          profileModalDescriptionEdit.value = isEmpty ? '' : currentDescription;
          profileModalDescriptionEdit.focus();
        });
        
        if (profileDescriptionSaveBtn) {
          const newSaveBtn = profileDescriptionSaveBtn.cloneNode(true);
          profileDescriptionSaveBtn.parentNode.replaceChild(newSaveBtn, profileDescriptionSaveBtn);
          
          newSaveBtn.addEventListener('click', async () => {
            const newDescription = profileModalDescriptionEdit.value.trim();
            
            try {
              const { error } = await supabase
                .from('unlocked_users')
                .update({ description: newDescription })
                .eq('auth_user_id', userId);
              
              if (error) throw error;
              
              // Update display
              if (newDescription) {
                profileModalDescription.textContent = newDescription;
                profileModalDescription.classList.remove('empty');
              } else {
                profileModalDescription.textContent = 'No description yet. Click "Edit Description" to add one.';
                profileModalDescription.classList.add('empty');
              }
              
              // Hide edit mode
              profileModalDescription.style.display = 'block';
              profileModalDescriptionEdit.style.display = 'none';
              profileDescriptionActions.style.display = 'none';
              newEditBtn.style.display = 'block';
            } catch (error) {
              console.error('Error saving description:', error);
              alert('Failed to save description. Please try again.');
            }
          });
        }
        
        if (profileDescriptionCancelBtn) {
          const newCancelBtn = profileDescriptionCancelBtn.cloneNode(true);
          profileDescriptionCancelBtn.parentNode.replaceChild(newCancelBtn, profileDescriptionCancelBtn);
          
          newCancelBtn.addEventListener('click', () => {
            profileModalDescription.style.display = 'block';
            profileModalDescriptionEdit.style.display = 'none';
            profileDescriptionActions.style.display = 'none';
            newEditBtn.style.display = 'block';
          });
        }
      }
      
      // Get current user's profile picture URL
      async function getUserProfilePicture() {
        if (!supabase || !currentUserId) return null;
        
        try {
          const { data: userData } = await supabase
            .from('unlocked_users')
            .select('profile_picture_url')
            .eq('auth_user_id', currentUserId)
            .maybeSingle();
          
          return userData?.profile_picture_url || null;
        } catch (error) {
          console.error('Error fetching profile picture:', error);
          return null;
        }
      }
      
      // Send a message
      async function sendMessage() {
        if (!supabase || !chatInput || !currentUserId) return;
        
        const message = chatInput.value.trim();
        if (!message) return;
        
        // Disable send button
        if (chatSendBtn) {
          chatSendBtn.disabled = true;
        }
        
        try {
          // Get user's profile picture URL
          const profilePictureUrl = await getUserProfilePicture();
          
          const { error } = await supabase
            .from('chat_messages')
            .insert({
              username: currentUsername,
              avatar: profilePictureUrl || currentUserAvatar,
              message: message,
              user_id: currentUserId
            });
          
          if (error) {
            console.error('Error sending message:', error);
            alert('Failed to send message. Please try again.');
          } else {
            // Clear input
            chatInput.value = '';
          }
        } catch (error) {
          console.error('Error sending message:', error);
          alert('Failed to send message. Please try again.');
        } finally {
          // Re-enable send button
          if (chatSendBtn) {
            chatSendBtn.disabled = false;
          }
        }
      }
      
      // Format time
      function formatTime(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        
        if (minutes < 1) return 'just now';
        if (minutes < 60) return `${minutes}m ago`;
        
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;
        
        const days = Math.floor(hours / 24);
        if (days < 7) return `${days}d ago`;
        
        return date.toLocaleDateString();
      }
      
      // Escape HTML
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      // Scroll to bottom
      function scrollToBottom() {
        if (chatMessages) {
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      }
      
      // Update badge
      function updateBadge() {
        if (chatBadge) {
          if (unreadCount > 0) {
            chatBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
            chatBadge.style.display = 'flex';
          } else {
            chatBadge.style.display = 'none';
          }
        }
      }
      
      // Toggle chat panel
      function toggleChat() {
        if (chatPanel) {
          chatPanel.classList.toggle('open');
          if (chatPanel.classList.contains('open')) {
            // Reset unread count when opening
            unreadCount = 0;
            updateBadge();
            scrollToBottom();
            // Focus input
            setTimeout(() => {
              if (chatInput) chatInput.focus();
            }, 100);
          }
        }
      }
      
      // Event listeners
      if (chatToggleBtn) {
        chatToggleBtn.addEventListener('click', toggleChat);
      }
      
      if (chatCloseBtn) {
        chatCloseBtn.addEventListener('click', toggleChat);
      }
      
      if (chatSendBtn) {
        chatSendBtn.addEventListener('click', sendMessage);
      }
      
      if (chatInput) {
        chatInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
      }
      
      // Initialize chat when page loads and user is unlocked
      function checkAndInitChat() {
        // Don't initialize if site is locked
        if (document.body.classList.contains('site-locked')) {
          // Hide chat widget when locked
          if (chatWidget) {
            chatWidget.style.display = 'none';
          }
          return;
        }
        
        const currentUser = localStorage.getItem('mmcs_current_user');
        if (currentUser) {
          initChat();
        } else {
          // Hide chat widget if no user
          if (chatWidget) {
            chatWidget.style.display = 'none';
          }
        }
      }
      
      // Check periodically if user becomes unlocked
      setInterval(checkAndInitChat, 2000);
      
      // Also check on DOMContentLoaded
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(checkAndInitChat, 1000);
        });
      } else {
        setTimeout(checkAndInitChat, 1000);
      }
      
      // Profile picture upload functionality
      const profilePictureBtn = document.getElementById('profile-picture-btn');
      const profilePictureInput = document.getElementById('profile-picture-input');
      const profileModalClose = document.getElementById('profile-modal-close');
      const profileModalBg = document.getElementById('profile-modal-bg');
      
      // Profile picture avatar in header
      const headerProfileAvatar = document.getElementById('header-profile-avatar');
      
      // Update header profile avatar display
      async function updateHeaderProfileAvatar() {
        if (!headerProfileAvatar) return;
        
        const currentUser = localStorage.getItem('mmcs_current_user');
        if (currentUser && !document.body.classList.contains('site-locked')) {
          headerProfileAvatar.style.display = 'flex';
          
          // Get user's profile picture
          const profilePictureUrl = await getUserProfilePicture();
          const currentUsername = localStorage.getItem('mmcs_current_username') || 'User';
          const initial = currentUsername.charAt(0).toUpperCase();
          
          if (profilePictureUrl && (profilePictureUrl.startsWith('http') || profilePictureUrl.startsWith('data:'))) {
            headerProfileAvatar.innerHTML = `<img src="${profilePictureUrl}" alt="${currentUsername}" />`;
            headerProfileAvatar.style.background = 'transparent';
          } else {
            headerProfileAvatar.innerHTML = '';
            headerProfileAvatar.textContent = initial;
            headerProfileAvatar.style.background = 'linear-gradient(135deg, #00e6d6 0%, #00b8a8 100%)';
          }
        } else {
          headerProfileAvatar.style.display = 'none';
        }
      }
      
      // Make avatar clickable to show profile modal
      if (headerProfileAvatar) {
        headerProfileAvatar.addEventListener('click', async () => {
          // Get current user info
          const currentUser = localStorage.getItem('mmcs_current_user');
          if (!currentUser || document.body.classList.contains('site-locked')) {
            return;
          }
          
          // Wait a bit for showProfile to be available (it's defined in chat system)
          await new Promise(resolve => setTimeout(resolve, 100));
          
          // Get user ID and profile picture
          const profilePictureUrl = await getUserProfilePicture();
          const currentUsername = localStorage.getItem('mmcs_current_username') || 'User';
          
          // Get current user ID from Supabase auth
          // Use the same Supabase client as the chat system
          const SUPABASE_URL = 'https://wbpfuuiznsmysbskywdx.supabase.co';
          const SUPABASE_ANON_KEY = 'sb_publishable_rIy_-DWT87Gj9ao1WvN3gA_WA6eME-x';
          
          if (window.supabase && window.showProfile) {
            const chatSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
              auth: {
                persistSession: true,
                autoRefreshToken: true,
                storage: window.localStorage,
                storageKey: 'sb-wbpfuuiznsmysbskywdx-auth-token'
              }
            });
            
            const { data: { user } } = await chatSupabase.auth.getUser();
            if (user && user.id) {
              window.showProfile(user.id, currentUsername, profilePictureUrl || null);
            }
          }
        });
      }
      
      // Show profile picture button when user is logged in
      function updateProfileButtonVisibility() {
        const currentUser = localStorage.getItem('mmcs_current_user');
        if (profilePictureBtn) {
          if (currentUser && !document.body.classList.contains('site-locked')) {
            profilePictureBtn.style.display = 'inline-block';
          } else {
            profilePictureBtn.style.display = 'none';
          }
        }
        // Also update avatar
        updateHeaderProfileAvatar();
      }
      
      // Handle profile picture selection
      if (profilePictureBtn && profilePictureInput) {
        profilePictureBtn.addEventListener('click', () => {
          profilePictureInput.click();
        });
        
        profilePictureInput.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if (!file || !file.type.startsWith('image/')) {
            alert('Please select a valid image file.');
            return;
          }
          
          // Check file size (max 2MB)
          if (file.size > 2 * 1024 * 1024) {
            alert('Image size must be less than 2MB.');
            return;
          }
          
          // Convert to base64 or upload to Supabase Storage
          // For simplicity, we'll use base64 and store in database
          const reader = new FileReader();
          reader.onload = async (event) => {
            const base64Image = event.target.result;
            
            try {
              // Update user's profile picture in database
              const { data: { user } } = await supabase.auth.getUser();
              if (!user) {
                alert('You must be logged in to update your profile picture.');
                return;
              }
              
              // Update unlocked_users table with profile picture URL
              const { error } = await supabase
                .from('unlocked_users')
                .update({ profile_picture_url: base64Image })
                .eq('auth_user_id', user.id);
              
              if (error) {
                console.error('Error updating profile picture:', error);
                alert('Failed to update profile picture. Please try again.');
              } else {
                alert('Profile picture updated successfully!');
                // Refresh chat to show new avatar
                if (isChatInitialized) {
                  await loadMessages();
                }
                // Update header avatar
                await updateHeaderProfileAvatar();
              }
            } catch (error) {
              console.error('Error saving profile picture:', error);
              alert('Failed to save profile picture. Please try again.');
            }
          };
          
          reader.readAsDataURL(file);
        });
      }
      
      // Close profile modal
      if (profileModalClose) {
        profileModalClose.addEventListener('click', () => {
          if (profileModalBg) {
            profileModalBg.classList.remove('show');
          }
        });
      }
      
      // Close modal when clicking outside
      if (profileModalBg) {
        profileModalBg.addEventListener('click', (e) => {
          if (e.target === profileModalBg) {
            profileModalBg.classList.remove('show');
          }
        });
      }
      
      // Update profile button visibility periodically
      setInterval(updateProfileButtonVisibility, 1000);
      updateProfileButtonVisibility();
      
      // Expose functions
      window.initChat = initChat;
      window.showProfile = showProfile;
      
      // Manage Subscription Button Handler
      const manageSubscriptionBtn = document.getElementById('manage-subscription-btn');
      if (manageSubscriptionBtn) {
        manageSubscriptionBtn.addEventListener('click', function() {
          const currentUser = localStorage.getItem('mmcs_current_user');
          if (!currentUser) {
            if (window.initUnlockSystem) {
              window.initUnlockSystem();
            }
            return;
          }
          if (window.showSubscriptionManagement) {
            window.showSubscriptionManagement();
          }
        });
      }
      
      // Discord Notifications Button Handlers
      const discordNotificationsBtn = document.getElementById('discord-notifications-btn');
      const headerDiscordBtn = document.getElementById('header-discord-notifications-btn');
      const mainDiscordBtn = document.getElementById('main-discord-notifications-btn');
      
      function handleDiscordNotificationsClick() {
        const currentUser = localStorage.getItem('mmcs_current_user');
        if (!currentUser) {
          // If not logged in, show upgrade modal highlighting Pro tier
          if (window.showUpgradeModal) {
            window.showUpgradeModal();
            // Highlight Pro tier after modal opens
            setTimeout(() => {
              const proTier = document.querySelector('.subscription-tier[data-tier="pro"]');
              if (proTier) {
                proTier.scrollIntoView({ behavior: 'smooth', block: 'center' });
                proTier.style.border = '2px solid #00e6d6';
                proTier.style.boxShadow = '0 0 20px rgba(0, 230, 214, 0.5)';
              }
            }, 100);
          } else if (window.initUnlockSystem) {
            window.initUnlockSystem();
          } else {
            alert('Discord notifications require Pro tier ($10/month). Please sign up and subscribe to Pro to enable Discord notifications!');
          }
          return;
        }
        // Check if user has Pro tier, if not show upgrade modal
        if (window.getCurrentSubscriptionTier) {
          window.getCurrentSubscriptionTier().then(tier => {
            if (tier === 'pro') {
              // User has Pro, show Discord notifications modal
              if (window.showDiscordNotificationsModal) {
                window.showDiscordNotificationsModal();
              }
            } else {
              // User doesn't have Pro, show upgrade modal highlighting Pro
              if (window.showUpgradeModal) {
                window.showUpgradeModal();
                setTimeout(() => {
                  const proTier = document.querySelector('.subscription-tier[data-tier="pro"]');
                  if (proTier) {
                    proTier.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    proTier.style.border = '2px solid #00e6d6';
                    proTier.style.boxShadow = '0 0 20px rgba(0, 230, 214, 0.5)';
                  }
                }, 100);
              } else {
                alert('Discord notifications require Pro tier ($10/month). Please upgrade to Pro to enable Discord notifications!');
              }
            }
          });
        } else {
          // Fallback: show Discord notifications modal (will check subscription inside)
          if (window.showDiscordNotificationsModal) {
            window.showDiscordNotificationsModal();
          }
        }
      }
      
      if (discordNotificationsBtn) {
        discordNotificationsBtn.addEventListener('click', handleDiscordNotificationsClick);
      }
      
      if (headerDiscordBtn) {
        headerDiscordBtn.addEventListener('click', handleDiscordNotificationsClick);
      }
      
      if (mainDiscordBtn) {
        mainDiscordBtn.addEventListener('click', handleDiscordNotificationsClick);
      }
      } catch (error) {
        console.error('Error initializing chat system:', error);
        // Don't break the page if chat fails
      }
    })();
    
    // Discord Notifications Management
    (function() {
      const SUPABASE_URL = 'https://wbpfuuiznsmysbskywdx.supabase.co';
      const SUPABASE_ANON_KEY = 'sb_publishable_rIy_-DWT87Gj9ao1WvN3gA_WA6eME-x';
      const supabase = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
      
      let userNotifications = [];
      
      // Expose function globally
      window.showDiscordNotificationsModal = showDiscordNotificationsModal;
      
      async function showDiscordNotificationsModal() {
        const modal = document.getElementById('discord-notifications-modal-bg');
        if (!modal) return;
        
        modal.style.display = 'flex';
        await loadDiscordNotifications();
        populateMarketsSelect();
      }
      
      async function checkDiscordSubscription() {
        if (!supabase) return false;
        
        try {
          const { data: { session } } = await supabase.auth.getSession();
          if (!session) return false;
          
          const { data: { user } } = await supabase.auth.getUser();
          if (!user) return false;
          
          // Check if user has Pro tier (Discord notifications require Pro)
          const currentTier = await getCurrentSubscriptionTier();
          if (currentTier !== 'pro') {
            return false; // Discord notifications require Pro tier
          }
          
          const { data: userData, error } = await supabase
            .from('unlocked_users')
            .select('subscription_tier, subscription_expires_at')
            .eq('auth_user_id', user.id)
            .maybeSingle();
          
          if (error || !userData) return false;
          
          // Verify Pro tier and check if subscription is not expired
          if (userData.subscription_tier !== 'pro') return false;
          
          if (userData.subscription_expires_at) {
            const expiresAt = new Date(userData.subscription_expires_at);
            if (expiresAt < new Date()) {
              return false; // Subscription expired
            }
          }
          
          return true;
        } catch (err) {
          console.error('Error checking Discord subscription:', err);
          return false;
        }
      }
      
      function hideDiscordNotificationsModal() {
        const modal = document.getElementById('discord-notifications-modal-bg');
        if (modal) modal.style.display = 'none';
      }
      
      async function loadDiscordNotifications() {
        if (!supabase) return;
        
        try {
          const { data: { session } } = await supabase.auth.getSession();
          if (!session) return;
          
          const { data: { user } } = await supabase.auth.getUser();
          if (!user) return;
          
          // Check subscription status first
          const hasSubscription = await checkDiscordSubscription();
          const statusInfo = document.getElementById('discord-subscription-info');
          
          // Get button elements once
          const subscribeBtn = document.getElementById('discord-subscribe-btn');
          const testBtn = document.getElementById('discord-notifications-test-btn');
          const saveBtn = document.getElementById('discord-notifications-save-btn');
          const webhookInput = document.getElementById('discord-webhook-input');
          const addBtn = document.getElementById('add-discord-notification-btn');
          
          if (!hasSubscription) {
            if (statusInfo) {
              statusInfo.innerHTML = '<span style="color: #ff6b6b;">❌ Pro tier required</span><br><span style="font-size: 11px;">Discord notifications require Pro tier ($10/month). Subscribe to Pro to enable.</span>';
            }
            // Show subscribe button, hide test/save
            if (subscribeBtn) subscribeBtn.style.display = 'inline-block';
            if (testBtn) testBtn.style.display = 'none';
            if (saveBtn) saveBtn.style.display = 'none';
            
            // Disable inputs
            if (webhookInput) webhookInput.disabled = true;
            if (addBtn) addBtn.disabled = true;
            return;
          }
          
          // Hide subscribe button, show test/save
          if (subscribeBtn) subscribeBtn.style.display = 'none';
          if (testBtn) testBtn.style.display = 'inline-block';
          if (saveBtn) saveBtn.style.display = 'inline-block';
          
          // Load subscription expiry info
          const { data: userData, error } = await supabase
            .from('unlocked_users')
            .select('discord_webhook_url, discord_notifications, subscription_tier, subscription_expires_at')
            .eq('auth_user_id', user.id)
            .maybeSingle();
          
          if (error) {
            console.error('Error loading Discord notifications:', error);
            return;
          }
          
          // Show subscription status (Pro tier)
          if (statusInfo && userData?.subscription_expires_at) {
            const expiresAt = new Date(userData.subscription_expires_at);
            const daysLeft = Math.ceil((expiresAt - new Date()) / (1000 * 60 * 60 * 24));
            statusInfo.innerHTML = `<span style="color: #00e6d6;">✅ Pro tier active</span><br><span style="font-size: 11px;">Expires in ${daysLeft} day${daysLeft !== 1 ? 's' : ''}</span>`;
          } else if (statusInfo) {
            statusInfo.innerHTML = '<span style="color: #00e6d6;">✅ Pro tier active</span>';
          }
          
          // Enable inputs (already declared above)
          if (webhookInput) webhookInput.disabled = false;
          if (addBtn) addBtn.disabled = false;
          
          // Set webhook URL
          if (webhookInput) {
            webhookInput.value = userData?.discord_webhook_url || '';
          }
          
          // Load notifications
          if (userData?.discord_notifications) {
            try {
              userNotifications = typeof userData.discord_notifications === 'string' 
                ? JSON.parse(userData.discord_notifications) 
                : userData.discord_notifications;
            } catch (e) {
              userNotifications = [];
            }
          } else {
            userNotifications = [];
          }
          
          renderNotificationsList();
        } catch (err) {
          console.error('Error loading Discord notifications:', err);
        }
      }
      
      function renderNotificationsList() {
        const list = document.getElementById('discord-notifications-list');
        if (!list) return;
        
        if (userNotifications.length === 0) {
          list.innerHTML = '<div style="color: #888; font-size: 12px; text-align: center; padding: 20px;">No notifications configured</div>';
          return;
        }
        
        // Sort notifications A-Z by search term
        const sortedNotifications = [...userNotifications].sort((a, b) => {
          const termA = (a.searchTerm || '').toLowerCase();
          const termB = (b.searchTerm || '').toLowerCase();
          return termA.localeCompare(termB);
        });
        
        list.innerHTML = '';
        sortedNotifications.forEach((notif, index) => {
          // Find original index for deletion
          const originalIndex = userNotifications.findIndex(n => n.id === notif.id);
          const item = document.createElement('div');
          item.style.cssText = 'background: rgba(44,46,48,0.55); border-radius: 8px; padding: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;';
          
          const info = document.createElement('div');
          info.style.cssText = 'flex: 1;';
          
          const term = document.createElement('div');
          term.style.cssText = 'color: #e3e3e3; font-weight: bold; margin-bottom: 4px;';
          term.textContent = notif.searchTerm || 'Untitled';
          
          const markets = document.createElement('div');
          markets.style.cssText = 'color: #b0b0b0; font-size: 12px;';
          if (notif.markets && notif.markets.length > 0) {
            // Get market labels for display
            const marketLabelMap = {
              'mercari-jp': 'Mercari Japan',
              'paypay-fleamarket': 'Yahoo PayPay Flea',
              'rakuma': 'Rakuten Rakuma',
              'rakuten-jp': 'Rakuten',
              'yahoo-auctions': 'Yahoo Auctions'
            };
            const marketLabels = notif.markets
              .map(key => marketLabelMap[key] || key)
              .sort(); // Sort market labels A-Z too
            markets.textContent = `Markets: ${marketLabels.join(', ')}`;
          } else {
            markets.textContent = 'All 5 supported markets';
          }
          
          info.appendChild(term);
          info.appendChild(markets);
          
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = '🗑';
          deleteBtn.style.cssText = 'background: rgba(255,107,107,0.2); border: none; color: #ff6b6b; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 14px;';
          deleteBtn.onclick = () => {
            if (originalIndex !== -1) {
              userNotifications.splice(originalIndex, 1);
            }
            renderNotificationsList();
          };
          
          item.appendChild(info);
          item.appendChild(deleteBtn);
          list.appendChild(item);
        });
      }
      
      function populateMarketsSelect() {
        const select = document.getElementById('notification-markets-select');
        if (!select) return;
        
        select.innerHTML = '';
        
        // Only show markets that actually work with the notifier (Sendico-supported)
        const supportedMarketKeys = [
          'mercari-jp',
          'paypay-fleamarket',
          'rakuma',
          'rakuten-jp',
          'yahoo-auctions'
        ];
        
        // Get all available markets
        const allMarkets = [
          ...getMarkets('asia'),
          ...getMarkets('international'),
          ...getMarkets('special')
        ];
        
        // Filter to only supported markets
        const supportedMarkets = allMarkets.filter(m => supportedMarketKeys.includes(m.key));
        
        // Sort alphabetically
        supportedMarkets.sort((a, b) => a.label.localeCompare(b.label));
        
        supportedMarkets.forEach(market => {
          const option = document.createElement('option');
          option.value = market.key;
          option.textContent = market.label.replace(' ★', '');
          select.appendChild(option);
        });
        
        // Add a note if no markets found (shouldn't happen, but just in case)
        if (supportedMarkets.length === 0) {
          const option = document.createElement('option');
          option.disabled = true;
          option.textContent = 'No supported markets available';
          select.appendChild(option);
        }
      }
      
      async function saveDiscordNotifications() {
        if (!supabase) {
          alert('Database connection not available.');
          return;
        }
        
        try {
          const { data: { session } } = await supabase.auth.getSession();
          if (!session) {
            alert('Please log in to save notifications.');
            return;
          }
          
          const { data: { user } } = await supabase.auth.getUser();
          if (!user) return;
          
          const webhookInput = document.getElementById('discord-webhook-input');
          const webhookUrl = webhookInput ? webhookInput.value.trim() : '';
          
          // Validate webhook URL if provided
          if (webhookUrl && !webhookUrl.startsWith('https://discord.com/api/webhooks/')) {
            alert('Please enter a valid Discord webhook URL.');
            return;
          }
          
          // Save to database
          const { error } = await supabase
            .from('unlocked_users')
            .update({
              discord_webhook_url: webhookUrl || null,
              discord_notifications: userNotifications.length > 0 ? JSON.stringify(userNotifications) : null
            })
            .eq('auth_user_id', user.id);
          
          if (error) {
            console.error('Error saving Discord notifications:', error);
            alert('Error saving notifications. Please try again.');
            return;
          }
          
          alert('Discord notifications saved successfully!');
          hideDiscordNotificationsModal();
        } catch (err) {
          console.error('Error saving Discord notifications:', err);
          alert('Error saving notifications. Please try again.');
        }
      }
      
      async function testDiscordWebhook() {
        const webhookInput = document.getElementById('discord-webhook-input');
        const webhookUrl = webhookInput ? webhookInput.value.trim() : '';
        
        if (!webhookUrl) {
          alert('Please enter a Discord webhook URL first.');
          return;
        }
        
        if (!webhookUrl.startsWith('https://discord.com/api/webhooks/')) {
          alert('Please enter a valid Discord webhook URL.');
          return;
        }
        
        try {
          const response = await fetch(webhookUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              content: '✅ **Discord Notifications Test**\n\nYour webhook is working correctly! You will receive notifications here when new items match your saved search terms.',
              embeds: [{
                title: 'MMCS Notification Test',
                description: 'If you received this message, your Discord notifications are set up correctly!',
                color: 0x00e6d6,
                timestamp: new Date().toISOString()
              }]
            })
          });
          
          if (response.ok) {
            alert('✅ Test message sent successfully! Check your Discord channel.');
          } else {
            alert('❌ Failed to send test message. Please check your webhook URL.');
          }
        } catch (err) {
          console.error('Error testing webhook:', err);
          alert('❌ Error testing webhook. Please check your webhook URL and try again.');
        }
      }
      
      function showAddNotificationModal() {
        const modal = document.getElementById('add-notification-modal-bg');
        if (!modal) return;
        
        modal.style.display = 'flex';
        populateMarketsSelect();
        
        const termInput = document.getElementById('notification-search-term-input');
        if (termInput) {
          termInput.value = '';
          setTimeout(() => termInput.focus(), 100);
        }
      }
      
      function hideAddNotificationModal() {
        const modal = document.getElementById('add-notification-modal-bg');
        if (modal) modal.style.display = 'none';
      }
      
      function addNotification() {
        const termInput = document.getElementById('notification-search-term-input');
        const marketsSelect = document.getElementById('notification-markets-select');
        
        if (!termInput || !marketsSelect) return;
        
        const searchTerm = termInput.value.trim();
        if (!searchTerm) {
          alert('Please enter a search term.');
          return;
        }
        
        const selectedMarkets = Array.from(marketsSelect.selectedOptions).map(opt => opt.value);
        
        userNotifications.push({
          id: Date.now().toString(36) + Math.random().toString(36).substr(2),
          searchTerm: searchTerm,
          markets: selectedMarkets.length > 0 ? selectedMarkets : null, // null means all markets
          createdAt: new Date().toISOString()
        });
        
        // Clear form
        termInput.value = '';
        marketsSelect.selectedIndex = -1; // Deselect all
        
        renderNotificationsList();
        hideAddNotificationModal();
      }
      
      // Event listeners
      const discordModalClose = document.getElementById('discord-notifications-modal-close');
      if (discordModalClose) {
        discordModalClose.addEventListener('click', hideDiscordNotificationsModal);
      }
      
      const discordModalBg = document.getElementById('discord-notifications-modal-bg');
      if (discordModalBg) {
        discordModalBg.addEventListener('click', function(e) {
          if (e.target === discordModalBg) hideDiscordNotificationsModal();
        });
      }
      
      const discordSaveBtn = document.getElementById('discord-notifications-save-btn');
      if (discordSaveBtn) {
        discordSaveBtn.addEventListener('click', saveDiscordNotifications);
      }
      
      const discordTestBtn = document.getElementById('discord-notifications-test-btn');
      if (discordTestBtn) {
        discordTestBtn.addEventListener('click', testDiscordWebhook);
      }
      
      const addNotificationBtn = document.getElementById('add-discord-notification-btn');
      if (addNotificationBtn) {
        addNotificationBtn.addEventListener('click', showAddNotificationModal);
      }
      
      const addNotificationSaveBtn = document.getElementById('add-notification-save-btn');
      if (addNotificationSaveBtn) {
        addNotificationSaveBtn.addEventListener('click', addNotification);
      }
      
      const addNotificationCancelBtn = document.getElementById('add-notification-cancel-btn');
      if (addNotificationCancelBtn) {
        addNotificationCancelBtn.addEventListener('click', hideAddNotificationModal);
      }
      
      const addNotificationModalBg = document.getElementById('add-notification-modal-bg');
      if (addNotificationModalBg) {
        addNotificationModalBg.addEventListener('click', function(e) {
          if (e.target === addNotificationModalBg) hideAddNotificationModal();
        });
      }
      
      // Subscribe button handler
      const subscribeBtn = document.getElementById('discord-subscribe-btn');
      if (subscribeBtn) {
        subscribeBtn.addEventListener('click', function() {
          // Discord notifications require Pro tier ($10)
          const stripePaymentLink = STRIPE_CHECKOUT_LINKS.pro; // Use Pro tier link
          
          // Open in new tab
          window.open(stripePaymentLink, '_blank');
          
          // Show message
          alert('Opening Stripe checkout for Pro tier ($10/month)...\n\nPro tier includes Discord notifications and all premium features.\n\nAfter payment, your subscription will be activated automatically.');
        });
      }
    })();

    // Online Users Counter (from Supabase)
    (function() {
      const onlineUsersCountEl = document.getElementById('online-users-number');
      const SUPABASE_URL = 'https://wbpfuuiznsmysbskywdx.supabase.co';
      const SUPABASE_ANON_KEY = 'sb_publishable_rIy_-DWT87Gj9ao1WvN3gA_WA6eME-x';
      const TABLE_NAME = 'unlocked_users';
      const supabase = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
      
      async function updateOnlineUsersCount() {
        if (!onlineUsersCountEl || !supabase) {
          if (onlineUsersCountEl) onlineUsersCountEl.textContent = '0';
          return;
        }
        
        try {
          // Count users who were active in the last 5 minutes
          // Use the same logic as the users list for consistency
          const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
          
          // Get all verified users and count online ones client-side (more accurate)
          const { data: users, error } = await supabase
            .from(TABLE_NAME)
            .select('last_active')
            .eq('verified', true);
          
          if (error) {
            console.error('Error fetching online users:', error);
            if (onlineUsersCountEl) onlineUsersCountEl.textContent = '?';
            return;
          }
          
          // Count users who were active in the last 5 minutes (same logic as users list)
          let onlineCount = 0;
          if (users && users.length > 0) {
            onlineCount = users.filter(user => {
              if (!user.last_active) return false;
              return new Date(user.last_active) >= new Date(fiveMinutesAgo);
            }).length;
          }
          
          if (onlineUsersCountEl) {
            onlineUsersCountEl.textContent = onlineCount.toString();
          }
        } catch (err) {
          console.error('Error updating online users count:', err);
          if (onlineUsersCountEl) onlineUsersCountEl.textContent = '?';
        }
      }
      
      // Update on load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(updateOnlineUsersCount, 500);
        });
      } else {
        setTimeout(updateOnlineUsersCount, 500);
      }
      
      // Update every 30 seconds
      setInterval(updateOnlineUsersCount, 30000);
    })();
    
    // Users List Modal Functionality
    (function() {
      const usersListModalBg = document.getElementById('users-list-modal-bg');
      const usersListContent = document.getElementById('users-list-content');
      const usersListClose = document.getElementById('users-list-modal-close');
      const onlineUsersBtn = document.getElementById('online-users-count');
      const SUPABASE_URL = 'https://wbpfuuiznsmysbskywdx.supabase.co';
      const SUPABASE_ANON_KEY = 'sb_publishable_rIy_-DWT87Gj9ao1WvN3gA_WA6eME-x';
      const TABLE_NAME = 'unlocked_users';
      const supabase = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
      
      function showUsersListModal() {
        if (usersListModalBg) {
          usersListModalBg.classList.add('show');
          loadUsersList();
        }
      }
      
      function hideUsersListModal() {
        if (usersListModalBg) {
          usersListModalBg.classList.remove('show');
        }
      }
      
      async function loadUsersList() {
        const usersListTotal = document.getElementById('users-list-total');
        if (!usersListContent || !supabase) {
          if (usersListContent) {
            usersListContent.innerHTML = '<div class="users-list-empty">Unable to load users</div>';
          }
          if (usersListTotal) usersListTotal.textContent = 'Total: 0 users';
          return;
        }
        
        usersListContent.innerHTML = '<div class="users-list-loading">Loading users...</div>';
        if (usersListTotal) usersListTotal.textContent = 'Total: Loading...';
        
        try {
          // Fetch all verified users with descriptions
          // Note: auth_user_id is the correct column name (not user_id or id)
          const { data: users, error } = await supabase
            .from(TABLE_NAME)
            .select('auth_user_id, username, email, profile_picture_url, last_active, description, created_at')
            .eq('verified', true)
            .order('username', { ascending: true });
          
          if (error) {
            console.error('Error fetching users:', error);
            usersListContent.innerHTML = '<div class="users-list-empty">Error loading users</div>';
            if (usersListTotal) usersListTotal.textContent = 'Total: Error';
            return;
          }
          
          if (!users || users.length === 0) {
            usersListContent.innerHTML = '<div class="users-list-empty">No users found</div>';
            if (usersListTotal) usersListTotal.textContent = 'Total: 0 users';
            return;
          }
          
          // Update total count
          const totalCount = users.length;
          if (usersListTotal) {
            usersListTotal.textContent = `Total: ${totalCount} ${totalCount === 1 ? 'user' : 'users'}`;
          }
          
          // Determine online status (active in last 5 minutes)
          const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
          
          // Render users
          usersListContent.innerHTML = '';
          
          users.forEach(user => {
            const isOnline = user.last_active && new Date(user.last_active) >= new Date(fiveMinutesAgo);
            const userItem = createUserListItem(user, isOnline);
            usersListContent.appendChild(userItem);
          });
          
        } catch (err) {
          console.error('Error loading users list:', err);
          usersListContent.innerHTML = `<div class="users-list-empty">Error loading users: ${err.message || 'Unknown error'}<br><small>Check browser console (F12) for details</small></div>`;
          if (usersListTotal) usersListTotal.textContent = 'Total: Error';
        }
      }
      
      function createUserListItem(user, isOnline) {
        const item = document.createElement('div');
        item.className = 'user-list-item';
        
        // Avatar
        const avatar = document.createElement('div');
        avatar.className = 'user-list-avatar';
        
        if (user.profile_picture_url) {
          const img = document.createElement('img');
          img.src = user.profile_picture_url;
          img.alt = user.username || 'User';
          img.onerror = function() {
            // Fallback to initial if image fails to load
            this.style.display = 'none';
            avatar.textContent = (user.username || user.email || 'U').charAt(0).toUpperCase();
          };
          avatar.appendChild(img);
        } else {
          const initial = (user.username || user.email || 'U').charAt(0).toUpperCase();
          avatar.textContent = initial;
        }
        
        // Info
        const info = document.createElement('div');
        info.className = 'user-list-info';
        
        const name = document.createElement('div');
        name.className = 'user-list-name';
        name.textContent = user.username || user.email || 'Unknown User';
        
        const status = document.createElement('div');
        status.className = 'user-list-status';
        
        const statusDot = document.createElement('div');
        statusDot.className = `user-status-dot ${isOnline ? 'online' : 'offline'}`;
        
        const statusText = document.createElement('span');
        statusText.className = `user-status-text ${isOnline ? 'online' : ''}`;
        statusText.textContent = isOnline ? 'Online' : 'Offline';
        
        status.appendChild(statusDot);
        status.appendChild(statusText);
        
        info.appendChild(name);
        info.appendChild(status);
        
        item.appendChild(avatar);
        item.appendChild(info);
        
        // Click handler to show profile (like in chat - clickable)
        item.style.cursor = 'pointer';
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          if (window.showProfile) {
            // Use auth_user_id (the correct column name in unlocked_users table)
            const userId = user.auth_user_id;
            if (userId) {
              window.showProfile(
                userId,
                user.username || user.email || 'Unknown User',
                user.profile_picture_url || null
              );
              hideUsersListModal();
            } else {
              console.error('No auth_user_id found for user:', user);
            }
          }
        });
        
        return item;
      }
      
      // Event listeners
      if (onlineUsersBtn) {
        onlineUsersBtn.addEventListener('click', showUsersListModal);
      }
      
      if (usersListClose) {
        usersListClose.addEventListener('click', hideUsersListModal);
      }
      
      if (usersListModalBg) {
        usersListModalBg.addEventListener('click', function(e) {
          if (e.target === usersListModalBg) {
            hideUsersListModal();
          }
        });
      }
      
      // Refresh users list when modal is opened
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.attributeName === 'class') {
            if (usersListModalBg.classList.contains('show')) {
              loadUsersList();
            }
          }
        });
      });
      
      if (usersListModalBg) {
        observer.observe(usersListModalBg, { attributes: true });
      }
    })();
    
    // Users List Modal Functionality
    (function() {
      const usersListModalBg = document.getElementById('users-list-modal-bg');
      const usersListContent = document.getElementById('users-list-content');
      const usersListClose = document.getElementById('users-list-modal-close');
      const onlineUsersBtn = document.getElementById('online-users-count');
      const SUPABASE_URL = 'https://wbpfuuiznsmysbskywdx.supabase.co';
      const SUPABASE_ANON_KEY = 'sb_publishable_rIy_-DWT87Gj9ao1WvN3gA_WA6eME-x';
      const TABLE_NAME = 'unlocked_users';
      const supabase = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
      
      function showUsersListModal() {
        if (usersListModalBg) {
          usersListModalBg.classList.add('show');
          loadUsersList();
        }
      }
      
      function hideUsersListModal() {
        if (usersListModalBg) {
          usersListModalBg.classList.remove('show');
        }
      }
      
      async function loadUsersList() {
        const usersListTotal = document.getElementById('users-list-total');
        if (!usersListContent || !supabase) {
          if (usersListContent) {
            usersListContent.innerHTML = '<div class="users-list-empty">Unable to load users</div>';
          }
          if (usersListTotal) usersListTotal.textContent = 'Total: 0 users';
          return;
        }
        
        usersListContent.innerHTML = '<div class="users-list-loading">Loading users...</div>';
        if (usersListTotal) usersListTotal.textContent = 'Total: Loading...';
        
        try {
          // Fetch all verified users with descriptions
          // Note: auth_user_id is the correct column name (not user_id or id)
          const { data: users, error } = await supabase
            .from(TABLE_NAME)
            .select('auth_user_id, username, email, profile_picture_url, last_active, description, created_at')
            .eq('verified', true)
            .order('username', { ascending: true });
          
          if (error) {
            console.error('Error fetching users:', error);
            usersListContent.innerHTML = '<div class="users-list-empty">Error loading users</div>';
            if (usersListTotal) usersListTotal.textContent = 'Total: Error';
            return;
          }
          
          if (!users || users.length === 0) {
            usersListContent.innerHTML = '<div class="users-list-empty">No users found</div>';
            if (usersListTotal) usersListTotal.textContent = 'Total: 0 users';
            return;
          }
          
          // Update total count
          const totalCount = users.length;
          if (usersListTotal) {
            usersListTotal.textContent = `Total: ${totalCount} ${totalCount === 1 ? 'user' : 'users'}`;
          }
          
          // Determine online status (active in last 5 minutes)
          const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
          
          // Render users
          usersListContent.innerHTML = '';
          
          users.forEach(user => {
            const isOnline = user.last_active && new Date(user.last_active) >= new Date(fiveMinutesAgo);
            const userItem = createUserListItem(user, isOnline);
            usersListContent.appendChild(userItem);
          });
          
        } catch (err) {
          console.error('Error loading users list:', err);
          usersListContent.innerHTML = `<div class="users-list-empty">Error loading users: ${err.message || 'Unknown error'}<br><small>Check browser console (F12) for details</small></div>`;
          if (usersListTotal) usersListTotal.textContent = 'Total: Error';
        }
      }
      
      function createUserListItem(user, isOnline) {
        const item = document.createElement('div');
        item.className = 'user-list-item';
        
        // Avatar
        const avatar = document.createElement('div');
        avatar.className = 'user-list-avatar';
        
        if (user.profile_picture_url) {
          const img = document.createElement('img');
          img.src = user.profile_picture_url;
          img.alt = user.username || 'User';
          img.onerror = function() {
            // Fallback to initial if image fails to load
            this.style.display = 'none';
            avatar.textContent = (user.username || user.email || 'U').charAt(0).toUpperCase();
          };
          avatar.appendChild(img);
        } else {
          const initial = (user.username || user.email || 'U').charAt(0).toUpperCase();
          avatar.textContent = initial;
        }
        
        // Info
        const info = document.createElement('div');
        info.className = 'user-list-info';
        
        const name = document.createElement('div');
        name.className = 'user-list-name';
        name.textContent = user.username || user.email || 'Unknown User';
        
        const status = document.createElement('div');
        status.className = 'user-list-status';
        
        const statusDot = document.createElement('div');
        statusDot.className = `user-status-dot ${isOnline ? 'online' : 'offline'}`;
        
        const statusText = document.createElement('span');
        statusText.className = `user-status-text ${isOnline ? 'online' : ''}`;
        statusText.textContent = isOnline ? 'Online' : 'Offline';
        
        status.appendChild(statusDot);
        status.appendChild(statusText);
        
        info.appendChild(name);
        info.appendChild(status);
        
        item.appendChild(avatar);
        item.appendChild(info);
        
        // Click handler to show profile (like in chat - clickable)
        item.style.cursor = 'pointer';
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          if (window.showProfile) {
            // Use auth_user_id (the correct column name in unlocked_users table)
            const userId = user.auth_user_id;
            if (userId) {
              window.showProfile(
                userId,
                user.username || user.email || 'Unknown User',
                user.profile_picture_url || null
              );
              hideUsersListModal();
            } else {
              console.error('No auth_user_id found for user:', user);
            }
          }
        });
        
        return item;
      }
      
      // Event listeners
      if (onlineUsersBtn) {
        onlineUsersBtn.addEventListener('click', showUsersListModal);
      }
      
      if (usersListClose) {
        usersListClose.addEventListener('click', hideUsersListModal);
      }
      
      if (usersListModalBg) {
        usersListModalBg.addEventListener('click', function(e) {
          if (e.target === usersListModalBg) {
            hideUsersListModal();
          }
        });
      }
      
      // Refresh users list when modal is opened
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.attributeName === 'class') {
            if (usersListModalBg.classList.contains('show')) {
              loadUsersList();
            }
          }
        });
      });
      
      if (usersListModalBg) {
        observer.observe(usersListModalBg, { attributes: true });
      }
    })();

    // Custom Market Storage
    const CUSTOM_MARKETS_KEY = 'customMarkets_v1';
    function loadCustomMarketsFromFolders(foldersObj) {
      return (foldersObj?.customMarkets && typeof foldersObj.customMarkets === 'object') 
        ? foldersObj.customMarkets
        : JSON.parse(localStorage.getItem(CUSTOM_MARKETS_KEY)) || { asia: [], international: [], special: [] };
    }
    const saveCustomMarkets = data => localStorage.setItem(CUSTOM_MARKETS_KEY, JSON.stringify(data));
    
    // Custom Categories Storage
    const CUSTOM_CATEGORIES_KEY = 'customCategories_v1';
    function loadCustomCategories() {
      const raw = localStorage.getItem(CUSTOM_CATEGORIES_KEY);
      if (raw) {
        try {
          return JSON.parse(raw);
        } catch {}
      }
      return [];
    }
    function saveCustomCategories(categories) {
      localStorage.setItem(CUSTOM_CATEGORIES_KEY, JSON.stringify(categories));
    }
    let customCategories = loadCustomCategories();
    
    // Folder Storage
    const FOLDER_KEY = 'savedFolders_v2';
    function loadFoldersObj() {
      const raw = localStorage.getItem(FOLDER_KEY);
      if (raw) {
        try {
          const data = JSON.parse(raw);
          if (Array.isArray(data)) {
            // legacy format, convert
            return { folders: data, customMarkets: loadCustomMarketsFromFolders() };
          }
          return data;
        } catch {}
      }
      // Legacy fallback
      return { folders: [{ name: 'Default', searches: [] }], customMarkets: { asia: [], international: [], special: [] } };
    }
    function saveFoldersObj(obj) {
      localStorage.setItem(FOLDER_KEY, JSON.stringify(obj));
      saveCustomMarkets(obj.customMarkets);
    }
    let foldersObj = loadFoldersObj();
    let savedFolders = foldersObj.folders;
    let customMarkets = foldersObj.customMarkets || { asia: [], international: [], special: [] };
    let currentFolderIdx = 0; // Default folder on start
    // Market Data
    const marketDataInitial = {
      asia: [
        { key: "mercari-jp", label: "Mercari Japan" },
        { key: "paypay-fleamarket", label: "Yahoo PayPay Flea" },
        { key: "rakuma", label: "Rakuten Rakuma" },
        { key: "rakuten-jp", label: "Rakuten Japan" },
        { key: "xianyu", label: "Xianyu (闲鱼)" },
        { key: "yahoo-auctions", label: "Yahoo Japan Auctions" },
        { key: "2ndstreet-jp", label: "2nd Street JP" },
        { key: "carousell-sg", label: "Carousell SG" },
        { key: "carousell-hk", label: "Carousell HK" },
        { key: "carousell-id", label: "Carousell ID" },
        { key: "carousell-my", label: "Carousell MY" },
        { key: "carousell-ph", label: "Carousell PH" },
        { key: "carousell-tw", label: "Carousell TW" },
        { key: "fruits-family", label: "Fruits Family" },
        { key: "kindal", label: "Kindal" }
      ],
      international: [
        { key: "depop", label: "Depop" },
        { key: "ebay", label: "Ebay" },
        { key: "facebook", label: "Facebook Marketplace" },
        { key: "gem", label: "Gem" },
        { key: "grailed", label: "Grailed" },
        { key: "mercari-us", label: "Mercari US" },
        { key: "poshmark", label: "Poshmark" },
        { key: "shopgoodwill", label: "ShopGoodwill" },
        { key: "vinted", label: "Vinted" },
        { key: "automated-searches", label: "Automated Searches" },
        { key: "avito", label: "Avito" },
        { key: "ebay-global", label: "Ebay Global" },
        { key: "google-images-past-month", label: "Google Images (Past month)" },
        { key: "instagram", label: "Instagram" }
      ],
      special: [
        { key: "secondstreet", label: "2nd STREET" },
        { key: "therealreal", label: "The RealReal" },
        { key: "vestiaire", label: "Vestiaire Collective" }
      ]
    };
    // Market toggle state storage
    const MARKET_TOGGLE_KEY = 'marketToggleStates';
    function loadMarketToggleState(marketKey) {
      return toggleStatesCache[marketKey] !== false; // Default to true if not set
    }
    let toggleStatesCache = JSON.parse(localStorage.getItem(MARKET_TOGGLE_KEY)) || {};
    function saveMarketToggleState(marketKey, isEnabled) {
      toggleStatesCache[marketKey] = isEnabled;
      // Debounce the localStorage write with requestAnimationFrame
      cancelAnimationFrame(window.toggleStateSaveRAF);
      window.toggleStateSaveRAF = requestAnimationFrame(() => {
        localStorage.setItem(MARKET_TOGGLE_KEY, JSON.stringify(toggleStatesCache));
      });
    }

    // Combined Market Data + Custom
    function getMarkets(section) {
      // Check if it's a custom category
      const customCategory = customCategories.find(cat => cat.id === section);
      if (customCategory) {
        // Return custom markets for this custom category
        return (customMarkets[section] || []).map(m => ({
          key: "custom-" + section + "-" + m.id,
          label: m.title,
          custom: true,
          urlTemplate: m.url,
          id: m.id
        }));
      }
      
      // Standard sections (asia, international, special)
      const orig = marketDataInitial[section] ? marketDataInitial[section].slice() : [];
      const custom = (customMarkets[section] || []).map(m => ({
        key: "custom-" + section + "-" + m.id,
        label: m.title,
        custom: true,
        urlTemplate: m.url,
        id: m.id
      }));
      return orig.concat(custom);
    }
    
    // Get all available sections (including custom categories)
    function getAllSections() {
      const standardSections = ['asia', 'international', 'special'];
      const customSectionIds = customCategories.map(cat => cat.id);
      return [...standardSections, ...customSectionIds];
    }
    
    // Get section display name
    function getSectionDisplayName(section) {
      if (section === 'asia') return 'Asia';
      if (section === 'international') return 'International & Other Markets';
      if (section === 'special') return 'Designer & Global Select';
      const customCategory = customCategories.find(cat => cat.id === section);
      return customCategory ? customCategory.name : section;
    }
    // Helper function to create a single market button
    function createSingleMarketButton(market, sectionName) {
      const btn = document.createElement('button');
      btn.type = "button";
      btn.className = "market-btn";
      btn.setAttribute("data-market", market.key);
      btn.setAttribute("data-section", sectionName);
      
      // Add toggle checkbox
      const toggle = document.createElement('input');
      toggle.type = "checkbox";
      toggle.className = "market-toggle";
      toggle.checked = true;
      toggle.addEventListener('change', function(e) {
        e.stopPropagation();
        const isChecked = toggle.checked;
        saveMarketToggleState(market.key, isChecked);
        
        if (!isChecked) {
          // Remove the button from DOM when unchecked
          btn.remove();
          // Update site list modal if open
          const siteListContainer = document.getElementById(`site-list-${sectionName}`);
          if (siteListContainer) {
            const siteListCheckbox = siteListContainer.querySelector(`input[type="checkbox"][data-market-key="${market.key}"]`);
            if (siteListCheckbox) {
              siteListCheckbox.checked = false;
              const siteListItem = siteListCheckbox.closest('.site-list-item');
              if (siteListItem) siteListItem.classList.add('disabled');
            }
          }
        } else {
          // If checked, button should already be visible
          // Update site list modal if open
          const siteListContainer = document.getElementById(`site-list-${sectionName}`);
          if (siteListContainer) {
            const siteListCheckbox = siteListContainer.querySelector(`input[type="checkbox"][data-market-key="${market.key}"]`);
            if (siteListCheckbox) {
              siteListCheckbox.checked = true;
              const siteListItem = siteListCheckbox.closest('.site-list-item');
              if (siteListItem) siteListItem.classList.remove('disabled');
            }
          }
        }
      }, { passive: true });
      
      // Set initial state
      const isEnabled = loadMarketToggleState(market.key);
      toggle.checked = isEnabled;
      
      btn.appendChild(toggle);
      const label = document.createElement('span');
      label.textContent = market.label + (market.custom ? " ★" : "");
      btn.appendChild(label);

      // Custom market remove button
      if (market.custom) {
        const removeBtn = document.createElement('button');
        removeBtn.className = 'market-remove-btn';
        removeBtn.title = 'Remove Website';
        removeBtn.innerHTML = '🗑';
        removeBtn.onclick = function(e) {
          e.stopPropagation();
          removeCustomMarket(sectionName, market.id);
        };
        btn.appendChild(removeBtn);
      }
      
      return btn;
    }

    function createMarketButtons(markets, sectionId, sectionName) {
      const container = document.getElementById(sectionId);
      container.innerHTML = '';
      markets.slice().sort((a, b) => a.label.localeCompare(b.label)).forEach(market => {
        // Only create buttons for enabled markets
        const isEnabled = loadMarketToggleState(market.key);
        if (isEnabled) {
          const btn = createSingleMarketButton(market, sectionName);
          container.appendChild(btn);
        }
      });
    }
    function refreshAllMarketButtons() {
      // Render standard sections
      createMarketButtons(getMarkets('asia'), "asia-markets", "asia");
      createMarketButtons(getMarkets('international'), "international-markets", "international");
      createMarketButtons(getMarkets('special'), "special-markets", "special");
      
      // Render custom categories
      customCategories.forEach(category => {
        const sectionId = category.id + "-markets";
        const container = document.getElementById(sectionId);
        if (container) {
          createMarketButtons(getMarkets(category.id), sectionId, category.id);
        } else {
          // Create the section if it doesn't exist
          createCustomCategorySection(category);
        }
      });
    }
    
    // Create HTML structure for a custom category section
    function createCustomCategorySection(category) {
      const container = document.querySelector('.container form');
      if (!container) return;
      
      // Find where to insert (after special section)
      const specialGroup = container.querySelector('.special-group');
      if (!specialGroup) return;
      
      // Check if section already exists
      const existingSection = document.getElementById(category.id + "-markets");
      if (existingSection) return;
      
      // Create section HTML
      const sectionDiv = document.createElement('div');
      sectionDiv.className = 'custom-category-section';
      sectionDiv.setAttribute('data-category-id', category.id);
      
      const headerRow = document.createElement('div');
      headerRow.className = 'section-header-row';
      
      const title = document.createElement('h2');
      title.textContent = category.name;
      
      const openAllBtn = document.createElement('button');
      openAllBtn.type = 'button';
      openAllBtn.className = 'section-openall-btn';
      openAllBtn.setAttribute('data-section', category.id);
      openAllBtn.textContent = `Open All ${category.name}`;
      
      const manageBtn = document.createElement('button');
      manageBtn.type = 'button';
      manageBtn.className = 'category-manage-btn';
      manageBtn.setAttribute('data-category-id', category.id);
      manageBtn.innerHTML = '⚙️';
      manageBtn.title = 'Manage Category';
      manageBtn.style.cssText = 'background: #232323; color: #e3e3e3; border: none; border-radius: 6px; font-size: 13px; padding: 4px 8px; cursor: pointer; margin-left: 8px;';
      
      headerRow.appendChild(title);
      headerRow.appendChild(openAllBtn);
      headerRow.appendChild(manageBtn);
      
      const marketsDiv = document.createElement('div');
      marketsDiv.className = 'markets';
      marketsDiv.id = category.id + "-markets";
      
      const addWebsiteBtn = document.createElement('button');
      addWebsiteBtn.type = 'button';
      addWebsiteBtn.className = 'add-market-btn';
      addWebsiteBtn.setAttribute('data-section', category.id);
      addWebsiteBtn.textContent = `+ Add Website to ${category.name}`;
      addWebsiteBtn.style.cssText = 'margin-top: 8px; margin-bottom: 20px;';
      
      sectionDiv.appendChild(headerRow);
      sectionDiv.appendChild(addWebsiteBtn);
      sectionDiv.appendChild(marketsDiv);
      
      // Insert after special group
      specialGroup.parentNode.insertBefore(sectionDiv, specialGroup.nextSibling);
      
      // Render markets
      createMarketButtons(getMarkets(category.id), category.id + "-markets", category.id);
      
      // Add event listeners
      manageBtn.addEventListener('click', () => showCategoryManageModal(category));
    }
    
    // Remove custom category section from DOM
    function removeCustomCategorySection(categoryId) {
      const section = document.querySelector(`[data-category-id="${categoryId}"]`);
      if (section) {
        section.remove();
      }
    }
    refreshAllMarketButtons();

    // Remove custom market
    function removeCustomMarket(section, id) {
      customMarkets[section] = (customMarkets[section] || []).filter(m => m.id !== id);
      foldersObj.customMarkets = customMarkets;
      saveFoldersObj(foldersObj);
      refreshAllMarketButtons();
    }

    // --- Saved Searches Folders UI ---
    const folderListEl = document.getElementById('saved-folder-list');
    const folderInputEl = document.getElementById('sidebar-folder-input');
    const folderAddBtn = document.getElementById('sidebar-folder-btn');

    function renderFolders() {
      folderListEl.innerHTML = '';
      savedFolders.forEach((folder, idx) => {
        const li = document.createElement('li');
        li.className = 'saved-folder-item' + (idx === currentFolderIdx ? ' sidebar-folder-active' : '');
        li.setAttribute('draggable', 'true');
        li.setAttribute('data-index', idx);

        // Drag events
        li.addEventListener('dragstart', function(e){
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', idx);
          setTimeout(() => { li.classList.add('sidebar-folder-dragover'); }, 10);
        });
        li.addEventListener('dragend', function(e){
          li.classList.remove('sidebar-folder-dragover');
        });
        li.addEventListener('dragover', function(e){
          e.preventDefault();
          li.classList.add('sidebar-folder-dragover');
        });
        li.addEventListener('dragleave', function(e){
          li.classList.remove('sidebar-folder-dragover');
        });
        li.addEventListener('drop', function(e){
          e.preventDefault();
          li.classList.remove('sidebar-folder-dragover');
          const fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
          const toIdx = idx;
          if (fromIdx !== toIdx) {
            const moved = savedFolders.splice(fromIdx, 1)[0];
            savedFolders.splice(toIdx, 0, moved);
            if (currentFolderIdx === fromIdx) currentFolderIdx = toIdx;
            else if (fromIdx < currentFolderIdx && toIdx >= currentFolderIdx) currentFolderIdx--;
            else if (fromIdx > currentFolderIdx && toIdx <= currentFolderIdx) currentFolderIdx++;
            foldersObj.folders = savedFolders;
            saveFoldersObj(foldersObj);
            renderFolders();
            renderSavedSearches();
          }
        });

        // Folder name or edit input
        if (folder.editing) {
          const editInput = document.createElement('input');
          editInput.type = 'text';
          editInput.value = folder.name;
          editInput.className = 'sidebar-folder-input';
          editInput.maxLength = 44;
          editInput.autofocus = true;
          editInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') saveFolderEdit(idx, editInput.value.trim());
            if (e.key === 'Escape') cancelFolderEdit(idx);
          });
          li.appendChild(editInput);
          const saveBtn = document.createElement('button');
          saveBtn.type = 'button';
          saveBtn.className = 'sidebar-folder-edit-btn';
          saveBtn.title = 'Save';
          saveBtn.textContent = '✔';
          saveBtn.onclick = () => saveFolderEdit(idx, editInput.value.trim());
          const cancelBtn = document.createElement('button');
          cancelBtn.type = 'button';
          cancelBtn.className = 'sidebar-folder-edit-btn';
          cancelBtn.title = 'Cancel';
          cancelBtn.textContent = '✕';
          cancelBtn.onclick = () => cancelFolderEdit(idx);
          li.appendChild(saveBtn);
          li.appendChild(cancelBtn);
        } else {
          const nameBtn = document.createElement('button');
          nameBtn.type = 'button';
          nameBtn.style = 'background:none;border:none;padding:0;margin:0;color:inherit;font-weight:inherit;cursor:pointer;display:flex;align-items:center;gap:6px;';
          nameBtn.onclick = () => {
            currentFolderIdx = idx;
            renderFolders();
            renderSavedSearches();
          };
          // Add miku.png as folder icon
          const folderIcon = document.createElement('img');
          folderIcon.src = 'miku.png';
          folderIcon.alt = 'Folder';
          folderIcon.style.width = '18px';
          folderIcon.style.height = '18px';
          folderIcon.style.marginRight = '4px';
          folderIcon.style.verticalAlign = 'middle';
          nameBtn.appendChild(folderIcon);
          // Folder name text
          const folderText = document.createElement('span');
          folderText.textContent = folder.name;
          nameBtn.appendChild(folderText);
          
          li.appendChild(nameBtn);
          // Edit/remove
          const editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.className = 'sidebar-folder-edit-btn';
          editBtn.title = 'Rename';
          editBtn.textContent = '✎';
          editBtn.onclick = () => editFolder(idx);
          li.appendChild(editBtn);
          if (savedFolders.length > 1) {
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'sidebar-folder-remove-btn';
            removeBtn.title = 'Remove';
            removeBtn.textContent = '🗑';
            removeBtn.onclick = () => removeFolder(idx);
            li.appendChild(removeBtn);
          }
        }
        folderListEl.appendChild(li);
      });
    }
    function addFolder(name) {
      name = name.trim();
      if (!name) return;
      if (savedFolders.some(f => f.name === name)) return;
      savedFolders.push({ name, searches: [] });
      currentFolderIdx = savedFolders.length - 1;
      foldersObj.folders = savedFolders;
      saveFoldersObj(foldersObj);
      renderFolders();
      renderSavedSearches();
    }
    function removeFolder(idx) {
      if (savedFolders.length === 1) return;
      savedFolders.splice(idx, 1);
      if (currentFolderIdx >= savedFolders.length) currentFolderIdx = savedFolders.length - 1;
      foldersObj.folders = savedFolders;
      saveFoldersObj(foldersObj);
      renderFolders();
      renderSavedSearches();
    }
    function editFolder(idx) {
      savedFolders = savedFolders.map((f, i) => i === idx ? { ...f, editing: true } : { ...f, editing: false });
      foldersObj.folders = savedFolders;
      saveFoldersObj(foldersObj);
      renderFolders();
      setTimeout(() => {
        const input = folderListEl.querySelector('input.sidebar-folder-input');
        if (input) input.focus();
      }, 50);
    }
    function saveFolderEdit(idx, value) {
      value = value.trim();
      if (!value) return;
      if (savedFolders.some((f, i) => f.name === value && i !== idx)) return;
      savedFolders[idx].name = value;
      savedFolders[idx].editing = false;
      foldersObj.folders = savedFolders;
      saveFoldersObj(foldersObj);
      renderFolders();
      renderSavedSearches();
    }
    function cancelFolderEdit(idx) {
      savedFolders[idx].editing = false;
      foldersObj.folders = savedFolders;
      saveFoldersObj(foldersObj);
      renderFolders();
    }
    folderAddBtn.addEventListener('click', function() {
      addFolder(folderInputEl.value);
      folderInputEl.value = '';
      folderInputEl.focus();
    });
    folderInputEl.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        addFolder(folderInputEl.value);
        folderInputEl.value = '';
      }
    });
    renderFolders();

    // --- Saved Searches Logic (Now Folder-Specific) ---
    const listEl = document.getElementById('saved-searches-list');
    const addInput = document.getElementById('sidebar-add-input');
    const addBtn = document.getElementById('sidebar-add-btn');
    const exportBtn = document.getElementById('sidebar-export-btn');
    const importInput = document.getElementById('sidebar-import-input');
    function sortSavedSearches(searches) {
      searches.sort((a, b) => (a.value || "").localeCompare(b.value || "", undefined, {sensitivity: 'base'}));
    }
    const CLICKED_SEARCHES_KEY = 'clickedSearches';
    let clickedSearches = JSON.parse(localStorage.getItem(CLICKED_SEARCHES_KEY)) || {};

    function updateUnhighlightedCount() {
      const folder = savedFolders[currentFolderIdx];
      const unhighlightedCount = folder.searches.filter(term => !clickedSearches[term.value]).length;
      document.getElementById('unhighlighted-count').textContent = `${unhighlightedCount} unhighlighted`;
    }

    function renderSavedSearches() {
      const folder = savedFolders[currentFolderIdx];
      sortSavedSearches(folder.searches);
      listEl.innerHTML = '';
      folder.searches.forEach((term, idx) => {
        const li = document.createElement('li');
        li.className = 'saved-search-item';
        if (term.editing) {
          const editInput = document.createElement('input');
          editInput.type = 'text';
          editInput.value = term.value;
          editInput.className = 'sidebar-add-input';
          editInput.style.marginRight = '5px';
          editInput.maxLength = 70;
          editInput.autofocus = true;
          editInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') saveEdit(idx, editInput.value.trim());
            if (e.key === 'Escape') cancelEdit(idx);
          });
          const saveBtn = document.createElement('button');
          saveBtn.type = 'button';
          saveBtn.className = 'save-edit-btn';
          saveBtn.title = 'Save';
          saveBtn.textContent = '✔';
          saveBtn.onclick = () => saveEdit(idx, editInput.value.trim());
          const cancelBtn = document.createElement('button');
          cancelBtn.type = 'button';
          cancelBtn.className = 'cancel-edit-btn';
          cancelBtn.title = 'Cancel';
          cancelBtn.textContent = '✕';
          cancelBtn.onclick = () => cancelEdit(idx);
          li.appendChild(editInput);
          li.appendChild(saveBtn);
          li.appendChild(cancelBtn);
        } else {
          const termBtn = document.createElement('button');
          termBtn.type = 'button';
          termBtn.className = 'saved-search-term';
          termBtn.title = 'Load into search bar';
          
          // Add checkbox
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'search-term-checkbox';
          checkbox.checked = selectedSearchTerms[term.value] || false;
          checkbox.addEventListener('change', function(e) {
            e.stopPropagation();
            selectedSearchTerms[term.value] = checkbox.checked;
            localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
          });
          
          // Add text
          const textSpan = document.createElement('span');
          textSpan.className = 'search-term-text';
          textSpan.textContent = term.value;
          textSpan.onclick = () => {
            document.getElementById('query').value = term.value;
            document.getElementById('query').focus();
            
            // Mark as clicked with category
            clickedSearches[term.value] = { 
              clicked: true, 
              category: determineSearchCategory(term.value) 
            };
            localStorage.setItem(CLICKED_SEARCHES_KEY, JSON.stringify(clickedSearches));
        
            // Update UI
            termBtn.classList.add('active');
            termBtn.setAttribute('data-category', determineSearchCategory(term.value));
            updateUnhighlightedCount();
          };
          
          termBtn.appendChild(checkbox);
          termBtn.appendChild(textSpan);
          
          // Check if previously clicked
          if (clickedSearches[term.value] && clickedSearches[term.value].clicked) {
            termBtn.classList.add('active');
            termBtn.setAttribute('data-category', clickedSearches[term.value].category || 'all');
          }
          const editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.className = 'edit-btn';
          editBtn.title = 'Edit';
          editBtn.textContent = '✎';
          editBtn.onclick = () => editSavedSearch(idx);
          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'remove-btn';
          removeBtn.title = 'Remove';
          removeBtn.textContent = '🗑';
          removeBtn.onclick = () => removeSavedSearch(idx);
          li.appendChild(termBtn);
          li.appendChild(editBtn);
          li.appendChild(removeBtn);
        }
        listEl.appendChild(li);
      });
      updateUnhighlightedCount();
    }
    function addSavedSearch(term) {
      term = term.trim();
      if (!term) return;
      const folder = savedFolders[currentFolderIdx];
      if (folder.searches.some(t => t.value === term)) return;
      folder.searches.push({ value: term });
      sortSavedSearches(folder.searches);
      foldersObj.folders = savedFolders;
      saveFoldersObj(foldersObj);
      renderSavedSearches();
      updateUnhighlightedCount();
      
      // Update mobile sidebar if on mobile
      if (isMobile) {
        updateMobileSearches();
      }
      
      // Clear selection when adding new term
      selectedSearchTerms = {};
      localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
    }
    function removeSavedSearch(idx) {
      const folder = savedFolders[currentFolderIdx];
      const removedTerm = folder.searches[idx].value;
      folder.searches.splice(idx, 1);
      sortSavedSearches(folder.searches);
      foldersObj.folders = savedFolders;
      saveFoldersObj(foldersObj);
      
      // Remove from selected terms if present
      if (selectedSearchTerms[removedTerm]) {
        delete selectedSearchTerms[removedTerm];
        localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
      }
      
      renderSavedSearches();
      updateUnhighlightedCount();
      
      // Update mobile sidebar if on mobile
      if (isMobile) {
        updateMobileSearches();
      }
    }
    function editSavedSearch(idx) {
      const folder = savedFolders[currentFolderIdx];
      folder.searches = folder.searches.map((t, i) => i === idx ? { ...t, editing: true } : { ...t, editing: false });
      foldersObj.folders = savedFolders;
      saveFoldersObj(foldersObj);
      renderSavedSearches();
      setTimeout(() => {
        const input = listEl.querySelector('input.sidebar-add-input');
        if (input) input.focus();
      }, 50);
    }
    function saveEdit(idx, value) {
      value = value.trim();
      if (!value) return;
      const folder = savedFolders[currentFolderIdx];
      const oldValue = folder.searches[idx].value;
      if (folder.searches.some((t, i) => t.value === value && i !== idx)) return;
      folder.searches[idx] = { value: value };
      sortSavedSearches(folder.searches);
      foldersObj.folders = savedFolders;
      saveFoldersObj(foldersObj);
      
      // Update selected terms if the old value was selected
      if (selectedSearchTerms[oldValue]) {
        selectedSearchTerms[value] = true;
        delete selectedSearchTerms[oldValue];
        localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
      }
      
      renderSavedSearches();
      updateUnhighlightedCount();
    }
    function cancelEdit(idx) {
      const folder = savedFolders[currentFolderIdx];
      folder.searches[idx].editing = false;
      foldersObj.folders = savedFolders;
      saveFoldersObj(foldersObj);
      renderSavedSearches();
    }
    addBtn.addEventListener('click', function() {
      addSavedSearch(addInput.value);
      addInput.value = '';
      addInput.focus();
    });
    addInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        addSavedSearch(addInput.value);
        addInput.value = '';
      }
    });

    exportBtn.addEventListener('click', function() {
      const dataStr = JSON.stringify(foldersObj, null, 2);
      const blob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'saved-searches-with-folders-and-websites.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 50);
    });

    importInput.addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          // If imported is array, legacy format
          if (Array.isArray(imported)) {
            foldersObj = { folders: imported, customMarkets: loadCustomMarketsFromFolders(imported) };
          } else if (imported && Array.isArray(imported.folders) && imported.customMarkets) {
            foldersObj = imported;
          } else {
            alert('Invalid file format.');
            return;
          }
          savedFolders = foldersObj.folders;
          customMarkets = foldersObj.customMarkets || { asia: [], international: [], special: [] };
          if (savedFolders.length === 0) savedFolders = [{ name: 'Default', searches: [] }];
          currentFolderIdx = 0;
          saveFoldersObj(foldersObj);
          refreshAllMarketButtons();
          renderFolders();
          renderSavedSearches();
        } catch (err) {
          alert('Failed to import: ' + err.message);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    });

    // Helper function to determine search category (you can customize this logic)
    function determineSearchCategory(searchTerm) {
      // This is a simple implementation - you can enhance it based on your needs
      // For now, we'll just return 'all' as a default
      return 'all';
    }

    // Track selected search terms
    const SELECTED_SEARCH_TERMS_KEY = 'selectedSearchTerms';
    let selectedSearchTerms = JSON.parse(localStorage.getItem(SELECTED_SEARCH_TERMS_KEY)) || {};

    // Update renderSavedSearches to handle category-based highlighting
    function renderSavedSearches() {
      const folder = savedFolders[currentFolderIdx];
      sortSavedSearches(folder.searches);
      listEl.innerHTML = '';
      folder.searches.forEach((term, idx) => {
        const li = document.createElement('li');
        li.className = 'saved-search-item';
        if (term.editing) {
          const editInput = document.createElement('input');
          editInput.type = 'text';
          editInput.value = term.value;
          editInput.className = 'sidebar-add-input';
          editInput.style.marginRight = '5px';
          editInput.maxLength = 70;
          editInput.autofocus = true;
          editInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') saveEdit(idx, editInput.value.trim());
            if (e.key === 'Escape') cancelEdit(idx);
          });
          const saveBtn = document.createElement('button');
          saveBtn.type = 'button';
          saveBtn.className = 'save-edit-btn';
          saveBtn.title = 'Save';
          saveBtn.textContent = '✔';
          saveBtn.onclick = () => saveEdit(idx, editInput.value.trim());
          const cancelBtn = document.createElement('button');
          cancelBtn.type = 'button';
          cancelBtn.className = 'cancel-edit-btn';
          cancelBtn.title = 'Cancel';
          cancelBtn.textContent = '✕';
          cancelBtn.onclick = () => cancelEdit(idx);
          li.appendChild(editInput);
          li.appendChild(saveBtn);
          li.appendChild(cancelBtn);
        } else {
          const termBtn = document.createElement('button');
          termBtn.type = 'button';
          termBtn.className = 'saved-search-term';
          termBtn.title = 'Load into search bar';
          
          // Add checkbox
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'search-term-checkbox';
          checkbox.checked = selectedSearchTerms[term.value] || false;
          checkbox.addEventListener('change', function(e) {
            e.stopPropagation();
            selectedSearchTerms[term.value] = checkbox.checked;
            localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
          });
          
          // Add text
          const textSpan = document.createElement('span');
          textSpan.className = 'search-term-text';
          textSpan.textContent = term.value;
          textSpan.onclick = () => {
            document.getElementById('query').value = term.value;
            document.getElementById('query').focus();
            
            // Mark as clicked with category
            clickedSearches[term.value] = { 
              clicked: true, 
              category: determineSearchCategory(term.value) 
            };
            localStorage.setItem(CLICKED_SEARCHES_KEY, JSON.stringify(clickedSearches));
        
            // Update UI
            termBtn.classList.add('active');
            termBtn.setAttribute('data-category', determineSearchCategory(term.value));
            updateUnhighlightedCount();
          };
          
          termBtn.appendChild(checkbox);
          termBtn.appendChild(textSpan);
          
          // Check if previously clicked
          if (clickedSearches[term.value] && clickedSearches[term.value].clicked) {
            termBtn.classList.add('active');
            termBtn.setAttribute('data-category', clickedSearches[term.value].category || 'all');
          }
          const editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.className = 'edit-btn';
          editBtn.title = 'Edit';
          editBtn.textContent = '✎';
          editBtn.onclick = () => editSavedSearch(idx);
          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'remove-btn';
          removeBtn.title = 'Remove';
          removeBtn.textContent = '🗑';
          removeBtn.onclick = () => removeSavedSearch(idx);
          li.appendChild(termBtn);
          li.appendChild(editBtn);
          li.appendChild(removeBtn);
        }
        listEl.appendChild(li);
      });
      updateUnhighlightedCount();
    }

    // Function to get selected search terms
    function getSelectedSearchTerms() {
      return Object.entries(selectedSearchTerms)
        .filter(([term, isSelected]) => isSelected)
        .map(([term]) => term);
    }
    
    // Function to open each selected term in separate tabs
    function openSelectedTermsInSeparateTabs(terms, marketFunction) {
      terms.forEach(term => {
        marketFunction(term);
      });
    }

    // Clear selection
    document.getElementById('sidebar-multi-clear-btn').addEventListener('click', function() {
      selectedSearchTerms = {};
      localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
      renderSavedSearches();
    });

    renderSavedSearches();
    updateUnhighlightedCount();


    function openRandomizedTerm(query, category) {
      // Set the query in the search bar
      document.getElementById('query').value = query;
      
      // Mark as clicked/highlighted with category
      clickedSearches[query] = { 
        clicked: true, 
        category: category 
      };
      localStorage.setItem(CLICKED_SEARCHES_KEY, JSON.stringify(clickedSearches));
      updateUnhighlightedCount();
        
      // Get markets for the selected category
      let markets = [];
      if (category === 'all') {
          // Include all standard sections and custom categories
          markets = [...getMarkets('asia'), ...getMarkets('international'), ...getMarkets('special')];
          customCategories.forEach(cat => {
            markets = [...markets, ...getMarkets(cat.id)];
          });
      } else {
          markets = getMarkets(category);
      }
      
      // Filter to only enabled markets
      const enabledMarkets = markets.filter(market => loadMarketToggleState(market.key));
      
      if (enabledMarkets.length === 0) {
        alert('No enabled markets in this category');
        return;
      }
      
      // Open all market URLs immediately without delays
      enabledMarkets.forEach(market => {
        if (market.custom) {
          // For openRandomizedTerm, we need to extract section from the key
          // Key format: "custom-{section}-{id}"
          const keyParts = market.key.split("-");
          if (keyParts.length >= 3) {
            // Try to find the section by checking custom categories first
            let section = null;
            let customId = null;
            
            // Check if it's a custom category
            for (const cat of customCategories) {
              const prefix = `custom-${cat.id}-`;
              if (market.key.startsWith(prefix)) {
                section = cat.id;
                customId = market.key.substring(prefix.length);
                break;
              }
            }
            
            // If not found, try standard sections
            if (!section) {
              const standardSections = ['asia', 'international', 'special'];
              for (const stdSection of standardSections) {
                const prefix = `custom-${stdSection}-`;
                if (market.key.startsWith(prefix)) {
                  section = stdSection;
                  customId = market.key.substring(prefix.length);
                  break;
                }
              }
            }
            
            // Fallback to old method if still not found
            if (!section) {
              section = keyParts[1];
              customId = keyParts.slice(2).join("-");
            }
            
            const url = getCustomMarketUrl(section, customId, query);
            if (url) tabQueue.add(url);
          }
        } else if (marketUrls[market.key]) {
          tabQueue.add(marketUrls[market.key](query));
        }
      });
      
      // Re-render to update highlights
      renderSavedSearches();
    }

    // --- Wishlist Logic with Editable Titles ---
    const WISHLIST_KEY = 'wishlist_links_v1';
    const wishlistListEl = document.getElementById('wishlist-list');
    const wishlistInput = document.getElementById('wishlist-link-input');
    const wishlistForm = document.getElementById('wishlist-add-form');
    let wishlistLinks = [];

    function loadWishlistLinks() {
      const raw = localStorage.getItem(WISHLIST_KEY);
      return raw ? JSON.parse(raw) : [];
    }
    function saveWishlistLinks(links) {
      localStorage.setItem(WISHLIST_KEY, JSON.stringify(links));
    }
    function renderWishlist() {
      wishlistListEl.innerHTML = '';
      wishlistLinks.forEach((item, idx) => {
        const li = document.createElement('li');
        li.className = 'wishlist-item';

        // Title (editable)
        let titleElem;
        if (item.editing) {
          titleElem = document.createElement('input');
          titleElem.type = 'text';
          titleElem.value = item.title || '';
          titleElem.className = 'wishlist-title-input';
          titleElem.autofocus = true;
          titleElem.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') saveTitleEdit(idx, titleElem.value.trim());
            if (e.key === 'Escape') cancelTitleEdit(idx);
          });
          titleElem.addEventListener('blur', function() {
            saveTitleEdit(idx, titleElem.value.trim());
          });
        } else {
          titleElem = document.createElement('span');
          titleElem.className = 'wishlist-title-text';
          titleElem.textContent = item.title ? item.title : 'Loading...';
          titleElem.title = 'Click to edit title';
          titleElem.onclick = () => beginTitleEdit(idx);
        }

        // Link
        const a = document.createElement('a');
        a.href = item.url;
        a.className = 'wishlist-link';
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = item.url;

        // Remove button
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'wishlist-remove-btn';
        removeBtn.title = 'Remove';
        removeBtn.textContent = '🗑';
        removeBtn.onclick = () => {
          wishlistLinks.splice(idx, 1);
          saveWishlistLinks(wishlistLinks);
          renderWishlist();
        };

        li.appendChild(titleElem);
        li.appendChild(a);
        li.appendChild(removeBtn);
        wishlistListEl.appendChild(li);
      });
    }

    function beginTitleEdit(idx) {
      wishlistLinks = wishlistLinks.map((item, i) => i === idx ? {...item, editing: true} : {...item, editing: false});
      renderWishlist();
      setTimeout(() => {
        const input = wishlistListEl.querySelector('input.wishlist-title-input');
        if (input) input.focus();
      }, 50);
    }
    function saveTitleEdit(idx, value) {
      wishlistLinks[idx].title = value || wishlistLinks[idx].title || 'Untitled';
      wishlistLinks[idx].editing = false;
      saveWishlistLinks(wishlistLinks);
      renderWishlist();
    }
    function cancelTitleEdit(idx) {
      wishlistLinks[idx].editing = false;
      renderWishlist();
    }

    async function fetchTitle(url) {
      // Sanitize URL first
      try {
        const parsedUrl = new URL(url);
        if (!['http:', 'https:'].includes(parsedUrl.protocol)) {
          throw new Error('Invalid protocol');
        }
        
        // Use a CORS proxy (public) for demonstration (should use own backend for prod)
        const proxy = "https://corsproxy.io/?";
        const res = await fetch(proxy + encodeURIComponent(url));
        const text = await res.text();
        const titleMatch = text.match(/<title.*?>([\s\S]*?)<\/title>/i);
        if (titleMatch) {
          let title = titleMatch[1].replace(/\n/g, ' ').trim();
          title = title.replace(/\s+/g, ' ');
          return title.length > 100 ? title.slice(0, 100) + "..." : title;
        }
      } catch (e) {}
      try {
        const u = new URL(url);
        return u.hostname;
      } catch {
        return url;
      }
    }

    function isValidUrl(u) {
      try {
        const test = new URL(u);
        return /^https?:/.test(test.protocol);
      } catch {
        return false;
      }
    }

    wishlistForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      let url = wishlistInput.value.trim();
      if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
      if (!isValidUrl(url)) {
        alert('Please enter a valid URL.');
        return;
      }
      if (wishlistLinks.some(item => item.url === url)) {
        wishlistInput.value = '';
        return;
      }
      wishlistLinks.push({ url, title: '', editing: false });
      saveWishlistLinks(wishlistLinks);
      renderWishlist();
      const idx = wishlistLinks.length - 1;
      const title = await fetchTitle(url);
      wishlistLinks[idx].title = title;
      saveWishlistLinks(wishlistLinks);
      renderWishlist();
      wishlistInput.value = '';
    });

    wishlistLinks = loadWishlistLinks();
    renderWishlist();
    wishlistLinks.forEach(async (item, idx) => {
      if (!item.title && item.url) {
        const title = await fetchTitle(item.url);
        wishlistLinks[idx].title = title;
        saveWishlistLinks(wishlistLinks);
        renderWishlist();
      }
    });

    // --- Main Search UI Logic ---
    function getVintedTime() {
      return Math.floor(Date.now() / 1000);
    }
    function getShopGoodwillDate() {
      const now = new Date();
      const month = now.getUTCMonth() + 1;
      const day = now.getUTCDate();
      const year = now.getUTCFullYear();
      return `${month}/${day}/${year}`;
    }
    const marketUrls = {
      "mercari-jp":      q => `https://jp.mercari.com/en/search?keyword=${encodeURIComponent(q)}&sort=created_time&order=desc`,
      "paypay-fleamarket": q => `https://paypayfleamarket.yahoo.co.jp/search/${encodeURIComponent(q)}?page=1&sort=openTime&order=desc`,
      "rakuma":          q => `https://fril.jp/s?order=desc&query=${encodeURIComponent(q)}&sort=created_at&transaction=selling`,
      "rakuten-jp":      q => `https://search.rakuten.co.jp/search/mall/${encodeURIComponent(q)}/?s=4&st=O`,
      "xianyu":          q => `https://2.taobao.com/search?word=${encodeURIComponent(q)}&spm=a2170.xianyu_tbpc_search.0.0`,
      "yahoo-auctions":  q => `https://auctions.yahoo.co.jp/search/search?p=${encodeURIComponent(q)}&s1=new&o1=d`,
      "depop":           q => `https://www.depop.com/search/?q=${encodeURIComponent(q)}&sort=newlyListed`,
      "ebay":            q => `https://www.ebay.com/sch/i.html?_nkw=${encodeURIComponent(q)}&_sop=10`,
      "facebook":        q => `https://www.facebook.com/marketplace/search/?query=${encodeURIComponent(q)}`,
      "gem":             q => `https://gem.app/search?terms=${encodeURIComponent(q)}&sort=newestFirst`,
      "grailed":         q => `https://www.grailed.com/shop?query=${encodeURIComponent(q)}&sort=new`,
      "mercari-us":      q => `https://www.mercari.com/search/?keyword=${encodeURIComponent(q)}&sortBy=2`,
      "poshmark":        q => `https://poshmark.com/search?query=${encodeURIComponent(q)}&sort_by=added_desc`,
      "shopgoodwill":    q => `https://shopgoodwill.com/categories/listing?st=${encodeURIComponent(q)}&sg=Keyword&c=&s=&lp=0&hp=999999&sbn=&spo=false&snpo=false&socs=false&sd=false&sca=false&caed=${encodeURIComponent(getShopGoodwillDate())}&cadb=7&scs=false&sis=false&col=1&p=1&ps=40&desc=true&ss=0&UseBuyerPrefs=true&sus=false&cln=1&catIds=&pn=&wc=false&mci=false&hmt=false&layout=grid&ihp=`,
      "vinted":          q => `https://www.vinted.com/catalog?search_text=${encodeURIComponent(q)}&time=${getVintedTime()}&order=newest_first&page=1`,
      "secondstreet":    q => `https://ec.2ndstreetusa.com/pages/search-results-page?q=${encodeURIComponent(q)}&tab=products&sort_by=created&page=1`,
      "therealreal":     q => `https://www.therealreal.com/products?keywords=${encodeURIComponent(q)}`,
      "vestiaire":       q => `https://us.vestiairecollective.com/search/?q=${encodeURIComponent(q)}&sortBy=3`,
      "2ndstreet-jp":    q => `https://www.2ndstreet.jp/search?keyword=${encodeURIComponent(q)}&selected_category=&minPrice=&maxPrice=&sortBy=arrival&category=`,
      "carousell-sg":    q => `https://www.carousell.sg/search/${encodeURIComponent(q)}?addRecent=true&canChangeKeyword=true&includeSuggestions=true&sort_by=3&t-search_query_source=direct_search`,
      "carousell-hk":    q => `https://www.carousell.com.hk/search/${encodeURIComponent(q)}?addRecent=true&canChangeKeyword=true&includeSuggestions=true&sort_by=3&t-search_query_source=direct_search`,
      "carousell-id":    q => `https://id.carousell.com/search/${encodeURIComponent(q)}?addRecent=true&canChangeKeyword=true&includeSuggestions=true&sort_by=3&t-search_query_source=direct_search`,
      "carousell-my":    q => `https://www.carousell.com.my/search/${encodeURIComponent(q)}?addRecent=true&canChangeKeyword=true&includeSuggestions=true&sort_by=3&t-search_query_source=direct_search`,
      "carousell-ph":    q => `https://www.carousell.ph/search/${encodeURIComponent(q)}?addRecent=true&canChangeKeyword=true&includeSuggestions=true&sort_by=3&t-search_query_source=direct_search`,
      "carousell-tw":    q => `https://tw.carousell.com/search/${encodeURIComponent(q)}?addRecent=true&canChangeKeyword=true&includeSuggestions=true&sort_by=3&t-search_query_source=direct_search`,
      "fruits-family":   q => `https://fruitsfamily.com/search/${encodeURIComponent(q)}`,
      "kindal":          q => `https://shop.kind.co.jp/search?q=${encodeURIComponent(q)}&sort=number-extra-sort1-descending`,
      "automated-searches": q => `https://automatedsearches.com/search?search_siteid=0&search_new=1&search_query=${encodeURIComponent(q)}&search_number=0&search_hic=0&search_category=11450&search_category0=11450&search_category1=11450&search_hmo=0&search_condition_used=1&search_condition_parts=1&sear`,
      "avito":           q => `https://www.avito.ru/all/odezhda_obuv_aksessuary?q=${encodeURIComponent(q)}`,
      "ebay-global":     q => `https://globalesearch.com/?searchTerm=${encodeURIComponent(q)}&sortBy=newlyListed&searchInDescription=false&se=0&se=3&se=77&se=100&se=15&se=123&se=23&se=2&se=210&se=71&se=201&se=205&se=101&se=146&se=212&se=216&se=186&se=16&se=193`,
      "google-images-past-month": q => `https://www.google.com/search?q=${encodeURIComponent(q)}&client=firefox-b-1-d&udm=2&tbs=qdr%3Am&sclient=img`,
      "instagram":       q => `https://www.instagram.com/explore/search/keyword/?q=${encodeURIComponent(q)}`
    };
    // Custom market URLs: key is "custom-section-id"
    function getCustomMarketUrl(section, id, q) {
      const found = (customMarkets[section] || []).find(item => item.id === id);
      if (!found) return null;
      return found.url.replace(/example/g, encodeURIComponent(q));
    }

    // Instant tab opening queue
    const tabQueue = {
      queue: [],
      isProcessing: false,
      
      add: function(url) {
        this.queue.push(url);
        if (!this.isProcessing) {
          this.process();
        }
      },
      
      process: function() {
        if (this.queue.length === 0) {
          this.isProcessing = false;
          return;
        }
        
        this.isProcessing = true;
        
        // Open all links simultaneously
        this.queue.forEach(url => {
          // Use window.open for first tab, then window.open with _blank for others
          const newWindow = window.open();
          if (newWindow) {
            newWindow.location.href = url;
          } else {
            window.open(url, '_blank');
          }
        });
        
        this.queue = []; // Clear the queue
        this.isProcessing = false;
      }
    };

    document.addEventListener('click', function(e) {
      // --- Market button logic (support custom) ---
      const marketBtn = e.target.closest('.market-btn');
      // Only proceed if clicking the button (not checkbox) and not disabled
      if (marketBtn && !marketBtn.classList.contains('disabled') && !e.target.classList.contains('market-toggle')) {
        // Check if any search terms are selected
        const selectedTerms = getSelectedSearchTerms();
        
        if (selectedTerms.length > 0) {
          // Mark each term as clicked
          selectedTerms.forEach(term => {
            clickedSearches[term] = { 
              clicked: true, 
              category: determineSearchCategory(term) 
            };
          });
          localStorage.setItem(CLICKED_SEARCHES_KEY, JSON.stringify(clickedSearches));
          
          // Open each selected term in separate tabs for this specific market
          const market = marketBtn.getAttribute('data-market');
          const section = marketBtn.getAttribute('data-section');
          
          openSelectedTermsInSeparateTabs(selectedTerms, function(term) {
            if (market.startsWith("custom-")) {
              // Extract market ID: key format is "custom-{section}-{id}"
              // Since we have the section, remove "custom-{section}-" prefix
              const prefix = `custom-${section}-`;
              const customId = market.startsWith(prefix) ? market.substring(prefix.length) : market.split("-").slice(2).join("-");
              const url = getCustomMarketUrl(section, customId, term);
              if (url) tabQueue.add(url);
            } else if (marketUrls[market]) {
              tabQueue.add(marketUrls[market](term));
            }
          });
          
          // Clear selection
          selectedSearchTerms = {};
          localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
          
          // Update UI
          renderSavedSearches();
          updateUnhighlightedCount();
        } else {
          // Use the current search query
          const query = document.getElementById('query').value.trim();
          if (!query) {
            document.getElementById('query').focus();
            return;
          }
          
          // Check if user can perform searches
          (async function() {
            // Check if user can perform search and show upgrade prompt if trial is low
            if (window.canPerformSearch) {
              const searchPermission = await window.canPerformSearch();
              if (searchPermission.allowed && searchPermission.reason === 'trial') {
                const remaining = searchPermission.remaining || 0;
                // Show upgrade banner if trial is running low (10 or fewer searches)
                if (remaining <= 10) {
                  const upgradeBanner = document.getElementById('premium-upgrade-banner');
                  if (upgradeBanner) {
                    upgradeBanner.classList.add('show');
                  }
                }
              }
            }
            
            if (window.canPerformSearch) {
              const searchPermission = await window.canPerformSearch();
              if (!searchPermission.allowed) {
                if (searchPermission.reason === 'trial_exhausted') {
                  alert(`Your free trial of 75 searches has been exhausted. Please make a donation to continue using the site.`);
                  if (window.initUnlockSystem) {
                    window.initUnlockSystem();
                  }
                } else {
                  alert('Please log in to perform searches.');
                }
                return;
              }
              
              // Increment trial search counter if on trial
              if (searchPermission.reason === 'trial' && window.incrementTrialSearch) {
                await window.incrementTrialSearch();
                if (searchPermission.remaining <= 5) {
                  alert(`Warning: You have ${searchPermission.remaining} free search${searchPermission.remaining === 1 ? '' : 'es'} remaining.`);
                }
              }
            }
            
            const market = marketBtn.getAttribute('data-market');
            const section = marketBtn.getAttribute('data-section');
            if (market.startsWith("custom-")) {
              // Extract market ID: key format is "custom-{section}-{id}"
              // Since we have the section, remove "custom-{section}-" prefix
              const prefix = `custom-${section}-`;
              const customId = market.startsWith(prefix) ? market.substring(prefix.length) : market.split("-").slice(2).join("-");
              const url = getCustomMarketUrl(section, customId, query);
              if (url) tabQueue.add(url);
            } else if (marketUrls[market]) {
              tabQueue.add(marketUrls[market](query));
            }
          })();
        }
      }
      // Sectional Open All
      if (e.target.classList.contains('section-openall-btn')) {
        // Check if user can perform searches
        (async function() {
          if (window.canPerformSearch) {
            const searchPermission = await window.canPerformSearch();
            if (!searchPermission.allowed) {
              if (searchPermission.reason === 'trial_exhausted') {
                alert(`Your free trial of 75 searches has been exhausted. Please make a donation to continue using the site.`);
                if (window.initUnlockSystem) {
                  window.initUnlockSystem();
                }
              } else {
                alert('Please log in to perform searches.');
              }
              return;
            }
            
            // Increment trial search counter if on trial
            if (searchPermission.reason === 'trial' && window.incrementTrialSearch) {
              await window.incrementTrialSearch();
              if (searchPermission.remaining <= 5) {
                alert(`Warning: You have ${searchPermission.remaining} free search${searchPermission.remaining === 1 ? '' : 'es'} remaining.`);
              }
            }
          }
          
          // Check if any search terms are selected
          const selectedTerms = getSelectedSearchTerms();
          
          if (selectedTerms.length > 0) {
            // Mark each term as clicked
            selectedTerms.forEach(term => {
              clickedSearches[term] = { 
                clicked: true, 
                category: determineSearchCategory(term) 
              };
            });
            localStorage.setItem(CLICKED_SEARCHES_KEY, JSON.stringify(clickedSearches));
            
            // Open each selected term in separate tabs for all markets in this section
            const section = e.target.getAttribute('data-section');
            
            openSelectedTermsInSeparateTabs(selectedTerms, function(term) {
              let marketArr = getMarkets(section);
              
              // Open all URLs immediately without delays
              marketArr.slice().sort((a, b) => a.label.localeCompare(b.label)).forEach(market => {
                // Skip if this market is toggled off
                if (!loadMarketToggleState(market.key)) return;
                
                if (market.custom) {
                  // Extract market ID: key format is "custom-{section}-{id}"
                  // Since we have the section, remove "custom-{section}-" prefix
                  const prefix = `custom-${section}-`;
                  const customId = market.key.startsWith(prefix) ? market.key.substring(prefix.length) : market.key.split("-").slice(2).join("-");
                  const url = getCustomMarketUrl(section, customId, term);
                  if (url) tabQueue.add(url);
                } else if (marketUrls[market.key]) {
                  tabQueue.add(marketUrls[market.key](term));
                }
              });
            });
            
            // Clear selection
            selectedSearchTerms = {};
            localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
            
            // Update UI
            renderSavedSearches();
            updateUnhighlightedCount();
          } else {
            // Use the current search query
            const query = document.getElementById('query').value.trim();
            if (!query) {
              document.getElementById('query').focus();
              return;
            }
            const section = e.target.getAttribute('data-section');
            let marketArr = getMarkets(section);
            
            // Collect all URLs first (only enabled markets)
            const urls = [];
            marketArr.slice().sort((a, b) => a.label.localeCompare(b.label)).forEach(market => {
              // Skip if this market is toggled off
              if (!loadMarketToggleState(market.key)) return;
              
              if (market.custom) {
                // Extract market ID: key format is "custom-{section}-{id}"
                // Since we have the section, remove "custom-{section}-" prefix
                const prefix = `custom-${section}-`;
                const customId = market.key.startsWith(prefix) ? market.key.substring(prefix.length) : market.key.split("-").slice(2).join("-");
                const url = getCustomMarketUrl(section, customId, query);
                if (url) urls.push(url);
              } else if (marketUrls[market.key]) {
                urls.push(marketUrls[market.key](query));
              }
            });
            
            // Process URLs with queue
            urls.forEach(url => tabQueue.add(url));
          }
        })();
      }
      // --- Add Custom Market Button ---
      if (e.target.classList.contains('add-market-btn')) {
        const section = e.target.getAttribute('data-section');
        showCustomMarketModal(section);
      }
    });

    document.getElementById('open-all-btn').addEventListener('click', async function() {
      // Check if user can perform searches
      if (window.canPerformSearch) {
        const searchPermission = await window.canPerformSearch();
        if (!searchPermission.allowed) {
          if (searchPermission.reason === 'trial_exhausted') {
            alert(`Your free trial of 75 searches has been exhausted. Please make a donation to continue using the site.`);
            // Show unlock modal
            if (window.initUnlockSystem) {
              window.initUnlockSystem();
            }
          } else {
            alert('Please log in to perform searches.');
          }
          return;
        }
        
        // Increment trial search counter if on trial
        if (searchPermission.reason === 'trial' && window.incrementTrialSearch) {
          await window.incrementTrialSearch();
          // Show remaining searches notification
          if (searchPermission.remaining <= 5) {
            alert(`Warning: You have ${searchPermission.remaining} free search${searchPermission.remaining === 1 ? '' : 'es'} remaining. After your trial ends, a donation will be required.`);
          }
        }
      }
      
      // Check if any search terms are selected
      const selectedTerms = getSelectedSearchTerms();
      
      if (selectedTerms.length > 0) {
        // Mark each term as clicked
        selectedTerms.forEach(term => {
          clickedSearches[term] = { 
            clicked: true, 
            category: determineSearchCategory(term) 
          };
        });
        localStorage.setItem(CLICKED_SEARCHES_KEY, JSON.stringify(clickedSearches));
        
        // Open each selected term in separate tabs for all markets
        openSelectedTermsInSeparateTabs(selectedTerms, function(term) {
          openAllMarketsWithQuery(term);
        });
        
        // Clear selection
        selectedSearchTerms = {};
        localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
        
        // Update UI
        renderSavedSearches();
        updateUnhighlightedCount();
      } else {
        // Use the current search query
        const query = document.getElementById('query').value.trim();
        if (!query) {
          document.getElementById('query').focus();
          return;
        }
        openAllMarketsWithQuery(query);
      }
    });

    // Update color indicator based on selected category
    function updateRandomizeColorIndicator() {
      const select = document.getElementById('randomize-category-select');
      const indicator = document.getElementById('randomize-color-indicator');
      if (!select || !indicator) return;
      
      const colors = {
        'all': '#6a0572',
        'asia': '#ff6b6b',
        'international': '#4ecdc4',
        'special': '#ffe66d'
      };
      
      // Check if it's a custom category
      const customCategory = customCategories.find(cat => cat.id === select.value);
      if (customCategory) {
        // Use a default color for custom categories
        indicator.style.backgroundColor = '#9b59b6';
      } else {
        indicator.style.backgroundColor = colors[select.value] || '#888';
      }
    }

    // Initialize color indicator
    updateRandomizeColorIndicator();
    
    // Update indicator when selection changes
    document.getElementById('randomize-category-select').addEventListener('change', updateRandomizeColorIndicator);
    
    // Randomize button functionality
    document.getElementById('sidebar-randomize-btn').addEventListener('click', function() {
      const category = document.getElementById('randomize-category-select').value;
      
      // Get the current folder's searches
      const folder = savedFolders[currentFolderIdx];
      if (!folder.searches || folder.searches.length === 0) {
        alert('No saved searches to randomize from');
        return;
      }
      
      // Find unhighlighted terms (compatibility with new structure)
      const unhighlightedTerms = folder.searches.filter(term => 
        !clickedSearches[term.value] || !clickedSearches[term.value].clicked
      );
      
      if (unhighlightedTerms.length === 0) {
        // Reset all highlights if all terms have been used
        clickedSearches = {};
        localStorage.setItem(CLICKED_SEARCHES_KEY, JSON.stringify(clickedSearches));
        // Use all terms
        const randomTerm = folder.searches[Math.floor(Math.random() * folder.searches.length)];
        openRandomizedTerm(randomTerm.value, category);
      } else {
        // Pick a random unhighlighted term
        const randomTerm = unhighlightedTerms[Math.floor(Math.random() * unhighlightedTerms.length)];
        openRandomizedTerm(randomTerm.value, category);
      }
    });

    // Clear search button
    const clearBtn = document.getElementById('clear-search');
    const searchInput = document.getElementById('query');
    
    searchInput.addEventListener('input', function() {
      clearBtn.style.display = this.value ? 'block' : 'none';
    });
    
    clearBtn.addEventListener('click', function() {
      searchInput.value = '';
      this.style.display = 'none';
      searchInput.focus();
    });

    document.getElementById('searchForm').addEventListener('submit', function(e){
      e.preventDefault();
      // Check if any search terms are selected
      const selectedTerms = getSelectedSearchTerms();
      
      if (selectedTerms.length > 0) {
        // Mark each term as clicked
        selectedTerms.forEach(term => {
          clickedSearches[term] = { 
            clicked: true, 
            category: determineSearchCategory(term) 
          };
        });
        localStorage.setItem(CLICKED_SEARCHES_KEY, JSON.stringify(clickedSearches));
        
        // Open each selected term in separate tabs for Mercari Japan
        openSelectedTermsInSeparateTabs(selectedTerms, function(term) {
          window.open(marketUrls["mercari-jp"](term), '_blank');
        });
        
        // Clear selection
        selectedSearchTerms = {};
        localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
        
        // Update UI
        renderSavedSearches();
        updateUnhighlightedCount();
      } else {
        // Use the current search query
        const query = document.getElementById('query').value.trim();
        if (!query) return;
        window.open(marketUrls["mercari-jp"](query), '_blank');
      }
    });

    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      const queryInput = document.getElementById('query');
      
      // Ctrl+Enter to open all
      if (e.ctrlKey && e.key === 'Enter') {
        document.getElementById('open-all-btn').click();
        return;
      }
      // Escape to clear search
      if (e.key === 'Escape') {
        queryInput.value = '';
        queryInput.focus();
        return;
      }
      
      // Arrow key navigation
      if (['ArrowDown', 'ArrowUp', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
        e.preventDefault();
        
        // Left-side elements (folders and search terms)
        const folders = [...document.querySelectorAll('.saved-folder-item button:first-child')].filter(el => el.offsetParent !== null);
        const searchTerms = [...document.querySelectorAll('.saved-search-term')].filter(el => el.offsetParent !== null);
        
        // Right-side elements (open all buttons and market buttons)
        const openAllBtns = [...document.querySelectorAll('.section-openall-btn')].filter(el => el.offsetParent !== null);
        const mainOpenAllBtn = document.getElementById('open-all-btn');
        const marketBtns = [...document.querySelectorAll('.market-btn')].filter(el => el.offsetParent !== null);
        
        // Get current focused element
        const currentEl = document.activeElement;
        
        // Handle vertical navigation (up/down)
        if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
          // Left-side navigation (folders and search terms)
          if (folders.includes(currentEl) || searchTerms.includes(currentEl)) {
            const leftElements = [...folders, ...searchTerms];
            const currentIndex = leftElements.indexOf(currentEl);
            let nextIndex = 0;
            
            if (e.key === 'ArrowDown') {
              nextIndex = currentIndex < leftElements.length - 1 ? currentIndex + 1 : 0;
            } else {
              nextIndex = currentIndex > 0 ? currentIndex - 1 : leftElements.length - 1;
            }
            
            leftElements[nextIndex].focus();
          } 
          // Right-side navigation (open all and market buttons)
          else if (openAllBtns.includes(currentEl) || currentEl === mainOpenAllBtn || marketBtns.includes(currentEl)) {
            const rightElements = [...openAllBtns, mainOpenAllBtn, ...marketBtns];
            const currentIndex = rightElements.indexOf(currentEl);
            let nextIndex = 0;
            
            if (e.key === 'ArrowDown') {
              // If on main Open All button, go to first section Open All button
              if (currentEl === mainOpenAllBtn && openAllBtns.length > 0) {
                nextIndex = rightElements.indexOf(openAllBtns[0]);
              } else {
                nextIndex = currentIndex < rightElements.length - 1 ? currentIndex + 1 : 0;
              }
            } else {
              nextIndex = currentIndex > 0 ? currentIndex - 1 : rightElements.length - 1;
            }
            
            rightElements[nextIndex].focus();
          }
        }
        // Handle horizontal navigation (left/right)
        else if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
          // Left arrow focuses left-side elements
          if (e.key === 'ArrowLeft') {
            if (searchTerms.length > 0) {
              searchTerms[0].focus();
            } else if (folders.length > 0) {
              folders[0].focus();
            }
          } 
          // Right arrow focuses right-side elements
          else {
            if (openAllBtns.length > 0) {
              openAllBtns[0].focus();
            } else if (marketBtns.length > 0) {
              marketBtns[0].focus();
            } else if (mainOpenAllBtn) {
              mainOpenAllBtn.focus();
            }
          }
        }
        return;
      }
      
      // Enter to load focused search term
      if (e.key === 'Enter' && e.target.classList.contains('saved-search-term')) {
        const searchTerm = e.target.textContent;
        const queryInput = document.getElementById('query');
        queryInput.value = searchTerm;
        queryInput.focus();
        
        // Force selection of all text in input
        setTimeout(() => {
          queryInput.setSelectionRange(0, queryInput.value.length);
        }, 0);
        
        // Mark as clicked with category
        clickedSearches[searchTerm] = { 
          clicked: true, 
          category: determineSearchCategory(searchTerm) 
        };
        localStorage.setItem(CLICKED_SEARCHES_KEY, JSON.stringify(clickedSearches));
        e.target.classList.add('active');
        e.target.setAttribute('data-category', determineSearchCategory(searchTerm));
        updateUnhighlightedCount();
        
        // Focus the Open All button
        setTimeout(() => {
          document.getElementById('open-all-btn').focus();
        }, 10);
        
        // Prevent form submission
        e.preventDefault();
        return false;
      }
      
      // Tab to focus first search term
      if (e.key === 'Tab' && e.target === queryInput && !e.shiftKey) {
        e.preventDefault();
        const firstSearchTerm = document.querySelector('.saved-search-term');
        if (firstSearchTerm) firstSearchTerm.focus();
      }
    });

    // --- Custom Market Modal Logic ---
    function showCustomMarketModal(section) {
      const bg = document.getElementById('custom-market-modal-bg');
      const sectionLabel = document.getElementById('custom-market-modal-section');
      
      // Check if it's a custom category
      const customCategory = customCategories.find(cat => cat.id === section);
      if (customCategory) {
        sectionLabel.textContent = `${customCategory.name} Section`;
      } else {
        sectionLabel.textContent = {
          asia: "Asia Section",
          international: "International Section",
          special: "Designer Section"
        }[section] || "";
      }
      
      bg.style.display = 'flex';
      bg.setAttribute('data-section', section);
      document.getElementById('custom-market-title-input').value = '';
      document.getElementById('custom-market-url-input').value = '';
      setTimeout(() => {
        document.getElementById('custom-market-title-input').focus();
      }, 20);
    }
    function hideCustomMarketModal() {
      document.getElementById('custom-market-modal-bg').style.display = 'none';
    }
    document.getElementById('custom-market-modal-cancel-btn').onclick = hideCustomMarketModal;
    document.getElementById('custom-market-modal-bg').onclick = function(e) {
      if (e.target === this) hideCustomMarketModal();
    };
    document.getElementById('custom-market-modal-save-btn').onclick = function() {
      const section = document.getElementById('custom-market-modal-bg').getAttribute('data-section');
      const title = document.getElementById('custom-market-title-input').value.trim();
      const url = document.getElementById('custom-market-url-input').value.trim();
      if (!title || !url || !url.includes('example')) {
        alert('Both a title and search layout URL are required. URL must contain "example".');
        return;
      }
      // Generate unique id
      const id = Date.now().toString(36) + '-' + Math.floor(Math.random()*99999).toString(36);
      customMarkets[section] = customMarkets[section] || [];
      customMarkets[section].push({ id, title, url });
      foldersObj.customMarkets = customMarkets;
      saveFoldersObj(foldersObj);
      refreshAllMarketButtons();
      hideCustomMarketModal();
    };

    // --- Site List Modal Logic ---
    function showSiteListModal() {
      const bg = document.getElementById('site-list-modal-bg');
      bg.style.display = 'flex';
      // Center modal
      const modal = document.querySelector('.site-list-modal');
      modal.style.left = '50%';
      modal.style.top = '50%';
      modal.style.transform = 'translate(-50%, -50%)';
      renderSiteList();
    }
    function hideSiteListModal() {
      document.getElementById('site-list-modal-bg').style.display = 'none';
    }
    function renderSiteList() {
      const sections = ['asia', 'international', 'special'];
      sections.forEach(section => {
        const container = document.getElementById(`site-list-${section}`);
        container.innerHTML = '';
        const markets = getMarkets(section);
        markets.slice().sort((a, b) => a.label.localeCompare(b.label)).forEach(market => {
          const item = document.createElement('div');
          item.className = 'site-list-item';
          const isEnabled = loadMarketToggleState(market.key);
          if (!isEnabled) item.classList.add('disabled');
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = isEnabled;
          checkbox.setAttribute('data-market-key', market.key);
          checkbox.addEventListener('change', function() {
            const enabled = checkbox.checked;
            item.classList.toggle('disabled', !enabled);
            saveMarketToggleState(market.key, enabled);
            
            // Find the container for this section
            const sectionId = `${section}-markets`;
            const container = document.getElementById(sectionId);
            if (!container) return;
            
            // Find existing button
            const marketBtn = container.querySelector(`.market-btn[data-market="${market.key}"]`);
            
            if (enabled) {
              // Add button if it doesn't exist
              if (!marketBtn) {
                const btn = createSingleMarketButton(market, section);
                // Find correct position to maintain alphabetical order
                const markets = getMarkets(section);
                const sortedMarkets = markets.slice().sort((a, b) => a.label.localeCompare(b.label));
                const currentIndex = sortedMarkets.findIndex(m => m.key === market.key);
                
                // Find the button that should come after this one
                let insertBefore = null;
                if (currentIndex < sortedMarkets.length - 1) {
                  const nextMarket = sortedMarkets[currentIndex + 1];
                  const nextBtn = container.querySelector(`.market-btn[data-market="${nextMarket.key}"]`);
                  if (nextBtn) insertBefore = nextBtn;
                }
                
                if (insertBefore) {
                  container.insertBefore(btn, insertBefore);
                } else {
                  container.appendChild(btn);
                }
              }
            } else {
              // Remove button from DOM
              if (marketBtn) {
                marketBtn.remove();
              }
            }
          });
          
          const label = document.createElement('label');
          label.className = 'site-list-item-label';
          label.textContent = market.label.replace(' ★', '');
          if (market.custom) {
            const badge = document.createElement('span');
            badge.className = 'site-list-item-custom-badge';
            badge.textContent = '★ Custom';
            label.appendChild(badge);
          }
          label.onclick = () => checkbox.click();
          
          const actions = document.createElement('div');
          actions.className = 'site-list-item-actions';
          
          if (market.custom) {
            const editBtn = document.createElement('button');
            editBtn.className = 'site-list-item-edit-btn';
            editBtn.textContent = 'Edit';
            editBtn.title = 'Edit Custom Website';
            editBtn.onclick = function(e) {
              e.stopPropagation();
              hideSiteListModal();
              const customMarket = customMarkets[section].find(m => m.id === market.id);
              if (customMarket) {
                showCustomMarketModal(section);
                document.getElementById('custom-market-title-input').value = customMarket.title;
                document.getElementById('custom-market-url-input').value = customMarket.url;
                // Override save to update instead of create
                const originalSave = document.getElementById('custom-market-modal-save-btn').onclick;
                document.getElementById('custom-market-modal-save-btn').onclick = function() {
                  const title = document.getElementById('custom-market-title-input').value.trim();
                  const url = document.getElementById('custom-market-url-input').value.trim();
                  if (!title || !url || !url.includes('example')) {
                    alert('Both a title and search layout URL are required. URL must contain "example".');
                    return;
                  }
                  customMarket.title = title;
                  customMarket.url = url;
                  foldersObj.customMarkets = customMarkets;
                  saveFoldersObj(foldersObj);
                  refreshAllMarketButtons();
                  hideCustomMarketModal();
                  document.getElementById('custom-market-modal-save-btn').onclick = originalSave;
                  showSiteListModal();
                };
              }
            };
            actions.appendChild(editBtn);
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'site-list-item-remove-btn';
            removeBtn.textContent = 'Remove';
            removeBtn.title = 'Remove Custom Website';
            removeBtn.onclick = function(e) {
              e.stopPropagation();
              if (confirm(`Remove "${market.label.replace(' ★', '')}" from your custom sites?`)) {
                removeCustomMarket(section, market.id);
                renderSiteList();
              }
            };
            actions.appendChild(removeBtn);
          }
          
          item.appendChild(checkbox);
          item.appendChild(label);
          if (actions.children.length > 0) {
            item.appendChild(actions);
          }
          container.appendChild(item);
        });
      });
    }
    
    document.getElementById('site-list-btn').onclick = showSiteListModal;
    document.getElementById('site-list-close-btn').onclick = hideSiteListModal;
    document.getElementById('site-list-modal-bg').onclick = function(e) {
      if (e.target === this) hideSiteListModal();
    };
    
    // Custom Category Management
    let editingCategoryId = null;
    
    function showCategoryModal(category = null) {
      const bg = document.getElementById('custom-category-modal-bg');
      const titleEl = document.getElementById('custom-category-modal-title');
      const nameInput = document.getElementById('custom-category-name-input');
      const deleteBtn = document.getElementById('custom-category-modal-delete-btn');
      
      if (category) {
        // Editing existing category
        titleEl.textContent = 'Edit Custom Category';
        nameInput.value = category.name;
        editingCategoryId = category.id;
        deleteBtn.style.display = 'inline-block';
      } else {
        // Creating new category
        titleEl.textContent = 'Create Custom Category';
        nameInput.value = '';
        editingCategoryId = null;
        deleteBtn.style.display = 'none';
      }
      
      bg.style.display = 'flex';
      setTimeout(() => {
        nameInput.focus();
      }, 20);
    }
    
    function hideCategoryModal() {
      document.getElementById('custom-category-modal-bg').style.display = 'none';
      editingCategoryId = null;
    }
    
    function addCustomCategory(name) {
      if (!name || !name.trim()) {
        alert('Please enter a category name.');
        return false;
      }
      
      // Check for duplicate names
      const allSections = ['asia', 'international', 'special'];
      const existingNames = [
        ...allSections.map(s => getSectionDisplayName(s).toLowerCase()),
        ...customCategories.map(c => c.name.toLowerCase())
      ];
      
      if (existingNames.includes(name.trim().toLowerCase())) {
        alert('A category with this name already exists.');
        return false;
      }
      
      // Generate unique ID
      const id = 'custom-' + Date.now().toString(36) + '-' + Math.floor(Math.random()*99999).toString(36);
      const category = { id, name: name.trim() };
      
      customCategories.push(category);
      saveCustomCategories(customCategories);
      
      // Initialize empty markets array for this category
      customMarkets[id] = [];
      foldersObj.customMarkets = customMarkets;
      saveFoldersObj(foldersObj);
      
      // Create the section in the DOM
      createCustomCategorySection(category);
      
      // Update randomize dropdown
      updateRandomizeDropdown();
      
      return true;
    }
    
    function updateCustomCategory(categoryId, newName) {
      if (!newName || !newName.trim()) {
        alert('Please enter a category name.');
        return false;
      }
      
      const category = customCategories.find(c => c.id === categoryId);
      if (!category) return false;
      
      // Check for duplicate names (excluding current category)
      const allSections = ['asia', 'international', 'special'];
      const existingNames = [
        ...allSections.map(s => getSectionDisplayName(s).toLowerCase()),
        ...customCategories.filter(c => c.id !== categoryId).map(c => c.name.toLowerCase())
      ];
      
      if (existingNames.includes(newName.trim().toLowerCase())) {
        alert('A category with this name already exists.');
        return false;
      }
      
      category.name = newName.trim();
      saveCustomCategories(customCategories);
      
      // Update the section header
      const section = document.querySelector(`[data-category-id="${categoryId}"]`);
      if (section) {
        const titleEl = section.querySelector('h2');
        if (titleEl) titleEl.textContent = category.name;
        
        const openAllBtn = section.querySelector('.section-openall-btn');
        if (openAllBtn) openAllBtn.textContent = `Open All ${category.name}`;
        
        const addBtn = section.querySelector('.add-market-btn');
        if (addBtn) addBtn.textContent = `+ Add Website to ${category.name}`;
      }
      
      // Update randomize dropdown
      updateRandomizeDropdown();
      
      return true;
    }
    
    function deleteCustomCategory(categoryId) {
      if (!confirm('Are you sure you want to delete this category? All websites in this category will also be deleted.')) {
        return false;
      }
      
      // Remove from categories array
      customCategories = customCategories.filter(c => c.id !== categoryId);
      saveCustomCategories(customCategories);
      
      // Remove markets for this category
      delete customMarkets[categoryId];
      foldersObj.customMarkets = customMarkets;
      saveFoldersObj(foldersObj);
      
      // Remove from DOM
      removeCustomCategorySection(categoryId);
      
      // Update randomize dropdown
      updateRandomizeDropdown();
      
      return true;
    }
    
    function showCategoryManageModal(category) {
      showCategoryModal(category);
    }
    
    function updateRandomizeDropdown() {
      const select = document.getElementById('randomize-category-select');
      if (!select) return;
      
      // Store current value
      const currentValue = select.value;
      
      // Clear and add standard options
      select.innerHTML = '<option value="all">All Categories</option><option value="asia">Asia</option><option value="international">International</option><option value="special">Designer</option>';
      
      // Add custom categories
      customCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = category.name;
        select.appendChild(option);
      });
      
      // Restore selection if still valid
      if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
        select.value = currentValue;
      }
      
      // Update color indicator
      if (window.updateRandomizeColorIndicator) {
        updateRandomizeColorIndicator();
      }
    }
    
    // Category modal event handlers
    document.getElementById('add-custom-category-btn').onclick = () => showCategoryModal();
    document.getElementById('custom-category-modal-cancel-btn').onclick = hideCategoryModal;
    document.getElementById('custom-category-modal-save-btn').onclick = function() {
      const name = document.getElementById('custom-category-name-input').value.trim();
      
      if (editingCategoryId) {
        if (updateCustomCategory(editingCategoryId, name)) {
          hideCategoryModal();
        }
      } else {
        if (addCustomCategory(name)) {
          hideCategoryModal();
        }
      }
    };
    document.getElementById('custom-category-modal-delete-btn').onclick = function() {
      if (editingCategoryId && deleteCustomCategory(editingCategoryId)) {
        hideCategoryModal();
      }
    };
    document.getElementById('custom-category-modal-bg').onclick = function(e) {
      if (e.target === this) hideCategoryModal();
    };

    // Container minimize/restore functionality (no dragging)
    const container = document.querySelector('.container');
    let isContainerMinimized = false;
    
    function toggleContainerMinimize() {
      isContainerMinimized = !isContainerMinimized;
      
      if (isContainerMinimized) {
        // Fully hide the container
        container.style.display = 'none';
      } else {
        // Show the container
        container.style.display = '';
      }
      
      // Update button state
      const btn = document.getElementById('minimize-container-btn');
      if (btn) btn.classList.toggle('active', isContainerMinimized);
    }
    
    // Minimize button handler (desktop only)
    const minimizeContainerBtn = document.getElementById('minimize-container-btn');
    if (minimizeContainerBtn) {
      minimizeContainerBtn.addEventListener('click', toggleContainerMinimize);
    }
    
    // Update button state on page load
    if (window.innerWidth >= 1200) {
      const containerBtn = document.getElementById('minimize-container-btn');
      if (containerBtn) {
        containerBtn.classList.toggle('active', container.style.display === 'none');
      }
    }

    // Make custom market modal draggable
    const modal = document.querySelector('.custom-market-modal');
    const modalHandle = modal.querySelector('.drag-handle');
    let isModalDragging = false;
    let modalOffsetX, modalOffsetY;
    let modalInitialLeft, modalInitialTop;

    modalHandle.addEventListener('mousedown', function(e) {
      isModalDragging = true;
      modal.classList.add('dragging'); // Disable transitions for smooth dragging
      // Get modal position relative to viewport
      const rect = modal.getBoundingClientRect();
      // Calculate offset from mouse to modal's top-left corner
      modalOffsetX = e.clientX - rect.left;
      modalOffsetY = e.clientY - rect.top;
      modal.style.cursor = 'grabbing';
      e.preventDefault();
    });

    let modalRafId = null;
    document.addEventListener('mousemove', function(e) {
      if (!isModalDragging) return;
      
      if (modalRafId !== null) {
        cancelAnimationFrame(modalRafId);
      }
      
      modalRafId = requestAnimationFrame(() => {
        // Calculate new position keeping the same mouse offset
        const x = e.clientX - modalOffsetX;
        const y = e.clientY - modalOffsetY;
        
        modal.style.left = x + 'px';
        modal.style.top = y + 'px';
        modal.style.transform = 'none'; // Remove centering transform
        modalRafId = null;
      });
    });

    document.addEventListener('mouseup', function() {
      if (isModalDragging) {
        isModalDragging = false;
        modal.classList.remove('dragging'); // Re-enable transitions
        modal.style.cursor = '';
        if (modalRafId !== null) {
          cancelAnimationFrame(modalRafId);
          modalRafId = null;
        }
      }
    });

    // Make site list modal draggable
    const siteListModal = document.querySelector('.site-list-modal');
    const siteListModalHandle = siteListModal.querySelector('.drag-handle');
    let isSiteListModalDragging = false;
    let siteListModalOffsetX, siteListModalOffsetY;

    siteListModalHandle.addEventListener('mousedown', function(e) {
      isSiteListModalDragging = true;
      siteListModal.classList.add('dragging'); // Disable transitions for smooth dragging
      const rect = siteListModal.getBoundingClientRect();
      siteListModalOffsetX = e.clientX - rect.left;
      siteListModalOffsetY = e.clientY - rect.top;
      siteListModal.style.cursor = 'grabbing';
      e.preventDefault();
    });

    let siteListModalRafId = null;
    document.addEventListener('mousemove', function(e) {
      if (!isSiteListModalDragging) return;
      
      if (siteListModalRafId !== null) {
        cancelAnimationFrame(siteListModalRafId);
      }
      
      siteListModalRafId = requestAnimationFrame(() => {
        const x = e.clientX - siteListModalOffsetX;
        const y = e.clientY - siteListModalOffsetY;
        siteListModal.style.left = x + 'px';
        siteListModal.style.top = y + 'px';
        siteListModal.style.transform = 'none';
        siteListModalRafId = null;
      });
    });

    document.addEventListener('mouseup', function() {
      if (isSiteListModalDragging) {
        isSiteListModalDragging = false;
        siteListModal.classList.remove('dragging'); // Re-enable transitions
        siteListModal.style.cursor = '';
        if (siteListModalRafId !== null) {
          cancelAnimationFrame(siteListModalRafId);
          siteListModalRafId = null;
        }
      }
    });

    // Center modal on show
    function showCustomMarketModal(section) {
      const bg = document.getElementById('custom-market-modal-bg');
      document.getElementById('custom-market-modal-section').textContent = {
        asia: "Asia Section",
        international: "International Section",
        special: "Designer Section"
      }[section] || "";
      bg.style.display = 'flex';
      bg.setAttribute('data-section', section);
      document.getElementById('custom-market-title-input').value = '';
      document.getElementById('custom-market-url-input').value = '';
      
      // Center modal
      const modal = document.querySelector('.custom-market-modal');
      modal.style.left = '50%';
      modal.style.top = '50%';
      modal.style.transform = 'translate(-50%, -50%)';
      
      setTimeout(() => {
        document.getElementById('custom-market-title-input').focus();
      }, 20);
    }

    // Toggle all marketplaces
    document.getElementById('toggle-all-checkbox').addEventListener('change', function(e) {
      const isChecked = e.target.checked;
      
      // Get all markets from all sections
      const allMarkets = [
        ...getMarkets('asia'),
        ...getMarkets('international'),
        ...getMarkets('special')
      ];
      
      // Update state for all markets
      allMarkets.forEach(market => {
        saveMarketToggleState(market.key, isChecked);
      });
      
      // Refresh all buttons to reflect the new state
      refreshAllMarketButtons();
      
      // Update site list modal if open
      const siteListModal = document.getElementById('site-list-modal-bg');
      if (siteListModal && siteListModal.style.display !== 'none') {
        renderSiteList();
      }
    });

    // Mobile detection and functionality - Enhanced
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    // Initialize mobile UI if on mobile
    if (isMobile) {
      console.log('Mobile device detected, initializing mobile UI');
      
      // Hide desktop sidebar and wishlist
      const sidebar = document.getElementById('sidebar');
      const wishlist = document.getElementById('wishlist-section');
      if (sidebar) sidebar.style.display = 'none';
      if (wishlist) wishlist.style.display = 'none';
      
      // Show mobile menu toggle
      const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
      if (mobileMenuToggle) {
        mobileMenuToggle.style.display = 'flex';
      }
      
      // Simplify mobile interface
      const openAllBtn = document.getElementById('open-all-btn');
      if (openAllBtn) {
        openAllBtn.style.display = 'block';
        openAllBtn.textContent = 'Open All';
      }
      
      // Hide complex features on mobile
      document.querySelectorAll('.add-market-btn').forEach(btn => {
        btn.style.display = 'none';
      });
      
      // Simplify section open all buttons
      document.querySelectorAll('.section-openall-btn').forEach(btn => {
        btn.style.display = 'block';
        btn.style.padding = '12px 16px';
        btn.style.fontSize = '14px';
      });
      
      // Hide theme editor on mobile
      const themeEditorBtn = document.getElementById('theme-editor-btn');
      if (themeEditorBtn) themeEditorBtn.style.display = 'none';
      
      // Initialize mobile sidebar functionality
      const mobileSidebar = document.getElementById('mobile-sidebar');
      const mobileSidebarOverlay = document.getElementById('mobile-sidebar-overlay');
      
      if (mobileMenuToggle && mobileSidebar && mobileSidebarOverlay) {
        // Add event listeners
        mobileMenuToggle.addEventListener('click', function() {
          console.log('Mobile menu opened, updating searches');
          mobileSidebar.classList.add('active');
          mobileSidebarOverlay.classList.add('active');
          // Update folders and searches when opening - ensure latest data
          updateMobileFolderTabs();
          updateMobileSearches();
          // Also update the main saved searches to sync
          renderSavedSearches();
        });
        
        mobileSidebarOverlay.addEventListener('click', function() {
          mobileSidebar.classList.remove('active');
          mobileSidebarOverlay.classList.remove('active');
        });
      }
      
      // Initialize mobile folders and searches immediately
      setTimeout(() => {
        console.log('Initializing mobile folders and searches');
        updateMobileFolderTabs();
        updateMobileSearches();
      }, 100);
      
      // Make sure mobile searches are updated when saved searches change
      // Override addSavedSearch to update mobile sidebar
      const originalAddSavedSearch = addSavedSearch;
      addSavedSearch = function(term) {
        originalAddSavedSearch.apply(this, arguments);
        if (isMobile) {
          updateMobileSearches();
        }
      };
      
      // Override removeSavedSearch to update mobile sidebar
      const originalRemoveSavedSearch = removeSavedSearch;
      removeSavedSearch = function(idx) {
        originalRemoveSavedSearch.apply(this, arguments);
        if (isMobile) {
          updateMobileSearches();
        }
      };
      
      // Initialize mobile folders and searches
      updateMobileFolderTabs();
      updateMobileSearches();
      
      // Update mobile folder tabs
      function updateMobileFolderTabs() {
        const folderTabs = document.getElementById('mobile-folder-tabs');
        if (!folderTabs) return;
      
        // Clear existing content
        folderTabs.innerHTML = '';
      
        savedFolders.forEach((folder, idx) => {
          const folderTab = document.createElement('button');
          folderTab.className = 'mobile-folder-tab' + (idx === currentFolderIdx ? ' active' : '');
          folderTab.textContent = folder.name;
          folderTab.style.padding = '8px 12px';
          folderTab.style.borderRadius = '6px';
          folderTab.style.border = '1px solid rgba(255,255,255,0.1)';
          folderTab.style.background = idx === currentFolderIdx ? 'rgba(0, 230, 214, 0.2)' : 'rgba(44,46,48,0.7)';
          folderTab.style.color = '#e3e3e3';
          folderTab.style.fontSize = '14px';
          folderTab.style.cursor = 'pointer';
          folderTab.style.transition = 'all 0.2s ease';
          folderTab.style.flex = '0 0 auto';
          folderTab.style.whiteSpace = 'nowrap';
        
          folderTab.onclick = function() {
            currentFolderIdx = idx;
            updateMobileFolderTabs();
            updateMobileSearches();
            renderFolders();
            renderSavedSearches();
          };
          folderTabs.appendChild(folderTab);
        });
      }
      
      // Ensure mobile sidebar is properly initialized
      window.addEventListener('load', function() {
        if (isMobile) {
          updateMobileFolders();
          updateMobileSearches();
        }
      });
      
      // Also update mobile searches when the main saved searches are rendered
      const originalRenderSavedSearches = renderSavedSearches;
      renderSavedSearches = function() {
        originalRenderSavedSearches.apply(this, arguments);
        if (isMobile) {
          updateMobileSearches();
        }
      };
      
      // Load saved searches into mobile sidebar - Show terms directly
      function updateMobileSearches() {
        // Make sure we have the current folder
        if (!savedFolders || savedFolders.length === 0) {
          console.error('No saved folders found');
          return;
        }
      
        const folder = savedFolders[currentFolderIdx];
        const mobileList = document.getElementById('mobile-searches-list');
        if (!mobileList) {
          console.error('Mobile searches list element not found');
          return;
        }
      
        // Clear the list first
        mobileList.innerHTML = '';
      
        if (!folder || !folder.searches || folder.searches.length === 0) {
          const emptyMsg = document.createElement('li');
          emptyMsg.textContent = 'No saved searches in this folder';
          emptyMsg.style.color = '#888';
          emptyMsg.style.textAlign = 'center';
          emptyMsg.style.padding = '20px';
          mobileList.appendChild(emptyMsg);
          return;
        }
      
        // Sort searches alphabetically
        const sortedSearches = [...folder.searches].sort((a, b) => 
          (a.value || "").localeCompare(b.value || "", undefined, {sensitivity: 'base'})
        );
      
        // Create a document fragment to batch DOM operations
        const fragment = document.createDocumentFragment();
      
        sortedSearches.forEach((term, idx) => {
          const li = document.createElement('li');
          li.style.marginBottom = '8px';
          li.style.padding = '0';
        
          const termBtn = document.createElement('button');
          termBtn.type = 'button';
          termBtn.style.width = '100%';
          termBtn.style.textAlign = 'left';
          termBtn.style.padding = '12px 14px';
          termBtn.style.borderRadius = '8px';
          termBtn.style.background = clickedSearches[term.value] ? 
            'linear-gradient(135deg, rgba(0, 230, 214, 0.25) 0%, rgba(0, 184, 169, 0.25) 100%)' : 
            'linear-gradient(135deg, rgba(44,46,48,0.7) 0%, rgba(30,32,34,0.7) 100%)';
          termBtn.style.border = clickedSearches[term.value] ? 
            '1px solid rgba(0, 230, 214, 0.4)' : '1px solid rgba(255,255,255,0.1)';
          termBtn.style.color = '#e3e3e3';
          termBtn.style.fontSize = '15px';
          termBtn.style.fontWeight = clickedSearches[term.value] ? '600' : '400';
          termBtn.style.transition = 'all 0.3s ease';
          termBtn.style.display = 'flex';
          termBtn.style.alignItems = 'center';
          termBtn.style.justifyContent = 'space-between';
        
          // Term text
          const termText = document.createElement('span');
          termText.textContent = term.value;
          termText.style.overflow = 'hidden';
          termText.style.textOverflow = 'ellipsis';
          termText.style.whiteSpace = 'nowrap';
          termText.style.flex = '1';
        
          // Remove button
          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.innerHTML = '🗑';
          removeBtn.style.background = 'none';
          removeBtn.style.border = 'none';
          removeBtn.style.color = '#ff3b5c';
          removeBtn.style.cursor = 'pointer';
          removeBtn.style.padding = '0 5px';
          removeBtn.style.fontSize = '16px';
          removeBtn.style.flexShrink = '0';
          removeBtn.style.marginLeft = '10px';
        
          // Find the index of this term in the current folder
          const termIndex = folder.searches.findIndex(t => t.value === term.value);
        
          removeBtn.onclick = function(e) {
            e.stopPropagation();
            removeSavedSearch(termIndex);
            updateMobileSearches();
            renderSavedSearches();
          };
        
          termBtn.appendChild(termText);
          termBtn.appendChild(removeBtn);
        
          // Use a closure to capture the current term value
          (function(termValue) {
            termBtn.onclick = function(e) {
              // Don't trigger if clicking the remove button
              if (e.target === removeBtn || removeBtn.contains(e.target)) {
                return;
              }
              document.getElementById('query').value = termValue;
              document.getElementById('query').focus();
            
              // Mark as clicked
              clickedSearches[termValue] = { 
                clicked: true, 
                category: determineSearchCategory(termValue) 
              };
              localStorage.setItem(CLICKED_SEARCHES_KEY, JSON.stringify(clickedSearches));
            
              // Update UI
              updateMobileSearches();
              renderSavedSearches();
            
              // Close mobile sidebar
              if (mobileSidebar) mobileSidebar.classList.remove('active');
              if (mobileSidebarOverlay) mobileSidebarOverlay.classList.remove('active');
            };
          })(term.value);
        
          li.appendChild(termBtn);
          fragment.appendChild(li);
        });
      
        // Append all at once
        mobileList.appendChild(fragment);
      }
      
      // Make sure mobile sidebar is properly initialized when opened
      if (mobileMenuToggle && mobileSidebar && mobileSidebarOverlay) {
        // Add event listeners
        mobileMenuToggle.addEventListener('click', function() {
          mobileSidebar.classList.add('active');
          mobileSidebarOverlay.classList.add('active');
          // Update folders and searches when opening
          updateMobileFolderTabs();
          updateMobileSearches();
        });
        
        mobileSidebarOverlay.addEventListener('click', function() {
          mobileSidebar.classList.remove('active');
          mobileSidebarOverlay.classList.remove('active');
        });
      }
      
      // Mobile add search functionality
      const mobileAddBtn = document.getElementById('mobile-add-btn');
      const mobileAddInput = document.getElementById('mobile-add-input');
      
      if (mobileAddBtn && mobileAddInput) {
        mobileAddBtn.addEventListener('click', function() {
          const value = mobileAddInput.value.trim();
          if (value) {
            addSavedSearch(value);
            mobileAddInput.value = '';
            updateMobileFolderTabs();
            updateMobileSearches();
            renderSavedSearches();
          }
        });
          
        mobileAddInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            const value = this.value.trim();
            if (value) {
              addSavedSearch(value);
              this.value = '';
              updateMobileFolderTabs();
              updateMobileSearches();
              renderSavedSearches();
            }
          }
        });
      }
      
      // Mobile randomize button - Simplified without category selection
      const mobileRandomizeBtn = document.getElementById('mobile-randomize-btn');
      if (mobileRandomizeBtn) {
        mobileRandomizeBtn.addEventListener('click', function() {
          const folder = savedFolders[currentFolderIdx];
          
          if (!folder.searches || folder.searches.length === 0) {
            alert('No saved searches to randomize from');
            return;
          }
          
          const unhighlightedTerms = folder.searches.filter(term => 
            !clickedSearches[term.value] || !clickedSearches[term.value].clicked
          );
          
          let randomTerm;
          if (unhighlightedTerms.length === 0) {
            clickedSearches = {};
            localStorage.setItem(CLICKED_SEARCHES_KEY, JSON.stringify(clickedSearches));
            randomTerm = folder.searches[Math.floor(Math.random() * folder.searches.length)];
          } else {
            randomTerm = unhighlightedTerms[Math.floor(Math.random() * unhighlightedTerms.length)];
          }
          
          document.getElementById('query').value = randomTerm.value;
          
          // Close mobile sidebar
          if (mobileSidebar) mobileSidebar.classList.remove('active');
          if (mobileSidebarOverlay) mobileSidebarOverlay.classList.remove('active');
          
          // Update UI
          updateMobileFolderTabs();
          updateMobileSearches();
          renderSavedSearches();
        });
      }
      
      // Mobile reset highlights
      const mobileResetBtn = document.getElementById('mobile-reset-highlights-btn');
      if (mobileResetBtn) {
        mobileResetBtn.addEventListener('click', function() {
          clickedSearches = {};
          localStorage.removeItem(CLICKED_SEARCHES_KEY);
          updateMobileFolderTabs();
          updateMobileSearches();
          renderSavedSearches();
          alert('All highlights have been reset');
        });
      }

      // Mobile export functionality
      const mobileExportBtn = document.getElementById('mobile-export-btn');
      if (mobileExportBtn) {
        mobileExportBtn.addEventListener('click', function() {
          const dataStr = JSON.stringify(foldersObj, null, 2);
          const blob = new Blob([dataStr], {type: 'application/json'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'saved-searches-with-folders-and-websites.json';
          document.body.appendChild(a);
          a.click();
          setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }, 50);
        });
      }

      // Mobile import functionality
      const mobileImportInput = document.getElementById('mobile-import-input');
      if (mobileImportInput) {
        mobileImportInput.addEventListener('change', function(event) {
          const file = event.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function(e) {
            try {
              const imported = JSON.parse(e.target.result);
              // If imported is array, legacy format
              if (Array.isArray(imported)) {
                foldersObj = { folders: imported, customMarkets: loadCustomMarketsFromFolders(imported) };
              } else if (imported && Array.isArray(imported.folders) && imported.customMarkets) {
                foldersObj = imported;
              } else {
                alert('Invalid file format.');
                return;
              }
              savedFolders = foldersObj.folders;
              customMarkets = foldersObj.customMarkets || { asia: [], international: [], special: [] };
              if (savedFolders.length === 0) savedFolders = [{ name: 'Default', searches: [] }];
              currentFolderIdx = 0;
              saveFoldersObj(foldersObj);
              refreshAllMarketButtons();
              renderFolders();
              renderSavedSearches();
              updateMobileFolderTabs();
              updateMobileFolderTabs();
              updateMobileSearches();
              alert('Import successful!');
              
              // Close mobile sidebar after import
              if (mobileSidebar) mobileSidebar.classList.remove('active');
              if (mobileSidebarOverlay) mobileSidebarOverlay.classList.remove('active');
            } catch (err) {
              alert('Failed to import: ' + err.message);
            }
          };
          reader.readAsText(file);
          event.target.value = '';
        });
      }
      
      // Initialize mobile folders and searches
      updateMobileFolderTabs();
      updateMobileSearches();
      
      // On mobile, open tabs one at a time to avoid overwhelming the browser
      const originalTabQueueAdd = tabQueue.add;
      tabQueue.add = function(url) {
        // Open immediately but in new tab
        window.open(url, '_blank');
      };
      
      // Update form submission for mobile
      const searchForm = document.getElementById('searchForm');
      if (searchForm) {
        searchForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const query = document.getElementById('query').value.trim();
          if (!query) return;
          
          // On mobile, open Mercari Japan in new tab
          window.open(marketUrls["mercari-jp"](query), '_blank');
        });
      }
      
      // Make sure market buttons work on mobile
      document.addEventListener('click', function(e) {
        const marketBtn = e.target.closest('.market-btn');
        if (marketBtn && !marketBtn.classList.contains('disabled') && !e.target.classList.contains('market-toggle')) {
          const query = document.getElementById('query').value.trim();
          if (!query) {
            document.getElementById('query').focus();
            return;
          }
          
          const market = marketBtn.getAttribute('data-market');
          const section = marketBtn.getAttribute('data-section');
          
          let url;
          if (market.startsWith("custom-")) {
            // Extract market ID: key format is "custom-{section}-{id}"
            // Since we have the section, remove "custom-{section}-" prefix
            const prefix = `custom-${section}-`;
            const customId = market.startsWith(prefix) ? market.substring(prefix.length) : market.split("-").slice(2).join("-");
            url = getCustomMarketUrl(section, customId, query);
          } else if (marketUrls[market]) {
            url = marketUrls[market](query);
          }
          
          if (url) {
            // On mobile, open in new tab
            window.open(url, '_blank');
          }
        }
      });
      
      // Improve mobile experience by adjusting some styles dynamically
      setTimeout(() => {
        // Make sure container is properly sized
        const container = document.querySelector('.container');
        if (container) {
          container.style.height = 'auto';
          container.style.minHeight = '100vh';
        }
      }, 100);
    }

    // On page load, refresh market buttons with custom
    refreshAllMarketButtons();

    // On folder or custom market change, refresh UI
    // (already handled above after relevant actions)
  </script>
  <script>
(function() {
  const folderList = document.getElementById('saved-folder-list');
  const searchList = document.getElementById('saved-searches-list');
  const handle = document.getElementById('sidebar-folder-search-resize');
  let startY, startFolderHeight, startSearchHeight, resizing = false;

  // Set initial heights
  folderList.style.height = '120px';
  searchList.style.height = '180px';
  folderList.style.overflowY = 'auto';
  searchList.style.overflowY = 'auto';

  handle.addEventListener('mousedown', function(e) {
    e.preventDefault();
    resizing = true;
    startY = e.clientY;
    startFolderHeight = folderList.offsetHeight;
    startSearchHeight = searchList.offsetHeight;
    document.body.style.userSelect = 'none';
  });

  window.addEventListener('mousemove', function(e) {
    if (!resizing) return;
    let dy = e.clientY - startY;
    let newFolderHeight = Math.max(60, Math.min(300, startFolderHeight + dy));
    let newSearchHeight = Math.max(80, Math.min(400, startSearchHeight - dy));
    folderList.style.height = newFolderHeight + 'px';
    searchList.style.height = newSearchHeight + 'px';
  });

  window.addEventListener('mouseup', function() {
    if (resizing) {
      resizing = false;
      document.body.style.userSelect = '';
    }
  });
})();
</script>
<script>
(function() {
  const sidebar = document.querySelector('.sidebar');
  const wishlist = document.querySelector('.wishlist-section');
  const container = document.querySelector('.container');
  const resizeHandles = document.querySelectorAll('.resize-handle');

  let resizing = false;
  let startX, startY, startW, startH;

  resizeHandles.forEach(handle => {
    handle.addEventListener('mousedown', function(e) {
      e.preventDefault();
      resizing = { type: handle.dataset.resize };
      startX = e.clientX;
      startY = e.clientY;
      startW = parseInt(document.defaultView.getComputedStyle(resizing.type === 'sidebar' ? sidebar : resizing.type === 'wishlist' ? wishlist : container).width, 10);
      startH = parseInt(document.defaultView.getComputedStyle(container).height, 10);
      document.body.style.userSelect = 'none';
    });
  });

  window.addEventListener('mousemove', function(e) {
    if (!resizing) return;
    
    // Get top header height to prevent handles from going under it
    const topHeader = document.querySelector('.top-header');
    const topHeaderHeight = topHeader ? topHeader.offsetHeight : 50;
    
    if (resizing.type === 'sidebar') {
      const dx = e.clientX - startX;
      let newW = Math.max(200, Math.min(600, startW + dx));
      const sidebar = document.querySelector('.sidebar');
      sidebar.style.width = newW + 'px';
      
      // Prevent side handles from going under top header
      const handleLeft = sidebar.querySelector('.resize-handle-left');
      const handleRight = sidebar.querySelector('.resize-handle-right');
      if (handleLeft && e.clientY < topHeaderHeight) {
        return; // Don't resize if mouse is under top header
      }
      if (handleRight && e.clientY < topHeaderHeight) {
        return; // Don't resize if mouse is under top header
      }
      
      // Adjust container margin when sidebar resizes
      if (window.innerWidth >= 1200) {
        document.querySelector('.container').style.marginLeft = newW + 'px';
      }
    }
    if (resizing.type === 'wishlist') {
      const dx = startX - e.clientX;
      let newW = Math.max(200, Math.min(600, startW + dx));
      const wishlist = document.querySelector('.wishlist-section');
      wishlist.style.width = newW + 'px';
      
      // Prevent side handles from going under top header
      const handleLeft = wishlist.querySelector('.resize-handle-left');
      if (handleLeft && e.clientY < topHeaderHeight) {
        return; // Don't resize if mouse is under top header
      }
    }
    if (resizing.type === 'container') {
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      let newW = Math.max(350, Math.min(900, startW + dx));
      let newH = Math.max(350, Math.min(window.innerHeight - 40, startH + dy));
      const container = document.querySelector('.container');
      container.style.width = newW + 'px';
      container.style.height = newH + 'px';
      
      // Prevent side handles from going under top header
      const handleLeft = container.querySelector('.resize-handle-left');
      const handleRight = container.querySelector('.resize-handle-right');
      if ((handleLeft || handleRight) && e.clientY < topHeaderHeight) {
        return; // Don't resize if mouse is under top header
      }
    }
  });

  window.addEventListener('mouseup', function() {
    if (resizing) {
      resizing = false;
      document.body.style.userSelect = '';
    }
  });
})();
</script>
  <!-- Theme Editor Modal -->
  <div id="theme-editor-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:3000;background:rgba(10,10,10,0.65);backdrop-filter:blur(2.5px);align-items:center;justify-content:center;">
    <div style="background:rgba(32,34,36,0.98);border-radius:18px;box-shadow:0 8px 32px #000a;padding:28px 22px 18px 22px;max-width:350px;width:96vw;border:1.5px solid #232323;backdrop-filter:blur(7px);cursor:default;">
      <h3 style="margin-top:0;font-size:1.17em;color:#e3e3e3;margin-bottom:10px;font-weight:bold;letter-spacing:0.01em;text-shadow:0 1px 8px #2224;">Theme Editor</h3>
      <div style="margin-bottom:15px;">
        <label style="display:block;margin-top:12px;margin-bottom:2px;color:#e3e3e3;font-weight:bold;font-size:1em;">Background Color</label>
        <input type="color" id="theme-bg-color" value="#121212" style="width:100%;height:40px;border-radius:5px;border:1.5px solid #232323;">
      </div>
      <div style="margin-bottom:15px;">
        <label style="display:block;margin-top:12px;margin-bottom:2px;color:#e3e3e3;font-weight:bold;font-size:1em;">Accent Color</label>
        <input type="color" id="theme-accent-color" value="#666" style="width:100%;height:40px;border-radius:5px;border:1.5px solid #232323;">
      </div>
      <div style="margin-bottom:15px;">
        <label style="display:block;margin-top:12px;margin-bottom:2px;color:#e3e3e3;font-weight:bold;font-size:1em;">Search Highlight Color</label>
        <input type="color" id="theme-highlight-color" value="#a0d8ed" style="width:100%;height:40px;border-radius:5px;border:1.5px solid #232323;">
      </div>
      <div style="margin-bottom:15px;">
        <label style="display:block;margin-top:12px;margin-bottom:2px;color:#e3e3e3;font-weight:bold;font-size:1em;">Background Image</label>
        <input type="file" id="theme-bg-image" accept="image/*" style="width:100%;border-radius:5px;border:1.5px solid #232323;padding:5px;">
        <div style="display:flex;gap:5px;margin-top:5px;">
          <button id="theme-bg-image-remove" style="background:#232323;color:#e3e3e3;border:none;border-radius:4px;font-size:0.9em;padding:3px 8px;cursor:pointer;">Remove Image</button>
          <button id="theme-bg-image-preview" style="background:#232323;color:#e3e3e3;border:none;border-radius:4px;font-size:0.9em;padding:3px 8px;cursor:pointer;">Preview</button>
        </div>
      </div>
      <div style="margin-bottom:15px;">
        <label style="display:block;margin-top:12px;margin-bottom:2px;color:#e3e3e3;font-weight:bold;font-size:1em;">Logo Image</label>
        <input type="file" id="theme-logo-image" accept="image/*" style="width:100%;border-radius:5px;border:1.5px solid #232323;padding:5px;">
        <div style="display:flex;gap:5px;margin-top:5px;">
          <button id="theme-logo-image-remove" style="background:#232323;color:#e3e3e3;border:none;border-radius:4px;font-size:0.9em;padding:3px 8px;cursor:pointer;">Reset Default</button>
          <button id="theme-logo-image-preview" style="background:#232323;color:#e3e3e3;border:none;border-radius:4px;font-size:0.9em;padding:3px 8px;cursor:pointer;">Preview</button>
        </div>
      </div>
      <div style="display:flex;gap:11px;margin-top:18px;justify-content:flex-end;">
        <button id="theme-apply-btn" style="background:#232323;color:#e3e3e3;border:none;border-radius:6px;font-size:1em;font-weight:bold;cursor:pointer;padding:8px 22px;transition:background .18s,box-shadow .18s,transform .13s;box-shadow:0 2px 8px #2224;opacity:0.93;backdrop-filter:blur(1.5px);">Apply</button>
        <button id="theme-reset-btn" style="background:#232323;color:#e3e3e3;border:none;border-radius:6px;font-size:1em;font-weight:bold;cursor:pointer;padding:8px 22px;transition:background .14s,color .14s;opacity:0.93;backdrop-filter:blur(1.5px);">Reset</button>
        <button id="theme-close-btn" style="background:#232323;color:#e3e3e3;border:none;border-radius:6px;font-size:1em;font-weight:bold;cursor:pointer;padding:8px 22px;transition:background .14s,color .14s;opacity:0.93;backdrop-filter:blur(1.5px);">Close</button>
      </div>
    </div>
  </div>

  <!-- Particle Background Effect -->
  <canvas id="particle-canvas" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;pointer-events:none;"></canvas>
  <script>
    // Particle background
    (function() {
      const canvas = document.getElementById('particle-canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      
      const particles = [];
      const particleCount = Math.floor(window.innerWidth / 10);
      
      for (let i = 0; i < particleCount; i++) {
        particles.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          size: Math.random() * 2 + 0.5,
          speedX: Math.random() * 0.2 - 0.1,
          speedY: Math.random() * 0.2 - 0.1,
          color: `rgba(100, 220, 255, ${Math.random() * 0.1 + 0.05})`
        });
      }
      
      function animateParticles() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        for (let i = 0; i < particles.length; i++) {
          const p = particles[i];
          
          p.x += p.speedX;
          p.y += p.speedY;
          
          if (p.x < 0 || p.x > canvas.width) p.speedX *= -1;
          if (p.y < 0 || p.y > canvas.height) p.speedY *= -1;
          
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
          ctx.fillStyle = p.color;
          ctx.fill();
        }
        
        requestAnimationFrame(animateParticles);
      }
      
      animateParticles();
      
      window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      });
    })();
  </script>
  <script>
    // Theme Editor Functionality
    document.getElementById('theme-editor-btn').addEventListener('click', function() {
      document.getElementById('theme-editor-modal').style.display = 'flex';
    });

    document.getElementById('theme-close-btn').addEventListener('click', function() {
      document.getElementById('theme-editor-modal').style.display = 'none';
    });

    // Handle background image upload
    document.getElementById('theme-bg-image').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          const bgImage = event.target.result;
          document.documentElement.style.setProperty('--theme-bg-image', `url(${bgImage})`);
          localStorage.setItem('themeBgImage', bgImage);
        };
        reader.readAsDataURL(file);
      }
    });

    // Remove background image
    document.getElementById('theme-bg-image-remove').addEventListener('click', function() {
      document.documentElement.style.setProperty('--theme-bg-image', 'none');
      localStorage.removeItem('themeBgImage');
      document.getElementById('theme-bg-image').value = '';
    });

    // Preview background image
    document.getElementById('theme-bg-image-preview').addEventListener('click', function() {
      const bgImage = localStorage.getItem('themeBgImage');
      if (bgImage) {
        document.documentElement.style.setProperty('--theme-bg-image', `url(${bgImage})`);
      } else {
        document.documentElement.style.setProperty('--theme-bg-image', 'url("bg.png")');
      }
    });

    document.getElementById('theme-apply-btn').addEventListener('click', function() {
      const bgColor = document.getElementById('theme-bg-color').value;
      const accentColor = document.getElementById('theme-accent-color').value;
      const highlightColor = document.getElementById('theme-highlight-color').value;
      
      // Apply theme
      document.documentElement.style.setProperty('--theme-bg', bgColor);
      document.documentElement.style.setProperty('--theme-accent', accentColor);
      document.documentElement.style.setProperty('--theme-highlight', highlightColor);
      
      // Save to localStorage
      localStorage.setItem('themeSettings', JSON.stringify({
        bgColor,
        accentColor,
        highlightColor
      }));
    });

    document.getElementById('theme-reset-btn').addEventListener('click', function() {
      // Reset to defaults
      document.getElementById('theme-bg-color').value = '#121212';
      document.getElementById('theme-accent-color').value = '#666';
      document.getElementById('theme-highlight-color').value = '#a0d8ed';
      
      // Remove saved theme
      localStorage.removeItem('themeSettings');
      localStorage.removeItem('themeBgImage');
      
      // Apply defaults
      document.documentElement.style.setProperty('--theme-bg', '#121212');
      document.documentElement.style.setProperty('--theme-accent', '#666');
      document.documentElement.style.setProperty('--theme-highlight', '#a0d8ed');
      document.documentElement.style.setProperty('--theme-bg-image', 'url("bg.png")');
      
      // Reset logo to default
      document.querySelector('.wishlist-mascot').src = 'mmcs.png';
      localStorage.removeItem('themeLogoImage');
      document.getElementById('theme-logo-image').value = '';
      document.getElementById('theme-bg-image').value = '';
    });

    // Reset highlights button
    document.getElementById('sidebar-reset-highlights-btn').addEventListener('click', function() {
      clickedSearches = {};
      localStorage.removeItem(CLICKED_SEARCHES_KEY);
      document.querySelectorAll('.saved-search-term').forEach(btn => {
        btn.classList.remove('active');
        btn.removeAttribute('data-category');
      });
      updateUnhighlightedCount();
      
      // Also clear selection
      selectedSearchTerms = {};
      localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
      renderSavedSearches();
    });

    // Helper function to open all markets with a query
    function openAllMarketsWithQuery(query) {
      // Collect all URLs first (only enabled markets)
      const urls = [];
      ['asia', 'international', 'special'].forEach(section => {
        getMarkets(section).forEach(market => {
          // Skip if this market is toggled off
          if (!loadMarketToggleState(market.key)) return;
          
          if (market.custom) {
            // Extract market ID: key format is "custom-{section}-{id}"
            // Since we have the section, remove "custom-{section}-" prefix
            const prefix = `custom-${section}-`;
            const customId = market.key.startsWith(prefix) ? market.key.substring(prefix.length) : market.key.split("-").slice(2).join("-");
            const url = getCustomMarketUrl(section, customId, query);
            if (url) urls.push(url);
          } else if (marketUrls[market.key]) {
            urls.push(marketUrls[market.key](query));
          }
        });
      });
      
      // Process URLs with queue
      urls.forEach(url => tabQueue.add(url));
      
      // Clear selection after search
      selectedSearchTerms = {};
      localStorage.setItem(SELECTED_SEARCH_TERMS_KEY, JSON.stringify(selectedSearchTerms));
      renderSavedSearches();
    }

    // Load saved theme on startup
    const savedTheme = localStorage.getItem('themeSettings');
    if (savedTheme) {
      const theme = JSON.parse(savedTheme);
      document.getElementById('theme-bg-color').value = theme.bgColor;
      document.getElementById('theme-accent-color').value = theme.accentColor;
      document.getElementById('theme-highlight-color').value = theme.highlightColor || '#00e6d6';
      
      document.documentElement.style.setProperty('--theme-bg', theme.bgColor);
      document.documentElement.style.setProperty('--theme-accent', theme.accentColor);
      document.documentElement.style.setProperty('--theme-highlight', theme.highlightColor || '#00e6d6');
    } else {
      // Apply default background image if no saved theme
      document.documentElement.style.setProperty('--theme-bg-image', 'url("bg.png")');
    }

    // Load saved background image
    const savedBgImage = localStorage.getItem('themeBgImage');
    if (savedBgImage) {
      document.documentElement.style.setProperty('--theme-bg-image', `url(${savedBgImage})`);
    }

    // Load saved logo image
    const savedLogoImage = localStorage.getItem('themeLogoImage');
    if (savedLogoImage) {
      document.querySelector('.wishlist-mascot').src = savedLogoImage;
    }

    // Handle logo image upload
    document.getElementById('theme-logo-image').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          const logoImage = event.target.result;
          document.querySelector('.wishlist-mascot').src = logoImage;
          localStorage.setItem('themeLogoImage', logoImage);
        };
        reader.readAsDataURL(file);
      }
    });

    // Reset logo to default
    document.getElementById('theme-logo-image-remove').addEventListener('click', function() {
      document.querySelector('.wishlist-mascot').src = 'mmcs.png';
      localStorage.removeItem('themeLogoImage');
      document.getElementById('theme-logo-image').value = '';
    });

    // Preview logo
    document.getElementById('theme-logo-image-preview').addEventListener('click', function() {
      const logoImage = localStorage.getItem('themeLogoImage');
      if (logoImage) {
        document.querySelector('.wishlist-mascot').src = logoImage;
      }
    });

    // Sidebar minimize/restore functionality (no dragging)
    (function() {
      const sidebar = document.getElementById('sidebar');
      let isMinimized = false;
      
      function toggleSidebarMinimize() {
        isMinimized = !isMinimized;
        
        if (isMinimized) {
          // Fully hide the sidebar
          sidebar.style.display = 'none';
        } else {
          // Show the sidebar
          sidebar.style.display = '';
        }
        
        // Update button state
        const btn = document.getElementById('minimize-sidebar-btn');
        if (btn) btn.classList.toggle('active', isMinimized);
      }
      
      // Minimize button handler (desktop only)
      const minimizeSidebarBtn = document.getElementById('minimize-sidebar-btn');
      if (minimizeSidebarBtn) {
        minimizeSidebarBtn.addEventListener('click', toggleSidebarMinimize);
      }
      
      // Update button state on page load
      if (window.innerWidth >= 1200) {
        if (minimizeSidebarBtn) {
          minimizeSidebarBtn.classList.toggle('active', sidebar.style.display === 'none');
        }
      }

      // Wishlist minimize/restore functionality
      const wishlistSection = document.getElementById('wishlist-section');
      let isWishlistMinimized = false;
      
      function toggleWishlistMinimize() {
        isWishlistMinimized = !isWishlistMinimized;
        
        if (isWishlistMinimized) {
          // Fully hide the wishlist
          wishlistSection.style.display = 'none';
        } else {
          // Show the wishlist
          wishlistSection.style.display = '';
        }
        
        // Update button state
        const btn = document.getElementById('minimize-wishlist-btn');
        if (btn) btn.classList.toggle('active', isWishlistMinimized);
      }
      
      // Minimize button handler (desktop only)
      const minimizeWishlistBtn = document.getElementById('minimize-wishlist-btn');
      if (minimizeWishlistBtn) {
        minimizeWishlistBtn.addEventListener('click', toggleWishlistMinimize);
      }
      
      // Update button state on page load
      if (window.innerWidth >= 1200) {
        if (minimizeWishlistBtn) {
          minimizeWishlistBtn.classList.toggle('active', wishlistSection.style.display === 'none');
        }
      }
      
      // Panel controls functionality (for close button)
      const minimizedPanels = document.getElementById('minimized-panels');
      const PANEL_SIZES_KEY = 'panelSizes';
      
      // Close panel handler removed - wishlist close button removed
      // Panels are now controlled via header minimization buttons only
      
      // ===== MONETIZATION FEATURES =====
      
      // Upgrade Modal Handlers
      const upgradeModalBg = document.getElementById('upgrade-modal-bg');
      const upgradeModalClose = document.getElementById('upgrade-modal-close');
      const premiumUpgradeBtn = document.getElementById('premium-upgrade-btn');
      const headerDonateBtn = document.getElementById('header-donate-btn');
      
      function showUpgradeModal() {
        if (upgradeModalBg) {
          upgradeModalBg.classList.add('show');
        }
      }
      
      function hideUpgradeModal() {
        if (upgradeModalBg) {
          upgradeModalBg.classList.remove('show');
        }
      }
      
      // Expose globally
      window.showUpgradeModal = showUpgradeModal;
      
      // Close upgrade modal
      if (upgradeModalClose) {
        upgradeModalClose.addEventListener('click', hideUpgradeModal);
      }
      
      // Close on background click
      if (upgradeModalBg) {
        upgradeModalBg.addEventListener('click', (e) => {
          if (e.target === upgradeModalBg) {
            hideUpgradeModal();
          }
        });
      }
      
      // Premium upgrade banner button
      if (premiumUpgradeBtn) {
        premiumUpgradeBtn.addEventListener('click', showUpgradeModal);
      }
      
      // Header donate button
      if (headerDonateBtn) {
        headerDonateBtn.addEventListener('click', showUpgradeModal);
      }
      
      // Upgrade modal donation buttons
      const upgradeDonatePaypal = document.getElementById('upgrade-donate-paypal');
      const upgradeDonateCashapp = document.getElementById('upgrade-donate-cashapp');
      const upgradeModalCancel = document.getElementById('upgrade-modal-cancel');
      
      if (upgradeDonatePaypal) {
        upgradeDonatePaypal.addEventListener('click', () => {
          window.open('https://www.paypal.com/donate?business=m3owle0@gmail.com&currency_code=USD', '_blank');
        });
      }
      
      if (upgradeDonateCashapp) {
        upgradeDonateCashapp.addEventListener('click', () => {
          window.open('https://cash.app/$0emo', '_blank');
        });
      }
      
      if (upgradeModalCancel) {
        upgradeModalCancel.addEventListener('click', hideUpgradeModal);
      }
      
      // Update premium badge visibility on user load
      async function updatePremiumBadge() {
        if (!supabase) return;
        
        try {
          const { data: { session } } = await supabase.auth.getSession();
          if (!session) {
            const premiumBadge = document.getElementById('premium-badge');
            if (premiumBadge) premiumBadge.style.display = 'none';
            return;
          }
          
          const { data: { user } } = await supabase.auth.getUser();
          if (!user) return;
          
          const { data: unlockedData } = await supabase
            .from('unlocked_users')
            .select('verified')
            .eq('auth_user_id', user.id)
            .maybeSingle();
          
          if (unlockedData) {
            const verifiedValue = unlockedData.verified;
            const isVerified = verifiedValue === true || 
                               verifiedValue === 'true' || 
                               verifiedValue === 1 ||
                               verifiedValue === '1' ||
                               String(verifiedValue).toLowerCase() === 'true';
            
            const premiumBadge = document.getElementById('premium-badge');
            if (premiumBadge) {
              premiumBadge.style.display = isVerified ? 'inline-flex' : 'none';
            }
            
            const donateBtn = document.getElementById('header-donate-btn');
            if (donateBtn) {
              donateBtn.style.display = isVerified ? 'none' : 'inline-flex';
            }
          }
        } catch (err) {
          console.error('Error updating premium badge:', err);
        }
      }
      
      // Call on page load and when user logs in
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updatePremiumBadge);
      } else {
        updatePremiumBadge();
      }
      
      // ===== SMART SUBSCRIPTION SYSTEM =====
      
      // Subscription tiers configuration
      const SUBSCRIPTION_TIERS = {
        trial: { name: 'Free Trial', price: 0, period: '75 searches', features: ['75 free searches', 'Basic search features', 'Community access'] },
        basic: { name: 'Basic', price: 5, period: 'per month', features: ['Unlimited searches', 'Premium badge', 'Priority support', 'All search features'] },
        pro: { name: 'Pro', price: 10, period: 'per month', features: ['Everything in Basic', 'Discord notifications', 'Advanced filters', 'Early access features'] }
      };
      
      // Stripe checkout links
      const STRIPE_CHECKOUT_LINKS = {
        basic: 'https://buy.stripe.com/00w6oH2q5g6YdryekFcwg00', // MMCS Basic ($5)
        pro: 'https://buy.stripe.com/3cIbJ1e8Ng6Y1IQfoJcwg01', // MMCS Pro ($10)
        discord: 'https://buy.stripe.com/3cIbJ1e8Ng6Y1IQfoJcwg01' // Discord notifications requires Pro tier ($10)
      };
      
      // Get current user subscription tier
      async function getCurrentSubscriptionTier() {
        if (!supabase) return 'trial';
        
        try {
          const { data: { session } } = await supabase.auth.getSession();
          if (!session) return 'trial';
          
          const { data: { user } } = await supabase.auth.getUser();
          if (!user) return 'trial';
          
          const { data: userData } = await supabase
            .from('unlocked_users')
            .select('verified, subscription_tier, subscription_expires_at, discord_subscription_active')
            .eq('auth_user_id', user.id)
            .maybeSingle();
          
          if (!userData) return 'trial';
          
          // Check if verified (one-time payment = basic tier)
          const isVerified = userData.verified === true || userData.verified === 'true' || userData.verified === 1;
          
          if (isVerified) {
            // If has subscription_tier, use it, otherwise default to 'basic' for verified users
            return userData.subscription_tier || 'basic';
          }
          
          // Check trial status
          const trialSearchesUsed = userData.trial_searches_used || 0;
          if (trialSearchesUsed < 75) {
            return 'trial';
          }
          
          return 'expired';
        } catch (err) {
          console.error('Error getting subscription tier:', err);
          return 'trial';
        }
      }
      
      // Update subscription tier display
      async function updateSubscriptionDisplay() {
        const currentTier = await getCurrentSubscriptionTier();
        const badgeContainer = document.getElementById('current-subscription-badge');
        
        if (badgeContainer) {
          let badgeClass = 'subscription-status-badge ';
          let badgeText = '';
          
          if (currentTier === 'trial') {
            badgeClass += 'trial';
            badgeText = '🎁 Free Trial';
          } else if (currentTier === 'expired') {
            badgeClass += 'expired';
            badgeText = '⚠️ Trial Expired';
          } else {
            badgeClass += 'active';
            badgeText = `⭐ ${SUBSCRIPTION_TIERS[currentTier]?.name || 'Pro'}`;
          }
          
          badgeContainer.innerHTML = `<div class="${badgeClass}">${badgeText}</div>`;
        }
        
        // Update tier cards to show current tier
        document.querySelectorAll('.subscription-tier').forEach(tier => {
          const tierType = tier.getAttribute('data-tier');
          tier.classList.remove('current');
          if (tierType === currentTier) {
            tier.classList.add('current');
          }
        });
      }
      
      // Handle subscription payment (Stripe only)
      function handleSubscriptionPayment(tier, method) {
        if (method === 'stripe') {
          // Stripe checkout
          const stripeLink = STRIPE_CHECKOUT_LINKS[tier];
          if (!stripeLink || stripeLink.includes('YOUR_')) {
            alert('Stripe checkout links need to be configured. Please contact support.');
            return;
          }
          window.open(stripeLink, '_blank');
          alert(`Opening Stripe checkout for ${SUBSCRIPTION_TIERS[tier].name} plan ($${SUBSCRIPTION_TIERS[tier].price}/month)...\n\nAfter payment, your subscription will be activated automatically.`);
        }
      }
      
      // Expose getCurrentSubscriptionTier globally
      window.getCurrentSubscriptionTier = getCurrentSubscriptionTier;
      
      // Subscription payment button handlers
      document.querySelectorAll('.subscription-payment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const tier = this.getAttribute('data-tier');
          const method = this.getAttribute('data-method');
          handleSubscriptionPayment(tier, method);
        });
      });
      
      // Update subscription display on load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updateSubscriptionDisplay);
      } else {
        updateSubscriptionDisplay();
      }
      
      // Update when user logs in
      window.addEventListener('userLoggedIn', updateSubscriptionDisplay);
      
      // Subscription management modal
      const subscriptionManagementModal = document.getElementById('subscription-management-modal-bg');
      const subscriptionManagementClose = document.getElementById('subscription-management-modal-close');
      
      if (subscriptionManagementClose) {
        subscriptionManagementClose.addEventListener('click', () => {
          if (subscriptionManagementModal) subscriptionManagementModal.style.display = 'none';
        });
      }
      
      if (subscriptionManagementModal) {
        subscriptionManagementModal.addEventListener('click', (e) => {
          if (e.target === subscriptionManagementModal) {
            subscriptionManagementModal.style.display = 'none';
          }
        });
      }
      
      // Add "Manage Subscription" button to profile modal
      const profileModal = document.getElementById('profile-modal-bg');
      if (profileModal) {
        // This will be added when profile modal is shown
        window.showSubscriptionManagement = function() {
          if (subscriptionManagementModal) {
            subscriptionManagementModal.style.display = 'flex';
            loadSubscriptionManagementData();
          }
        };
      }
      
      // Load subscription management data
      async function loadSubscriptionManagementData() {
        const currentTier = await getCurrentSubscriptionTier();
        const planEl = document.getElementById('current-subscription-plan');
        const detailsEl = document.getElementById('current-subscription-details');
        const statusBadgeEl = document.getElementById('subscription-status-badge-container');
        const nextBillingEl = document.getElementById('next-billing-date');
        const paymentMethodEl = document.getElementById('payment-method');
        
        if (planEl) planEl.textContent = SUBSCRIPTION_TIERS[currentTier]?.name || 'Free Trial';
        if (detailsEl) detailsEl.textContent = `$${SUBSCRIPTION_TIERS[currentTier]?.price || 0} ${SUBSCRIPTION_TIERS[currentTier]?.period || ''}`;
        
        if (statusBadgeEl) {
          let badgeClass = 'subscription-status-badge ';
          if (currentTier === 'trial') badgeClass += 'trial';
          else if (currentTier === 'expired') badgeClass += 'expired';
          else badgeClass += 'active';
          statusBadgeEl.innerHTML = `<div class="${badgeClass}">${currentTier === 'trial' ? '🎁 Free Trial' : currentTier === 'expired' ? '⚠️ Expired' : '⭐ Active'}</div>`;
        }
        
        // Load subscription expiry date
        if (supabase) {
          try {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
              const { data: userData } = await supabase
                .from('unlocked_users')
                .select('subscription_expires_at, payment_method, discord_subscription_expires_at')
                .eq('auth_user_id', user.id)
                .maybeSingle();
              
              if (userData) {
                const expiryDate = userData.subscription_expires_at || userData.discord_subscription_expires_at;
                if (expiryDate && nextBillingEl) {
                  const expiry = new Date(expiryDate);
                  nextBillingEl.textContent = expiry.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                }
                
                if (userData.payment_method && paymentMethodEl) {
                  paymentMethodEl.textContent = userData.payment_method;
                }
              }
            }
          } catch (err) {
            console.error('Error loading subscription data:', err);
          }
        }
      }
      
      
    })();
  </script>
</body>
</html>
